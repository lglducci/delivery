 CREATE OR REPLACE FUNCTION buscar_numero_por_posicao(
  p_user_id     integer,
  p_id_empresa  integer,
  p_posicao     integer
)
RETURNS text
LANGUAGE plpgsql
AS $$

DECLARE
  v_item RECORD;
  v_msg TEXT;


BEGIN
  UPDATE turno_opcoes
     SET escolhido = true,etapa = 'falta_qtd'
   WHERE user_id    = p_user_id
     AND id_empresa = p_id_empresa
     AND posicao    = p_posicao;

  DELETE FROM turno_opcoes
   WHERE user_id    = p_user_id
     AND id_empresa = p_id_empresa
     AND posicao   <> p_posicao
     AND COALESCE(escolhido,false) = false;

PERFORM adianta_etapa(p_user_id, p_id_empresa);


SELECT numero, nome, tamanho, quantidade
  INTO v_item
  FROM turno_opcoes
  WHERE user_id = p_user_id
    AND id_empresa = p_id_empresa
    AND posicao = p_posicao
  LIMIT 1;

  IF NOT FOUND THEN
    RETURN FORMAT('‚ö†Ô∏è Nenhum item encontrado na posi√ß√£o %s.', p_posicao);
  END IF;

  -- se quantidade ou tamanho est√£o nulos, monta mensagem espec√≠fica
  IF v_item.quantidade IS NULL THEN
    v_msg := FORMAT('üçï %s selecionado com sucesso! Agora informe a quantidade desejada.', v_item.nome);
  ELSIF v_item.tamanho IS NULL THEN
    v_msg := FORMAT('üçï %s selecionado com sucesso! Qual tamanho voc√™ quer? (m√©dia ou grande)', v_item.nome);
  ELSE
    v_msg := FORMAT('üçï %s (%s) selecionado com sucesso! Quantidade: %s', v_item.nome, v_item.tamanho, v_item.quantidade);
  END IF;

  RETURN v_msg;
 
END;
$$;
