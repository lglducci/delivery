 BEGIN;
DROP FUNCTION IF EXISTS public.getpizzamontagem(integer, integer);

CREATE FUNCTION public.getpizzamontagem(p_user int, p_pedido int)
RETURNS TABLE (
  item_id bigint,           -- <â€” agora BIGINT
  comando_original text,
  categoria text,
  fracionada boolean,
  parte int
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    u.item_id,
    u.comando_original,
    u.categoria,
    u.fracionada,
    u.parte
  FROM (
    SELECT i.item_id, i.comando_original, i.categoria, i.fracionada, 1 AS parte
    FROM item_pedido_temp i
    WHERE i.status = 'opcoes'
      AND i.user_id = p_user
      AND i.pedido_id = p_pedido
      AND i.numero = 0
    UNION ALL
    SELECT j.item_id, j.comando_original, j.categoria, j.fracionada, 2 AS parte
    FROM item_pedido_temp j
    WHERE j.status = 'concluido'
      AND j.user_id = p_user
      AND j.pedido_id = p_pedido
      AND j.numero_fracao = 0
  ) u
  ORDER BY u.item_id, u.fracionada
  LIMIT 1;
END;
$$ LANGUAGE plpgsql STABLE;
COMMIT;
