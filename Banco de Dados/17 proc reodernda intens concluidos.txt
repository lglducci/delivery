 CREATE OR REPLACE PROCEDURE ReordenarItensConcluidos(p_user_id BIGINT, p_pedido_id BIGINT)
LANGUAGE plpgsql
AS $$
BEGIN
  WITH ordenado AS (
    SELECT 
      item_id,
      user_id,
      pedido_id,
      ROW_NUMBER() OVER (
        PARTITION BY user_id, pedido_id 
        ORDER BY item_id
      ) AS nova_ordem
    FROM item_pedido_temp
    WHERE user_id   = p_user_id
      AND pedido_id = p_pedido_id
      AND status    = 'concluido'
  )
  UPDATE item_pedido_temp i
     SET ordem_item = o.nova_ordem
  FROM ordenado o
  WHERE i.item_id   = o.item_id
    AND i.user_id   = o.user_id
    AND i.pedido_id = o.pedido_id;
END;
$$;
