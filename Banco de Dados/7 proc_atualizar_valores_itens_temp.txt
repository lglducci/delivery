      CREATE OR REPLACE FUNCTION atualizar_valores_itens_temp(
  p_categoria TEXT,
  p_user_id INTEGER,
 p_pedido_id INTEGER 
)
RETURNS void AS $$
 
BEGIN

UPDATE item_pedido_temp 
set tamanho = 'media'  
  WHERE pedido_id = p_pedido_id and
      user_id =  p_user_id 
   and categoria = 'pizza' 
   and  lower(tamanho) in ( 'médio', 'm','medio','média', 'médias')
   and  status = 'inicio' ;

 UPDATE item_pedido_temp 
set tamanho = 'grande'
   WHERE pedido_id = p_pedido_id and
      user_id =  p_user_id 
   and categoria = 'pizza' 
   and  lower(tamanho)  ='g'
   and status = 'inicio';

  
 UPDATE item_pedido_temp AS i
SET
  valor = CASE
            WHEN i.tamanho = 'grande' THEN c.preco_grande
            WHEN i.tamanho = 'media'  THEN c.preco_medio
            ELSE c.preco_grande
          END * quantidade,

  -- <<< AQUI: usa numero_fracao p/ borda/item; senão, usa numero normal
  nome = '(' || 
           CASE 
             WHEN i.categoria IN ('borda','item') THEN
               COALESCE(NULLIF(i.numero_fracao,0)::text,
                        COALESCE(i.numero::text, c.numero::text))
             ELSE
               COALESCE(i.numero::text, c.numero::text)
           END
         || ') ' || COALESCE(i.nome, c.nome),

  valor_unitario = CASE
                     WHEN i.tamanho = 'grande' THEN c.preco_grande
                     WHEN i.tamanho = 'media'  THEN c.preco_medio
                     ELSE c.preco_grande
                   END
FROM cardapio AS c
WHERE
  i.numero = c.numero
  AND i.user_id   = p_user_id
  AND c.categoria = p_categoria
  AND i.categoria = p_categoria
  AND i.fracionada = 'FALSE'
  AND i.pedido_id = p_pedido_id
  AND i.status = 'inicio';


UPDATE item_pedido_temp AS i
  SET valor =  CASE
    WHEN i.tamanho = 'grande' THEN c.preco_grande
    WHEN i.tamanho = 'media'  THEN c.preco_medio
    ELSE  c.preco_grande
  END * quantidade,
  nome =    ( '(' || COALESCE(i.numero::text, c.numero::text) || ') ' || COALESCE(i.nome, c.nome) )  ,
   valor_unitario =  CASE
    WHEN i.tamanho = 'grande' THEN c.preco_grande
    WHEN i.tamanho = 'media'  THEN c.preco_medio
    ELSE  c.preco_grande
  END  
  FROM cardapio AS c
  WHERE 
    i.numero = c.numero
    AND i.user_id = p_user_id 
   AND c.tipo   = 'bebida'
    AND i.tipo = 'bebida'
    AND i.fracionada = 'FALSE'
    AND i.pedido_id = p_pedido_id and i.status = 'inicio'; 




END;
$$ LANGUAGE plpgsql;

GRANT EXECUTE ON FUNCTION atualizar_valores_itens_temp(TEXT, INTEGER, INTEGER) TO public;
GRANT EXECUTE ON FUNCTION atualizar_valores_itens_temp(TEXT, INTEGER,INTEGER) TO authenticated;

SELECT atualizar_valores_itens_temp('borda',  82,1);
