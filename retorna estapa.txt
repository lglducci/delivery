CREATE OR REPLACE FUNCTION turno_opcoes_count_all_false(
  p_user_id    integer,
  p_id_empresa integer
)
RETURNS integer
LANGUAGE sql
STABLE
AS $$
WITH base AS (
  SELECT COALESCE(escolhido, false) AS escolhido
  FROM turno_opcoes
  WHERE user_id = p_user_id
    AND id_empresa = p_id_empresa
),
agg AS (
  SELECT
    COUNT(*) AS total,
    SUM(CASE WHEN escolhido THEN 1 ELSE 0 END) AS qt_true
  FROM base
)
SELECT CASE
         WHEN total = 0         THEN 0         -- sem linhas
         WHEN qt_true > 0       THEN 0         -- existe pelo menos um true
         ELSE total                          -- todos false (ou null)
       END::int
FROM agg;
$$;
