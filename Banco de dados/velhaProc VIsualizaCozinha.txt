CREATE OR REPLACE FUNCTION visualizarcozinha( 
  p_id_empresa INT,
  p_pedido_id  INT
)
RETURNS TABLE (
  numero        INT,
  nome          TEXT,
  quantidade    INT,
  tamanho       TEXT,
  fracionado    TEXT,
  tipo          TEXT,
  categoria     TEXT,
  numero_pai    INT,
  nome_pai      TEXT
)
LANGUAGE sql
AS $$
  -- Itens principais (pizza, bebida etc.)
  SELECT 
    i.numero,
    i.nome,
    i.quantidade,
    i.tamanho,
    i.fracionada,
    i.tipo,
    i.categoria,
    NULL::INT  AS numero_pai,
    NULL::TEXT AS nome_pai
  FROM item_pedido i
  WHERE   i.id_empresa = p_id_empresa
    AND i.pedido_id  = p_pedido_id
    AND i.categoria NOT IN ('item', 'borda')

  UNION ALL

  -- Itens filhos (borda, adicionais etc.) com referÃªncia ao pai
  SELECT 
    f.numero,
    f.nome,
    f.quantidade,
    f.tamanho,
    f.fracionada,
    f.tipo,
    f.categoria,
    p.numero AS numero_pai,
    p.nome   AS nome_pai
  FROM item_pedido f
  JOIN item_pedido p
    ON p.item_id = f.id_pizza_pai
   AND p.user_id = f.user_id
   AND p.id_empresa = f.id_empresa
   AND p.pedido_id = f.pedido_id
  WHERE  f.id_empresa = p_id_empresa
    AND f.pedido_id  = p_pedido_id
    AND f.categoria IN ('item', 'borda')
$$;

 