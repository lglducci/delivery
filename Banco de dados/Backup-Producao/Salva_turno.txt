  CREATE OR REPLACE FUNCTION salvar_opcoes_turno(
  p_id_empresa INT,
  p_user_id INT,
  p_json_opcoes JSONB
)
RETURNS TABLE (
  posicao INT,
  numero INT,
  nome TEXT,
  categoria TEXT,
  descricao TEXT,
  preco_grande NUMERIC,
  preco_medio NUMERIC,
  preco_pequena NUMERIC
)
LANGUAGE plpgsql
AS $$
BEGIN
  -- Limpa opções anteriores do usuário
  DELETE FROM turno_opcoes 
  WHERE id_empresa = p_id_empresa 
    AND user_id = p_user_id;

  -- Insere novas opções e retorna tudo de volta
  RETURN QUERY
  INSERT INTO turno_opcoes (
    id_empresa, user_id, posicao, numero, nome, categoria, descricao,
    preco_grande, preco_medio, preco_pequena, escolhido, updated_at
  )
  SELECT 
    p_id_empresa AS id_empresa,
    p_user_id AS user_id,
    ROW_NUMBER() OVER () AS posicao,       -- posição gerada
    (elem->>'numero')::INT AS numero,
    elem->>'nome' AS nome,
    elem->>'categoria' AS categoria,
    elem->>'descricao' AS descricao,
    (elem->>'preco_grande')::NUMERIC AS preco_grande,
    (elem->>'preco_medio')::NUMERIC AS preco_medio,
    (elem->>'preco_pequena')::NUMERIC AS preco_pequena,
    false AS escolhido,
    now() AS updated_at
  FROM jsonb_array_elements(p_json_opcoes) AS elem
  RETURNING 
    turno_opcoes.posicao, 
    turno_opcoes.numero, 
    turno_opcoes.nome, 
    turno_opcoes.categoria, 
    turno_opcoes.descricao,
    turno_opcoes.preco_grande, 
    turno_opcoes.preco_medio, 
    turno_opcoes.preco_pequena;
END;
$$;


