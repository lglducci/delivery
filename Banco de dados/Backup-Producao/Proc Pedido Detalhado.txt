CREATE OR REPLACE FUNCTION pedido_detalhado(p_pedido_id INT, p_id_empresa INT)
RETURNS JSON AS $$
DECLARE
  pedido_json JSON;
BEGIN
  SELECT json_build_object(
    'pedido_id', p.pedido_id,
    'nome_cliente', u.nome,
    'tipo_cobranca', p.tipo_cobranca,
    'resumo', p.resumo,
    'endereco', u."endere√ßo",
    'bairro', u.bairro,
    'itens', (
      SELECT json_agg(
        json_build_object(
          'numero', i.numero,
          'nome', i.nome,
          'quantidade', i.quantidade,
          'valor', i.valor,
          'categoria', i.categoria,
          'tipo', i.tipo,
          'fracionada', i.fracionada
        )
      )
      FROM item_pedido i
      WHERE i.pedido_id = p.pedido_id
        AND i.id_empresa = p.id_empresa
    )
  )
  INTO pedido_json
  FROM pedidos p
  INNER JOIN usuario u
    ON u.user_id = p.user_id
   AND u.id_empresa = p.id_empresa
  WHERE p.pedido_id = p_pedido_id
    AND p.id_empresa = p_id_empresa;

  RETURN pedido_json;
END;
$$ LANGUAGE plpgsql;
 




select * from pedido_detalhado (2,2)
