    DROP FUNCTION get_carrinho_pizza(integer,integer,integer,text) 



 CREATE OR REPLACE FUNCTION get_carrinho_pizza(
    p_user_id INTEGER,
    p_pedido_id INTEGER,
    p_id_empresa INTEGER,
    p_categoria text 
)
RETURNS TABLE (
    item_id  BIGINT,,
    numero BIGINT,
    nome TEXT,
    tamanho TEXT,
   categoria  TEXT,
    quantidade BIGINT,
    valor  numeric(10,2)
)
LANGUAGE plpgsql
AS $$
BEGIN
  

    -- Retornar os itens de pizza no carrinho
    RETURN QUERY
  SELECT 
    i.item_id,
    i.numero,
    i.nome,
    i.tamanho,
    i.categoria,
    i.quantidade,
    COALESCE(i.valor, 0)::numeric(10,2) AS valor   
FROM item_pedido_temp i
WHERE i.user_id = p_user_id
  AND i.pedido_id = p_pedido_id
  AND i.id_empresa = p_id_empresa
  AND (p_categoria = '' OR i.categoria = p_categoria)
  AND i.item_id NOT IN (
        SELECT COALESCE(b.id_pizza_pai, 0)
        FROM item_pedido_temp b
        WHERE b.user_id = p_user_id
          AND b.pedido_id = p_pedido_id
          AND b.id_empresa = p_id_empresa
          AND b.categoria = 'borda'
          AND b.id_pizza_pai IS NOT NULL
  )
ORDER BY i.item_id;

END;
$$;