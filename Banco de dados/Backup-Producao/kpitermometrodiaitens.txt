  CREATE OR REPLACE FUNCTION public.kpi_termometro_itens(
  p_id_empresa INT,
  p_data DATE DEFAULT (now() AT TIME ZONE 'America/Sao_Paulo')::date
)
RETURNS JSONB
LANGUAGE plpgsql
AS $$
DECLARE
  v_result JSONB;
BEGIN
  v_result := jsonb_build_object(
    'vendas_hora',
    COALESCE((
      SELECT jsonb_agg(jsonb_build_object('hora',vh.hora,'pedidos',vh.pedidos,'total',vh.total))
      FROM (
        SELECT
          EXTRACT(HOUR FROM p.create_at AT TIME ZONE 'America/Sao_Paulo')::int AS hora,
          COUNT(*) AS pedidos,
          SUM(p.valor)::numeric AS total
        FROM pedidos p
        WHERE p.id_empresa = p_id_empresa
          AND (p.create_at AT TIME ZONE 'America/Sao_Paulo')::date = p_data
        GROUP BY 1 ORDER BY 1
      ) vh
    ), '[]'::jsonb),

    'top_itens',
    COALESCE((
      SELECT jsonb_agg(jsonb_build_object('nome',ti.nome,'qtd',ti.qtd,'total',ti.total))
      FROM (
        SELECT
          c.nome,
          SUM(i.quantidade)::int AS qtd,
          SUM(i.valor)::numeric AS total
        FROM item_pedido i
        JOIN cardapio c ON c.numero = i.numero AND c.id_empresa = i.id_empresa
        JOIN pedidos p ON p.pedido_id = i.pedido_id AND p.id_empresa = i.id_empresa
        WHERE p.id_empresa = p_id_empresa
          AND (p.create_at AT TIME ZONE 'America/Sao_Paulo')::date = p_data
        GROUP BY c.nome
        ORDER BY total DESC
        LIMIT 10
      ) ti
    ), '[]'::jsonb)
  );

  RETURN v_result;
END;
$$;