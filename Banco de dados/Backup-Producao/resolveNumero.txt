 CREATE OR REPLACE FUNCTION buscar_numero_por_posicao(
  p_user_id     integer,
  p_id_empresa  integer,
  p_posicao     integer
)
RETURNS text
LANGUAGE plpgsql
AS $$
BEGIN
  UPDATE turno_opcoes
     SET escolhido = true,etapa = 'falta_qtd'
   WHERE user_id    = p_user_id
     AND id_empresa = p_id_empresa
     AND posicao    = p_posicao;

  DELETE FROM turno_opcoes
   WHERE user_id    = p_user_id
     AND id_empresa = p_id_empresa
     AND posicao   <> p_posicao
     AND COALESCE(escolhido,false) = false;

  RETURN 'ok';
END;
$$;
