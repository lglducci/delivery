CREATE OR REPLACE PROCEDURE ConcluiPrePedido(
    p_user_id     INTEGER,
    p_pedido_id   INTEGER,
    p_id_empresa  INTEGER
)
LANGUAGE plpgsql
AS $$
BEGIN
  -- 1️⃣ Rejeita itens inválidos (mantém apenas os válidos)
  PERFORM rejeita_item(p_user_id, p_pedido_id, p_id_empresa);

  -- 2️⃣ Atualiza itens válidos para status 'concluido'
  UPDATE item_pedido_temp AS i
  SET status = 'concluido',
      ordem_item = 0
  WHERE i.status = 'inicio'
    AND i.user_id = p_user_id
    AND i.pedido_id = p_pedido_id
    AND i.numero <> 0
    AND i.id_empresa = p_id_empresa;

  -- 3️⃣ Reordena os itens concluídos
  CALL ReordenarItensConcluidos(p_user_id, p_pedido_id, p_id_empresa);

  RAISE NOTICE '✅ ConcluiPrePedido executado com sucesso (user %, pedido %, empresa %)', 
    p_user_id, p_pedido_id, p_id_empresa;
END;
$$;

-- Permissões (ajuste o usuário conforme o seu ambiente)
GRANT EXECUTE ON PROCEDURE ConcluiPrePedido(INTEGER, INTEGER, INTEGER) TO PUBLIC;
