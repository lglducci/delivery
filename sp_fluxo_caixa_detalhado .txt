 CREATE OR REPLACE FUNCTION contab.sp_fluxo_caixa_detalhado (
    p_empresa_id BIGINT,
    p_data_ini   DATE,
    p_data_fim   DATE
)
RETURNS TABLE (
    data_mov        DATE,
    conta_codigo    TEXT,
    conta_nome      TEXT,
    historico       TEXT,
    entrada         NUMERIC(14,2),
    saida           NUMERIC(14,2),
    saldo_mov       NUMERIC(14,2)
)
LANGUAGE sql
AS $$
WITH contas_caixa AS (
    SELECT id
    FROM contab.contas
    WHERE tipo = 'ATIVO'
      AND analitica = TRUE
      AND (
            codigo = '1.1.1'
         OR codigo LIKE '1.1.1.%'
         OR codigo = '1.1.2'
         OR codigo LIKE '1.1.2.%'
      )
),

movimentos AS (
    SELECT
        l.data_mov::date AS data_mov,
        c.codigo         AS conta_codigo,
        c.nome           AS conta_nome,
        l.historico      AS historico,

        CASE
            WHEN c.natureza = 'D' THEN COALESCE(l.debito,0)
            ELSE COALESCE(l.credito,0)
        END AS entrada,

        CASE
            WHEN c.natureza = 'D' THEN COALESCE(l.credito,0)
            ELSE COALESCE(l.debito,0)
        END AS saida,

        CASE
            WHEN c.natureza = 'D'
                THEN COALESCE(l.debito,0) - COALESCE(l.credito,0)
            ELSE
                COALESCE(l.credito,0) - COALESCE(l.debito,0)
        END AS saldo_mov
    FROM contab.lancamentos l
    JOIN contab.contas c ON c.id = l.conta_id
    WHERE l.empresa_id = p_empresa_id
      AND l.conta_id IN (SELECT id FROM contas_caixa)
),

saldo_inicial AS (
    SELECT
        COALESCE(SUM(si.saldo),0)
        +
        COALESCE((
            SELECT SUM(m.entrada - m.saida)
            FROM movimentos m
            WHERE m.data_mov < p_data_ini
        ),0) AS saldo
    FROM contab.saldos_iniciais si
    WHERE si.empresa_id = p_empresa_id
      AND si.conta_id IN (SELECT id FROM contas_caixa)
      AND si.data_base <= p_data_ini
)

-- ðŸ”¹ LINHA FAKE DE SALDO INICIAL
SELECT
    p_data_ini            AS data_mov,
    NULL                  AS conta_codigo,
    'SALDO INICIAL'       AS conta_nome,
    'SALDO INICIAL'       AS historico,
    0::numeric            AS entrada,
    0::numeric            AS saida,
    s.saldo               AS saldo_mov
FROM saldo_inicial s

UNION ALL

-- ðŸ”¹ MOVIMENTOS REAIS DO PERÃODO
SELECT
    m.data_mov,
    m.conta_codigo,
    m.conta_nome,
    m.historico,
    m.entrada,
    m.saida,
    m.saldo_mov
FROM movimentos m
WHERE m.data_mov BETWEEN p_data_ini AND p_data_fim

ORDER BY
    data_mov,
    conta_codigo NULLS FIRST;
$$;
