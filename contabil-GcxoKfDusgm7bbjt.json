{"createdAt":"2025-08-21T17:15:11.015Z","updatedAt":"2025-08-23T15:10:47.840Z","id":"GcxoKfDusgm7bbjt","name":"Contabil","active":false,"isArchived":false,"nodes":[{"parameters":{"promptType":"define","text":"= ","options":{"systemMessage":"= # Overview  \nVocê é um agente AI responsável por coletar dados sequenciais para gerar lançamentos contábeis. Cada campo depende do preenchimento correto do anterior antes de prosseguir. Após a coleta completa dos dados, o agente executa o serviço `geralancamento(id)` usando o ID de retorno obtido ao solicitar os dados do diário.\n\n## Context  \n- O objetivo é gerar lançamentos contábeis a partir de dados fornecidos pelo cliente.  \n- Os dados devem ser coletados na seguinte ordem: modelo_codigo, historico, doc_ref, valor_total, valor_custo, valor_imposto, desconto.  \n- O campo seguinte só deve ser solicitado se o campo anterior for preenchido corretamente.  \n- Após a coleta, o serviço de geração de lançamento deve ser chamado com o ID retornado da criação do diário.  \n\n## Instructions  \n1. Solicite ao cliente o campo `modelo_codigo`.  \n2. Se fornecido, solicite o campo `historico`.  \n3. Se fornecido, solicite o campo `doc_ref`.  \n4. Continue solicitando os campos na seguinte ordem, apenas se o anterior tiver sido preenchido:  \n   - valor_total  \n   - valor_custo  \n   - valor_imposto  \n   - desconto  \n\n\n\n5. Após todos os campos serem coletados, crie o diário atraves da execução    `geradiario(modelo_codigo,historico,doc_ref, valor_total,valor_custo, valor_imposto,desconto )`  e obtenha o ID de retorno da execução  \n \n6. Execute o serviço `geradiario(modelo_codigo,historico,doc_ref, valor_total,valor_custo, valor_imposto,desconto)`  e retorne  o ID retornado.  \n\n{\n  \"id\": {{ memory.previousToolResponse.response[0].id }}\n}\n\n7. Execute o serviço `geralancamento(id)` usando o ID retornado.  \n\n## Tools  \n- Serviço: `geradiario(modelo_codigo,historico,doc_ref, valor_total,valor_custo, valor_imposto,desconto )`  \n- Serviço: `geralancamento(id)` \n- Recurso: Diário contábil (para obter ID de retorno)  \n\n## Examples  \n- Input sequencial:  \n  - modelo_codigo: \"VENDA_REFEICAO\"    \n  - historico: Compra de insumos  \n  - doc_ref: NF1234  \n  - valor_total: 1000  \n  - valor_custo: 0  \n  - valor_imposto: 0  \n  - desconto: 0  \n\n- Output:  \n  - Diário criado com ID: 5789  \n  - Serviço `geralancamento(5789)` executado com sucesso.  \n\n## SOP (Standard Operating Procedure)  \n1. Pergunte o campo `modelo_codigo`.  \n2. Se preenchido, pergunte `historico`.  \n3. Se preenchido, pergunte `doc_ref`.  \n4. Continue com os próximos campos somente se o anterior for preenchido.  \n5. Após coletar todos os campos, envie os dados para criar o diário e armazene o ID retornado.  \n6. Chame `geralancamento(id)` com o ID recebido.  \n7. Confirme com o cliente a execução bem-sucedida.  \n\n## Final Notes  \n- Sempre valide se o campo anterior foi preenchido antes de prosseguir.  \n- Não aceite valores em branco ou nulos.  \n- Os valores numéricos devem estar em formato decimal com ponto (.) como separador.  \n---\n\n\n\n## Final Notes  \n- `modelo_codigo` deve ser uma string representando o tipo de operação (ex: \"VENDA_REFEICAO\", \"COMPRA_MERCADORIA\").  \n- Os valores numéricos devem estar em formato decimal com ponto (.) como separador.  \n- Não aceite valores em branco ou nulos, a não ser valor_custo ,  valor_imposto, desconto.  Esses podem ter valor zero. valor_total não---\n\n\n\n\n\n\n\n\n## Examples - Entrada rápida: - modelo_codigo: PAG_FORNECEDOR - historico: Pgto NF 456 - doc_ref: NF456 - valor_total: 1200 - valor_custo: 0 - valor_imposto: 0 - desconto: 0 - Saída esperada: - geradiario → response[0].id = 42 - geralancamento chamado com id = 42"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[2192,0],"id":"02dee18b-3c49-4711-9301-e3c039da27c0","name":"AI Agent"},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"gpt-4o-mini"},"options":{"temperature":0}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[2192,368],"id":"a04f2a29-e94e-4939-943c-0cb66d3b27a9","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"2hW4LOItQwhgTw0Q","name":"OpenAi account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"=14552"},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[2256,240],"id":"04a8e3e6-8e80-45f6-a447-5ea2bb8b5acd","name":"Simple Memory"},{"parameters":{"method":"POST","url":"= https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-MyrBo2u0n7N/text","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer MyrBo2u0n7N"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=   {\n  \"messageData\": {\n    \"to\": \"5516992975836\",\n    \"text\": \"{{ $json.output.replace(/\\n/g, '\\\\n')  }}\"\n  }\n}\n","options":{}},"id":"ce3d062c-1eaa-47fa-a7bb-7270810cfa59","name":"RequestMenu7","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2560,0]},{"parameters":{"schema":{"__rl":true,"value":"contab","mode":"name"},"table":{"__rl":true,"value":"diario","mode":"list","cachedResultName":"diario"},"columns":{"mappingMode":"defineBelow","value":{"modelo_codigo":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('modelo_codigo', `modelo_codigo`, 'string') }}","data_mov":"= {{ $now }}","historico":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('historico', `historico`, 'string') }}","doc_ref":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('doc_ref', `doc_ref`, 'string') }}","valor_total":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('valor_total', `valor_total`, 'number') }}","valor_custo":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('valor_custo', `valor_custo`, 'number') }}","valor_imposto":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('valor_imposto', `valor_imposto`, 'number') }}","desconto":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('desconto', `desconto `, 'number') }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"data_mov","displayName":"data_mov","required":true,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"modelo_codigo","displayName":"modelo_codigo","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"historico","displayName":"historico","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"doc_ref","displayName":"doc_ref","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"parceiro_id","displayName":"parceiro_id","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"valor_total","displayName":"valor_total","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"valor_custo","displayName":"valor_custo","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"valor_imposto","displayName":"valor_imposto","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"desconto","displayName":"desconto","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"outros","displayName":"outros","required":false,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{"outputColumns":["id"]}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[2368,224],"id":"079b7668-4fe3-40c7-876a-f54ef00a8513","name":"geradiario","credentials":{"postgres":{"id":"SsAL6F2essiJYcMm","name":"PostgreeContabil"}}},{"parameters":{"descriptionType":"manual","toolDescription":"Execute a SQL query in Postgres","operation":"executeQuery","query":"SELECT * FROM contab.gerar_lancamentos_por_diario($1)","options":{"queryReplacement":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Query_Parameters', ``, 'string') }}"}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[2560,208],"id":"93b9aa6d-4a11-44ce-a77e-c876cbca7347","name":"geralancamento","credentials":{"postgres":{"id":"SsAL6F2essiJYcMm","name":"PostgreeContabil"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2768,0],"id":"6c3d8a07-8874-4363-9f5c-118595b9c44d","name":"No Operation, do nothing12","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"httpMethod":"POST","path":"agente","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-928,-80],"id":"f9802e94-a078-4470-bd9b-75a80fe3686e","name":"Webhook","webhookId":"66949457-5339-4325-b499-9a15d57ff6a1"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.status }}","rightValue":"menu","operator":{"type":"string","operation":"equals"},"id":"af400445-ccdb-465c-bb38-87e980d17d91"}],"combinator":"and"},"renameOutput":true,"outputKey":"menu"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c8b0ced3-4826-4fb1-8d17-053d7e7ac874","leftValue":"={{ $json.status }}","rightValue":"sair","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"sair"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"e2b4bc27-0610-4495-a368-f931a1af7b35","leftValue":"={{ $json.status }}","rightValue":"voltar","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"voltar"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"cd2e6601-4c7c-4ec5-866d-803a336ecf96","leftValue":"={{ $json.status }}","rightValue":"cadastro","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"cadastro"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"8ed1ccb5-e3fd-47fd-bc07-104ed5d4705b","leftValue":"={{ $json.status }}","rightValue":"lancamento","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"lancamento"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b8c1114d-3f7b-47a3-9cd6-0f892e78c593","leftValue":"={{ $json.status }}","rightValue":"balancete","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"balancete"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"e7dfeb6c-c09b-4a3e-a2aa-631dfe69eb03","leftValue":"={{ $json.status }}","rightValue":"razao","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"razao"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"886c4f7f-60d9-49c3-a240-ea5425296f2f","leftValue":"={{ $json.status }}","rightValue":"balancosaldo","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"balancosaldo"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"662d8533-704c-4ad0-9fa4-85eab246bdaf","leftValue":"={{ $json.status }}","rightValue":"patrimonial","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"patrimonial"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"dd6568cb-c4ce-4e2a-96bd-33b000224e25","leftValue":"={{ $json.status }}","rightValue":"DER","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"DER"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"bd318d1e-8fb9-4b2f-8d6c-f32b00fb2b73","leftValue":"={{ $json.status }}","rightValue":"modelo","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"modelo"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[64,-128],"id":"dd1806bd-357e-479c-94f7-207157d12c1b","name":"Switch"},{"parameters":{"method":"POST","url":"https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-MyrBo2u0n7N/listMessage","sendHeaders":true,"headerParameters":{"parameters":[{"name":"authorization","value":"Bearer MyrBo2u0n7N"}]},"sendBody":true,"specifyBody":"json","jsonBody":" \n                                            {\n                                                \"messageData\": {\n                                                    \"to\": \"5516994066336\",\n                                                    \"buttonText\": \"Escolha\",\n                                                    \"text\": \"Opção\",\n                                                    \"title\": \"Menu contábil\",\n                                                    \"description\": \"Selecione item do Menu\",\n                                                    \"sections\": [\n                                                        {\n                                                            \"title\": \"Lançamento\",\n                                                            \"rows\": [\n                                                                {\n                                                                    \"title\": \"Lançamento\",\n                                                                    \"description\": \"Lançamento Contábil\",\n                                                                    \"rowId\": \"01\"\n                                                                }\n                                                            ]\n                                                        },\n                                                        {\n                                                            \"title\": \"Cadastro\",\n                                                            \"rows\": [\n                                                                {\n                                                                    \"title\": \"Casdatro de Conta \",\n                                                                    \"description\": \"Cadastramento de conta contábil\",\n                                                                    \"rowId\": \"02\"\n                                                                }\n                                                            ]\n                                                        },\n\n                                                       {\n                                                            \"title\": \"Lançamento\",\n                                                            \"rows\": [\n                                                                {\n                                                                    \"title\": \"Lançamento\",\n                                                                    \"description\": \"Lançamento Contábil\",\n                                                                    \"rowId\": \"01\"\n                                                                }\n                                                            ]\n                                                        },\n                                                        {\n                                                            \"title\": \"Voltar\",\n                                                            \"rows\": [\n                                                                {\n                                                                    \"title\": \"Voltar\",\n                                                                    \"description\": \"Voltar\",\n                                                                    \"rowId\": \"03\"\n                                                                }\n                                                            ]\n                                                        },\n\n                                                       {\n                                                            \"title\": \"Processamento Contábil\",\n                                                            \"rows\": [\n                                                                {\n                                                                    \"title\": \"Geração de Lançamento\",\n                                                                    \"description\": \"Processamento Contábil\",\n                                                                    \"rowId\": \"03\"\n                                                                }\n                                                            ]\n                                                        },\n                                                        {\n                                                            \"title\": \"Relatório de Contas\",\n                                                            \"rows\": [\n                                                                {\n                                                                    \"title\": \"Relatório de Contas \",\n                                                                    \"description\": \"Relatório de Contas\",\n                                                                    \"rowId\": \"04\"\n                                                                }\n                                                            ]\n                                                        },\n                                                        {\n                                                            \"title\": \"Relatório Contábeil\",\n                                                            \"rows\": [\n                                                                {\n                                                                    \"title\": \"Relatório Contábeil\",\n                                                                    \"description\": \"Relatório Contábeil\",\n                                                                    \"rowId\": \"05\"\n                                                                }\n                                                            ]\n                                                        }\n                                                    ],\n                                                    \"listType\": 0\n                                                }\n                                            }\n                                        ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[352,-864],"id":"672a35fa-7029-40cf-8022-d92967a3de55","name":"HTTP Request"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[624,-864],"id":"84fc29fa-b96d-460b-ad6e-009eeaab176d","name":"No Operation, do nothing","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"assignments":{"assignments":[{"id":"468b693c-abc2-4ece-b9c7-15a6a41d329c","name":"selectedRowId","value":"={{ $json.body?.message?.listResponseMessage?.singleSelectReply?.selectedRowId }}","type":"string"},{"id":"3611f97f-8ddc-4cc8-b264-c6105a232bd8","name":"msg","value":"={{ $json.body.message.conversation }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-688,-64],"id":"5339df6e-f7a7-45ee-b918-e0d85a0eedfd","name":"Edit Fields"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b74707c5-e9f6-4c4c-b126-d0b3eec3d03d","leftValue":"={{ $json.msg }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-480,-64],"id":"3295349d-a347-4ed3-9c97-08c9a19085c0","name":"If"},{"parameters":{"operation":"select","schema":{"__rl":true,"value":"contab","mode":"name"},"table":{"__rl":true,"value":"menu","mode":"list","cachedResultName":"menu"},"returnAll":true,"where":{"values":[{"column":"selecionado","value":"=true"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-272,-80],"id":"086d27e9-5cbc-435b-ae84-879aef63948f","name":"Select rows from a table1","credentials":{"postgres":{"id":"SsAL6F2essiJYcMm","name":"PostgreeContabil"}}},{"parameters":{"operation":"executeQuery","query":"update menu set selecionado =false;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-960,640],"id":"e427d526-cd2e-43c9-84e5-a9ee681afa0f","name":"Execute a SQL query","credentials":{"postgres":{"id":"SsAL6F2essiJYcMm","name":"PostgreeContabil"}}},{"parameters":{"operation":"executeQuery","query":"update menu set selecionado = true where  selectedRowId= {{ $json.selectedRowId }};","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-768,640],"id":"29b7aab7-9eef-406a-af72-bc8b81a63936","name":"Execute a SQL query1","credentials":{"postgres":{"id":"SsAL6F2essiJYcMm","name":"PostgreeContabil"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-320,656],"id":"d38d6f00-ffb2-47d9-8b5a-8d1a301270c0","name":"No Operation, do nothing1","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"method":"POST","url":"= https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-MyrBo2u0n7N/text","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer MyrBo2u0n7N"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=   {\n  \"messageData\": {\n    \"to\": \"5516992975836\",\n    \"text\": \"Ok digite continar\"\n  }\n}\n","options":{}},"id":"27c9d300-b019-481c-9051-00b2787d1e99","name":"RequestMenu","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-560,656]},{"parameters":{"promptType":"define","text":"= ","options":{"systemMessage":"= # Overview  \nVocê é um agente AI responsável por coletar dados sequenciais para gerar lançamentos contábeis. Cada campo depende do preenchimento correto do anterior antes de prosseguir. Após a coleta completa dos dados, o agente executa o serviço `geralancamento(id)` usando o ID de retorno obtido ao solicitar os dados do diário.\n\n## Context  \n- O objetivo é gerar lançamentos contábeis a partir de dados fornecidos pelo cliente.  \n- Os dados devem ser coletados na seguinte ordem: modelo_codigo, historico, doc_ref, valor_total, valor_custo, valor_imposto, desconto.  \n- O campo seguinte só deve ser solicitado se o campo anterior for preenchido corretamente.  \n- Após a coleta, o serviço de geração de lançamento deve ser chamado com o ID retornado da criação do diário.  \n\n## Instructions  \n1. Solicite ao cliente o campo `modelo_codigo`.  \n2. Se fornecido, solicite o campo `historico`.  \n3. Se fornecido, solicite o campo `doc_ref`.  \n4. Continue solicitando os campos na seguinte ordem, apenas se o anterior tiver sido preenchido:  \n   - valor_total  \n   - valor_custo  \n   - valor_imposto  \n   - desconto  \n\n\n\n5. Após todos os campos serem coletados, crie o diário atraves da execução    `geradiario(modelo_codigo,historico,doc_ref, valor_total,valor_custo, valor_imposto,desconto )`  e obtenha o ID de retorno da execução  \n \n6. Execute o serviço `geradiario(modelo_codigo,historico,doc_ref, valor_total,valor_custo, valor_imposto,desconto)`  e retorne  o ID retornado.  \n\n{\n  \"id\": {{ memory.previousToolResponse.response[0].id }}\n}\n\n7. Execute o serviço `geralancamento(id)` usando o ID retornado.  \n\n## Tools  \n- Serviço: `geradiario(modelo_codigo,historico,doc_ref, valor_total,valor_custo, valor_imposto,desconto )`  \n- Serviço: `geralancamento(id)` \n- Recurso: Diário contábil (para obter ID de retorno)  \n\n## Examples  \n- Input sequencial:  \n  - modelo_codigo: \"VENDA_REFEICAO\"    \n  - historico: Compra de insumos  \n  - doc_ref: NF1234  \n  - valor_total: 1000  \n  - valor_custo: 0  \n  - valor_imposto: 0  \n  - desconto: 0  \n\n- Output:  \n  - Diário criado com ID: 5789  \n  - Serviço `geralancamento(5789)` executado com sucesso.  \n\n## SOP (Standard Operating Procedure)  \n1. Pergunte o campo `modelo_codigo`.  \n2. Se preenchido, pergunte `historico`.  \n3. Se preenchido, pergunte `doc_ref`.  \n4. Continue com os próximos campos somente se o anterior for preenchido.  \n5. Após coletar todos os campos, envie os dados para criar o diário e armazene o ID retornado.  \n6. Chame `geralancamento(id)` com o ID recebido.  \n7. Confirme com o cliente a execução bem-sucedida.  \n\n## Final Notes  \n- Sempre valide se o campo anterior foi preenchido antes de prosseguir.  \n- Não aceite valores em branco ou nulos.  \n- Os valores numéricos devem estar em formato decimal com ponto (.) como separador.  \n---\n\n\n\n## Final Notes  \n- `modelo_codigo` deve ser uma string representando o tipo de operação (ex: \"VENDA_REFEICAO\", \"COMPRA_MERCADORIA\").  \n- Os valores numéricos devem estar em formato decimal com ponto (.) como separador.  \n- Não aceite valores em branco ou nulos, a não ser valor_custo ,  valor_imposto, desconto.  Esses podem ter valor zero. valor_total não---\n\n\n\n\n\n\n\n\n## Examples - Entrada rápida: - modelo_codigo: PAG_FORNECEDOR - historico: Pgto NF 456 - doc_ref: NF456 - valor_total: 1200 - valor_custo: 0 - valor_imposto: 0 - desconto: 0 - Saída esperada: - geradiario → response[0].id = 42 - geralancamento chamado com id = 42"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[592,-672],"id":"5f089d56-f3bc-425d-b1f6-7b1b2e592542","name":"AI Agent1"},{"parameters":{"sessionIdType":"customKey","sessionKey":"=14552"},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[656,-448],"id":"cd475f56-5a38-4ca4-bb55-14047c44a73e","name":"Simple Memory1"},{"parameters":{"method":"POST","url":"= https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-MyrBo2u0n7N/text","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer MyrBo2u0n7N"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=   {\n  \"messageData\": {\n    \"to\": \"5516992975836\",\n    \"text\": \"{{ $json.output.replace(/\\n/g, '\\\\n')  }}\"\n  }\n}\n","options":{}},"id":"6467f7b4-518f-41c7-8e65-8bde501e7638","name":"RequestMenu8","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[944,-672]},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1200,-672],"id":"2298c491-4107-4f01-9510-89538919ebc5","name":"No Operation, do nothing13","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"gpt-4o-mini"},"options":{"temperature":0}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[544,-464],"id":"b1b1886e-5e61-4184-a146-2b14c04d8532","name":"OpenAI Chat Model1","credentials":{"openAiApi":{"id":"2hW4LOItQwhgTw0Q","name":"OpenAi account"}}},{"parameters":{"schema":{"__rl":true,"value":"contab","mode":"name"},"table":{"__rl":true,"value":"modelos","mode":"list","cachedResultName":"modelos"},"columns":{"mappingMode":"defineBelow","value":{"codigo":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('codigo', `modelo_codigo`, 'string') }}","nome":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('nome', `nome`, 'string') }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"codigo","displayName":"codigo","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"nome","displayName":"nome","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"ativo","displayName":"ativo","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{"outputColumns":["id"]}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[752,-464],"id":"42dbe10b-3b85-434c-8931-86f8e0766d74","name":"InsereModelo","credentials":{"postgres":{"id":"SsAL6F2essiJYcMm","name":"PostgreeContabil"}}},{"parameters":{"method":"POST","url":"https://gotenberggotenberg8-production-8d7d.up.railway.app/forms/chromium/convert/html","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"files","inputDataFieldName":"file"}]},"options":{"response":{"response":{"responseFormat":"file","outputPropertyName":"balancete.pdf"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[928,432],"id":"200ea412-472c-475f-b924-637401aaca57","name":"HTTP Request6"},{"parameters":{"method":"POST","url":"=https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-Mp5VTYM2qds/mediaBase64","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer Mp5VTYM2qds"}]},"sendBody":true,"specifyBody":"json","jsonBody":"= {\n  \"messageData\": {\n    \"to\": \"5516992975836\",\n    \"type\": \"document\",\n    \"caption\": \"Segue Balancete\",\n    \"fileName\": \"{{ $node['gerahtml'].json.fileName || 'relatorio.pdf' }}\",\n    \"mimeType\": \"application/pdf\",\n    \"base64\": \"data:application/pdf;base64, {{ $json.base64 }}\"\n  }\n}\n ","options":{}},"id":"52be582b-1bed-4c7c-8ea9-d840d65957e8","name":"MegaApi3","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1344,432]},{"parameters":{"jsCode":" // garante que entrou um item com binário\nconst item = items[0];\nconst bins = item.binary || {};\nconst keys = Object.keys(bins);\nif (!keys.length) {\n  throw new Error('Nenhum binário no input. No HTTP Request (Gotenberg), ative Download=ON e Response=File.');\n}\n\n// escolhe o PDF: por mimeType, por extensão .pdf, ou o primeiro\nconst pdfKey =\n  keys.find(k => (bins[k].mimeType || '').includes('pdf')) ||\n  keys.find(k => k.toLowerCase().endsWith('.pdf')) ||\n  keys[0];\n\nconst pdf = bins[pdfKey];\nif (!pdf) {\n  throw new Error('PDF não encontrado. Binários disponíveis: ' + keys.join(', '));\n}\n\n// nome do arquivo\nconst fileName = item.json.fileName || pdf.fileName || 'relatorio.pdf';\n\n// sai com base64 + fileName para o próximo nó\nreturn [{\n  json: {\n    base64: pdf.data,                 // JÁ é base64\n    fileName: fileName                // ex.: relatorio-2025-08-20.pdf\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1136,432],"id":"926d66d0-46b3-4787-a65f-63c6ec8527e2","name":"Code11"},{"parameters":{"operation":"toText","sourceProperty":"html","binaryPropertyName":"=file","options":{"encoding":"utf8","fileName":"index.html"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[736,432],"id":"9e0a6a90-7ff6-4ea7-bae4-2a1bf735e961","name":"Convert to File2"},{"parameters":{"jsCode":" // pega todos os itens da entrada\nconst rows = items.map(item => item.json);\n\n// monta cabeçalho da tabela\nlet html = `\n<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n<meta charset=\"UTF-8\">\n<title>Balancete</title>\n<style>\n  body { font-family: Arial, sans-serif; margin: 20px; }\n  h2 { text-align: center; }\n  table { border-collapse: collapse; width: 100%; margin-top:20px; }\n  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; font-size: 12px; }\n  th { background-color: #f2f2f2; }\n  tr:nth-child(even) { background-color: #fafafa; }\n</style>\n</head>\n<body>\n  <h2>Balancete</h2>\n  <table>\n    <thead>\n      <tr>\n        <th>Código</th>\n        <th>Nome</th>\n        <th>Tipo</th>\n        <th>Natureza</th>\n        <th>Total Débitos</th>\n        <th>Total Créditos</th>\n        <th>Saldo</th>\n      </tr>\n    </thead>\n    <tbody>\n`;\n\n// preenche as linhas da tabela\nfor (const row of rows) {\n  html += `\n    <tr>\n      <td>${row.codigo}</td>\n      <td>${row.nome}</td>\n      <td>${row.tipo}</td>\n      <td>${row.natureza}</td>\n      <td>${Number(row.total_debitos).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>\n      <td>${Number(row.total_creditos).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>\n      <td>${Number(row.saldo).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>\n    </tr>\n  `;\n}\n\nhtml += `\n    </tbody>\n  </table>\n</body>\n</html>\n`;\n\n// devolve o HTML como campo\nreturn [{ json: { html } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[544,432],"id":"a45dbe12-9b06-47c0-9ac2-33ccbb59769d","name":"gerahtml"},{"parameters":{"method":"POST","url":"https://gotenberggotenberg8-production-8d7d.up.railway.app/forms/chromium/convert/html","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"files","inputDataFieldName":"file"}]},"options":{"response":{"response":{"responseFormat":"file","outputPropertyName":"razao.pdf"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[944,608],"id":"dacfdb52-2ec4-47f1-b8e7-481493e8a5f7","name":"HTTP Request7"},{"parameters":{"jsCode":" // garante que entrou um item com binário\nconst item = items[0];\nconst bins = item.binary || {};\nconst keys = Object.keys(bins);\nif (!keys.length) {\n  throw new Error('Nenhum binário no input. No HTTP Request (Gotenberg), ative Download=ON e Response=File.');\n}\n\n// escolhe o PDF: por mimeType, por extensão .pdf, ou o primeiro\nconst pdfKey =\n  keys.find(k => (bins[k].mimeType || '').includes('pdf')) ||\n  keys.find(k => k.toLowerCase().endsWith('.pdf')) ||\n  keys[0];\n\nconst pdf = bins[pdfKey];\nif (!pdf) {\n  throw new Error('PDF não encontrado. Binários disponíveis: ' + keys.join(', '));\n}\n\n// nome do arquivo\nconst fileName = item.json.fileName || pdf.fileName || 'relatorio.pdf';\n\n// sai com base64 + fileName para o próximo nó\nreturn [{\n  json: {\n    base64: pdf.data,                 // JÁ é base64\n    fileName: fileName                // ex.: relatorio-2025-08-20.pdf\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1136,608],"id":"29dd8059-4b61-419f-a107-f270b64c015b","name":"Code"},{"parameters":{"operation":"toText","sourceProperty":"html","binaryPropertyName":"=file","options":{"encoding":"utf8","fileName":"index.html"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[736,608],"id":"2b788e0b-926f-4681-bcdb-62cb8c445ea9","name":"Convert to File"},{"parameters":{"operation":"executeQuery","query":"select * from contab.vw_razao;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[336,608],"id":"37e927fa-0ded-4e08-a0be-861a1e271470","name":"razao","credentials":{"postgres":{"id":"SsAL6F2essiJYcMm","name":"PostgreeContabil"}}},{"parameters":{"jsCode":" const rows = items.map(item => item.json);\n\nlet html = `\n<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n<meta charset=\"UTF-8\">\n<title>Razão Contábil</title>\n<style>\n  body {\n    font-family: \"Segoe UI\", Arial, sans-serif;\n    margin: 30px;\n    background-color: #f9fafc;\n  }\n  h2 {\n    text-align: center;\n    color: #2c3e50;\n    margin-bottom: 20px;\n  }\n  table {\n    border-collapse: collapse;\n    width: 100%;\n    font-size: 12px;\n    background-color: #fff;\n    box-shadow: 0 0 8px rgba(0,0,0,0.1);\n  }\n  th {\n    background-color: #2980b9;\n    color: white;\n    padding: 8px;\n    text-align: center;\n  }\n  td {\n    border: 1px solid #ddd;\n    padding: 6px;\n    text-align: center;\n  }\n  td.hist {\n    text-align: left;\n  }\n  tr:nth-child(even) {\n    background-color: #f2f6f9;\n  }\n  tr:hover {\n    background-color: #eaf2f8;\n  }\n</style>\n</head>\n<body>\n  <h2>Razão Contábil</h2>\n  <table>\n    <thead>\n      <tr>\n        <th>Data</th>\n        <th>Código Conta</th>\n        <th>Nome Conta</th>\n        <th>Histórico</th>\n        <th>Débito</th>\n        <th>Crédito</th>\n        <th>Diário ID</th>\n        <th>Modelo</th>\n      </tr>\n    </thead>\n    <tbody>\n`;\n\nfor (const r of rows) {\n  html += `\n    <tr>\n      <td>${new Date(r.data_mov).toLocaleDateString('pt-BR')}</td>\n      <td>${r.conta_codigo}</td>\n      <td>${r.conta_nome}</td>\n      <td class=\"hist\">${r.historico}</td>\n      <td>${Number(r.debito).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>\n      <td>${Number(r.credito).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>\n      <td>${r.diario_id}</td>\n      <td>${r.modelo_codigo}</td>\n    </tr>\n  `;\n}\n\nhtml += `\n    </tbody>\n  </table>\n</body>\n</html>\n`;\n\nreturn [{ json: { html } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[528,608],"id":"5280ba50-96a2-4ddc-bf3e-79671818949a","name":"Code1"},{"parameters":{"operation":"executeQuery","query":"select * from contab.vw_balancete;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[336,432],"id":"30fcda63-c44e-4892-bd5a-4ad6ff900177","name":"balancete","credentials":{"postgres":{"id":"SsAL6F2essiJYcMm","name":"PostgreeContabil"}}},{"parameters":{"method":"POST","url":"https://gotenberggotenberg8-production-8d7d.up.railway.app/forms/chromium/convert/html","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"files","inputDataFieldName":"file"}]},"options":{"response":{"response":{"responseFormat":"file","outputPropertyName":"balancetesaldo.pdf"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[928,784],"id":"da4015d3-bb31-474f-8790-b550b4323f49","name":"HTTP Request8"},{"parameters":{"method":"POST","url":"=https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-Mp5VTYM2qds/mediaBase64","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer Mp5VTYM2qds"}]},"sendBody":true,"specifyBody":"json","jsonBody":"= {\n  \"messageData\": {\n    \"to\": \"5516992975836\",\n    \"type\": \"document\",\n    \"caption\": \"Segue Balancete Saldo\",\n    \"fileName\": \"{{ $node['gerahtml1'].json.fileName || 'balancetesaldo.pdf' }}\",\n    \"mimeType\": \"application/pdf\",\n    \"base64\": \"data:application/pdf;base64, {{ $json.base64 }}\"\n  }\n}\n ","options":{}},"id":"e0d3546f-90bd-49da-ab42-c77f690e731f","name":"MegaApi4","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1344,784]},{"parameters":{"jsCode":" // garante que entrou um item com binário\nconst item = items[0];\nconst bins = item.binary || {};\nconst keys = Object.keys(bins);\nif (!keys.length) {\n  throw new Error('Nenhum binário no input. No HTTP Request (Gotenberg), ative Download=ON e Response=File.');\n}\n\n// escolhe o PDF: por mimeType, por extensão .pdf, ou o primeiro\nconst pdfKey =\n  keys.find(k => (bins[k].mimeType || '').includes('pdf')) ||\n  keys.find(k => k.toLowerCase().endsWith('.pdf')) ||\n  keys[0];\n\nconst pdf = bins[pdfKey];\nif (!pdf) {\n  throw new Error('PDF não encontrado. Binários disponíveis: ' + keys.join(', '));\n}\n\n// nome do arquivo\nconst fileName = item.json.fileName || pdf.fileName || 'relatorio.pdf';\n\n// sai com base64 + fileName para o próximo nó\nreturn [{\n  json: {\n    base64: pdf.data,                 // JÁ é base64\n    fileName: fileName                // ex.: relatorio-2025-08-20.pdf\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1136,784],"id":"08de972c-91f3-4146-b23e-d88057e4f057","name":"Code12"},{"parameters":{"operation":"toText","sourceProperty":"html","binaryPropertyName":"=file","options":{"encoding":"utf8","fileName":"index.html"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[736,784],"id":"033231fb-dd80-4e9c-92b1-addd8cfb6915","name":"Convert to File3"},{"parameters":{"jsCode":" // === Code node (Run Once for All Items) ===\n// Entrada: items -> [{ conta_codigo, conta_nome, saldo_mes_anterior, saldo_mes_atual, diferenca }, ...]\n// Saída: { html } -> para Convert to File / Gotenberg\n\nconst rows = items.map(i => i.json);\n\n// ordena por código de conta (humano)\nrows.sort((a, b) => String(a.conta_codigo).localeCompare(String(b.conta_codigo), 'pt-BR', { numeric: true }));\n\nconst fmt   = (n) => Number(n || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });\nconst sum   = (key) => rows.reduce((acc, r) => acc + (Number(r[key]) || 0), 0);\nconst cellN = (n) => `<td class=\"num ${Number(n) < 0 ? 'neg' : ''}\">${fmt(n)}</td>`;\n\n// totais\nconst totalAnt  = sum('saldo_mes_anterior');\nconst totalMes  = sum('saldo_mes_atual');\n// se a consulta já traz \"diferenca\" por linha, somamos; senão, calculamos por (mes - anterior)\nconst totalDiff = rows.some(r => r.hasOwnProperty('diferenca')) ? sum('diferenca') : (totalMes - totalAnt);\n\n// metadata\nconst geradoEm = new Date().toLocaleString('pt-BR');\nconst titulo   = 'Balancete de Saldos';\nconst subtitulo= `Gerado em ${geradoEm}`;\n\nlet html = `<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n<meta charset=\"UTF-8\">\n<title>${titulo}</title>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n<style>\n  :root{\n    --primary:#1e88e5;\n    --zebra:#f5f9ff;\n    --border:#e5e9f2;\n    --text:#2c3e50;\n    --muted:#6b7a90;\n    --total-bg:#eef3fb;\n    --neg:#c0392b;\n  }\n  @page { margin: 20mm 12mm; }\n  * { box-sizing: border-box; }\n  body{\n    font-family: \"Segoe UI\", Arial, sans-serif;\n    color: var(--text);\n    margin: 0;\n    padding: 24px;\n    background: #fff;\n  }\n  header{\n    text-align:center;\n    margin-bottom: 14px;\n  }\n  h1{\n    margin: 0 0 4px 0;\n    font-size: 20px;\n    font-weight: 700;\n    letter-spacing: .3px;\n  }\n  .sub{\n    color: var(--muted);\n    font-size: 12px;\n  }\n  table{\n    width:100%;\n    border-collapse: collapse;\n    font-size: 12px;\n    margin-top: 8px;\n  }\n  thead th{\n    background: var(--primary);\n    color: #fff;\n    padding: 8px 10px;\n    text-align: left;\n    border: 1px solid var(--primary);\n    white-space: nowrap;\n  }\n  tbody td{\n    border: 1px solid var(--border);\n    padding: 7px 10px;\n    vertical-align: top;\n  }\n  tbody tr:nth-child(even){ background: var(--zebra); }\n  td.cod   { width: 90px; font-variant-numeric: tabular-nums; }\n  td.nome  { width: auto; }\n  .num{\n    text-align: right;\n    font-variant-numeric: tabular-nums;\n    white-space: nowrap;\n  }\n  .neg{ color: var(--neg); font-weight: 600; }\n  tfoot td{\n    border: 1px solid var(--border);\n    background: var(--total-bg);\n    font-weight: 700;\n    padding: 8px 10px;\n  }\n  .tot-label{ text-align:right; }\n</style>\n</head>\n<body>\n  <header>\n    <h1>${titulo}</h1>\n    <div class=\"sub\">${subtitulo}</div>\n  </header>\n\n  <table>\n    <thead>\n      <tr>\n        <th>Código</th>\n        <th>Conta</th>\n        <th>Saldo mês anterior</th>\n        <th>Saldo do mês</th>\n        <th>Diferença</th>\n      </tr>\n    </thead>\n    <tbody>\n`;\n\nfor (const r of rows) {\n  html += `\n      <tr>\n        <td class=\"cod\">${r.conta_codigo ?? ''}</td>\n        <td class=\"nome\">${r.conta_nome ?? ''}</td>\n        ${cellN(r.saldo_mes_anterior)}\n        ${cellN(r.saldo_mes_atual)}\n        ${cellN(r.diferenca ?? (Number(r.saldo_mes_atual||0) - Number(r.saldo_mes_anterior||0)))}\n      </tr>\n  `;\n}\n\nhtml += `\n    </tbody>\n    <tfoot>\n      <tr>\n        <td colspan=\"2\" class=\"tot-label\">Totais</td>\n        ${cellN(totalAnt)}\n        ${cellN(totalMes)}\n        ${cellN(totalDiff)}\n      </tr>\n    </tfoot>\n  </table>\n</body>\n</html>`;\n\nreturn [{ json: { html } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[528,784],"id":"d3ff21c3-b095-49ce-bff3-a97a3c902096","name":"gerahtml1"},{"parameters":{"method":"POST","url":"=https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-Mp5VTYM2qds/mediaBase64","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer Mp5VTYM2qds"}]},"sendBody":true,"specifyBody":"json","jsonBody":"= {\n  \"messageData\": {\n    \"to\": \"5516992975836\",\n    \"type\": \"document\",\n    \"caption\": \"Segue Relatório Razão\",\n    \"fileName\": \"{{ $node['gerahtmlrazao'].json.fileName || 'razao.pdf' }}\",\n    \"mimeType\": \"application/pdf\",\n    \"base64\": \"data:application/pdf;base64, {{ $json.base64 }}\"\n  }\n}\n ","options":{}},"id":"88786124-eb1c-4492-9e64-1f8bbeed1d12","name":"MegaApi","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1344,608]},{"parameters":{"operation":"executeQuery","query":"select * from contab.vw_balancete_saldos;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[352,784],"id":"5b50a0ca-f3ee-4243-aeae-a8bbbe96409d","name":"balancetesaldo","credentials":{"postgres":{"id":"SsAL6F2essiJYcMm","name":"PostgreeContabil"}}},{"parameters":{"method":"POST","url":"https://gotenberggotenberg8-production-8d7d.up.railway.app/forms/chromium/convert/html","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"files","inputDataFieldName":"file"}]},"options":{"response":{"response":{"responseFormat":"file","outputPropertyName":"patrimonial.pdf"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[928,976],"id":"fd865bd1-aa62-41a4-8f2d-b5d11ce94eae","name":"HTTP Request9"},{"parameters":{"method":"POST","url":"=https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-Mp5VTYM2qds/mediaBase64","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer Mp5VTYM2qds"}]},"sendBody":true,"specifyBody":"json","jsonBody":"= {\n  \"messageData\": {\n    \"to\": \"5516992975836\",\n    \"type\": \"document\",\n    \"caption\": \"Segue Balanço Patrimonial\",\n    \"fileName\": \"{{ $node['gerahtml2'].json.fileName || 'patrimonial.pdf' }}\",\n    \"mimeType\": \"application/pdf\",\n    \"base64\": \"data:application/pdf;base64, {{ $json.base64 }}\"\n  }\n}\n ","options":{}},"id":"5a9a7e48-3baa-41de-b9f3-e3e73e1313a0","name":"MegaApi5","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1344,976]},{"parameters":{"jsCode":" // garante que entrou um item com binário\nconst item = items[0];\nconst bins = item.binary || {};\nconst keys = Object.keys(bins);\nif (!keys.length) {\n  throw new Error('Nenhum binário no input. No HTTP Request (Gotenberg), ative Download=ON e Response=File.');\n}\n\n// escolhe o PDF: por mimeType, por extensão .pdf, ou o primeiro\nconst pdfKey =\n  keys.find(k => (bins[k].mimeType || '').includes('pdf')) ||\n  keys.find(k => k.toLowerCase().endsWith('.pdf')) ||\n  keys[0];\n\nconst pdf = bins[pdfKey];\nif (!pdf) {\n  throw new Error('PDF não encontrado. Binários disponíveis: ' + keys.join(', '));\n}\n\n// nome do arquivo\nconst fileName = item.json.fileName || pdf.fileName || 'relatorio.pdf';\n\n// sai com base64 + fileName para o próximo nó\nreturn [{\n  json: {\n    base64: pdf.data,                 // JÁ é base64\n    fileName: fileName                // ex.: relatorio-2025-08-20.pdf\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1136,976],"id":"4755a31a-db85-450d-99a9-e7d85372316e","name":"Code13"},{"parameters":{"operation":"toText","sourceProperty":"html","binaryPropertyName":"=file","options":{"encoding":"utf8","fileName":"index.html"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[736,976],"id":"4495f919-df07-4348-96f5-ddbdec584e16","name":"Convert to File4"},{"parameters":{"jsCode":" // Entrada: items -> [{ ordem, descricao, saldo_inicial, saldo_final, diferenca }, ...]\n// Saída: { html }\n\nconst rows = items.map(i => i.json);\nrows.sort((a, b) => Number(a.ordem) - Number(b.ordem));\n\nconst fmt = (n) => Number(Math.abs(n || 0)).toLocaleString('pt-BR', {\n  minimumFractionDigits: 2,\n  maximumFractionDigits: 2\n});\n\n// Define natureza (D ou C)\nfunction natureza(desc, valor) {\n  const d = String(desc || '').toUpperCase();\n  const v = Number(valor) || 0;\n  if (d.startsWith('ATIVO')) return v >= 0 ? 'D' : 'C';\n  if (d.startsWith('PASSIVO') || d.includes('PATRIMÔNIO')) return v >= 0 ? 'C' : 'D';\n  return v >= 0 ? 'D' : 'C';\n}\n\nconst isSection = (desc) => {\n  const d = String(desc || '').toUpperCase();\n  return d === 'ATIVO' || d === 'PASSIVO E PL' || d.includes('PATRIMÔNIO');\n};\n\n// Totais (seções)\nlet ativoIni=0, ativoFim=0, ativoDif=0, passIni=0, passFim=0, passDif=0;\nfor (const r of rows) {\n  const d = String(r.descricao || '').toUpperCase();\n  if (d === 'ATIVO') {\n    ativoIni += Number(r.saldo_inicial) || 0;\n    ativoFim += Number(r.saldo_final)   || 0;\n    ativoDif += Number(r.diferenca)     || 0;\n  } else if (d === 'PASSIVO E PL' || d.includes('PATRIMÔNIO')) {\n    passIni += Number(r.saldo_inicial) || 0;\n    passFim += Number(r.saldo_final)   || 0;\n    passDif += Number(r.diferenca)     || 0;\n  }\n}\nconst chkIni = ativoIni - passIni;\nconst chkFim = ativoFim - passFim;\nconst chkDif = ativoDif - passDif;\n\nconst geradoEm = new Date().toLocaleString('pt-BR');\n\nlet html = `<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n<meta charset=\"UTF-8\">\n<title>Balanço Patrimonial</title>\n<style>\n  :root{ --primary:#1e88e5; --zebra:#f5f9ff; --border:#e5e9f2; --section:#f0f5ff; --total:#eef3fb; }\n  body{ font-family:\"Segoe UI\", Arial, sans-serif; padding:24px; }\n  header{ text-align:center; margin-bottom:14px; }\n  h1{ margin:0; font-size:20px; }\n  .sub{ color:#6b7a90; font-size:12px; }\n  table{ width:100%; border-collapse:collapse; font-size:12px; }\n  thead th{ background:var(--primary); color:#fff; padding:8px; }\n  td, th{ border:1px solid var(--border); padding:6px 10px; }\n  tbody tr:nth-child(even){ background:var(--zebra); }\n  .sec{ background:var(--section); font-weight:700; }\n  .num{ text-align:right; }\n  .tot{ background:var(--total); font-weight:700; }\n  .center{ text-align:center; }\n</style>\n</head>\n<body>\n<header>\n  <h1>Balanço Patrimonial</h1>\n  <div class=\"sub\">Gerado em ${geradoEm}</div>\n</header>\n<table>\n  <thead>\n    <tr>\n      <th>Descrição</th>\n      <th>Saldo inicial</th><th></th>\n      <th>Saldo final</th><th></th>\n      <th>Diferença</th><th></th>\n    </tr>\n  </thead>\n  <tbody>`;\n\nfor (const r of rows) {\n  const ini = Number(r.saldo_inicial) || 0;\n  const fim = Number(r.saldo_final)   || 0;\n  const dif = Number(r.diferenca)     || 0;\n  html += `\n    <tr class=\"${isSection(r.descricao)?'sec':''}\">\n      <td>${r.descricao}</td>\n      <td class=\"num\">${fmt(ini)}</td><td class=\"center\">${natureza(r.descricao, ini)}</td>\n      <td class=\"num\">${fmt(fim)}</td><td class=\"center\">${natureza(r.descricao, fim)}</td>\n      <td class=\"num\">${fmt(dif)}</td><td class=\"center\">${natureza(r.descricao, dif)}</td>\n    </tr>`;\n}\n\nhtml += `\n  </tbody>\n  <tfoot>\n    <tr class=\"tot\">\n      <td>Ativo (totais)</td>\n      <td class=\"num\">${fmt(ativoIni)}</td><td class=\"center\">${natureza('ATIVO', ativoIni)}</td>\n      <td class=\"num\">${fmt(ativoFim)}</td><td class=\"center\">${natureza('ATIVO', ativoFim)}</td>\n      <td class=\"num\">${fmt(ativoDif)}</td><td class=\"center\">${natureza('ATIVO', ativoDif)}</td>\n    </tr>\n    <tr class=\"tot\">\n      <td>Passivo + PL (totais)</td>\n      <td class=\"num\">${fmt(passIni)}</td><td class=\"center\">${natureza('PASSIVO E PL', passIni)}</td>\n      <td class=\"num\">${fmt(passFim)}</td><td class=\"center\">${natureza('PASSIVO E PL', passFim)}</td>\n      <td class=\"num\">${fmt(passDif)}</td><td class=\"center\">${natureza('PASSIVO E PL', passDif)}</td>\n    </tr>\n    <tr class=\"tot\">\n      <td>Checagem (Ativo − Passivo/PL)</td>\n      <td class=\"num\">${fmt(chkIni)}</td><td class=\"center\">${natureza('ATIVO', chkIni)}</td>\n      <td class=\"num\">${fmt(chkFim)}</td><td class=\"center\">${natureza('ATIVO', chkFim)}</td>\n      <td class=\"num\">${fmt(chkDif)}</td><td class=\"center\">${natureza('ATIVO', chkDif)}</td>\n    </tr>\n  </tfoot>\n</table>\n</body>\n</html>`;\n\nreturn [{ json: { html } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[528,976],"id":"4c8c0a8c-0d7a-460b-979c-7e8b8afa949c","name":"gerahtml2"},{"parameters":{"operation":"executeQuery","query":" select * from contab.vw_balanco_patrimonial;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[352,976],"id":"a9ecb078-8c35-43ce-a339-68b316c553c3","name":"BalancoPatrimonial","credentials":{"postgres":{"id":"SsAL6F2essiJYcMm","name":"PostgreeContabil"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1600,976],"id":"39e3af2a-da68-495f-893a-a6314a9a5b6d","name":"No Operation, do nothing14","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1584,432],"id":"2d1e208a-3427-4bfe-acad-cef994703868","name":"No Operation, do nothing15","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1600,608],"id":"c7373264-a9f9-4925-af9a-ae945a9326d3","name":"No Operation, do nothing16","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1600,784],"id":"0c0a9189-f2c0-42a9-a3f0-0f2a7f80bcbf","name":"No Operation, do nothing17","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"executeQuery","query":" select * from contab.vw_dre_ytd  ;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[336,1168],"id":"6b5b66ca-fc67-4472-8de3-324dfc2849a5","name":"BalancoPatrimonial1","credentials":{"postgres":{"id":"SsAL6F2essiJYcMm","name":"PostgreeContabil"}}},{"parameters":{"method":"POST","url":"https://gotenberggotenberg8-production-8d7d.up.railway.app/forms/chromium/convert/html","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"files","inputDataFieldName":"file"}]},"options":{"response":{"response":{"responseFormat":"file","outputPropertyName":"der.pdf"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[928,1168],"id":"91194215-d9f2-4d15-990b-062cb08cc809","name":"HTTP Request10"},{"parameters":{"method":"POST","url":"=https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-Mp5VTYM2qds/mediaBase64","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer Mp5VTYM2qds"}]},"sendBody":true,"specifyBody":"json","jsonBody":"= {\n  \"messageData\": {\n    \"to\": \"5516992975836\",\n    \"type\": \"document\",\n    \"caption\": \"Segue DER\",\n    \"fileName\": \"{{ $node['gerahtml3'].json.fileName || 'der.pdf' }}\",\n    \"mimeType\": \"application/pdf\",\n    \"base64\": \"data:application/pdf;base64, {{ $json.base64 }}\"\n  }\n}\n ","options":{}},"id":"77486fe4-1be8-47ec-a843-46058d0c6943","name":"MegaApi6","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1344,1168]},{"parameters":{"jsCode":" // garante que entrou um item com binário\nconst item = items[0];\nconst bins = item.binary || {};\nconst keys = Object.keys(bins);\nif (!keys.length) {\n  throw new Error('Nenhum binário no input. No HTTP Request (Gotenberg), ative Download=ON e Response=File.');\n}\n\n// escolhe o PDF: por mimeType, por extensão .pdf, ou o primeiro\nconst pdfKey =\n  keys.find(k => (bins[k].mimeType || '').includes('pdf')) ||\n  keys.find(k => k.toLowerCase().endsWith('.pdf')) ||\n  keys[0];\n\nconst pdf = bins[pdfKey];\nif (!pdf) {\n  throw new Error('PDF não encontrado. Binários disponíveis: ' + keys.join(', '));\n}\n\n// nome do arquivo\nconst fileName = item.json.fileName || pdf.fileName || 'relatorio.pdf';\n\n// sai com base64 + fileName para o próximo nó\nreturn [{\n  json: {\n    base64: pdf.data,                 // JÁ é base64\n    fileName: fileName                // ex.: relatorio-2025-08-20.pdf\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1136,1168],"id":"632e0dc1-f549-4fe5-b2ce-4cc9c3f930dc","name":"Code14"},{"parameters":{"operation":"toText","sourceProperty":"html","binaryPropertyName":"=file","options":{"encoding":"utf8","fileName":"index.html"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[736,1168],"id":"fbbfa773-7589-4feb-9948-49b6d2793e30","name":"Convert to File5"},{"parameters":{"jsCode":" // === Code node (Run Once for All Items) ===\n// Entrada: items -> [{ ordem, grupo, valor_mes, valor_acumulado }, ...]\n// Saída: { html } -> para Convert to File (ou Gotenberg)\n\nconst rows = items.map(i => i.json);\nrows.sort((a, b) => Number(a.ordem) - Number(b.ordem));\n\nconst fmt = (n) => Number(n || 0).toLocaleString('pt-BR', {\n  minimumFractionDigits: 2,\n  maximumFractionDigits: 2\n});\n\n// Identifica linhas de \"resultado\" para destacar\nconst isResultado = (grupo) => {\n  const g = String(grupo || '').toUpperCase();\n  return g.includes('RESULTADO') || g.includes('LUCRO') || g.includes('PREJU');\n};\n\nconst geradoEm = new Date().toLocaleString('pt-BR');\nconst titulo = 'Demonstração do Resultado do Exercício (DRE)';\nconst subtitulo = `Gerado em ${geradoEm}`;\n\nlet html = `<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n<meta charset=\"UTF-8\">\n<title>${titulo}</title>\n<style>\n  :root{\n    --primary:#1e88e5; --zebra:#f5f9ff; --border:#e5e9f2;\n    --text:#2c3e50; --muted:#6b7a90; --total:#eef3fb;\n  }\n  body{ font-family:\"Segoe UI\", Arial, sans-serif; margin:0; padding:24px; color:var(--text);}\n  header{text-align:center; margin-bottom:16px;}\n  h1{ margin:0; font-size:20px; }\n  .sub{ color:var(--muted); font-size:12px; }\n  table{ width:100%; border-collapse:collapse; font-size:13px; }\n  thead th{ background:var(--primary); color:#fff; padding:8px; text-align:left; }\n  td, th{ border:1px solid var(--border); padding:6px 10px; }\n  tbody tr:nth-child(even){ background:var(--zebra); }\n  .num{ text-align:right; font-variant-numeric:tabular-nums; white-space:nowrap; }\n  .resultado{ background:var(--total); font-weight:700; }\n</style>\n</head>\n<body>\n<header>\n  <h1>${titulo}</h1>\n  <div class=\"sub\">${subtitulo}</div>\n</header>\n\n<table>\n  <thead>\n    <tr>\n      <th>Grupo</th>\n      <th>Valor do mês</th>\n      <th>Acumulado no ano</th>\n    </tr>\n  </thead>\n  <tbody>\n`;\n\nfor (const r of rows) {\n  const linhaClasse = isResultado(r.grupo) ? 'resultado' : '';\n  html += `\n    <tr class=\"${linhaClasse}\">\n      <td>${r.grupo}</td>\n      <td class=\"num\">${fmt(r.valor_mes)}</td>\n      <td class=\"num\">${fmt(r.valor_acumulado)}</td>\n    </tr>`;\n}\n\nhtml += `\n  </tbody>\n</table>\n</body>\n</html>`;\n\nreturn [{ json: { html } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[528,1168],"id":"d18571ff-294e-452f-90e8-be1939650045","name":"gerahtml3"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1600,1168],"id":"6cabf191-182e-4e63-8c0f-2bf47827013f","name":"No Operation, do nothing18","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"executeQuery","query":" select * from contab.modelos ;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[288,1360],"id":"4d016668-0ea3-4268-acdd-e72f57a1048f","name":"BalancoPatrimonial2","credentials":{"postgres":{"id":"SsAL6F2essiJYcMm","name":"PostgreeContabil"}}},{"parameters":{"method":"POST","url":"https://gotenberggotenberg8-production-8d7d.up.railway.app/forms/chromium/convert/html","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"files","inputDataFieldName":"file"}]},"options":{"response":{"response":{"responseFormat":"file","outputPropertyName":"modelos.pdf"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[928,1360],"id":"0ea73526-77fd-46fe-9fe0-afc7203ef56e","name":"HTTP Request11"},{"parameters":{"jsCode":" // garante que entrou um item com binário\nconst item = items[0];\nconst bins = item.binary || {};\nconst keys = Object.keys(bins);\nif (!keys.length) {\n  throw new Error('Nenhum binário no input. No HTTP Request (Gotenberg), ative Download=ON e Response=File.');\n}\n\n// escolhe o PDF: por mimeType, por extensão .pdf, ou o primeiro\nconst pdfKey =\n  keys.find(k => (bins[k].mimeType || '').includes('pdf')) ||\n  keys.find(k => k.toLowerCase().endsWith('.pdf')) ||\n  keys[0];\n\nconst pdf = bins[pdfKey];\nif (!pdf) {\n  throw new Error('PDF não encontrado. Binários disponíveis: ' + keys.join(', '));\n}\n\n// nome do arquivo\nconst fileName = item.json.fileName || pdf.fileName || 'relatorio.pdf';\n\n// sai com base64 + fileName para o próximo nó\nreturn [{\n  json: {\n    base64: pdf.data,                 // JÁ é base64\n    fileName: fileName                // ex.: relatorio-2025-08-20.pdf\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1120,1360],"id":"df549c73-cd1c-4579-8eb1-a3238d312c18","name":"Code15"},{"parameters":{"operation":"toText","sourceProperty":"html","binaryPropertyName":"=file","options":{"encoding":"utf8","fileName":"index.html"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[736,1360],"id":"c22050d0-b138-45b2-b6dd-2c2f8d99cd59","name":"Convert to File6"},{"parameters":{"jsCode":" // === Code node (Run Once for All Items) ===\n// Entrada: items -> [{ codigo, nome, ativo }, ...]\n// Saída: { html } -> passe para Convert to File / Gotenberg\n\nconst rows = items.map(i => i.json);\n\n// ordena por nome (ou por código, se preferir)\nrows.sort((a, b) => String(a.nome||'').localeCompare(String(b.nome||''), 'pt-BR'));\n\nconst geradoEm = new Date().toLocaleString('pt-BR');\nconst titulo    = 'Modelos Contábeis';\nconst subtitulo = `Gerado em ${geradoEm}`;\n\nconst total       = rows.length;\nconst ativos      = rows.filter(r => String(r.ativo) === 'true' || r.ativo === true).length;\nconst inativos    = total - ativos;\n\nconst badge = (flag) =>\n  `<span class=\"badge ${flag ? 'ok' : 'off'}\">${flag ? 'Ativo' : 'Inativo'}</span>`;\n\nlet html = `<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n<meta charset=\"UTF-8\">\n<title>${titulo}</title>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n<style>\n  :root{\n    --primary:#1e88e5; --zebra:#f7fbff; --border:#e6edf4; --text:#2c3e50; --muted:#6b7a90;\n    --ok:#0f9d58; --off:#c0392b; --chip:#eef3fb;\n  }\n  @page { margin: 18mm 12mm; }\n  *{ box-sizing:border-box; }\n  body{ font-family:\"Segoe UI\",Arial,sans-serif; color:var(--text); margin:0; padding:24px; }\n  header{ text-align:center; margin-bottom:16px; }\n  h1{ margin:0 0 4px 0; font-size:20px; font-weight:700; }\n  .sub{ color:var(--muted); font-size:12px; }\n  .chips{ display:flex; gap:8px; justify-content:center; margin-top:6px; }\n  .chip{ background:var(--chip); border:1px solid var(--border); border-radius:999px; padding:4px 10px; font-size:12px; }\n  table{ width:100%; border-collapse:collapse; font-size:13px; margin-top:14px; }\n  thead th{\n    background:var(--primary); color:#fff; padding:9px 10px; text-align:left; border:1px solid var(--primary);\n  }\n  tbody td{ border:1px solid var(--border); padding:8px 10px; vertical-align:top; }\n  tbody tr:nth-child(even){ background:var(--zebra); }\n  .codigo{ width:160px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, \"Liberation Mono\", monospace; }\n  .nome{ width:auto; }\n  .status{ width:120px; text-align:center; }\n  .badge{\n    display:inline-block; min-width:64px; text-align:center;\n    padding:3px 8px; border-radius:999px; font-size:12px; font-weight:600;\n    border:1px solid;\n  }\n  .badge.ok{ color:var(--ok); border-color:var(--ok); background:#e9f7f0; }\n  .badge.off{ color:var(--off); border-color:var(--off); background:#fdecea; }\n</style>\n</head>\n<body>\n<header>\n  <h1>${titulo}</h1>\n  <div class=\"sub\">${subtitulo}</div>\n  <div class=\"chips\">\n    <div class=\"chip\">Total: <strong>${total}</strong></div>\n    <div class=\"chip\">Ativos: <strong>${ativos}</strong></div>\n    <div class=\"chip\">Inativos: <strong>${inativos}</strong></div>\n  </div>\n</header>\n\n<table>\n  <thead>\n    <tr>\n      <th>Código</th>\n      <th>Nome</th>\n      <th>Status</th>\n    </tr>\n  </thead>\n  <tbody>\n`;\n\nfor (const r of rows) {\n  const ativo = (String(r.ativo) === 'true' || r.ativo === true);\n  html += `\n    <tr>\n      <td class=\"codigo\">${r.codigo ?? ''}</td>\n      <td class=\"nome\">${r.nome ?? ''}</td>\n      <td class=\"status\">${badge(ativo)}</td>\n    </tr>`;\n}\n\nhtml += `\n  </tbody>\n</table>\n</body>\n</html>`;\n\nreturn [{ json: { html } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[528,1360],"id":"ba5f8259-3ae3-45fc-bf01-9d5231e81f48","name":"gerahtml4"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1600,1360],"id":"f9445e17-b53e-4a4b-b5d1-2c06e5c6ea2f","name":"No Operation, do nothing19","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"method":"POST","url":"=https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-Mp5VTYM2qds/mediaBase64","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer Mp5VTYM2qds"}]},"sendBody":true,"specifyBody":"json","jsonBody":"= {\n  \"messageData\": {\n    \"to\": \"5516992975836\",\n    \"type\": \"document\",\n    \"caption\": \"Segue relatório de modelos\",\n    \"fileName\": \"{{ $node['gerahtml4'].json.fileName || 'modelos.pdf' }}\",\n    \"mimeType\": \"application/pdf\",\n    \"base64\": \"data:application/pdf;base64, {{ $json.base64 }}\"\n  }\n}\n ","options":{}},"id":"fa05f9f9-405f-421a-8a1c-1968cda89eba","name":"MegaApi7","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1360,1360]},{"parameters":{"operation":"executeQuery","query":"  SELECT\n  mo.codigo  AS modelo,\n  ml.ordem,\n  co.codigo  AS conta,\n  ml.dc, \n \n  ml.obrigatorio\nFROM contab.modelos_linhas ml\nJOIN contab.modelos mo ON mo.id = ml.modelo_id\nJOIN contab.contas  co ON co.id = ml.conta_id\nORDER BY mo.codigo, ml.ordem;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[288,1552],"id":"f5cab8a8-b028-4925-b6c5-8a63f6aa0ea3","name":"BalancoPatrimonial3","credentials":{"postgres":{"id":"SsAL6F2essiJYcMm","name":"PostgreeContabil"}}},{"parameters":{"method":"POST","url":"https://gotenberggotenberg8-production-8d7d.up.railway.app/forms/chromium/convert/html","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"files","inputDataFieldName":"file"}]},"options":{"response":{"response":{"responseFormat":"file","outputPropertyName":"modelos.pdf"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[928,1552],"id":"1755f6e5-a3dc-4307-a77b-d48e8f8e5b9e","name":"HTTP Request12"},{"parameters":{"jsCode":" // garante que entrou um item com binário\nconst item = items[0];\nconst bins = item.binary || {};\nconst keys = Object.keys(bins);\nif (!keys.length) {\n  throw new Error('Nenhum binário no input. No HTTP Request (Gotenberg), ative Download=ON e Response=File.');\n}\n\n// escolhe o PDF: por mimeType, por extensão .pdf, ou o primeiro\nconst pdfKey =\n  keys.find(k => (bins[k].mimeType || '').includes('pdf')) ||\n  keys.find(k => k.toLowerCase().endsWith('.pdf')) ||\n  keys[0];\n\nconst pdf = bins[pdfKey];\nif (!pdf) {\n  throw new Error('PDF não encontrado. Binários disponíveis: ' + keys.join(', '));\n}\n\n// nome do arquivo\nconst fileName = item.json.fileName || pdf.fileName || 'relatorio.pdf';\n\n// sai com base64 + fileName para o próximo nó\nreturn [{\n  json: {\n    base64: pdf.data,                 // JÁ é base64\n    fileName: fileName                // ex.: relatorio-2025-08-20.pdf\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1120,1552],"id":"887cc4a5-df22-4b38-b509-47e334029282","name":"Code16"},{"parameters":{"operation":"toText","sourceProperty":"html","binaryPropertyName":"=file","options":{"encoding":"utf8","fileName":"index.html"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[736,1552],"id":"f77e2d1e-befb-4736-82f0-c6b892bead10","name":"Convert to File7"},{"parameters":{"jsCode":" // === Code node (Run Once for All Items) ===\n// Entrada: items -> [{ modelo, ordem, conta, dc, fonte_valor, valor_fixo, fator, obrigatorio }, ...]\n// Saída: { html }  -> passe para Convert to File / Gotenberg\n\nconst rows = items.map(i => i.json);\n\n// ordena: modelo A..Z e ordem crescente\nrows.sort((a,b)=>{\n  const m = String(a.modelo||'').localeCompare(String(b.modelo||''), 'pt-BR');\n  if (m !== 0) return m;\n  return Number(a.ordem||0) - Number(b.ordem||0);\n});\n\n// agrupa por modelo\nconst grupos = new Map();\nfor (const r of rows) {\n  const key = r.modelo ?? '(sem modelo)';\n  if (!grupos.has(key)) grupos.set(key, []);\n  grupos.get(key).push(r);\n}\n\nconst fmt2 = (n) => {\n  if (n === null || n === undefined || n === '') return '';\n  const v = Number(n);\n  if (Number.isNaN(v)) return String(n);\n  return v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 6 });\n};\nconst yesno = (b) => (String(b)==='true' || b===true) ? 'Obrigatório' : 'Opcional';\n\nconst badgeDC = (dc) => {\n  const d = String(dc||'').toUpperCase().trim();\n  if (d === 'D') return `<span class=\"badge deb\">D&eacute;bito</span>`;\n  if (d === 'C') return `<span class=\"badge cred\">Cr&eacute;dito</span>`;\n  return `<span class=\"badge mute\">${dc ?? '-'}</span>`;\n};\nconst badgeObr = (flag) => {\n  const on = (String(flag)==='true' || flag===true);\n  return `<span class=\"badge ${on?'ok':'off'}\">${on?'Obrigatório':'Opcional'}</span>`;\n};\n\nconst geradoEm = new Date().toLocaleString('pt-BR');\nconst titulo = 'Modelos → Linhas (Plano de Contas)';\n\nlet html = `<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n<meta charset=\"UTF-8\">\n<title>${titulo}</title>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n<style>\n  :root{\n    --primary:#1e88e5; --zebra:#f7fbff; --border:#e6edf4; --text:#2c3e50; --muted:#6b7a90;\n    --ok:#0f9d58; --off:#c0392b; --deb:#1565c0; --cred:#8e24aa; --chip:#eef3fb;\n  }\n  @page { margin: 18mm 12mm; }\n  *{ box-sizing:border-box; }\n  body{ font-family:\"Segoe UI\",Arial,sans-serif; color:var(--text); margin:0; padding:24px; }\n  header{ text-align:center; margin-bottom:12px; }\n  h1{ margin:0 0 4px 0; font-size:20px; font-weight:800; letter-spacing:.2px; }\n  .sub{ color:var(--muted); font-size:12px; }\n  .chips{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:6px; }\n  .chip{ background:var(--chip); border:1px solid var(--border); border-radius:999px; padding:4px 10px; font-size:12px; }\n  .toc{ display:flex; gap:8px; flex-wrap:wrap; margin:14px 0 0; justify-content:center; }\n  .toc a{ text-decoration:none; color:var(--primary); border:1px solid var(--border); padding:4px 10px; border-radius:999px; font-size:12px; }\n  section{ margin-top:18px; page-break-inside:avoid; }\n  h2{ font-size:15px; margin:0 0 6px 0; display:flex; align-items:center; gap:8px; }\n  .tag{ font-size:11px; color:#fff; background:var(--primary); padding:2px 8px; border-radius:999px; }\n  table{ width:100%; border-collapse:collapse; font-size:12.5px; margin-top:8px; }\n  thead th{ background:var(--primary); color:#fff; padding:8px 10px; text-align:left; border:1px solid var(--primary); }\n  tbody td{ border:1px solid var(--border); padding:7px 10px; vertical-align:top; }\n  tbody tr:nth-child(even){ background:var(--zebra); }\n  .num{ text-align:right; font-variant-numeric:tabular-nums; white-space:nowrap; }\n  .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, \"Liberation Mono\", monospace; }\n  .badge{\n    display:inline-block; min-width:80px; text-align:center;\n    padding:3px 8px; border-radius:999px; font-size:11.5px; font-weight:700; border:1px solid;\n  }\n  .badge.deb{ color:var(--deb);  border-color:var(--deb);  background:#e8f1ff; }\n  .badge.cred{ color:var(--cred); border-color:var(--cred); background:#f3e8f8; }\n  .badge.ok{ color:var(--ok); border-color:var(--ok); background:#e9f7f0; }\n  .badge.off{ color:var(--off); border-color:var(--off); background:#fdecea; }\n  .badge.mute{ color:var(--muted); border-color:var(--border); background:#fafbfc; }\n  footer{ margin-top:16px; color:var(--muted); font-size:11px; text-align:center; }\n</style>\n</head>\n<body>\n<header>\n  <h1>${titulo}</h1>\n  <div class=\"sub\">Gerado em ${geradoEm}</div>\n  <div class=\"chips\">\n    <div class=\"chip\">Modelos: <strong>${grupos.size}</strong></div>\n    <div class=\"chip\">Linhas totais: <strong>${rows.length}</strong></div>\n  </div>\n  <div class=\"toc\">\n    ${[...grupos.keys()].map((m,i)=>`<a href=\"#m${i}\">${m}</a>`).join('')}\n  </div>\n</header>\n`;\n\n// seções por modelo\nlet idx = 0;\nfor (const [modelo, linhas] of grupos.entries()) {\n  html += `\n  <section id=\"m${idx++}\">\n    <h2><span class=\"tag\">${linhas.length} linha${linhas.length>1?'s':''}</span> ${modelo}</h2>\n    <table>\n      <thead>\n        <tr>\n          <th style=\"width:70px\">Ordem</th>\n          <th style=\"width:120px\">Conta</th>\n          <th style=\"width:110px\">D/C</th>\n          <th>Fonte do valor</th>\n          <th style=\"width:120px\" class=\"num\">Valor fixo</th>\n          <th style=\"width:90px\" class=\"num\">Fator</th>\n          <th style=\"width:120px\">Obrigatório</th>\n        </tr>\n      </thead>\n      <tbody>\n        ${linhas.map(r=>`\n          <tr>\n            <td class=\"num\">${Number(r.ordem||0)}</td>\n            <td class=\"mono\">${r.conta ?? ''}</td>\n            <td>${badgeDC(r.dc)}</td>\n            <td class=\"mono\">${r.fonte_valor ?? ''}</td>\n            <td class=\"num\">${fmt2(r.valor_fixo)}</td>\n            <td class=\"num\">${fmt2(r.fator ?? 1)}</td>\n            <td>${badgeObr(r.obrigatorio)}</td>\n          </tr>\n        `).join('')}\n      </tbody>\n    </table>\n  </section>`;\n}\n\nhtml += `\n<footer>\n  D/C = natureza da partida. \"Fonte do valor\" indica qual campo do lançamento abastece a linha (ex.: valor_total, valor_custo, valor_imposto).\n</footer>\n</body>\n</html>`;\n\nreturn [{ json: { html } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[528,1552],"id":"d8efa455-5436-4f1e-9557-b7266de7fbb8","name":"gerahtml5"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1568,1552],"id":"4343ed17-8ab4-466d-91aa-eb0545d67b60","name":"No Operation, do nothing20","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"method":"POST","url":"=https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-Mp5VTYM2qds/mediaBase64","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer Mp5VTYM2qds"}]},"sendBody":true,"specifyBody":"json","jsonBody":"= {\n  \"messageData\": {\n    \"to\": \"5516992975836\",\n    \"type\": \"document\",\n    \"caption\": \"Segue relatório de modelos\",\n    \"fileName\": \"{{ $node['gerahtml5'].json.fileName || 'modelos.pdf' }}\",\n    \"mimeType\": \"application/pdf\",\n    \"base64\": \"data:application/pdf;base64, {{ $json.base64 }}\"\n  }\n}\n ","options":{}},"id":"333a2981-4425-4dd1-b741-8c75b6a4e579","name":"MegaApi8","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1360,1552]}],"connections":{"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Simple Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"AI Agent":{"main":[[{"node":"RequestMenu7","type":"main","index":0}]]},"geradiario":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"geralancamento":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"RequestMenu7":{"main":[[{"node":"No Operation, do nothing12","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Switch":{"main":[[{"node":"HTTP Request","type":"main","index":0}],[],[],[{"node":"AI Agent1","type":"main","index":0}],[{"node":"AI Agent","type":"main","index":0}],[],[{"node":"razao","type":"main","index":0}],[{"node":"balancetesaldo","type":"main","index":0}],[{"node":"BalancoPatrimonial","type":"main","index":0}],[{"node":"BalancoPatrimonial1","type":"main","index":0}],[{"node":"BalancoPatrimonial2","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"No Operation, do nothing","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"Select rows from a table1","type":"main","index":0}],[{"node":"Execute a SQL query","type":"main","index":0}]]},"Select rows from a table1":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Execute a SQL query1":{"main":[[{"node":"RequestMenu","type":"main","index":0}]]},"Execute a SQL query":{"main":[[{"node":"Execute a SQL query1","type":"main","index":0}]]},"RequestMenu":{"main":[[{"node":"No Operation, do nothing1","type":"main","index":0}]]},"AI Agent1":{"main":[[{"node":"RequestMenu8","type":"main","index":0}]]},"Simple Memory1":{"ai_memory":[[{"node":"AI Agent1","type":"ai_memory","index":0}]]},"RequestMenu8":{"main":[[{"node":"No Operation, do nothing13","type":"main","index":0}]]},"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"InsereModelo":{"ai_tool":[[{"node":"AI Agent1","type":"ai_tool","index":0}]]},"HTTP Request6":{"main":[[{"node":"Code11","type":"main","index":0}]]},"Code11":{"main":[[{"node":"MegaApi3","type":"main","index":0}]]},"Convert to File2":{"main":[[{"node":"HTTP Request6","type":"main","index":0}]]},"gerahtml":{"main":[[{"node":"Convert to File2","type":"main","index":0}]]},"HTTP Request7":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"MegaApi","type":"main","index":0}]]},"Convert to File":{"main":[[{"node":"HTTP Request7","type":"main","index":0}]]},"razao":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Code1":{"main":[[{"node":"Convert to File","type":"main","index":0}]]},"balancete":{"main":[[{"node":"gerahtml","type":"main","index":0}]]},"HTTP Request8":{"main":[[{"node":"Code12","type":"main","index":0}]]},"Code12":{"main":[[{"node":"MegaApi4","type":"main","index":0}]]},"Convert to File3":{"main":[[{"node":"HTTP Request8","type":"main","index":0}]]},"gerahtml1":{"main":[[{"node":"Convert to File3","type":"main","index":0}]]},"balancetesaldo":{"main":[[{"node":"gerahtml1","type":"main","index":0}]]},"HTTP Request9":{"main":[[{"node":"Code13","type":"main","index":0}]]},"Code13":{"main":[[{"node":"MegaApi5","type":"main","index":0}]]},"Convert to File4":{"main":[[{"node":"HTTP Request9","type":"main","index":0}]]},"gerahtml2":{"main":[[{"node":"Convert to File4","type":"main","index":0}]]},"BalancoPatrimonial":{"main":[[{"node":"gerahtml2","type":"main","index":0}]]},"MegaApi5":{"main":[[{"node":"No Operation, do nothing14","type":"main","index":0}]]},"MegaApi3":{"main":[[{"node":"No Operation, do nothing15","type":"main","index":0}]]},"MegaApi":{"main":[[{"node":"No Operation, do nothing16","type":"main","index":0}]]},"MegaApi4":{"main":[[{"node":"No Operation, do nothing17","type":"main","index":0}]]},"HTTP Request10":{"main":[[{"node":"Code14","type":"main","index":0}]]},"MegaApi6":{"main":[[{"node":"No Operation, do nothing18","type":"main","index":0}]]},"Code14":{"main":[[{"node":"MegaApi6","type":"main","index":0}]]},"Convert to File5":{"main":[[{"node":"HTTP Request10","type":"main","index":0}]]},"gerahtml3":{"main":[[{"node":"Convert to File5","type":"main","index":0}]]},"BalancoPatrimonial1":{"main":[[{"node":"gerahtml3","type":"main","index":0}]]},"BalancoPatrimonial2":{"main":[[{"node":"gerahtml4","type":"main","index":0}]]},"HTTP Request11":{"main":[[{"node":"Code15","type":"main","index":0}]]},"Code15":{"main":[[{"node":"MegaApi7","type":"main","index":0}]]},"Convert to File6":{"main":[[{"node":"HTTP Request11","type":"main","index":0}]]},"gerahtml4":{"main":[[{"node":"Convert to File6","type":"main","index":0}]]},"MegaApi7":{"main":[[{"node":"No Operation, do nothing19","type":"main","index":0}]]},"BalancoPatrimonial3":{"main":[[{"node":"gerahtml5","type":"main","index":0}]]},"HTTP Request12":{"main":[[{"node":"Code16","type":"main","index":0}]]},"Code16":{"main":[[{"node":"MegaApi8","type":"main","index":0}]]},"Convert to File7":{"main":[[{"node":"HTTP Request12","type":"main","index":0}]]},"gerahtml5":{"main":[[{"node":"Convert to File7","type":"main","index":0}]]},"MegaApi8":{"main":[[{"node":"No Operation, do nothing20","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","timezone":"America/Sao_Paulo","callerPolicy":"workflowsFromSameOwner"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"ca207ad8-c8f5-46cf-a5d4-6aa18f9d8534","triggerCount":1,"shared":[{"createdAt":"2025-08-21T17:15:11.015Z","updatedAt":"2025-08-21T17:15:11.015Z","role":"workflow:owner","workflowId":"GcxoKfDusgm7bbjt","projectId":"kDZetBR3Erj53CH1"}],"tags":[]}