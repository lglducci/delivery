{"createdAt":"2025-08-18T01:56:16.259Z","updatedAt":"2025-08-22T22:13:31.540Z","id":"nFnokjPTuTYr7VZH","name":"AdministradorDelivery","active":false,"isArchived":false,"nodes":[{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.chatTrigger","typeVersion":1.3,"position":[368,-352],"id":"7aad0ea0-4873-4cfd-b160-41467a60623b","name":"When chat message received","webhookId":"c4567342-fb0e-4d55-8bbc-7ef93a8bcdee","disabled":true},{"parameters":{"url":"=https://singlecolorimage.com/get/ffffff/450x300.png","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2784,16],"id":"ce1c12ee-669e-4aaa-afab-0ea66fb04cc8","name":"HTTP Request"},{"parameters":{"operation":"multiStep","operations":{"operations":[{"operation":"text","text":"= {{ $('Resumo').item.json.resumo.replace(/[\\p{Extended_Pictographic}\\p{Emoji_Presentation}]/gu, '-') }}\\n{{ $('enderecopagto').item.json.mensagem.replace(/[\\p{Extended_Pictographic}\\p{Emoji_Presentation}]/gu, '-') }}","fontSize":12,"positionX":20,"positionY":60,"lineLength":200,"font":"/usr/share/fonts/truetype/msttcorefonts/Arial_Bold.ttf"}]},"options":{}},"type":"n8n-nodes-base.editImage","typeVersion":1,"position":[3008,16],"id":"247cfddc-2c59-4f6b-bccc-fe31da6c645a","name":"Edit Image"},{"parameters":{"method":"POST","url":"= https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-Mp5VTYM2qds/mediaBase64","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer Mp5VTYM2qds"}]},"sendBody":true,"specifyBody":"json","jsonBody":"= {\n\t\"messageData\": {\n\t\t\"to\": \"{{ $('Parametros Fluxo').item.json.telefonesend }}\",\n\t\t\"base64\": \"data:image/jpeg;base64,{{ $json.base64 }}\",\n\t\t\"fileName\": \"{{ $json.fileName }}\",\n\t\t\"type\": \"document\",\n\t\t\"caption\": \"Segue  {{ $('Resumo').item.json.resumo.split(/\\r?\\n/)[0].replace(/^[^\\wÀ-ÿ]+/, '').trim() }}  \",\n\t\t\"mimeType\": \"image/jpeg\"\n\t}\n}","options":{}},"id":"091e8fe7-bf6a-42e7-a4a2-2f89d0a2f155","name":"MegaApi14","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3664,16]},{"parameters":{"pdfName":"={{ $('Resumo').item.json.resumo .split(/\\r?\\n/)[0].replace(/^[^\\wÀ-ÿ]+/, '').trim() }}"},"type":"n8n-nodes-pdfkit.pdfKit","typeVersion":1,"position":[3232,16],"id":"fc1d4c3d-c084-489d-866f-2f9fabbae14a","name":"gerapdf"},{"parameters":{"jsCode":"// Pega o primeiro item do fluxo\nconst it = items[0];\n\n// Garante que veio binário\nif (!it.binary || Object.keys(it.binary).length === 0) {\n  throw new Error('Sem binary no item. Conecte este Function logo após o nó que gera o PDF.');\n}\n\n// Descobre o nome da propriedade binária (pode ser \"data\", \"pdf\", etc.)\nconst binKey = Object.keys(it.binary)[0];\nconst bin = it.binary[binKey];\n\n// O n8n já guarda em base64 em bin.data. Limpamos quebras de linha/espaços só por garantia.\nconst base64 = (bin.data || '').replace(/\\s+/g, '');\n\n// Retorna em JSON para o próximo nó\nreturn [{\n  json: {\n    base64,\n    fileName: bin.fileName || 'tesxte.pdf',\n    mimeType: bin.mimeType || 'application/pdf',\n    binKeyUsado: binKey\n  }\n}];\n "},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3440,16],"id":"837e1ee5-5571-4600-90e2-4e226ba89cfb","name":"Code1"},{"parameters":{"operation":"executeQuery","query":"update  \n  pedidos\n  set status ='producao'\nWHERE status = 'recebido'\nand pedido_id = {{ $('Resumo').item.json.pedido_id }}  and user_id = {{ $('Resumo').item.json.user_id }};","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[3856,16],"id":"4503cb42-6c22-4041-95f6-253535688955","name":"Execute a SQL query1","credentials":{"postgres":{"id":"UaH67kvWXxdMMhJt","name":"Postgres account"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[4048,16],"id":"403a57e3-c299-4e95-b4f1-f67da9329553","name":"No Operation, do nothing16","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"executeQuery","query":" SELECT pedido_id, user_id, resumo\nFROM pedidos\nWHERE status = 'recebido'\nORDER BY pedido_id ASC, pedido_id ASC\nLIMIT 1;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[656,-192],"id":"da173dcc-44b3-4a40-889c-0928eac074db","name":"Resumo","credentials":{"postgres":{"id":"UaH67kvWXxdMMhJt","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT\n  '- Endereço:  ' || COALESCE(u.\"endereço\", '—')\n  || E'\\n - Bairro:  ' || COALESCE(u.bairro, '—')\n  || E'\\n - Pagamento:  ' || COALESCE(pt.tipo_cobranca, '—')\n  AS mensagem\nFROM pedidos pt\nJOIN usuario_lacantina u\n  ON u.user_id = pt.user_id\nLEFT JOIN comentario_pedido  ct\n  ON ct.user_id = pt.user_id\n AND ct.pedido_id = pt.pedido_id\nWHERE\n  pt.user_id   = {{ $json.user_id }}\n  AND pt.pedido_id =  {{ $json.pedido_id }} \nLIMIT 1;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[848,-192],"id":"3c0827e5-bd06-45a8-9de5-46b7bf7c0195","name":"enderecopagto","credentials":{"postgres":{"id":"UaH67kvWXxdMMhJt","name":"Postgres account"}}},{"parameters":{"httpMethod":"POST","path":"admin","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-624,-16],"id":"0f91a70c-2d6a-444c-9b1a-69654f4134c5","name":"Webhook","webhookId":"e1bcd88a-5d5d-4f23-8e0c-e6b1655f6eab"},{"parameters":{"assignments":{"assignments":[{"id":"d40cfc22-d0e3-4b41-81d5-b9eec06f2dab","name":"mensagem","value":"={{  $json.saida.replace(/[\\s\\u00A0\\u2000-\\u200B\\u202F\\u205F\\u3000]+/g, '') }}","type":"string"},{"id":"b81fa178-1d74-47ba-bc36-b7a29e1c64bc","name":"telefonereciver","value":"={{   $('Webhook').item.json.body.jid.replace(\"@s.whatsapp.net\",\"\") }}","type":"string"},{"id":"3a70c352-4788-4c66-bea9-6a6b4b47cd2e","name":"telefonesend","value":"= {{ $('Webhook').item.json.body.jid.replace(\"@s.whatsapp.net\",\"\") }} ","type":"string"},{"id":"5efc25c7-e60a-415d-a313-ae92c1f454c8","name":"pedido","value":"= {{ $json.pedido }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-160,-16],"id":"680462f9-9a0d-40af-9a2a-bb84d05bfe01","name":"Parametros Fluxo","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"204f54b0-e3ed-4ff4-8302-8c20d3b8aa78","leftValue":"={{ $('Webhook').item.json.body.isGroup }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}},{"id":"c51986d9-f347-4198-89bb-9e4cd0f021c9","leftValue":"={{ $('Webhook').item.json.body.broadcast }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}},{"id":"05ee6414-0164-473b-8f82-225cfba55ad2","leftValue":"={{ $('Webhook').item.json.body.key.fromMe }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"id":"813dfa38-bb30-4938-b145-9299220671da","name":"Filtro Inicial1","type":"n8n-nodes-base.filter","typeVersion":2.1,"position":[96,-16],"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('Parametros Fluxo').item.json.mensagem.replace(/\\s+/g, '') }}","rightValue":"first","operator":{"type":"string","operation":"equals"},"id":"ebf4aaf4-df56-403a-a60c-42012aa83604"}],"combinator":"and"},"renameOutput":true,"outputKey":"first"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c5accebb-12b5-4552-a7ac-2b6bf21d9282","leftValue":"={{ $('Parametros Fluxo').item.json.mensagem }}","rightValue":"aberto","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"aberto"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"bffbce01-80c1-4652-8bff-32602950b4fa","leftValue":"={{ $('Parametros Fluxo').item.json.mensagem }}","rightValue":"consultar","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"consultar"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"5115db10-3466-4647-8c94-4d157c8ab436","leftValue":"={{ $('Parametros Fluxo').item.json.mensagem }}","rightValue":" avancar","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"avancar"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[304,-48],"id":"6f7c46e1-178d-4d5b-87f3-c8d323f97da4","name":"Switch"},{"parameters":{"url":"=https://singlecolorimage.com/get/ffffff/350x900.png","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2928,304],"id":"720ca3dd-3397-4b98-be0d-d747e53ec108","name":"HTTP Request1"},{"parameters":{"operation":"multiStep","operations":{"operations":[{"operation":"text","text":"= \n\n ","fontSize":12,"positionX":20,"positionY":60,"lineLength":200,"font":"/usr/share/fonts/truetype/msttcorefonts/Arial_Bold.ttf"}]},"options":{}},"type":"n8n-nodes-base.editImage","typeVersion":1,"position":[3168,304],"id":"52a182dc-ff40-42e0-beeb-d5f3d60e072b","name":"Edit Image1"},{"parameters":{"method":"POST","url":"=https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-Mp5VTYM2qds/mediaBase64","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer Mp5VTYM2qds"}]},"sendBody":true,"specifyBody":"json","jsonBody":"= {\n  \"messageData\": {\n    \"to\": \"{{ $('Parametros Fluxo').item.json.telefonesend }}\",\n    \"type\": \"document\",\n    \"caption\": \"Segue  Lista de pedidos em aberto\",\n    \"fileName\": \"{{ $json.fileName }}\",\n    \"mimeType\": \"application/pdf\",\n    \"base64\": \"data:application/pdf;base64,{{ $json.base64 }}\"\n  }\n}\n","options":{}},"id":"69f0011f-5c61-41d5-a328-f7003013e5d2","name":"MegaApi","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3808,304]},{"parameters":{"outputKey":"= {{ $json.base64 }}","pdfName":"= Pedidos em Aberto"},"type":"n8n-nodes-pdfkit.pdfKit","typeVersion":1,"position":[3392,304],"id":"e8a9f1d3-3792-46ab-bb39-d4341675d225","name":"gerapdf1"},{"parameters":{"jsCode":"// Pega o primeiro item do fluxo\nconst it = items[0];\n\n// Garante que veio binário\nif (!it.binary || Object.keys(it.binary).length === 0) {\n  throw new Error('Sem binary no item. Conecte este Function logo após o nó que gera o PDF.');\n}\n\n// Descobre o nome da propriedade binária (pode ser \"data\", \"pdf\", etc.)\nconst binKey = Object.keys(it.binary)[0];\nconst bin = it.binary[binKey];\n\n// O n8n já guarda em base64 em bin.data. Limpamos quebras de linha/espaços só por garantia.\nconst base64 = (bin.data || '').replace(/\\s+/g, '');\n\n// Retorna em JSON para o próximo nó\nreturn [{\n  json: {\n    base64,\n    fileName: bin.fileName || 'tesxte.pdf',\n    mimeType: bin.mimeType || 'application/pdf',\n    binKeyUsado: binKey\n  }\n}];\n "},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3616,304],"id":"011b05ce-5ed0-479d-96be-bea66e0eb9c0","name":"Code"},{"parameters":{"operation":"executeQuery","query":"update  \n  pedidos\n  set status ='producao'\nWHERE status = 'recebido'\nand pedido_id = {{ $('Resumo').item.json.pedido_id }}  and user_id = {{ $('Resumo').item.json.user_id }};","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2448,-192],"id":"ba1d39b6-facb-4d79-94ab-9d9081cef2d7","name":"Execute a SQL query2","credentials":{"postgres":{"id":"UaH67kvWXxdMMhJt","name":"Postgres account"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[4064,288],"id":"6cf16111-3935-47a4-a4e8-19927924a579","name":"No Operation, do nothing","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"executeQuery","query":" SELECT\n  COALESCE(\n    STRING_AGG(\n      'Pedido nº ' || pedido_id::text || ' - ' || TO_CHAR(create_at, 'DD/MM/YYYY HH24:MI'),\n      E'\\n' ORDER BY create_at ASC, pedido_id ASC\n    ),\n    ''\n  ) || E'\\n' AS pedidos_lista\nFROM pedidos\nWHERE status = 'recebido';","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[688,16],"id":"91e208d9-48fb-466a-a060-94d4f7af9f5a","name":"PedidosAberto","credentials":{"postgres":{"id":"UaH67kvWXxdMMhJt","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":" SELECT pedido_id, user_id, resumo, status\nFROM pedidos\nWHERE  pedido_id = {{ $json.pedido }}  ;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[656,224],"id":"512cbe73-219d-4a44-a584-bf7a6b856c94","name":"Resumo1","credentials":{"postgres":{"id":"UaH67kvWXxdMMhJt","name":"Postgres account"}}},{"parameters":{"url":"=https://singlecolorimage.com/get/ffffff/450x300.png","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1104,224],"id":"6a088c9c-b8de-4840-bf6d-6e28fb1881b4","name":"HTTP Request2"},{"parameters":{"operation":"multiStep","operations":{"operations":[{"operation":"text","text":"= {{ $('Resumo1').item.json.resumo.replace(/[\\p{Extended_Pictographic}\\p{Emoji_Presentation}]/gu, '-') }}\\n- {{ String($('Resumo1').item.json.status ?? '').trimStart().replace(/^./, c => c.toUpperCase()) }}\\n - Endereço e forma de pagamento:\\n{{ $('enderecopagto1').item.json.mensagem.replace(/[\\p{Extended_Pictographic}\\p{Emoji_Presentation}]/gu, '-') }}","fontSize":12,"positionX":20,"positionY":60,"lineLength":200,"font":"/usr/share/fonts/truetype/msttcorefonts/Arial_Bold.ttf"}]},"options":{}},"type":"n8n-nodes-base.editImage","typeVersion":1,"position":[1328,224],"id":"2382e324-959c-47e2-8c68-c6304aac27f0","name":"Edit Image2"},{"parameters":{"method":"POST","url":"= https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-Mp5VTYM2qds/mediaBase64","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer Mp5VTYM2qds"}]},"sendBody":true,"specifyBody":"json","jsonBody":"= {\n\t\"messageData\": {\n\t\t\"to\": \"{{$('Parametros Fluxo').item.json.telefonesend.trim() }}\",\n\t\t\"base64\": \"data:image/jpeg;base64,{{ $json.base64 }}\",\n\t\t\"fileName\": \"{{ $json.fileName }}\",\n\t\t\"type\": \"document\",\n\t\t\"caption\": \"Segue  {{ $('Resumo1').item.json.resumo .split(/\\r?\\n/)[0].replace(/^[^\\wÀ-ÿ]+/, '').trim() }}  \",\n\t\t\"mimeType\": \"image/jpeg\"\n\t}\n}","options":{}},"id":"dd000542-3157-4ca0-99b4-67fb560445aa","name":"MegaApi15","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1984,224]},{"parameters":{"pdfName":"={{ $('Resumo1').item.json.resumo .split(/\\r?\\n/)[0].replace(/^[^\\wÀ-ÿ]+/, '').trim() }}"},"type":"n8n-nodes-pdfkit.pdfKit","typeVersion":1,"position":[1552,224],"id":"5130bcb3-04bd-4d4a-b338-08fa657e09d1","name":"gerapdf2"},{"parameters":{"jsCode":"// Pega o primeiro item do fluxo\nconst it = items[0];\n\n// Garante que veio binário\nif (!it.binary || Object.keys(it.binary).length === 0) {\n  throw new Error('Sem binary no item. Conecte este Function logo após o nó que gera o PDF.');\n}\n\n// Descobre o nome da propriedade binária (pode ser \"data\", \"pdf\", etc.)\nconst binKey = Object.keys(it.binary)[0];\nconst bin = it.binary[binKey];\n\n// O n8n já guarda em base64 em bin.data. Limpamos quebras de linha/espaços só por garantia.\nconst base64 = (bin.data || '').replace(/\\s+/g, '');\n\n// Retorna em JSON para o próximo nó\nreturn [{\n  json: {\n    base64,\n    fileName: bin.fileName || 'tesxte.pdf',\n    mimeType: bin.mimeType || 'application/pdf',\n    binKeyUsado: binKey\n  }\n}];\n "},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1760,224],"id":"b33471cf-aca1-4b28-ab48-d73015fa5f00","name":"Code2"},{"parameters":{"operation":"executeQuery","query":"update  \n  pedidos\n  set status = '{{ $json.status }}'\nWHERE   pedido_id ={{ $('Parametros Fluxo').item.json.pedido }} ;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1792,608],"id":"d08e47e8-ecfe-4e9c-85c8-b54d5a91a78d","name":"Execute a SQL query","credentials":{"postgres":{"id":"UaH67kvWXxdMMhJt","name":"Postgres account"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2224,224],"id":"bc14523d-eb38-4a61-9b54-3be19651d82b","name":"No Operation, do nothing17","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"executeQuery","query":"SELECT\n  '- Endereço:  ' || COALESCE(u.\"endereço\", '—')\n  || E'\\n - Bairro:  ' || COALESCE(u.bairro, '—')\n  || E'\\n - Pagamento:  ' || COALESCE(pt.tipo_cobranca, '—')\n  AS mensagem\nFROM pedidos pt\nJOIN usuario_lacantina u\n  ON u.user_id = pt.user_id\nLEFT JOIN comentario_pedido  ct\n  ON ct.user_id = pt.user_id\n AND ct.pedido_id = pt.pedido_id\nWHERE\n  pt.user_id   = {{ $json.user_id }}\n  AND pt.pedido_id =  {{ $json.pedido_id }} \nLIMIT 1;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[864,224],"id":"648c1572-0e81-40de-b34d-732517ba9cb5","name":"enderecopagto1","credentials":{"postgres":{"id":"UaH67kvWXxdMMhJt","name":"Postgres account"}}},{"parameters":{"jsCode":" // Lê só a mensagem do 1º item\nconst raw = String($input.first().json?.body?.message?.conversation ?? '');\n\n// Normaliza: NBSP/zero-width → espaço, colapsa espaços, trim\nconst msg = raw\n  .normalize('NFKC')\n  .replace(/[\\u00A0\\u2007\\u202F]/g, ' ')   // NBSPs comuns\n  .replace(/\\uFEFF/g, '')                  // BOM\n  .replace(/[\\u200B-\\u200D\\u2060]/g, '')   // zero-widths\n  .replace(/\\s+/g, ' ')\n  .trim();\n\n// Base sem acento e minúscula para as regras\nconst base = msg\n  .toLowerCase()\n  .normalize('NFD').replace(/[\\u0300-\\u036f]/g, ''); // remove acentos\n\n// ordem importa: deixe 'first' por último (catch-all)\nconst regras = [\n  ['consultar', /\\bconsultar\\b/],\n  ['aberto', /\\aberto\\b/],\n  ['avancar',   /\\b(?:avancar|continuar|proximo)\\b/],\n  ['voltar',    /\\bvoltar\\b/],\n  ['cancelar',  /\\bcancelar\\b/],\n  ['first',     /.+/], // default\n];\n\nconst achou = regras.find(([, re]) => re.test(base));\nconst saida = achou[0]; // sempre existe por causa do 'first' no fim\n\n// Extrai número do pedido para consultar e avançar\nlet pedido = null;\nif (saida === 'consultar') {\n  pedido = base.match(/\\bconsultar\\b\\D*(\\d+)/)?.[1] ?? null;\n} else if (saida === 'avancar') {\n  pedido = base.match(/\\b(?:avancar|continuar|proximo)\\b\\D*(\\d+)/)?.[1] ?? null;\n}\n\nreturn [{ json: { saida, pedido } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-384,-16],"id":"add9f29b-bcb0-41fc-9495-f43504055717","name":"Code3"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.status }}","rightValue":"producao","operator":{"type":"string","operation":"equals"},"id":"590570b6-6ad3-4a8a-85aa-73a7103414b3"}],"combinator":"and"},"renameOutput":true,"outputKey":"producao"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"f7507cac-1ca9-4cdb-a214-6ec63aac31a0","leftValue":"={{ $json.status }}","rightValue":"entrega","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"entrega"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fc846c07-c37d-4e5b-9631-c28bd8982938","leftValue":"={{ $json.status }}","rightValue":"recebido","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"}}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[864,592],"id":"6ddadb03-816c-4914-945c-8f791e427810","name":"Switch1"},{"parameters":{"assignments":{"assignments":[{"id":"f1e0b7ac-d8c4-4845-a161-71db934c6ff9","name":"status","value":"=entrega","type":"string"},{"id":"79fcdf15-1b17-487f-bf64-6c557812da36","name":"acao","value":"entrega","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1184,448],"id":"5bacedaa-62e8-46ac-a024-b2febf4a32ea","name":"Edit Fields"},{"parameters":{"operation":"executeQuery","query":" SELECT pedido_id, user_id,   status\nFROM pedidos\nWHERE   pedido_id =  {{ $('Parametros Fluxo').item.json.pedido }} \nLIMIT 1;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[640,608],"id":"d6dc6860-a656-477a-ac8d-36016dad02f0","name":"PendidoAvancar","credentials":{"postgres":{"id":"UaH67kvWXxdMMhJt","name":"Postgres account"}}},{"parameters":{"assignments":{"assignments":[{"id":"f1e0b7ac-d8c4-4845-a161-71db934c6ff9","name":"status","value":"=concluido","type":"string"},{"id":"c1877cbe-998c-4bdc-a539-5699a76293db","name":"acao","value":"concluido","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1184,624],"id":"664c04a1-b9cb-4bf1-a6fd-4d0f6e2a0fd2","name":"Edit Fields1"},{"parameters":{"assignments":{"assignments":[{"id":"f1e0b7ac-d8c4-4845-a161-71db934c6ff9","name":"status","value":"=producao","type":"string"},{"id":"5f919bd7-55dd-4cb7-a1ee-24a7887c6e45","name":"acao","value":"produção","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1184,816],"id":"0d3f936d-c674-4a0c-8c9c-c18e66b8d63a","name":"Edit Fields2"},{"parameters":{"numberInputs":3},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1568,592],"id":"df0556b8-57bd-4f8e-9b9a-3f4fed286f5a","name":"Merge","alwaysOutputData":false},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2256,608],"id":"df5e6375-9a5b-4801-8795-e45ef2bb2f6f","name":"No Operation, do nothing18","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"method":"POST","url":"= https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-MyrBo2u0n7N/text","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer MyrBo2u0n7N"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=   {\n  \"messageData\": {\n    \"to\": \"{{ $('Parametros Fluxo').item.json.telefonesend }}\",\n    \"text\": \"So seu pedido foi atualizado com sucesso.\\n De  {{ $('PendidoAvancar').item.json.status }} para {{ $('Merge').item.json.acao }} \"\n  }\n}\n","options":{}},"id":"994d445f-ee94-4930-8c24-fce412881102","name":"RequestMenu7","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2032,608]},{"parameters":{"jsCode":" // === ENTRADA ===\n// Ex.: $('PedidosAberto').first().json.pedidos_lista  (string com linhas)\n// ==================\nlet texto = $('PedidosAberto').first().json.pedidos_lista ?? '';\nif (typeof texto !== 'string') texto = String(texto);\n\n// Converte \"\\n\" literal em quebras reais e separa linhas válidas\ntexto = texto.replace(/\\\\n/g, '\\n');\nconst linhas = texto.split(/\\r?\\n/).map(s => s.trim()).filter(Boolean);\n\n// Regex: \"Pedido nº 168 - 18/08/2025 13:53\"\nconst re = /pedido\\s*(?:n[ºo°.]|nº|n°|no|n)\\s*\\.?\\s*(\\d+)\\s*[-–—]\\s*(.+)$/i;\n\nconst dados = [];\nfor (const linha of linhas) {\n  let num=null, data=null;\n  const m = linha.match(re);\n  if (m) {\n    num = m[1]; data = m[2];\n  } else {\n    const parts = linha.split(/\\s*-\\s*/);\n    if (parts.length>=2){\n      const m2 = parts[0].match(/(\\d+)/);\n      if (m2) num = m2[1];\n      data = parts.slice(1).join(' - ');\n    }\n  }\n  if (num && data) {\n    // ✅ ALTERAÇÃO: usa entidade HTML para o “º”\n    dados.push({ pedido: `n&ordm; ${num}`, data });\n  }\n}\n\n// Título fixo para não dar undefined\n \nconst titulo = \"Relat&oacute;rio de Pedidos em Aberto\"; // evita mojibake\n\n// Monta HTML\nconst linhasHtml = dados.map(row => `\n  <tr>\n    <td style=\"padding:10px;border-bottom:1px solid #e5e7eb;text-align:center;\">${row.pedido}</td>\n    <td style=\"padding:10px;border-bottom:1px solid #e5e7eb;text-align:center;\">${row.data}</td>\n  </tr>\n`).join('');\n\nconst html = `\n<!doctype html><html lang=\"pt-br\"><head>\n<meta charset=\"utf-8\"/>\n<title>${titulo}</title>\n<style>\n body{font-family:Arial, Helvetica, \"Noto Sans\", \"Liberation Sans\", sans-serif;background:#f7f7f8;color:#111827;margin:0;padding:24px;}\n .container{max-width:900px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.07);overflow:hidden;}\n .header{padding:24px 28px;background:#0ea5e9;color:white;display:flex;justify-content:space-between;}\n .title{font-size:20px;font-weight:700}\n table{width:100%;border-collapse:collapse;border:1px solid #e5e7eb}\n thead th{background:#f1f5f9;font-size:12px;text-transform:uppercase;letter-spacing:.6px;color:#334155;padding:12px 10px;text-align:center;border-bottom:1px solid #e5e7eb}\n tfoot td{padding:12px 10px;font-size:12px;color:#475569}\n</style></head><body>\n<div class=\"container\">\n  <div class=\"header\">\n    <div class=\"title\">${titulo}</div>\n    <div>Gerado em: ${new Date().toLocaleString('pt-BR')}</div>\n  </div>\n  <div style=\"padding:24px 28px;\">\n    <table>\n      <thead><tr><th>Pedido</th><th>Data e Hora</th></tr></thead>\n      <tbody>${linhasHtml || `<tr><td colspan=\"2\" style=\"padding:14px;text-align:center;color:#64748b;\">Sem registros</td></tr>`}</tbody>\n      <tfoot><tr><td colspan=\"2\">Total de registros: ${dados.length}</td></tr></tfoot>\n    </table>\n  </div>\n</div>\n</body></html>`;\n\n// Nome do PDF\nconst fileName = `relatorio-pedidos-${new Date().toISOString().slice(0,10)}.pdf`;\n\nreturn [{ json: { html, fileName } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[912,16],"id":"1c1dd7a2-832c-47f6-b735-a84b3cdf012d","name":"Code6"},{"parameters":{"operation":"toText","sourceProperty":"html","binaryPropertyName":"=file","options":{"encoding":"binary","fileName":"index.html"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[1136,16],"id":"e712c54f-5bdd-45ac-b817-24ac94882d54","name":"Convert to File"},{"parameters":{"method":"POST","url":"https://gotenberggotenberg8-production-8d7d.up.railway.app/forms/chromium/convert/url","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"url","value":"https://www.n8n.io"}]},"options":{"response":{"response":{"responseFormat":"file","outputPropertyName":"relatorio.pdf"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-96,624],"id":"28a67efe-5fe1-4fa0-9277-c9690dbb737f","name":"HTTP Request3"},{"parameters":{"method":"POST","url":"https://gotenberggotenberg8-production-8d7d.up.railway.app/forms/chromium/convert/html","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"files","inputDataFieldName":"file"}]},"options":{"response":{"response":{"responseFormat":"file","outputPropertyName":"relatorio.pdf"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1344,16],"id":"52efc6fe-581e-40a8-9055-4fec8aeea0e7","name":"HTTP Request4"},{"parameters":{"method":"POST","url":"=https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-Mp5VTYM2qds/mediaBase64","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer Mp5VTYM2qds"}]},"sendBody":true,"specifyBody":"json","jsonBody":"= {\n  \"messageData\": {\n    \"to\": \"{{ $('Parametros Fluxo').item.json.telefonesend }}\",\n    \"type\": \"document\",\n    \"caption\": \"Segue  Lista de pedidos em aberto\",\n    \"fileName\": \"{{ $node['Code6'].json.fileName || 'relatorio.pdf' }}\",\n    \"mimeType\": \"application/pdf\",\n    \"base64\": \"data:application/pdf;base64, {{ $json.base64 }}\"\n  }\n}\n ","options":{}},"id":"65a0fed5-ac3b-4ec1-b51b-9ccace764498","name":"MegaApi1","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1824,16]},{"parameters":{"jsCode":" // garante que entrou um item com binário\nconst item = items[0];\nconst bins = item.binary || {};\nconst keys = Object.keys(bins);\nif (!keys.length) {\n  throw new Error('Nenhum binário no input. No HTTP Request (Gotenberg), ative Download=ON e Response=File.');\n}\n\n// escolhe o PDF: por mimeType, por extensão .pdf, ou o primeiro\nconst pdfKey =\n  keys.find(k => (bins[k].mimeType || '').includes('pdf')) ||\n  keys.find(k => k.toLowerCase().endsWith('.pdf')) ||\n  keys[0];\n\nconst pdf = bins[pdfKey];\nif (!pdf) {\n  throw new Error('PDF não encontrado. Binários disponíveis: ' + keys.join(', '));\n}\n\n// nome do arquivo\nconst fileName = item.json.fileName || pdf.fileName || 'relatorio.pdf';\n\n// sai com base64 + fileName para o próximo nó\nreturn [{\n  json: {\n    base64: pdf.data,                 // JÁ é base64\n    fileName: fileName                // ex.: relatorio-2025-08-20.pdf\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1552,16],"id":"b21d8685-f229-4235-b83b-6372c4752159","name":"Code7"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2080,16],"id":"0f4b340f-62d4-43af-a873-5f1547e6aeb1","name":"No Operation, do nothing19","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"jsCode":" // === ENTRADA ===\n// Ex.: $('PedidosAberto').first().json.pedidos_lista  (string com linhas)\n// ==================\nlet texto = $('PedidosAberto').first().json.pedidos_lista ?? '';\nif (typeof texto !== 'string') texto = String(texto);\n\n// Converte \"\\n\" literal em quebras reais e separa linhas válidas\ntexto = texto.replace(/\\\\n/g, '\\n');\nconst linhas = texto.split(/\\r?\\n/).map(s => s.trim()).filter(Boolean);\n\n// Regex: \"Pedido nº 168 - 18/08/2025 13:53\"\nconst re = /pedido\\s*(?:n[ºo°.]|nº|n°|no|n)\\s*\\.?\\s*(\\d+)\\s*[-–—]\\s*(.+)$/i;\n\nconst dados = [];\nfor (const linha of linhas) {\n  let num=null, data=null;\n  const m = linha.match(re);\n  if (m) {\n    num = m[1]; data = m[2];\n  } else {\n    const parts = linha.split(/\\s*-\\s*/);\n    if (parts.length>=2){\n      const m2 = parts[0].match(/(\\d+)/);\n      if (m2) num = m2[1];\n      data = parts.slice(1).join(' - ');\n    }\n  }\n  if (num && data) {\n    // ✅ ALTERAÇÃO: usa entidade HTML para o “º”\n    dados.push({ pedido: `n&ordm; ${num}`, data });\n  }\n}\n\n// Título fixo para não dar undefined\n \nconst titulo = \"Relat&oacute;rio de Pedidos em Aberto\"; // evita mojibake\n\n// Monta HTML\nconst linhasHtml = dados.map(row => `\n  <tr>\n    <td style=\"padding:10px;border-bottom:1px solid #e5e7eb;text-align:center;\">${row.pedido}</td>\n    <td style=\"padding:10px;border-bottom:1px solid #e5e7eb;text-align:center;\">${row.data}</td>\n  </tr>\n`).join('');\n\nconst html = `\n<!doctype html><html lang=\"pt-br\"><head>\n<meta charset=\"utf-8\"/>\n<title>${titulo}</title>\n<style>\n body{font-family:Arial, Helvetica, \"Noto Sans\", \"Liberation Sans\", sans-serif;background:#f7f7f8;color:#111827;margin:0;padding:24px;}\n .container{max-width:900px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.07);overflow:hidden;}\n .header{padding:24px 28px;background:#0ea5e9;color:white;display:flex;justify-content:space-between;}\n .title{font-size:20px;font-weight:700}\n table{width:100%;border-collapse:collapse;border:1px solid #e5e7eb}\n thead th{background:#f1f5f9;font-size:12px;text-transform:uppercase;letter-spacing:.6px;color:#334155;padding:12px 10px;text-align:center;border-bottom:1px solid #e5e7eb}\n tfoot td{padding:12px 10px;font-size:12px;color:#475569}\n</style></head><body>\n<div class=\"container\">\n  <div class=\"header\">\n    <div class=\"title\">${titulo}</div>\n    <div>Gerado em: ${new Date().toLocaleString('pt-BR')}</div>\n  </div>\n  <div style=\"padding:24px 28px;\">\n    <table>\n      <thead><tr><th>Pedido</th><th>Data e Hora</th></tr></thead>\n      <tbody>${linhasHtml || `<tr><td colspan=\"2\" style=\"padding:14px;text-align:center;color:#64748b;\">Sem registros</td></tr>`}</tbody>\n      <tfoot><tr><td colspan=\"2\">Total de registros: ${dados.length}</td></tr></tfoot>\n    </table>\n  </div>\n</div>\n</body></html>`;\n\n// Nome do PDF\nconst fileName = `relatorio-pedidos-${new Date().toISOString().slice(0,10)}.pdf`;\n\nreturn [{ json: { html, fileName } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1760,928],"id":"ba412c5b-a012-43ac-8e80-5f08073fc723","name":"Code8"},{"parameters":{"operation":"toText","sourceProperty":"html","binaryPropertyName":"=file","options":{"encoding":"binary","fileName":"index.html"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[1984,928],"id":"0f45ae15-b1c6-4d63-b08f-ee0a6dbb64b3","name":"Convert to File1"},{"parameters":{"method":"POST","url":"https://gotenberggotenberg8-production-8d7d.up.railway.app/forms/chromium/convert/html","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"files","inputDataFieldName":"file"}]},"options":{"response":{"response":{"responseFormat":"file","outputPropertyName":"relatorio.pdf"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2192,928],"id":"2f6338c9-d854-4eea-bae6-94c456c20912","name":"HTTP Request5"},{"parameters":{"method":"POST","url":"=https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-Mp5VTYM2qds/mediaBase64","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer Mp5VTYM2qds"}]},"sendBody":true,"specifyBody":"json","jsonBody":"= {\n  \"messageData\": {\n    \"to\": \"{{ $('Parametros Fluxo').item.json.telefonesend }}\",\n    \"type\": \"document\",\n    \"caption\": \"Segue  Lista de pedidos em aberto\",\n    \"fileName\": \"{{ $node['Code8'].json.fileName || 'relatorio.pdf' }}\",\n    \"mimeType\": \"application/pdf\",\n    \"base64\": \"data:application/pdf;base64, {{ $json.base64 }}\"\n  }\n}\n ","options":{}},"id":"2795b9a3-d936-430b-bee2-13642e0aa563","name":"MegaApi2","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2672,928]},{"parameters":{"jsCode":" // garante que entrou um item com binário\nconst item = items[0];\nconst bins = item.binary || {};\nconst keys = Object.keys(bins);\nif (!keys.length) {\n  throw new Error('Nenhum binário no input. No HTTP Request (Gotenberg), ative Download=ON e Response=File.');\n}\n\n// escolhe o PDF: por mimeType, por extensão .pdf, ou o primeiro\nconst pdfKey =\n  keys.find(k => (bins[k].mimeType || '').includes('pdf')) ||\n  keys.find(k => k.toLowerCase().endsWith('.pdf')) ||\n  keys[0];\n\nconst pdf = bins[pdfKey];\nif (!pdf) {\n  throw new Error('PDF não encontrado. Binários disponíveis: ' + keys.join(', '));\n}\n\n// nome do arquivo\nconst fileName = item.json.fileName || pdf.fileName || 'relatorio.pdf';\n\n// sai com base64 + fileName para o próximo nó\nreturn [{\n  json: {\n    base64: pdf.data,                 // JÁ é base64\n    fileName: fileName                // ex.: relatorio-2025-08-20.pdf\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2400,928],"id":"7e38b09e-ef82-47c3-8820-e92ce1386c8d","name":"Code9"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2928,928],"id":"63646d5a-eb56-4534-b25d-ec7f125eb504","name":"No Operation, do nothing20","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"toText","sourceProperty":"html","binaryPropertyName":"=file","options":{"encoding":"binary","fileName":"index.html"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[1552,-192],"id":"7a61beab-891d-4390-9d21-a247c6d3d0bd","name":"Convert to File2"},{"parameters":{"method":"POST","url":"https://gotenberggotenberg8-production-8d7d.up.railway.app/forms/chromium/convert/html","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"files","inputDataFieldName":"file"}]},"options":{"response":{"response":{"responseFormat":"file","outputPropertyName":"relatorio.pdf"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1760,-192],"id":"8d1be020-d09f-4988-96b5-46e91e65cb1f","name":"HTTP Request6"},{"parameters":{"method":"POST","url":"=https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-Mp5VTYM2qds/mediaBase64","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer Mp5VTYM2qds"}]},"sendBody":true,"specifyBody":"json","jsonBody":"= {\n  \"messageData\": {\n    \"to\": \"{{ $('Parametros Fluxo').item.json.telefonesend }}\",\n    \"type\": \"document\",\n    \"caption\": \"Segue  Lista de pedidos em aberto\",\n    \"fileName\": \"{{ $node['gerahtml'].json.fileName || 'relatorio.pdf' }}\",\n    \"mimeType\": \"application/pdf\",\n    \"base64\": \"data:application/pdf;base64, {{ $json.base64 }}\"\n  }\n}\n ","options":{}},"id":"7bd16445-4e7f-4b77-99c8-4a9478efdafc","name":"MegaApi3","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2240,-192]},{"parameters":{"jsCode":" // garante que entrou um item com binário\nconst item = items[0];\nconst bins = item.binary || {};\nconst keys = Object.keys(bins);\nif (!keys.length) {\n  throw new Error('Nenhum binário no input. No HTTP Request (Gotenberg), ative Download=ON e Response=File.');\n}\n\n// escolhe o PDF: por mimeType, por extensão .pdf, ou o primeiro\nconst pdfKey =\n  keys.find(k => (bins[k].mimeType || '').includes('pdf')) ||\n  keys.find(k => k.toLowerCase().endsWith('.pdf')) ||\n  keys[0];\n\nconst pdf = bins[pdfKey];\nif (!pdf) {\n  throw new Error('PDF não encontrado. Binários disponíveis: ' + keys.join(', '));\n}\n\n// nome do arquivo\nconst fileName = item.json.fileName || pdf.fileName || 'relatorio.pdf';\n\n// sai com base64 + fileName para o próximo nó\nreturn [{\n  json: {\n    base64: pdf.data,                 // JÁ é base64\n    fileName: fileName                // ex.: relatorio-2025-08-20.pdf\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1968,-192],"id":"cabf4f69-bc7e-4683-a693-7b42a5b0ff18","name":"Code11"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2704,-192],"id":"d0cadd3f-a419-4271-84f3-2dd48ffbd66d","name":"No Operation, do nothing21","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"jsCode":" // Lê suas duas entradas\nconst r = $('Resumo').first().json || {};\nconst e = $('enderecopagto').first().json || {};\n\n// 1) Regex de emojis (inclui bandeiras, pictogramas, var. selector e ZWJ)\nconst EMOJI_RE =\n  /(?:[\\u{1F1E6}-\\u{1F1FF}]{2}|[\\u{1F300}-\\u{1FAFF}]|[\\u{2600}-\\u{27BF}]|\\u{FE0F}|\\u{200D})/gu;\n\n// 2) Remove TODOS os emojis do texto\nfunction removeEmoji(s = '') {\n  return String(s).replace(EMOJI_RE, '');\n}\n\n// (opcional) remove só emoji no **início de cada linha**\nfunction removeEmojiNoInicioDasLinhas(s = '') {\n  return String(s)\n    .split(/\\r?\\n/)\n    .map(l => l.replace(new RegExp('^(?:' + EMOJI_RE.source + ')+\\\\s*', 'gu'), ''))\n    .join('\\n');\n}\n\n// Normaliza linhas \\n literais\nconst resumoBruto   = String(r.resumo ?? '').replace(/\\\\n/g, '\\n');\nconst enderecoBruto = String(e.mensagem ?? '').replace(/\\\\n/g, '\\n');\n\n// A) Remover emojis do texto inteiro\nconst resumoSemEmoji   = removeEmoji(resumoBruto);\nconst enderecoSemEmoji = removeEmoji(enderecoBruto);\n\n// B) (se preferir) Remover só no começo das linhas\nconst resumoSemEmojiInicio   = removeEmojiNoInicioDasLinhas(resumoBruto);\nconst enderecoSemEmojiInicio = removeEmojiNoInicioDasLinhas(enderecoBruto);\n\nreturn [{\n  json: {\n    // Use UM dos pares abaixo no seu próximo nó:\n\n    // 1) Limpo geral:\n    resumo_sem_emoji: resumoSemEmoji,\n    enderecopagto_sem_emoji: enderecoSemEmoji,\n\n    // 2) OU: limpo só no começo das linhas:\n    resumo_sem_emoji_inicio: resumoSemEmojiInicio,\n    enderecopagto_sem_emoji_inicio: enderecoSemEmojiInicio\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1072,-192],"id":"14439f4f-c613-40f9-8f13-36c709d22421","name":"RemoveEmoji"},{"parameters":{"jsCode":" // ===== ENTRADA: nó RemoveEmoji =====\nconst R = $('RemoveEmoji').first().json || {};\nlet resumo   = String(R.resumo_sem_emoji ?? R.resumo_sem_emoji_inicio ?? R.resumo ?? '').replace(/\\\\n/g, '\\n');\nlet endbloc  = String(R.enderecopagto_sem_emoji ?? R.enderecopagto_sem_emoji_inicio ?? R.mensagem ?? '').replace(/\\\\n/g, '\\n');\n\n// remove \" - \" / bullets no INÍCIO das linhas do bloco de endereço\nendbloc = endbloc.replace(/^\\s*[-•–—]+\\s*/gm, '');\n\n// ===== HELPERS =====\nconst esc = s => String(s)\n  .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')\n  .replace(/\"/g,'&quot;').replace(/'/g,'&#39;');\n\nfunction moneyToNumber(s=''){\n  s = String(s).replace(/[^\\d,.-]/g,'').replace(/\\.(?=\\d{3}(?:\\D|$))/g,'');\n  s = s.replace(',', '.');\n  const n = parseFloat(s);\n  return isNaN(n) ? 0 : n;\n}\nconst fmtBR = n => n.toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});\n\n// ===== PARSE DO RESUMO (ultra simples) =====\nconst linhas = resumo.split(/\\r?\\n/).map(t => t.trim()).filter(Boolean);\nlet numeroPedido=null, formaPg=null, entrega=null, total=null, comentario=null;\nconst itens = [];\n\nfor (const ln of linhas) {\n  let m;\n  if ((m = ln.match(/pedido\\s*n[ºo°.]?\\s*(\\d+)/i))) { numeroPedido = m[1]; continue; }\n  if ((m = ln.match(/forma de pagamento\\s*:\\s*(.+)/i))) { formaPg = m[1].trim(); continue; }\n  if ((m = ln.match(/^pagamento\\s*:\\s*(.+)/i))) { formaPg = m[1].trim(); continue; }\n  if ((m = ln.match(/entrega\\s*:\\s*R?\\$?\\s*([\\d.,]+)/i))) { entrega = moneyToNumber(m[1]); continue; }\n  if ((m = ln.match(/total\\s*:\\s*R\\$\\s*([\\d.,]+)/i))) { total = moneyToNumber(m[1]); continue; }\n  if ((m = ln.match(/coment[áa]rio\\s*:\\s*(.+)/i))) { comentario = m[1].trim(); continue; }\n  if (/^resumo\\s*:$/i.test(ln)) { continue; }\n\n  // ITEM: pega TUDO antes do ÚLTIMO \" - R$ valor\" como descrição (preserva (65), 1/2, etc)\n  m = ln.match(/^(.*)\\s-\\s*R\\$\\s*([\\d.,]+)\\s*$/);\n  if (m) { itens.push({ descricao: m[1].trim(), preco: moneyToNumber(m[2]) }); continue; }\n}\n\n// subtotal/total\nconst subtotal = itens.reduce((a,b)=>a+b.preco,0);\nif (total == null) total = subtotal + (entrega || 0);\n\n// ===== PARSE ENDEREÇO / PAGTO (bloco separado) =====\nlet endereco=null, bairro=null, pagamentoMsg=null;\nfor (const raw of endbloc.split(/\\r?\\n/)) {\n  const s = raw.trim();\n  let m;\n  if ((m = s.match(/^(?:end(?:ere[cç]o|ereco))\\s*:\\s*(.+)$/i))) { endereco = m[1].trim(); continue; }\n  if ((m = s.match(/^bairro\\s*:\\s*(.+)$/i)))                            { bairro = m[1].trim(); continue; }\n  if ((m = s.match(/^(?:pagamento|forma\\s*de\\s*pagamento)\\s*:\\s*(.+)$/i))) { pagamentoMsg = m[1].trim(); continue; }\n}\nconst formaFinal = formaPg || pagamentoMsg || 'não informado';\n\n// ===== HTML =====\nconst hoje   = new Date().toLocaleString('pt-BR');\nconst titulo = 'Detalhes do pedido';\n\nconst linhasHtml = itens.length\n  ? itens.map(it => `\n      <div class=\"row\">\n        <div class=\"desc\">${esc(it.descricao)}</div>\n        <div class=\"val\">R$ ${fmtBR(it.preco)}</div>\n      </div>`).join('')\n  : `<div class=\"row empty\">Sem itens</div>`;\n\nconst html = `<!doctype html>\n<html lang=\"pt-br\"><head>\n<meta charset=\"utf-8\"/>\n<title>${titulo}</title>\n<style>\n:root{--bg:#f7f7f8;--card:#fff;--ink:#0f172a;--muted:#475569;--line:#e5e7eb;--brand:#0ea5e9}\nbody{font-family:Arial,Helvetica,\"Noto Sans\",\"Liberation Sans\",sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:24px}\n.wrap{max-width:900px;margin:0 auto;background:var(--card);border-radius:16px;box-shadow:0 10px 25px rgb(0 0 0/.07);overflow:hidden}\n.hdr{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;background:var(--brand);color:#fff}\n.hdr .title{font-size:20px;font-weight:700}\n.meta{padding:16px 24px;display:grid;grid-template-columns:1fr 1fr;gap:16px;border-bottom:1px solid var(--line)}\n.card{background:#fafafa;border:1px solid var(--line);border-radius:12px;padding:12px}\n.card h4{margin:0 0 6px 0;font-size:13px;color:var(--muted);letter-spacing:.6px}\n.list{padding:20px 24px}\n.head{display:grid;grid-template-columns:1fr 140px;gap:16px;padding:10px 0;margin:0 0 8px;border-bottom:1px solid var(--line);color:#334155;font-size:12px}\n.row{display:grid;grid-template-columns:1fr 140px;gap:16px;padding:10px 0;border-bottom:1px solid var(--line)}\n.desc{word-break:break-word}\n.val{text-align:right;font-variant-numeric:tabular-nums;font-feature-settings:'tnum' 1,'lnum' 1}\n.tot{display:grid;grid-template-columns:1fr 140px;gap:16px;padding:8px 0;color:#475569}\n.tot.bold{color:#0f172a;font-weight:700}\n</style></head><body>\n  <div class=\"wrap\">\n    <div class=\"hdr\">\n      <div class=\"title\">${titulo}</div>\n      <div>Pedido n&ordm; ${esc(numeroPedido ?? '')}</div>\n    </div>\n\n    <div class=\"meta\">\n      <div class=\"card\">\n        <h4>Endere&ccedil;o</h4>\n        <div>${esc(endereco || 'não informado')}</div>\n        <div>${esc(bairro ? 'Bairro: '+bairro : '')}</div>\n      </div>\n      <div class=\"card\">\n        <h4>Pagamento &amp; Entrega</h4>\n        <div>Forma de pagamento: ${esc(formaFinal)}</div>\n        <div>Entrega: ${entrega!=null ? ('R$ '+fmtBR(entrega)) : '—'}</div>\n        <div>Gerado em: ${esc(hoje)}</div>\n      </div>\n    </div>\n\n    <div class=\"list\">\n      <div class=\"head\"><div>Descri&ccedil;&atilde;o</div><div style=\"text-align:right\">Valor</div></div>\n      ${linhasHtml}\n      <div class=\"tot\"><div>Subtotal</div><div class=\"val\">R$ ${fmtBR(subtotal)}</div></div>\n      <div class=\"tot\"><div>Entrega</div><div class=\"val\">${entrega!=null ? ('R$ '+fmtBR(entrega)) : '—'}</div></div>\n      <div class=\"tot bold\"><div>Total</div><div class=\"val\">R$ ${fmtBR(total)}</div></div>\n      ${comentario ? `<div style=\"margin-top:12px;color:#334155\"><b>Coment&aacute;rio:</b> ${esc(comentario)}</div>` : ''}\n    </div>\n  </div>\n</body></html>`;\n\n// ===== SAÍDA =====\nconst fileName = `pedido-${numeroPedido || 'sem-id'}-${new Date().toISOString().slice(0,10)}.pdf`;\nreturn [{ json: { html, fileName } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1296,-192],"id":"ff44a1e3-cdb6-419f-bfce-0e3b987d3ead","name":"gerahtml"}],"connections":{"When chat message received":{"main":[[]]},"HTTP Request":{"main":[[{"node":"Edit Image","type":"main","index":0}]]},"Edit Image":{"main":[[{"node":"gerapdf","type":"main","index":0}]]},"gerapdf":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Code1":{"main":[[{"node":"MegaApi14","type":"main","index":0}]]},"MegaApi14":{"main":[[{"node":"Execute a SQL query1","type":"main","index":0}]]},"Execute a SQL query1":{"main":[[{"node":"No Operation, do nothing16","type":"main","index":0}]]},"Resumo":{"main":[[{"node":"enderecopagto","type":"main","index":0}]]},"enderecopagto":{"main":[[{"node":"RemoveEmoji","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Code3","type":"main","index":0}]]},"Parametros Fluxo":{"main":[[{"node":"Filtro Inicial1","type":"main","index":0}]]},"Filtro Inicial1":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Resumo","type":"main","index":0}],[{"node":"PedidosAberto","type":"main","index":0}],[{"node":"Resumo1","type":"main","index":0}],[{"node":"PendidoAvancar","type":"main","index":0}]]},"HTTP Request1":{"main":[[{"node":"Edit Image1","type":"main","index":0}]]},"Edit Image1":{"main":[[{"node":"gerapdf1","type":"main","index":0}]]},"MegaApi":{"main":[[{"node":"No Operation, do nothing","type":"main","index":0}]]},"gerapdf1":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"MegaApi","type":"main","index":0}]]},"Execute a SQL query2":{"main":[[{"node":"No Operation, do nothing21","type":"main","index":0}]]},"PedidosAberto":{"main":[[{"node":"Code6","type":"main","index":0}]]},"HTTP Request2":{"main":[[{"node":"Edit Image2","type":"main","index":0}]]},"Edit Image2":{"main":[[{"node":"gerapdf2","type":"main","index":0}]]},"MegaApi15":{"main":[[{"node":"No Operation, do nothing17","type":"main","index":0}]]},"gerapdf2":{"main":[[{"node":"Code2","type":"main","index":0}]]},"Code2":{"main":[[{"node":"MegaApi15","type":"main","index":0}]]},"Execute a SQL query":{"main":[[{"node":"RequestMenu7","type":"main","index":0}]]},"enderecopagto1":{"main":[[{"node":"HTTP Request2","type":"main","index":0}]]},"Resumo1":{"main":[[{"node":"enderecopagto1","type":"main","index":0}]]},"Code3":{"main":[[{"node":"Parametros Fluxo","type":"main","index":0}]]},"Switch1":{"main":[[{"node":"Edit Fields","type":"main","index":0}],[{"node":"Edit Fields1","type":"main","index":0}],[{"node":"Edit Fields2","type":"main","index":0}]]},"PendidoAvancar":{"main":[[{"node":"Switch1","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Edit Fields1":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Edit Fields2":{"main":[[{"node":"Merge","type":"main","index":2}]]},"Merge":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]},"RequestMenu7":{"main":[[{"node":"No Operation, do nothing18","type":"main","index":0}]]},"Code6":{"main":[[{"node":"Convert to File","type":"main","index":0}]]},"Convert to File":{"main":[[{"node":"HTTP Request4","type":"main","index":0}]]},"HTTP Request4":{"main":[[{"node":"Code7","type":"main","index":0}]]},"Code7":{"main":[[{"node":"MegaApi1","type":"main","index":0}]]},"MegaApi1":{"main":[[{"node":"No Operation, do nothing19","type":"main","index":0}]]},"Code8":{"main":[[{"node":"Convert to File1","type":"main","index":0}]]},"Convert to File1":{"main":[[{"node":"HTTP Request5","type":"main","index":0}]]},"HTTP Request5":{"main":[[{"node":"Code9","type":"main","index":0}]]},"MegaApi2":{"main":[[{"node":"No Operation, do nothing20","type":"main","index":0}]]},"Code9":{"main":[[{"node":"MegaApi2","type":"main","index":0}]]},"Convert to File2":{"main":[[{"node":"HTTP Request6","type":"main","index":0}]]},"HTTP Request6":{"main":[[{"node":"Code11","type":"main","index":0}]]},"MegaApi3":{"main":[[{"node":"Execute a SQL query2","type":"main","index":0}]]},"Code11":{"main":[[{"node":"MegaApi3","type":"main","index":0}]]},"gerahtml":{"main":[[{"node":"Convert to File2","type":"main","index":0}]]},"RemoveEmoji":{"main":[[{"node":"gerahtml","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"host":"primary-production-d79b.up.railway.app","user-agent":"axios/1.7.7","content-length":"729","accept":"application/json, text/plain, */*","accept-encoding":"gzip, compress, deflate, br","content-type":"application/json","x-forwarded-for":"5.78.66.98","x-forwarded-host":"primary-production-d79b.up.railway.app","x-forwarded-proto":"https","x-railway-edge":"railway/us-west2","x-railway-request-id":"woliuvp5RWuFrYaXnpoFkQ","x-real-ip":"5.78.66.98","x-request-start":"1755705865079"},"params":{},"query":{},"body":{"instance_key":"megacode-Mp5VTYM2qds","jid":"5516994066336@s.whatsapp.net","messageType":"conversation","isBusiness":true,"key":{"remoteJid":"5516992975836@s.whatsapp.net","fromMe":false,"id":"3EB03A8BF406C73500716A"},"messageTimestamp":1755705864,"pushName":"Luis Gustavo Landucci","broadcast":false,"message":{"conversation":"first","messageContextInfo":{"deviceListMetadata":{"senderKeyHash":"WPqpxngRfZMFYQ==","senderTimestamp":"1755521044","senderAccountType":"E2EE","receiverAccountType":"E2EE","recipientKeyHash":"QSzVrqWSvvnr3w==","recipientTimestamp":"1755688392"},"deviceListMetadataVersion":2,"messageSecret":"rx3lmXoEepiJUQdpYHPEjJVDxKQlGYfUru++zEvjSCE="}},"verifiedBizName":"Luis Gustavo Landucci","isGroup":false},"webhookUrl":"https://primary-production-d79b.up.railway.app/webhook-test/admin","executionMode":"test"}}]},"versionId":"bb18acda-9715-4768-8f57-95d225fe50f2","triggerCount":1,"tags":[]}