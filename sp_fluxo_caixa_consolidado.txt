 CREATE OR REPLACE FUNCTION contab.sp_fluxo_caixa_consolidado (
    p_empresa_id BIGINT,
    p_data_ini   DATE,
    p_data_fim   DATE
)
RETURNS TABLE (
    saldo_inicial NUMERIC(14,2),
    entrada       NUMERIC(14,2),
    saida         NUMERIC(14,2),
    saldo_final   NUMERIC(14,2)
)
LANGUAGE sql
AS $$
WITH contas_caixa AS (
    SELECT id
    FROM contab.contas
    WHERE tipo = 'ATIVO'
      AND analitica = TRUE
      AND (
            codigo LIKE '1.1.1%'  -- Caixa
         OR codigo LIKE '1.1.2%'  -- Bancos
      )
),
movimentos AS (
    SELECT
        l.data_mov,
        CASE
            WHEN c.natureza = 'D' THEN COALESCE(l.debito,0)
            ELSE COALESCE(l.credito,0)
        END AS entrada,
        CASE
            WHEN c.natureza = 'D' THEN COALESCE(l.credito,0)
            ELSE COALESCE(l.debito,0)
        END AS saida
    FROM contab.lancamentos l
    JOIN contab.contas c ON c.id = l.conta_id
    WHERE l.empresa_id = p_empresa_id
      AND l.conta_id IN (SELECT id FROM contas_caixa)
),
saldo_implantacao AS (
    SELECT COALESCE(SUM(si.saldo),0) AS saldo
    FROM contab.saldos_iniciais si
    WHERE si.empresa_id = p_empresa_id
      AND si.conta_id IN (SELECT id FROM contas_caixa)
      AND si.data_base <= p_data_ini
)

SELECT
    -- SALDO INICIAL = implantação + movimentos antes do período
    (
      MAX(s.saldo)
      + COALESCE(SUM(CASE WHEN m.data_mov < p_data_ini THEN (m.entrada - m.saida) ELSE 0 END),0)
    ) AS saldo_inicial,

    -- ENTRADAS NO PERÍODO
    COALESCE(SUM(CASE WHEN m.data_mov BETWEEN p_data_ini AND p_data_fim THEN m.entrada ELSE 0 END),0) AS entrada,

    -- SAÍDAS NO PERÍODO
    COALESCE(SUM(CASE WHEN m.data_mov BETWEEN p_data_ini AND p_data_fim THEN m.saida ELSE 0 END),0) AS saida,

    -- SALDO FINAL = implantação + movimentos até data fim
    (
      MAX(s.saldo)
      + COALESCE(SUM(CASE WHEN m.data_mov <= p_data_fim THEN (m.entrada - m.saida) ELSE 0 END),0)
    ) AS saldo_final

FROM movimentos m
CROSS JOIN saldo_implantacao s;
$$;
