  

CREATE OR REPLACE FUNCTION salva_turno(
  p_user_id       int,
  p_id_empresa    int,
  p_quantidade    int,
  p_tamanho       text,
  p_json_opcoes   jsonb
)
RETURNS TABLE (
  posicao         int,
  numero          int,
  nome            text,
  categoria       text,
  descricao       text,
  preco_grande    numeric,
  preco_medio     numeric,
  preco_pequena   numeric,
  tamanho         text,
  quantidade      int
)
LANGUAGE plpgsql
AS $$
BEGIN
  -- 1) Zera opções anteriores do usuário/empresa
  DELETE FROM turno_opcoes
   WHERE id_empresa = p_id_empresa
     AND user_id    = p_user_id;

  -- 2) Insere as novas opções (SEM RETURNING!)
  INSERT INTO turno_opcoes (
    id_empresa, user_id, posicao, numero, nome, categoria, descricao,
    preco_grande, preco_medio, preco_pequena, escolhido, updated_at,
    tamanho, quantidade
  )
  SELECT
    p_id_empresa,
    p_user_id,
    ROW_NUMBER() OVER () AS posicao,
    (elem->>'numero')::int,
    elem->>'nome',
    elem->>'categoria',
    elem->>'descricao',
    NULLIF(elem->>'preco_grande','')::numeric,
    NULLIF(elem->>'preco_medio','')::numeric,
    NULLIF(elem->>'preco_pequena','')::numeric,
    false,
    now(),
    p_tamanho,
    p_quantidade
  FROM jsonb_array_elements(p_json_opcoes) AS elem;

  -- 3) Avança etapa (AGORA funciona, porque não teve RETURN antes)
  PERFORM adianta_etapa(p_user_id, p_id_empresa);

  -- 4) Retorna a visão atual já com etapa ajustada
  RETURN QUERY
  SELECT
    t.posicao, t.numero, t.nome, t.categoria, t.descricao,
    t.preco_grande, t.preco_medio, t.preco_pequena,
    t.tamanho, t.quantidade
  FROM turno_opcoes as t
  WHERE t.id_empresa = p_id_empresa
    AND t.user_id    = p_user_id
  ORDER BY t.posicao;
END;
$$;
