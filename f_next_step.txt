 CREATE OR REPLACE FUNCTION f_next_step(
  p_user_id int,
  p_id_empresa int
) RETURNS jsonb
LANGUAGE plpgsql AS $$
DECLARE 
  r turno_opcoes%ROWTYPE;
BEGIN
  SELECT * INTO r
  FROM turno_opcoes
  WHERE user_id=p_user_id 
       AND id_empresa=p_id_empresa 
  ORDER BY updated_at DESC LIMIT 1;

  IF NOT FOUND THEN
    RETURN jsonb_build_object('acao','nenhum','mensagem','Diga o que deseja do cardÃ¡pio.');
  END IF;

  -- 1) Sem escolha feita ainda â†’ pedir posiÃ§Ã£o
  IF r.etapa = 'pedir_posicao' THEN
    RETURN jsonb_build_object(
      'acao','pedir_posicao',
      'mensagem','Qual OPÃ‡ÃƒO da lista vocÃª quer (1â€“N)?'
    );
  END IF;

  -- 2) Falta quantidade
  IF r.etapa = 'falta_qtd' OR r.quantidade IS NULL OR r.quantidade <= 0 THEN
    RETURN jsonb_build_object(
      'acao','pedir_qtd',
      'mensagem','Quantas unidades vocÃª quer?'
    );
  END IF;

 -- ðŸŸ¡ Falta tamanho (somente pizza)
IF lower(btrim(coalesce(r.categoria,''))) = 'pizza' THEN
  IF r.etapa = 'falta_tamanho'
     OR r.tamanho IS NULL
     OR btrim(coalesce(r.tamanho,'')) = '' THEN
    RETURN jsonb_build_object(
      'acao','pedir_tamanho',
      'mensagem','Qual tamanho da pizza vocÃª quer? (mÃ©dia ou grande)'
    );
  END IF;
END IF;

  -- 3) Pronto para gravar intenÃ§Ã£o
  IF r.etapa = 'ready' AND r.quantidade > 0 AND r.escolhido THEN
    RETURN jsonb_build_object(
      'acao','gravar_intencao',
      'categoria', r.categoria,
      'numero', r.numero,
      'qtd', r.quantidade,
      'mensagem_confirm','Perfeito! Registrando seu item.'
    );
  END IF;

  -- fallback
  RETURN jsonb_build_object('acao','nenhum','mensagem','Vamos continuar: qual opÃ§Ã£o (1â€“N)?');
END;
$$;
