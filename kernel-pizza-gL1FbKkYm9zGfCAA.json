{"createdAt":"2025-09-18T15:44:58.320Z","updatedAt":"2025-09-24T23:59:24.370Z","id":"gL1FbKkYm9zGfCAA","name":"Kernel Pizza","active":true,"isArchived":false,"nodes":[{"parameters":{"operation":"executeQuery","query":" SELECT rejeita_item( {{ $('DadoPedido').item.json.user_id }}, {{ $('DadoPedido').item.json.pedido_id }}  );","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2672,192],"id":"d5d30080-47a6-459c-b463-883f0f46f96a","name":"RejeitaItem","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"fieldToSplitOut":"output.bebidas","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-48,-192],"id":"7a608843-94ae-4a9d-8a55-9f4222a0f6ab","name":"Bebidas","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"fieldToSplitOut":" output.pizzas_fracionadas","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-32,32],"id":"49dbeeb0-7863-4321-abc5-6aa8716b5d4c","name":"Pizzas Fracionada","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"fieldToSplitOut":"output.pizzas_inteiras","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-32,176],"id":"e738ed86-7847-426a-928a-9dd96bf35e0a","name":"Pizzas Inteira","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"fieldToSplitOut":"output.esfirras","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-32,320],"id":"158da210-0bc8-433a-9120-6fd036ad4d85","name":"Esfirra","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('MontPedido').item.json.user_id }}"},{"fieldId":"quantidade","fieldValue":"={{ $json.quantidade }}"},{"fieldId":"tipo","fieldValue":"bebida"},{"fieldId":"categoria","fieldValue":"bebida"},{"fieldId":"nome","fieldValue":"={{ $json.nome }}"},{"fieldId":"volume","fieldValue":"= {{ (($json.volume ?? '').toString().replace(/[\\s\\u00A0\\u200B-\\u200D\\uFEFF]+/g, '') === '')\n    ? ' volume desconhecido'\n    : ($json.volume ?? '').toString().replace(/[\\s\\u00A0\\u200B-\\u200D\\uFEFF]+/g, '') }}"},{"fieldId":"fracionada","fieldValue":"false"},{"fieldId":"pedido_id","fieldValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"fieldId":"numero","fieldValue":"={{ $json.numero ? $json.numero : 0 }}"},{"fieldId":"comando_original","fieldValue":"={{ $json.comando_original }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[208,-192],"id":"f7635034-812e-4fbd-aa0d-9042e5cc4409","name":"Itembebida","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('MontPedido').item.json.user_id }}"},{"fieldId":"quantidade","fieldValue":"={{ $json.quantidade }}"},{"fieldId":"categoria","fieldValue":"pizza"},{"fieldId":"fracionada","fieldValue":"true"},{"fieldId":"numero","fieldValue":"= {{ $json.metade1 }}"},{"fieldId":"numero_fracao","fieldValue":"={{ $json.metade2 }}"},{"fieldId":"tamanho","fieldValue":"grande"},{"fieldId":"fracionada","fieldValue":"true"},{"fieldId":"pedido_id","fieldValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"fieldId":"nome","fieldValue":"={{ $json.nome }}"},{"fieldId":"nome_fracao","fieldValue":"={{ $json.nome_fracao }}"},{"fieldId":"pizza_referencia","fieldValue":"={{$json.pizza_referencia.trim()}}"},{"fieldId":"comando_original","fieldValue":"={{ $json.comando_original }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[224,32],"id":"1a425d55-acc5-40b3-8035-6dea956073b8","name":"ItemFracionado","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('MontPedido').item.json.user_id }}"},{"fieldId":"quantidade","fieldValue":"={{ $json.quantidade }}"},{"fieldId":"categoria","fieldValue":"pizza"},{"fieldId":"fracionada","fieldValue":"false"},{"fieldId":"numero","fieldValue":"={{ String($json.numero ?? '').trim() === '' ? null : $json.numero }}"},{"fieldId":"tamanho","fieldValue":"={{ $json.tamanho.toLowerCase() }}"},{"fieldId":"fracionada","fieldValue":"false"},{"fieldId":"pedido_id","fieldValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"fieldId":"nome","fieldValue":"={{ $json.nome?.trim() === '' ? null : $json.nome }}"},{"fieldId":"pizza_referencia","fieldValue":"={{ $json.pizza_referencia }}"},{"fieldId":"comando_original","fieldValue":"={{ $json.comando_original }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[224,176],"id":"09a72d7a-7fcc-4cd4-97a6-28bd531c962c","name":"ItemInteira","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('MontPedido').item.json.user_id }}"},{"fieldId":"quantidade","fieldValue":"={{ $json.quantidade }}"},{"fieldId":"tipo","fieldValue":"bebida"},{"fieldId":"categoria","fieldValue":"esfirra"},{"fieldId":"nome","fieldValue":"={{ $json.nome?.trim() === '' ? null : $json.nome }}"},{"fieldId":"tipo","fieldValue":"={{ $json.tipo?.trim() === '' ? null : $json.tipo }}"},{"fieldId":"fracionada","fieldValue":"false"},{"fieldId":"pedido_id","fieldValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"fieldId":"numero","fieldValue":"={{ (String($json.numero ?? '').trim() === '' \n    || Number(String($json.numero).replace(',','.').trim()) === 0)\n  ? null \n  : $json.numero }}"},{"fieldId":"comando_original","fieldValue":"={{ $json.comando_original }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[224,320],"id":"59df7bdc-aed6-46b7-9f35-1a2bf7ec7cf3","name":"ItemEsfirra","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.outputParserAutofixing","typeVersion":1,"position":[-736,304],"id":"b399cce6-9e20-4758-989a-b43190cb9942","name":"Auto-fixing Output Parser","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"executeQuery","query":"WITH ordenado AS (\n  SELECT \n    item_id,\n    user_id,\n    pedido_id,\n    ROW_NUMBER() OVER (PARTITION BY user_id, pedido_id ORDER BY item_id) AS nova_ordem\n  FROM item_pedido_temp\n)\nUPDATE item_pedido_temp i\nSET ordem_item = o.nova_ordem\nFROM ordenado o\nWHERE i.item_id = o.item_id\n  AND i.user_id = o.user_id\n  AND i.pedido_id = o.pedido_id \n   and i.user_id =   {{ $('DadoPedido').item.json.user_id }} \n  and i.pedido_id = {{ $('DadoPedido').item.json.pedido_id }}  and  status = 'concluido'  ;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[3072,192],"id":"86faff93-e8fb-47a4-84e7-6d67471a8cd9","name":"OrdenaPedido","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":" UPDATE Item_pedido_temp AS i\nSET  status = 'concluido',\n   ordem_item = 0\n \nWHERE  status = 'inicio' and\n    user_id =  {{ $('DadoPedido').item.json.user_id }} and i.pedido_id = {{ $('DadoPedido').item.json.pedido_id }} and i.numero <> 0 ;\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2912,192],"id":"b5ebf3b9-d2df-4845-8e4c-e0c83e3097fa","name":"ConcluiTudo","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"fieldToSplitOut":"output.bordas","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-32,592],"id":"e56769d0-adcf-4271-8573-80a1dc184634","name":"Bordas","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"numberInputs":6},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[992,144],"id":"ec18115b-1dc9-4971-b260-adebc6788470","name":"Merge1","alwaysOutputData":false,"onError":"continueRegularOutput"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-864,544],"id":"29668865-9ed1-45b0-941b-049371b5e133","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"schemaType":"manual","inputSchema":" {\n  \"type\": \"object\",\n  \"properties\": {\n    \"pizzas_inteiras\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"quantidade\": { \"type\": \"integer\" },\n          \"numero\": { \"type\": \"integer\" },\n          \"tamanho\": { \"type\": \"string\" },\n           \"nome\": { \"type\": \"string\" },\n           \"pizza_referencia\":  { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" }\n          \n        },\n        \"required\": [\"quantidade\", \"numero\", \"tamanho\", \"pedido_id\"]\n      }\n    },\n    \"pizzas_fracionadas\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"quantidade\": { \"type\": \"integer\" },\n          \"metade1\": { \"type\": \"integer\" },\n          \"metade2\": { \"type\": \"integer\" },\n            \"nome\": { \"type\": \"string\" },\n            \"nome_fracao\": { \"type\": \"string\" },\n           \"pizza_referencia\":  { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" }\n         \n        },\n        \"required\": [\"quantidade\", \"metade1\", \"metade2\",\"pedido_id\"]\n      }\n    },\n    \"bebidas\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"quantidade\": { \"type\": \"integer\" },\n          \"nome\": { \"type\": \"string\" },\n          \"volume\": { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" }\n         \n        },\n        \"required\": [\"quantidade\", \"nome\", \"volume\",\"pedido_id\"]\n      }\n    },\n    \"esfirras\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"quantidade\": { \"type\": \"integer\" },\n          \"numero\": { \"type\": \"integer\" },\n          \"nome\": { \"type\": \"string\" },\n          \"tipo\": { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" }\n        },\n        \"required\": [\"quantidade\", \"numero\", \"nome\", \"tipo\"]\n      }\n    },\n    \"bordas\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"numero\": { \"type\": \"integer\" },\n          \"nome\": { \"type\": \"string\" } ,\n           \"pizza_referencia\":  { \"type\": \"string\" },\n          \"tamanho\": { \"type\": \"string\" }, \n          \"categoria\": { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" }\n  \n         \n    },\n        \"required\": [\"numero\", \"pizza_referencia\"]\n      }\n    },\n    \"item\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": { \n          \"nome\": { \"type\": \"string\" } ,\n           \"pizza_referencia\":  { \"type\": \"string\" } ,\n           \"comando_original\":  { \"type\": \"string\" }\n          \n    },\n        \"required\": [\"nome\", \"pizza_pai\"]\n      }\n    }\n\n    \n  },\n  \"required\": [\n    \"pizzas_inteiras\",\n    \"pizzas_fracionadas\",\n    \"bebidas\",\n    \"esfirras\",\n    \"bordas\" \n  ]\n}\n"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.2,"position":[-640,496],"id":"8e713269-9051-4c42-82c1-636de7005114","name":"Structured Output Parser [Schema]","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"promptType":"define","text":"=<mensagem_do_usuario>\n{{ $('When Executed by Another Workflow').item.json.mensagem }}\n</mensagem_do_usuario>","hasOutputParser":true,"messages":{"messageValues":[{"message":"=  {\n  \"pizzas_inteiras\": [\n    { \"quantidade\": int, \"numero\": int, \"tamanho\": str , \"nome\": str, \"pizza_referencia\": str, \"comando_original\": str  }   // pizza_referencia √© uma rela√ß√£o com a borda ou com item \n  ],\n  \"pizzas_fracionadas\": [\n    { \"quantidade\": int, \"metade1\": int, \"metade2\": int , \"nome\": str, \n\"nome_fracao\": str , \"pizza_referencia\": str, \"comando_original\": str }\n  ],\n  \"bebidas\": [\n    { \"quantidade\": int, \"nome\": str, \"volume\": str , \"comando_original\": str }\n  ],\n \"esfirras\": [\n  { \"quantidade\": int, \"numero\": int, \"nome\": str, \"tipo\": str , \"comando_original\": str} // tipo: \"salgada\" ou \"doce\"\n  ],\n  \"bordas\": [\n   \n { \"numero\": int, \"nome\": str, \"pizza_referencia\": str , \"tamanho\": str, \"categoria\": str, \"comando_original\": str } // pizza_referencia √© uma rela√ß√£o da borda com a pizza \n\n\n// \"pizza_referencia\" = string que identifica a pizza onde ser√° aplicada\n  ]\n \"item\": [\n    { \"nome\": str , \"pizza_pai\": int , \"comando_original\": str} //  \n  ]\n\n\n}\n\n‚ö†Ô∏è Regras obrigat√≥rias:\n- Sempre retorne exatamente essas 5 listas, mesmo que estejam vazias.\n- Use apenas os nomes de campos e estrutura mostrados acima.\n- Retorne **apenas o JSON v√°lido**, sem explica√ß√µes, coment√°rios ou texto adicional.\n\nSe o usu√°rio informar apenas ‚Äòpizza N‚Äô, n√£o descarte. Gere {quantidade:1, numero:N, tamanho:'media'} em pizzas_inteiras.‚Äù\n\n‚ÄúNunca omita itens amb√≠guos; use defaults: quantidade=1, tamanho='media'.‚Äù\n\n‚ÄúN√£o valide com o card√°pio. A valida√ß√£o ser√° feita depois; sempre retorne o item.‚Äù\n\n\"A palavra uma , duas  refere-se sempre  quantidade  exemplo uma  pizza mussarela ou uma pizza presunto e queijo √© quantidade..\"\n\n\n\nPrioridade de interpreta√ß√£o\n\nSe houver padr√µes de pizza fracionada no formato {Q? 1/2 A (e|,|+|/) 1/2 B}, crie um item em pizzas_fracionadas com {quantidade: Q || 1, metade1: A, metade2: B}.\n\nNunca crie pizzas_inteiras para n√∫meros A ou B quando eles estiverem dentro de um padr√£o fracionado.\n\nS√≥ trate ‚Äúpizza N‚Äù (inteira) quando n√£o fizer parte de um padr√£o 1/2 N.  \n\nSo trate   \"pizza\" se tiver explicito que se trata de \"pizza\"\n\nSo trate   \"esfirra \" se tiver explicito que se trata de \"esfirra\"\n\no comando_origianal guaro valor da string que gerou o json  exemplo :  ‚Äú1 pizza 1/2 14  e 1/2 21‚Äù\n\nRegras espec√≠ficas para BORDAS (muito importante):\n- Se a mensagem contiver ‚Äúborda‚Äù, o texto imediatamente ap√≥s a palavra ‚Äúborda‚Äù\n  at√© antes de ‚Äúao item‚Äù, ‚Äúno item‚Äù, ‚Äúitem‚Äù, ‚Äúpizza‚Äù ou o fim da frase, √© o campo \"nome\".\n- Normalize espa√ßos e min√∫sculas (ex.: \"Borda   Cheddar\" ‚Üí nome: \"cheddar\").\n- Sempre preencha \"categoria\":\"borda\" e \"pizza_pai\" com o n√∫mero do item/pizza alvo quando presente (ex.: \"item 1\" ‚Üí pizza_pai: 1).\n- N√£o use o campo \"item[]\"; bordas devem ir apenas em \"bordas[]\".\n- Defaults para borda quando ausentes: numero=0, tamanho=\"\", pizza_referencia=\"\".\n\n\n\nExemplos:\n\n‚Äú1 pizza 1/2 14  e 1/2 21‚Äù ‚Üí pizzas_fracionadas: [{quantidade:1, metade1:14, metade2:21, nome:'', nome_fracao: '' } ]\n\n‚Äú2 1/2 10, 1/2 15‚Äù ‚Üí pizzas_fracionadas: [{quantidade:2, metade1:10, metade2:15 , nome:'', nome_fracao: '' }]\n\n‚Äú14 e 21‚Äù (sem 1/2) ‚Üí pizzas_inteiras: [{q:1,n:14,media},{q:1,n:21,media }]\n\n\n\n‚Äú1 pizza 1/2 mussarela  e 1/2 presunto e queijo ‚Äù ‚Üí pizzas_fracionadas: [{quantidade:1, metade1:0, metade2:0, nome:mussarela, nome_fracao: presunto e queijo } ]\n\n‚Äú1 pizza meia  mussarela  e meia  presunto e queijo ‚Äù ‚Üí pizzas_fracionadas: [{quantidade:1, metade1:0, metade2:0, nome:mussarela, nome_fracao: presunto e queijo } ]\n\nSe o cliente disser meia  interprete como 1/2\n\n\n \nBebidas ‚Äî defaults e sin√¥nimos (obrigat√≥rio)\n\nSe o cliente disser ‚Äúlata‚Äù e n√£o informar volume, use 350ml.\n\nSe o cliente disser ‚Äúlong neck‚Äù e n√£o informar volume, use 330ml.\n\nSe o cliente pedir coca/coca-cola sem volume, use 2l.\n\nNunca rejeite bebidas por falta de volume quando se aplicar uma regra acima.\n\nNormalize o campo volume sempre em min√∫sculas e sem espa√ßos (ex.: 350ml, 330ml, 2l).\n\nExemplos\n\n‚Äú3 long neck heineken‚Äù ‚Üí bebidas: [{ \"quantidade\": 3, \"nome\": \"heineken\", \"volume\": \"330ml\" }]\n\n‚Äúlata bud‚Äù ‚Üí bebidas: [{ \"quantidade\": 1, \"nome\": \"budweiser\", \"volume\": \"350ml\" }]\n\n‚Äú2 coca‚Äù ‚Üí bebidas: [{ \"quantidade\": 2, \"nome\": \"coca cola\", \"volume\": \"2l\" }]\nPedido:\n{pedido}\n\nquando numa string de comando tiver 1 pizza musssarela  1 borda chedaar na qual o codigo da pizza n√£o for identifica,  crie no campo   \"pizza_referencia\" uma amarra√ß√£o entre 1 pizza mussarela e borda   \"pizza_referencia\" pode ser um codigo unico. Isso vale tambpem para pizza fracionada \n\n"}]}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.6,"position":[-800,64],"id":"03c7b5ef-890b-43ea-9e04-b190ee33affa","name":"Basic LLM Chain","retryOnFail":true,"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"fieldToSplitOut":"output.item","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-32,448],"id":"52506e17-3640-4a5c-97f2-d75318f09678","name":"item4","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('MontPedido').item.json.user_id }}"},{"fieldId":"quantidade","fieldValue":"=1"},{"fieldId":"tipo","fieldValue":"item"},{"fieldId":"categoria","fieldValue":"item"},{"fieldId":"nome","fieldValue":"={{ $json.nome?.trim() === '' ? null : $json.nome }}"},{"fieldId":"numero","fieldValue":"=0"},{"fieldId":"fracionada","fieldValue":"=false"},{"fieldId":"pedido_id","fieldValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"fieldId":"tamanho","fieldValue":"=0"},{"fieldId":"comando_original","fieldValue":"={{ $json.comando_original }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[224,448],"id":"5f4ecb21-f345-44c7-92f8-9be2a993f5f8","name":"Item4","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT AtualizaValorFracionado(  {{ $('DadoPedido').item.json.user_id }},{{ $('DadoPedido').item.json.pedido_id }});","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2448,192],"id":"a381a11d-a7c7-4aa3-aa57-c6a67985f4bb","name":"AtualizaValorPizzaFracionada2","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT   atualizar_valores_itens_temp( {{ $('DadoPedido').item.json.user_id }},{{ $('DadoPedido').item.json.pedido_id }} );","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2224,192],"id":"157dbe1e-050f-456b-ac79-2d88e1607752","name":"AtualizaValorItem2","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('MontPedido').item.json.user_id }}"},{"fieldId":"quantidade","fieldValue":"=1"},{"fieldId":"tipo","fieldValue":"borda"},{"fieldId":"categoria","fieldValue":"borda"},{"fieldId":"nome","fieldValue":"={{ $('Bordas').item.json.nome }}"},{"fieldId":"numero","fieldValue":"={{ $json.numero ? $json.numero : 0 }}"},{"fieldId":"fracionada","fieldValue":"=false"},{"fieldId":"pedido_id","fieldValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"fieldId":"tamanho","fieldValue":"={{ $json.tamanho }}"},{"fieldId":"pizza_referencia","fieldValue":"={{ $json.pizza_referencia }}"},{"fieldId":"comando_original","fieldValue":"={{ $json.comando_original }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[224,592],"id":"754e1ee8-60ce-4a79-9dc7-aa77cf2359e8","name":"Item5","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"assignments":{"assignments":[{"id":"a3c83333-8ce3-4995-8230-b361099aa1e4","name":"user_id","value":"={{ $('When Executed by Another Workflow').item.json.user_id }}","type":"number"},{"id":"d7c14753-505f-48ee-a344-fa565ace43df","name":"pedido_id","value":"={{ $('When Executed by Another Workflow').item.json.pedido_id }}","type":"number"},{"id":"fdf33d81-37b4-46c9-b56a-6787b3d92dac","name":"rotina","value":"={{ $('When Executed by Another Workflow').item.json.rotina }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2064,-768],"id":"a6418514-62bb-4f8a-b1e3-7debd49a46c5","name":"MontPedido"},{"parameters":{"assignments":{"assignments":[{"id":"8033b503-a34e-4682-a40a-b60b315714e6","name":"user_id","value":"={{ $json.user_id }}","type":"number"},{"id":"bd4fde4d-0d15-4271-945c-571b24973379","name":"pedido_id","value":"={{ $json.pedido_id }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1344,192],"id":"8373ecb1-043b-4540-895e-8bb63b1ffe3a","name":"DadoPedido","executeOnce":true},{"parameters":{"operation":"executeQuery","query":"call valida_nome_item_pedido( {{ $json.user_id }} , {{ $json.pedido_id }});","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1536,192],"id":"fe8bc0da-85fc-4616-8f56-8b2747cc414e","name":"ValidaItemNome","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"assignments":{"assignments":[{"id":"9f488c5c-0b3b-48e9-87b1-5a22d513d1ec","name":"IdConversa","value":"={{ $('When Executed by Another Workflow').item.json.telefone }}","type":"string"}]},"options":{}},"id":"63df038e-25e8-410b-8781-94308aa7e0c4","name":"Dados Lead","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2272,-768],"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"resource":"messages-api","instanceName":"=delivery","remoteJid":"= {{$('Dados Lead').first().json.IdConversa}}","messageText":"=```{{ $json.message.content }}```","options_message":{"delay":4}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[3584,192],"id":"d942bd11-aad4-4a6e-aba8-6544cb118f2a","name":"MenuCardapio","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{"operation":"executeQuery","query":"\nselect numero, tamanho, fracionada, categoria, nome,  \n(case when categoria <> 'bebida' then '' else volume end)  , status, valor  from item_pedido_temp where status  ='rejeitado'\nand user_id =    {{ $('DadoPedido').item.json.user_id }} \nand pedido_id =  {{ $('DadoPedido').item.json.pedido_id }}","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[3920,448],"id":"a924e254-623b-401d-a3b7-3c07de02ad05","name":"GetProblemas","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"       select count(*) total_op√ß√µes ,  o.item_id , comando_original  , categoria   , fracionada, valor \n   from item_opcoes  o    \n   join  item_pedido_temp i \n   on  o.item_id = i.item_id  where\n            i.user_id =   {{ $('DadoPedido').item.json.user_id }}\n          AND i.pedido_id =    {{ $('DadoPedido').item.json.pedido_id }}\n    group by o.item_id ,   comando_original  , fracionada , categoria  , valor \n\n\n ","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[4464,384],"id":"75ed7fd2-e03e-46bc-a36e-7015dd00fbbc","name":"GetOpcoes","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"  select calcula_pre_pedido({{ $('DadoPedido').item.json.user_id }}, {{ $('DadoPedido').item.json.pedido_id }}  );","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[3392,448],"id":"11117d42-0441-4708-b771-ddacf0ea0356","name":"GetCarrinho","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":" \n\nUPDATE item_pedido_temp AS ib\nSET id_pizza_pai = ip.item_id\nFROM item_pedido_temp AS ip\nWHERE ib.pizza_referencia IS NOT NULL\n  AND LENGTH(TRIM(ib.pizza_referencia)) > 1\n  AND ib.status = 'inicio'\n  AND ib.categoria IN ('item','borda')\n  AND ip.pizza_referencia IS NOT NULL\n  AND LENGTH(TRIM(ip.pizza_referencia)) > 1\n  AND ip.status = 'inicio'\n  AND ip.categoria = 'pizza'\n  AND ib.user_id = ip.user_id\n  AND ib.pedido_id = ip.pedido_id\n  AND ib.user_id =  {{ $('DadoPedido').item.json.user_id }} \n  AND ib.pedido_id =  {{ $('DadoPedido').item.json.pedido_id }}\n  AND ib.pizza_referencia = ip.pizza_referencia;\n\n ","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1760,192],"id":"623d8730-7d3e-4b28-b8f2-47db6bc22d80","name":"VinculaBordaItemPizza","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{"temperature":0.1}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[224,-528],"id":"0f56742b-affa-497c-bde4-75bf60479a63","name":"OpenAI Chat Model2","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"43534543534","contextWindowLength":3},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[336,-560],"id":"f5e05165-597b-4bc3-aa8c-f577775e46a5","name":"Simple Memory1"},{"parameters":{"operation":"update","tableId":"usuario_lacantina","filters":{"conditions":[{"keyName":"user_id","condition":"eq","keyValue":"={{ $('MontPedido').item.json.user_id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"endere√ßo","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues0_Field_Value', `endere√ßo `, 'string') }}"},{"fieldId":"bairro","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues1_Field_Value', `bairro`, 'string') }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[768,-544],"id":"5dd9d402-25cd-475b-88a2-bfd4d571b918","name":"SalvaEndereco","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"tableId":"comentario_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $json.user_id }}"},{"fieldId":"pedido_id","fieldValue":"={{ $json.pedido_id }}"},{"fieldId":"comentario","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues2_Field_Value', `Comentario campo`, 'string') }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[368,-432],"id":"4466276d-e81b-455b-a0d7-bc04e4bd27c4","name":"Comentario","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"operation":"update","tableId":"pedido_temp","filters":{"conditions":[{"keyName":"user_id","condition":"eq","keyValue":"={{ $('MontPedido').item.json.user_id }}"},{"keyName":"pedido_id","condition":"eq","keyValue":"= {{ $('MontPedido').item.json.pedido_id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"tipo_cobranca","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues0_Field_Value', `forma_pagamento`, 'string') }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[560,-464],"id":"c654bfb2-2b66-4255-8f5a-0a0c547d7d3f","name":"SalvaFormaPagto","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"descriptionType":"manual","toolDescription":"Execute a SQL query in Postgres fechamento ","operation":"executeQuery","query":"SELECT * from finalizar_pedido(    {{ $('MontPedido').item.json.user_id }} , {{ $('MontPedido').item.json.pedido_id }} ;) ;","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[656,-400],"id":"527da8aa-05f5-43a7-bcf0-344fdaf6d5ba","name":"Fechamento","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"resource":"messages-api","instanceName":"=delivery","remoteJid":"={{ $('Dados Lead').item.json.IdConversa }}","messageText":"=```{{ $json.output }}```","options_message":{"delay":4}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[736,-752],"id":"eb621430-0a3a-4261-ae41-1c9ebf61d4d2","name":"MenuCardapio1","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{"operation":"executeQuery","query":"  select calcula_pre_pedido(   {{ $('MontPedido').item.json.user_id }} , {{ $('MontPedido').item.json.pedido_id }}) ;","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[480,-368],"id":"5267879a-d5b7-4e4a-8c7f-a08b6f436970","name":"GetCarrinho1","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"update item_pedido_temp \n  set status = 'enviado'\n  where user_id =   {{ $('MontPedido').item.json.user_id }}  \n  and   pedido_id =    {{ $('MontPedido').item.json.pedido_id }}  and  status = 'fechamento'  ;\n \n  ","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[816,-400],"id":"0670b9ba-bc75-48f9-9e7b-f3e940fd84f0","name":"Execute a SQL query in Postgres","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"assignments":{"assignments":[{"id":"66a91f66-e755-4120-b22f-44c814f56162","name":"message","value":"={{ $json.mensagem }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2512,-768],"id":"03833dad-39dc-4ec9-8164-85890b68dea4","name":"MensagemTraduzida","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"workflowInputs":{"values":[{"name":"mensagem"},{"name":"user_id","type":"number"},{"name":"pedido_id","type":"number"},{"name":"telefone"},{"name":"rotina","type":"number"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-2768,-768],"id":"cc6d6912-cf38-4e7d-9d5e-f165d4a45897","name":"When Executed by Another Workflow"},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"messages":{"values":[{"content":"=# Persona\nVoc√™ √© respons√°vel por mostrar o carrinho do cliente de forma clara e objetiva.\n\n# Regras\n1. Sempre chame GetCarrinho( ).\n2. Mostre os itens numerados, quantidade, descri√ß√£o e valor.\n3. Finalize com subtotal, entrega e total.\n4. N√£o invente itens nem pre√ßos.\n5. Seja simp√°tico, mas n√£o d√™ opini√µes ou sugest√µes.\n\n# Regras adicionais\n- Sempre inicie a resposta com exatamente:\n  üõí Carrinho:\n- Nunca remova ou altere esse cabe√ßalho. Ele deve aparecer sempre na primeira linha. mostre os dados n√£o altere nada e nem de sugest√µes. Voc√™ so mostra dados. No maximo diga aqui esta o seu carrinho. algo agrad√°vel apois exibir os dados. N√£o mexa nos dados\n\n\n\n# Tool dispon√≠vel\n- GetCarrinho( )\n","role":"system"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[3264,192],"id":"07710563-a738-4c6b-b817-dd306235cab4","name":"Carinnho","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"messages":{"values":[{"content":"= # Persona\nVoc√™ informa de forma clara e curta se houve itens rejeitados ou n√£o encontrados.\n\n# Regras\n1. Sempre chame GetRejeitados() mas n√£o mostre para usuario.\n2. Mostre os itens rejeitados numa lista simples.\n3. Nunca invente substitui√ß√µes.\n4. Apenas diga: ‚ÄúDeseja tentar escolher outra coisa para esses itens?‚Äù\n \n\n- Nunca remova ou altere esse cabe√ßalho. Ele deve aparecer sempre na primeira linha. mostre os dados n√£o altere nada e nem de sugest√µes. Voc√™ so mostra dados. \n\n\n \n# Tool dispon√≠vel\n- GetRejeitados()","role":"system"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[3776,192],"id":"10d4654e-5a34-4874-9f8f-e9980c232a27","name":"Issue","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"resource":"messages-api","instanceName":"=delivery","remoteJid":"= {{$('Dados Lead').first().json.IdConversa}}","messageText":"=```{{ $json.message.content }}```","options_message":{"delay":4}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[4096,192],"id":"ebe4104e-7f71-468e-88a3-716a8563a1ac","name":"Issue1","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{"resource":"messages-api","instanceName":"=delivery","remoteJid":"= {{$('Dados Lead').first().json.IdConversa}}","messageText":"=```{{ $json.message.content }}```","options_message":{"delay":4}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[4640,192],"id":"34a4487d-2877-4838-a8d4-b0b4e25adbf5","name":"Issue3","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"messages":{"values":[{"content":"= # Persona\nVoc√™ ajuda o cliente a escolher quando um item tem m√∫ltiplas op√ß√µes.\n\n# Regras\n1. Sempre chame GetOpcoes ().\n2. Mostre as op√ß√µes numeradas e inclua sempre:\n   - Tota de op√ß√µes  total_op√ß√µes  (ex: `(3) op√ß√µes`)\n   - N√∫mero do card√°pio (ex: `(23)`)\n   - Nome da pizza\n   - Pre√ßos (grande / m√©dia, se dispon√≠veis)\n   - Indica√ß√£o de fracionada: `üçï Fracionada: Sim` ou `‚ùå Fracionada: N√£o`\n3. Cada op√ß√£o deve ser exibida em **duas ou tr√™s linhas**:\n   - Linha 1: n√∫mero sequencial + n√∫mero do card√°pio + nome + pre√ßo.\n    \n   - Linha 2 (se existir campo fracionada): status da fracionada.\n4. Diga ao cliente que: ‚ÄúVamos lhe ajudar com a montagem. OK?‚Äù \n5. Nunca invente op√ß√µes extras, use apenas o retorno da tool.\n\n# Tool dispon√≠vel\n- GetOpcoes()\n","role":"system"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[4320,192],"id":"392376a1-567b-4410-b5dd-454429e4e315","name":"Opcoes","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"httpMethod":"POST","path":"agente","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-2352,-1472],"id":"a5faf8cf-3ff7-4b2e-a69d-820f663b9329","name":"Webhook","webhookId":"66949457-5339-4325-b499-9a15d57ff6a1"},{"parameters":{"assignments":{"assignments":[{"id":"a3c83333-8ce3-4995-8230-b361099aa1e4","name":"user_id","value":"=72","type":"number"},{"id":"d7c14753-505f-48ee-a344-fa565ace43df","name":"pedido_id","value":"=18","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1616,-1472],"id":"4b938162-d19c-4b67-8fcc-5bbbcedad775","name":"MontPedido2"},{"parameters":{"assignments":{"assignments":[{"id":"9f488c5c-0b3b-48e9-87b1-5a22d513d1ec","name":"IdConversa","value":"=5516992975836","type":"string"}]},"options":{}},"id":"807a7a22-5c0f-48b6-95f1-af7c9103f468","name":"Dados Lead1","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1968,-1472],"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"assignments":{"assignments":[{"id":"66a91f66-e755-4120-b22f-44c814f56162","name":"message","value":"={{ $json.body.data.message.conversation }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2144,-1472],"id":"8bed62c6-6564-42a1-ae42-e0bc523413c6","name":"MensagemTraduzida1","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"resource":"messages-api","instanceName":"=delivery","remoteJid":"= {{ $('Dados Lead1').item.json.IdConversa }}","messageText":"=```{{ $json.output }}```","options_message":{"delay":4}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[256,-1376],"id":"a5155701-51df-4242-a46c-914118a1e42b","name":"MenuCardapio2","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{"operation":"executeQuery","query":"  call popula_item_opcoes( {{ $('DadoPedido').item.json.user_id }}, {{ $('DadoPedido').item.json.pedido_id }}  );","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1984,192],"id":"de0d183a-8dcd-42c0-b5e8-39a52c8170f4","name":"InsereOpcoesItens","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":" SELECT * FROM  GetPizzaMontagem(    {{ $('MontPedido').item.json.user_id }} , {{ $('MontPedido').item.json.pedido_id }} ) ;","options":{"largeNumbersOutput":"numbers"}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[-80,-1120],"id":"e2177701-b0d4-445f-8cbf-55137d8a3e15","name":"GetPizzaMontagem","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"gpt-4o-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-224,-1120],"id":"f067a71b-fd1d-4322-9807-033b71ccbd42","name":"OpenAI Chat Model3","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"promptType":"define","text":"={{ $('MensagemTraduzida1').item.json.message }}","options":{"systemMessage":"=   #Persona\n\nVoc√™ √© um atendente de pizzaria respons√°vel por ajudar o cliente a resolver itens que ficaram em ‚Äúop√ß√µes‚Äù no carrinho.\nSempre trate apenas um item por vez at√© acabar. \n\nREGRA 0 (priorit√°ria, primeira a√ß√£o):\n\nNa primeira mensagem deste atendimento, chame IMEDIATAMENTE a ferramenta EscolheOpcao, GetPizzaMontagem e GetOpcMontagem e Atualiza.\nN√£o escreva texto antes disso. N√£o fa√ßa nenhuma outra chamada antes.\nAp√≥s o retorno, prossiga com o fluxo normal.\n\n\n#Fluxo obrigat√≥rio\n\n \nexecute  GetPizzaMontagem(  )\nlinha  de dados  (resultado de  GetPizzaMontagem exatamente como vier no banco:\nN√ÉO reenumere. Use o valor da coluna opcao.\n \n \n \n\nSe n√£o houver itens ‚Üí responda apenas:\n‚úÖ Todas as op√ß√µes foram resolvidas, podemos prosseguir com o fechamento do pedido.\n\nSe houver item ‚Üí mostre o campo comando_original.\n\nListe as op√ß√µes numeradas 1‚Ä¶N resultado da  GetOpcoesMontagem(item_id) :\n1Ô∏è‚É£ (<numero>) <nome> ‚Äì R$ <preco>\n‚ÑπÔ∏è Descri√ß√£o: <descricao>\nüçï Fracionada: Sim/N√£o\n\nPergunte: ‚ÄúQual op√ß√£o voc√™ escolhe? Responda com 1‚Ä¶N.‚Äù\n\nSe o cliente responder um n√∫mero v√°lido (1‚Ä¶N):\n\n\nSe o cliente responder um n√∫mero v√°lido (1‚Ä¶N):\n\nLocalize a linha cuja opcao = n√∫mero digitado.\n\nUse o mesmo item_id atual e o numero (c√≥digo do card√°pio) dessa linha.\n\nChame Atualiza preenchendo apenas os campos num√©ricos:\n\nitem_id = (o mesmo do item atual)\n\nnumero = (valor da coluna numero da op√ß√£o escolhida)\n\nNunca use o √≠ndice 1‚Ä¶N como numero. numero √© o c√≥digo do card√°pio.\n\nSe o cliente responder fora de 1‚Ä¶N:\nDiga: ‚ÄúN√£o entendi. Por favor, responda com um n√∫mero v√°lido (1‚Ä¶N).‚Äù e reapresente a mesma lista.\n \nUse exatamente o mesmo item_id retornado por GetPizzaMontagem.\n\nPegue o numero correspondente da lista de GetOpcoesMontagem (1556).\n\n \nDepois volte ao passo 1 (GetPizzaMontagem) at√© n√£o restarem itens.\n\nSe o cliente responder fora de 1‚Ä¶N ‚Üí diga:\n‚ùå N√£o entendi. Por favor, responda com um n√∫mero v√°lido.\n(Reexiba a mesma lista anterior).\n\nTools dispon√≠veis\n\nGetPizzaMontagem ()\n\nGetOpcoesMontagem( 1556)\n \n\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[-112,-1376],"id":"694c7130-f060-47e1-b354-4db6c6c0ba18","name":"AI Agent1","notesInFlow":false},{"parameters":{"assignments":{"assignments":[{"id":"0d78d99f-fa3e-4f51-82d8-af0b018dbcb7","name":"session_key","value":"={{ String( ( $('Dados Lead1') && $('Dados Lead1').item && $('Dados Lead1').item.json && $('Dados Lead1').item.json.IdConversa ) || ( $json && $json.IdConversa ) || 'fallback' ) }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1808,-1472],"id":"663a7fce-0534-4546-af1e-aeee16aa1a4f","name":"SessionKey"},{"parameters":{"operation":"executeQuery","query":" SELECT *\nFROM GetOpcoes( $1);\n","options":{"queryReplacement":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Query_Parameters', `item_id`, 'string') }}","largeNumbersOutput":"numbers"}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[48,-1104],"id":"c78b7be0-579b-4a2c-bd9a-b10d2381f3d1","name":"GetOpcMontagem","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"gpt-4o-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[3616,-256],"id":"6e6f6763-5243-42f3-8cb3-df8e4a48a6a4","name":"OpenAI Chat Model4","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"operation":"update","tableId":"item_pedido_temp","matchType":"allFilters","filters":{"conditions":[{"keyName":"item_id","condition":"eq","keyValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conditions0_Field_Value', `item_id`, 'string') }}"},{"keyName":"user_id","condition":"eq","keyValue":"=  {{ $('MontPedido2').item.json.user_id }}"},{"keyName":"pedido_id","condition":"eq","keyValue":"={{ $('MontPedido2').item.json.pedido_id }}"},{"keyName":"numero","condition":"eq","keyValue":"0"}]},"fieldsUi":{"fieldValues":[{"fieldId":"numero","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues0_Field_Value', ``, 'string') }}"},{"fieldId":"status","fieldValue":"inicio"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[3792,-304],"id":"71293d82-2756-498c-8dad-b39d8d665577","name":"AtualizaItemtemp1","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"promptType":"define","text":"={{ $('MensagemTraduzida1').item.json.message }}","options":{"systemMessage":"= #Persona\n\nVoc√™ √© um atendente de pizzaria respons√°vel por ajudar o cliente a resolver itens que ficaram em ‚Äúop√ß√µes‚Äù no carrinho.\nSempre trate apenas um item por vez at√© acabar.\n\n#Fluxo obrigat√≥rio\n\n1 Chame GetPizzaMontagem( ).\n\n2 execute GetOpcMontagem(item_id)   \napos  passo 1.  \n\nSe n√£o houver itens ‚Üí responda apenas:\n‚úÖ Todas as op√ß√µes foram resolvidas, podemos prosseguir com o fechamento do pedido.\n\nSe houver item ‚Üí mostre o campo comando_original.\n\nListe as op√ß√µes numeradas 1‚Ä¶N resultado da  GetOpcoesMontagem(item_id) :\n1Ô∏è‚É£ (<numero>) <nome> ‚Äì R$ <preco>\n‚ÑπÔ∏è Descri√ß√£o: <descricao>\nüçï Fracionada: Sim/N√£o\n\nPergunte: ‚ÄúQual op√ß√£o voc√™ escolhe? Responda com 1‚Ä¶N.‚Äù\n\nSe o cliente responder um n√∫mero v√°lido (1‚Ä¶N):\n\nUse exatamente o mesmo item_id retornado por GetPizzaMontagem.\n\nPegue o numero correspondente da lista de GetOpcoesMontagem (item_id).\n\nChame AtualizaItem(item_id,numero) .\n  \nDepois volte ao passo 1 (GetPizzaMontagem) at√© n√£o restarem itens.\n\nSe o cliente responder fora de 1‚Ä¶N ‚Üí diga:\n‚ùå N√£o entendi. Por favor, responda com um n√∫mero v√°lido.\n(Reexiba a mesma lista anterior).\n\nTools dispon√≠veis\n\nGetPizzaMontagem ()\n\nGetOpcoesMontagem(item_id)\n\nAtualizaItem(item_id, numero)\n\nRegras\n\nNunca invente op√ß√µes, pre√ßos ou c√≥digos.\n\nNunca pe√ßa user_id ou pedido_id ao cliente.\n\nSempre siga a ordem: GetPizzaMontagem ‚Üí GetOpcoesMontagem ‚Üí AtualizaItem ‚Üí repetir."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[3632,-592],"id":"01eac990-3bc8-46b3-bf04-cd566af33634","name":"AI Agent3"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('SessionKey').item.json.session_key }}"},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[3664,-320],"id":"28aebb0c-3c83-43af-8a9c-2b04967ed4b6","name":"Postgres Chat Memory1","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":" SELECT * FROM  GetPizzaMontagem(    {{ $('MontPedido').item.json.user_id }} , {{ $('MontPedido').item.json.pedido_id }} ) ;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-752,-1376],"id":"b013dad7-f696-4bc4-b5f9-a25fdbfd2ef6","name":"Montagem","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"88562244-0734-4bd1-ad22-d614ab675052","leftValue":"={{ $json.numero }}","rightValue":0,"operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-992,-1344],"id":"ca874184-03fe-4330-b617-21cba9e9efcb","name":"If1"},{"parameters":{"jsCode":" // n8n Function node\nconst msg = $('MensagemTraduzida1').item?.json?.message ?? ($json.message ?? '');\nconst nums = (String(msg).match(/\\d+/g) || []).map(n => Number(n));\n\nif (nums.length === 1 && Number.isFinite(nums[0])) {\n  return [{ json: { numero: nums[0], mensagem: 'ok' } }];\n}\n\nreturn [{ json: { numero: 0, mensagem: 'blabdbsfsb' } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1248,-1344],"id":"05c4727e-6e13-4a05-9352-de827b1c2cf4","name":"Code2"},{"parameters":{"resource":"messages-api","instanceName":"=delivery","remoteJid":"= {{ $('Dados Lead1').item.json.IdConversa }}","messageText":"=``` Escolha uma op√ß√£o valida por favor.```","options_message":{"delay":4}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[-624,-1152],"id":"80a741de-611d-4292-8dee-55292e2a2521","name":"MenuCardapio3","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{"operation":"executeQuery","query":"\nupdate item_opcoes\nset habilitada = true  \nwhere item_id = {{ $json.item_id }}  and\nopcao =  {{ $('Code2').item.json.numero }}   \n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-544,-1376],"id":"967b5815-37f7-4a8c-a340-048823ebc3ce","name":"Execute a SQL query","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"\nupdate item_pedido_temp as  i \nset status = 'concluido',\nnumero = o.numero ,\nnome =    '(' || o.numero::text || ') ' || o.nome\nfrom item_opcoes as o \nwhere i.item_id = {{ $('Montagem').item.json.item_id }}  and\ni.numero = 0 and  user_id=  {{ $('MontPedido').item.json.user_id }} and pedido_id = {{ $('MontPedido').item.json.pedido_id }}\nand o.item_id =  i.item_id and \no.habilitada = true and i.numero = 0 ;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-336,-1376],"id":"7b4d8d69-b07a-41df-be33-95d0914d0124","name":"Execute a SQL query2","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"promptType":"define","text":"={{ $('MensagemTraduzida').item.json.message }}","options":{"systemMessage":"= # Persona\nVoc√™ √© um atendente de pizzaria respons√°vel por fechar pedidos de forma organizada e simp√°tica.  \nSeu papel √© colher os dados finais (endere√ßo, bairro, forma de pagamento e coment√°rio), salvar cada um deles usando as ferramentas dispon√≠veis e, somente quando tudo estiver confirmado, executar o fechamento do pedido.\n\n# Regras de Atendimento\n1. Ordem obrigat√≥ria de coleta:\n\n   - Primeiramente: Mostrar o carrinho atual usando GetCarrinho1( ) e perguntar se o cliente confirma o fechamento do pedido.   \n     - Se o cliente disser \"sim\", prossiga para os pr√≥ximos passos Fechamento().   \n     - Se o cliente disser \"n√£o\", conitunua antendendo.\n\n   - Depois: Endere√ßo completo (rua + n√∫mero) e Bairro ‚Üí use SalvaEndereco(user_id, pedido_id, endereco, bairro).\n   - Depois: Forma de pagamento ‚Üí use SalvaFormaPagto(user_id, pedido_id, forma_pagto).\n   - Depois: Coment√°rio ou observa√ß√µes ‚Üí use Comentario(user_id, pedido_id, comentario).\n   - Por √∫ltimo: Execute PosFechamento(user_id, pedido_id).\n2. Sempre valide se o cliente forneceu a informa√ß√£o correta.  \n   - Se faltar algo (ex: o cliente manda s√≥ a rua sem bairro), pe√ßa novamente de forma clara e curta.\n3. Somente quando endere√ßo, bairro, forma de pagamento e coment√°rio tiverem sido salvos com sucesso, execute PosFechamento().\n4. Se alguma tool retornar erro, informe o cliente e pe√ßa o dado novamente.\n5. Nunca finalize o pedido sem executar PosFechamento().\n6. Nunca invente dados; sempre utilize o que o cliente informou.\n7. Use uma linguagem simp√°tica e objetiva.\n\n \n \n \n\n- Nunca pergunte ao cliente o user_id ou pedido_id.\n- Esses dados j√° s√£o fornecidos automaticamente pelo fluxo e voc√™ deve us√°-los diretamente ao chamar as tools.\n\n\n# Tools dispon√≠veis\n- GetCarrinho1( )\n- SalvaEndereco  endereco, bairro)\n- SalvaFormaPagto(  forma_pagto)\n- Comentario(  comentario)\n- PosFechamento  pedido_id)\n-VoltaPedido( ) \n\n# Fluxo esperado\n1. Mostrar carrinho ‚Üí chamar GetCarrinho() ‚Üí perguntar se o cliente confirma.\n   - Se sim ‚Üí seguir para pr√≥ximo passo.\n   - Se n√£o ‚Üí encerrar sem fechar pedido.\n2. Perguntar endere√ßo e bairro ‚Üí chamar SalvaEndereco().\n3. Perguntar forma de pagamento ‚Üí chamar SalvaFormaPagto().\n4. Perguntar se h√° coment√°rio ou observa√ß√£o extra ‚Üí chamar Comentario().\n5. Confirmar que tudo foi salvo com sucesso.\n6. Executar PosFechamento() e avisar o cliente que o pedido foi finalizado com sucesso üéâ.\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[336,-752],"id":"ad59e662-f3b3-4946-b211-c4d37f4bf9b1","name":"Fechamento1"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.rotina }}","rightValue":3,"operator":{"type":"number","operation":"equals"},"id":"e3160797-555d-41ca-a0d5-60a5caf4fb75"}],"combinator":"and"},"renameOutput":true,"outputKey":"montagem"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"e96fc6ed-5139-4fcb-8523-91c5ad9d6f23","leftValue":"={{ $json.rotina }}","rightValue":2,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"fechamento"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0fb4b223-80cf-4071-ba32-727a64e9d77f","leftValue":"={{ $json.rotina }}","rightValue":1,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"constroi"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-1840,-768],"id":"83c5c999-841e-4b52-b01a-df440f3849d1","name":"Switch"}],"connections":{"RejeitaItem":{"main":[[{"node":"ConcluiTudo","type":"main","index":0}]]},"Bebidas":{"main":[[{"node":"Itembebida","type":"main","index":0}]]},"Pizzas Fracionada":{"main":[[{"node":"ItemFracionado","type":"main","index":0}]]},"Pizzas Inteira":{"main":[[{"node":"ItemInteira","type":"main","index":0}]]},"Esfirra":{"main":[[{"node":"ItemEsfirra","type":"main","index":0}]]},"Itembebida":{"main":[[{"node":"Merge1","type":"main","index":0}]]},"ItemFracionado":{"main":[[{"node":"Merge1","type":"main","index":1}]]},"ItemInteira":{"main":[[{"node":"Merge1","type":"main","index":2}]]},"ItemEsfirra":{"main":[[{"node":"Merge1","type":"main","index":3}]]},"Auto-fixing Output Parser":{"ai_outputParser":[[{"node":"Basic LLM Chain","type":"ai_outputParser","index":0}]]},"OrdenaPedido":{"main":[[{"node":"Carinnho","type":"main","index":0}]]},"ConcluiTudo":{"main":[[{"node":"OrdenaPedido","type":"main","index":0}]]},"Bordas":{"main":[[{"node":"Item5","type":"main","index":0}]]},"Merge1":{"main":[[{"node":"DadoPedido","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"Auto-fixing Output Parser","type":"ai_languageModel","index":0},{"node":"Basic LLM Chain","type":"ai_languageModel","index":0}]]},"Structured Output Parser [Schema]":{"ai_outputParser":[[{"node":"Auto-fixing Output Parser","type":"ai_outputParser","index":0}]]},"Basic LLM Chain":{"main":[[{"node":"Bebidas","type":"main","index":0},{"node":"Pizzas Fracionada","type":"main","index":0},{"node":"Pizzas Inteira","type":"main","index":0},{"node":"Esfirra","type":"main","index":0},{"node":"item4","type":"main","index":0},{"node":"Bordas","type":"main","index":0}]]},"item4":{"main":[[{"node":"Item4","type":"main","index":0}]]},"Item4":{"main":[[{"node":"Merge1","type":"main","index":4}]]},"AtualizaValorPizzaFracionada2":{"main":[[{"node":"RejeitaItem","type":"main","index":0}]]},"AtualizaValorItem2":{"main":[[{"node":"AtualizaValorPizzaFracionada2","type":"main","index":0}]]},"Item5":{"main":[[{"node":"Merge1","type":"main","index":5}]]},"MontPedido":{"main":[[{"node":"Switch","type":"main","index":0}]]},"DadoPedido":{"main":[[{"node":"ValidaItemNome","type":"main","index":0}]]},"ValidaItemNome":{"main":[[{"node":"VinculaBordaItemPizza","type":"main","index":0}]]},"Dados Lead":{"main":[[{"node":"MontPedido","type":"main","index":0}]]},"GetProblemas":{"ai_tool":[[{"node":"Issue","type":"ai_tool","index":0}]]},"GetOpcoes":{"ai_tool":[[{"node":"Opcoes","type":"ai_tool","index":0}]]},"GetCarrinho":{"ai_tool":[[{"node":"Carinnho","type":"ai_tool","index":0}]]},"VinculaBordaItemPizza":{"main":[[{"node":"InsereOpcoesItens","type":"main","index":0}]]},"OpenAI Chat Model2":{"ai_languageModel":[[{"node":"Fechamento1","type":"ai_languageModel","index":0}]]},"Simple Memory1":{"ai_memory":[[{"node":"Fechamento1","type":"ai_memory","index":0}]]},"SalvaEndereco":{"ai_tool":[[{"node":"Fechamento1","type":"ai_tool","index":0}]]},"Comentario":{"ai_tool":[[{"node":"Fechamento1","type":"ai_tool","index":0}]]},"SalvaFormaPagto":{"ai_tool":[[{"node":"Fechamento1","type":"ai_tool","index":0}]]},"Fechamento":{"ai_tool":[[{"node":"Fechamento1","type":"ai_tool","index":0}]]},"GetCarrinho1":{"ai_tool":[[{"node":"Fechamento1","type":"ai_tool","index":0}]]},"Execute a SQL query in Postgres":{"ai_tool":[[{"node":"Fechamento1","type":"ai_tool","index":0}]]},"MensagemTraduzida":{"main":[[{"node":"Dados Lead","type":"main","index":0}]]},"When Executed by Another Workflow":{"main":[[{"node":"MensagemTraduzida","type":"main","index":0}]]},"Carinnho":{"main":[[{"node":"MenuCardapio","type":"main","index":0}]]},"MenuCardapio":{"main":[[{"node":"Issue","type":"main","index":0}]]},"Issue":{"main":[[{"node":"Issue1","type":"main","index":0}]]},"Issue1":{"main":[[{"node":"Opcoes","type":"main","index":0}]]},"Opcoes":{"main":[[{"node":"Issue3","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"MensagemTraduzida1","type":"main","index":0}]]},"Dados Lead1":{"main":[[{"node":"SessionKey","type":"main","index":0}]]},"MensagemTraduzida1":{"main":[[{"node":"Dados Lead1","type":"main","index":0}]]},"MontPedido2":{"main":[[]]},"InsereOpcoesItens":{"main":[[{"node":"AtualizaValorItem2","type":"main","index":0}]]},"GetPizzaMontagem":{"ai_tool":[[{"node":"AI Agent1","type":"ai_tool","index":0}]]},"OpenAI Chat Model3":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"AI Agent1":{"main":[[{"node":"MenuCardapio2","type":"main","index":0}]]},"SessionKey":{"main":[[{"node":"MontPedido2","type":"main","index":0}]]},"GetOpcMontagem":{"ai_tool":[[{"node":"AI Agent1","type":"ai_tool","index":0}]]},"OpenAI Chat Model4":{"ai_languageModel":[[{"node":"AI Agent3","type":"ai_languageModel","index":0}]]},"AtualizaItemtemp1":{"ai_tool":[[{"node":"AI Agent3","type":"ai_tool","index":0}]]},"Postgres Chat Memory1":{"ai_memory":[[{"node":"AI Agent3","type":"ai_memory","index":0}]]},"Issue3":{"main":[[]]},"Montagem":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]},"Code2":{"main":[[{"node":"If1","type":"main","index":0}]]},"If1":{"main":[[{"node":"Montagem","type":"main","index":0}],[{"node":"MenuCardapio3","type":"main","index":0}]]},"Execute a SQL query":{"main":[[{"node":"Execute a SQL query2","type":"main","index":0}]]},"Execute a SQL query2":{"main":[[{"node":"AI Agent1","type":"main","index":0}]]},"Fechamento1":{"main":[[{"node":"MenuCardapio1","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Code2","type":"main","index":0}],[{"node":"Fechamento1","type":"main","index":0}],[{"node":"Basic LLM Chain","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"When Executed by Another Workflow":[{"json":{"mensagem":"1 pizza 1/2 calabresa meia frango 1 pizza 23 media 1 pizza 11 grande 1 coca cola 2l e 1 cerveja sckol lata 2 coca cola grande, 1 pizza baiana grande 1 bacon grande com borda catupiry","user_id":72,"pedido_id":18,"telefone":"5516992975836","rotina":1}}],"Webhook":[{"json":{"headers":{"host":"n8n.lglducci.com.br","user-agent":"axios/1.7.7","content-length":"920","accept-encoding":"gzip, br","cdn-loop":"cloudflare; loops=1","cf-connecting-ip":"159.69.117.195","cf-ipcountry":"DE","cf-ray":"983d0e854a9c18d1-FRA","cf-visitor":"{\"scheme\":\"https\"}","content-type":"application/json","x-forwarded-for":"162.158.110.181","x-forwarded-host":"n8n.lglducci.com.br","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"traefik_traefik.1","x-real-ip":"162.158.110.181"},"params":{},"query":{},"body":{"event":"messages.upsert","instance":"delivery","data":{"key":{"remoteJid":"5516992975836@s.whatsapp.net","fromMe":false,"id":"3EB07C25D4EEFCD956EF91"},"pushName":"Luis Gustavo Landucci","message":{"conversation":"0","messageContextInfo":{"deviceListMetadata":{"senderKeyHash":"qsa2uhWhGgSvcA==","senderTimestamp":"1757369973","senderAccountType":"E2EE","receiverAccountType":"E2EE","recipientKeyHash":"tPXKkPhX8YIDCg==","recipientTimestamp":"1757207594"},"deviceListMetadataVersion":2,"messageSecret":"yxsgaiLkFTPjAoFpo/ERzSPC66liZtly72zltqHUtMA="}},"messageType":"conversation","messageTimestamp":1758662118,"instanceId":"4dd4c0e0-99c0-4837-ad50-a467024f723a","source":"web"},"destination":"https://n8n.lglducci.com.br/webhook-test/agente","date_time":"2025-09-23T18:15:19.121Z","sender":"5516991216319@s.whatsapp.net","server_url":"https://evolution.lglducci.com.br","apikey":"61E902EA720B-492E-9768-BE78CE95B224"},"webhookUrl":"https://webhook.lglducci.com.br/webhook-test/agente","executionMode":"test"}}]},"versionId":"fa9476e7-4924-42ce-a427-97a1d1a9e5dd","triggerCount":1,"shared":[{"createdAt":"2025-09-18T15:44:58.320Z","updatedAt":"2025-09-18T15:44:58.320Z","role":"workflow:owner","workflowId":"gL1FbKkYm9zGfCAA","projectId":"wFRMrac2003Pl1x6"}],"tags":[]}