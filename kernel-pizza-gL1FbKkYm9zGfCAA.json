{"createdAt":"2025-09-18T15:44:58.320Z","updatedAt":"2025-11-09T22:34:26.551Z","id":"gL1FbKkYm9zGfCAA","name":"Kernel Pizza","active":false,"isArchived":false,"nodes":[{"parameters":{"operation":"executeQuery","query":" SELECT rejeita_item( {{ $('DadoPedido').item.json.user_id }}, {{ $('DadoPedido').item.json.pedido_id }}, {{ $('Dados Lead').item.json.id_empresa }}   );","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[3136,-320],"id":"d5d30080-47a6-459c-b463-883f0f46f96a","name":"RejeitaItem","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"fieldToSplitOut":"output.bebidas","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[848,-624],"id":"7a608843-94ae-4a9d-8a55-9f4222a0f6ab","name":"Bebidas","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"fieldToSplitOut":" output.pizzas_fracionadas","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[848,-432],"id":"49dbeeb0-7863-4321-abc5-6aa8716b5d4c","name":"Pizzas Fracionada","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"fieldToSplitOut":"output.pizzas_inteiras","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[848,-304],"id":"e738ed86-7847-426a-928a-9dd96bf35e0a","name":"Pizzas Inteira","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"fieldToSplitOut":"output.esfirras","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[848,-176],"id":"158da210-0bc8-433a-9120-6fd036ad4d85","name":"Esfirra","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('MontPedido').item.json.user_id }}"},{"fieldId":"quantidade","fieldValue":"={{ $json.quantidade }}"},{"fieldId":"tipo","fieldValue":"bebida"},{"fieldId":"categoria","fieldValue":"bebida"},{"fieldId":"nome","fieldValue":"={{ $json.nome }}"},{"fieldId":"volume","fieldValue":"= {{ (($json.volume ?? '').toString().replace(/[\\s\\u00A0\\u200B-\\u200D\\uFEFF]+/g, '') === '')\n    ? ' volume desconhecido'\n    : ($json.volume ?? '').toString().replace(/[\\s\\u00A0\\u200B-\\u200D\\uFEFF]+/g, '') }}"},{"fieldId":"fracionada","fieldValue":"false"},{"fieldId":"pedido_id","fieldValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"fieldId":"numero","fieldValue":"={{ $json.numero ? $json.numero : 0 }}"},{"fieldId":"comando_original","fieldValue":"={{ $json.comando_original }}"},{"fieldId":"id_empresa","fieldValue":"= {{ $('Dados Lead').item.json.id_empresa }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1088,-624],"id":"f7635034-812e-4fbd-aa0d-9042e5cc4409","name":"Itembebida","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('MontPedido').item.json.user_id }}"},{"fieldId":"quantidade","fieldValue":"={{ $json.quantidade }}"},{"fieldId":"categoria","fieldValue":"pizza"},{"fieldId":"fracionada","fieldValue":"true"},{"fieldId":"numero","fieldValue":"= {{ $json.metade1 }}"},{"fieldId":"numero_fracao","fieldValue":"={{ $json.metade2 }}"},{"fieldId":"tamanho","fieldValue":"grande"},{"fieldId":"fracionada","fieldValue":"true"},{"fieldId":"pedido_id","fieldValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"fieldId":"nome","fieldValue":"={{ $json.nome }}"},{"fieldId":"nome_fracao","fieldValue":"={{ $json.nome_fracao }}"},{"fieldId":"pizza_referencia","fieldValue":"={{$json.pizza_referencia.trim()}}"},{"fieldId":"comando_original","fieldValue":"={{ $json.comando_original }}"},{"fieldId":"id_empresa","fieldValue":"= {{ $('Dados Lead').item.json.id_empresa }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1104,-432],"id":"1a425d55-acc5-40b3-8035-6dea956073b8","name":"ItemFracionado","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('MontPedido').item.json.user_id }}"},{"fieldId":"quantidade","fieldValue":"={{ $json.quantidade }}"},{"fieldId":"categoria","fieldValue":"pizza"},{"fieldId":"fracionada","fieldValue":"false"},{"fieldId":"numero","fieldValue":"={{ String($json.numero ?? '').trim() === '' ? null : $json.numero }}"},{"fieldId":"tamanho","fieldValue":"={{ $json.tamanho.toLowerCase() }}"},{"fieldId":"fracionada","fieldValue":"false"},{"fieldId":"pedido_id","fieldValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"fieldId":"nome","fieldValue":"={{ $json.nome?.trim() === '' ? null : $json.nome }}"},{"fieldId":"pizza_referencia","fieldValue":"={{ $json.pizza_referencia }}"},{"fieldId":"comando_original","fieldValue":"={{ $json.comando_original }}"},{"fieldId":"id_empresa","fieldValue":"= {{ $('Dados Lead').item.json.id_empresa }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1104,-304],"id":"09a72d7a-7fcc-4cd4-97a6-28bd531c962c","name":"ItemInteira","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('MontPedido').item.json.user_id }}"},{"fieldId":"quantidade","fieldValue":"={{ $json.quantidade }}"},{"fieldId":"tipo","fieldValue":"bebida"},{"fieldId":"categoria","fieldValue":"esfirra"},{"fieldId":"nome","fieldValue":"={{ $json.nome?.trim() === '' ? null : $json.nome }}"},{"fieldId":"tipo","fieldValue":"={{ $json.tipo?.trim() === '' ? null : $json.tipo }}"},{"fieldId":"fracionada","fieldValue":"false"},{"fieldId":"pedido_id","fieldValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"fieldId":"numero","fieldValue":"= {{ $json.numero }}"},{"fieldId":"comando_original","fieldValue":"={{ $json.comando_original }}"},{"fieldId":"id_empresa","fieldValue":"= {{ $('Dados Lead').item.json.id_empresa }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1104,-176],"id":"59df7bdc-aed6-46b7-9f35-1a2bf7ec7cf3","name":"ItemEsfirra","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.outputParserAutofixing","typeVersion":1,"position":[144,-208],"id":"b399cce6-9e20-4758-989a-b43190cb9942","name":"Auto-fixing Output Parser","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"executeQuery","query":" \n\n\nCALL ReordenarItensConcluidos( {{ $('DadoPedido').item.json.user_id }}, {{ $('DadoPedido').item.json.pedido_id }} , {{ $('Dados Lead').item.json.id_empresa }} );\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[3520,-320],"id":"86faff93-e8fb-47a4-84e7-6d67471a8cd9","name":"OrdenaPedido","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":" UPDATE Item_pedido_temp AS i\nSET  status = 'concluido',\n   ordem_item = 0\n \nWHERE  status = 'inicio' and\n    user_id =  {{ $('DadoPedido').item.json.user_id }} and i.pedido_id = {{ $('DadoPedido').item.json.pedido_id }} and i.numero <> 0 and \ni.id_empresa = {{ $('Dados Lead').item.json.id_empresa }} ;\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[3328,-320],"id":"b5ebf3b9-d2df-4845-8e4c-e0c83e3097fa","name":"ConcluiTudo","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"fieldToSplitOut":"output.bordas","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[848,96],"id":"e56769d0-adcf-4271-8573-80a1dc184634","name":"Bordas","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"numberInputs":6},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1872,-384],"id":"ec18115b-1dc9-4971-b260-adebc6788470","name":"Merge1","alwaysOutputData":false,"onError":"continueRegularOutput"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[16,32],"id":"29668865-9ed1-45b0-941b-049371b5e133","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"schemaType":"manual","inputSchema":" {\n  \"type\": \"object\",\n  \"properties\": {\n    \"pizzas_inteiras\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"quantidade\": { \"type\": \"integer\" },\n          \"numero\": { \"type\": \"integer\" },\n          \"tamanho\": { \"type\": \"string\" },\n           \"nome\": { \"type\": \"string\" },\n           \"pizza_referencia\":  { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" }\n          \n        },\n        \"required\": [\"quantidade\", \"numero\", \"tamanho\", \"pedido_id\"]\n      }\n    },\n    \"pizzas_fracionadas\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"quantidade\": { \"type\": \"integer\" },\n          \"metade1\": { \"type\": \"integer\" },\n          \"metade2\": { \"type\": \"integer\" },\n            \"nome\": { \"type\": \"string\" },\n            \"nome_fracao\": { \"type\": \"string\" },\n           \"pizza_referencia\":  { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" }\n         \n        },\n        \"required\": [\"quantidade\", \"metade1\", \"metade2\",\"pedido_id\"]\n      }\n    },\n    \"bebidas\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"quantidade\": { \"type\": \"integer\" },\n           \"numero\": { \"type\": \"integer\" },\n          \"nome\": { \"type\": \"string\" },\n          \"volume\": { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" }\n         \n        },\n        \"required\": [\"quantidade\",\"numero\", \"nome\", \"volume\",\"comando_original\"]\n      }\n    },\n    \"esfirras\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"quantidade\": { \"type\": \"integer\" },\n          \"numero\": { \"type\": \"integer\" },\n          \"nome\": { \"type\": \"string\" },\n          \"tipo\": { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" }\n        },\n        \"required\": [\"quantidade\", \"numero\", \"nome\", \"tipo\"]\n      }\n    },\n    \"bordas\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"numero\": { \"type\": \"integer\" },\n          \"nome\": { \"type\": \"string\" } ,\n           \"pizza_referencia\":  { \"type\": \"string\" },\n          \"tamanho\": { \"type\": \"string\" }, \n          \"categoria\": { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" },\n            \"pizza_pai\": { \"type\": \"integer\" }\n  \n         \n    },\n        \"required\": [\"numero\", \"pizza_referencia\"]\n      }\n    },\n    \"item\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": { \n          \"numero\": { \"type\": \"integer\" },\n          \"nome\": { \"type\": \"string\" } ,\n            \"tamanho\": { \"type\": \"string\" },\n           \"pizza_referencia\":  { \"type\": \"string\" } ,\n           \"comando_original\":  { \"type\": \"string\" },\n            \"pizza_pai\": { \"type\": \"integer\" }\n          \n    },\n        \"required\": [\"nome\", \"pizza_pai\"]\n      }\n    }\n\n    \n  },\n  \"required\": [\n    \"pizzas_inteiras\",\n    \"pizzas_fracionadas\",\n    \"bebidas\",\n    \"esfirras\",\n    \"bordas\" \n  ]\n}\n\n   "},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.2,"position":[240,-16],"id":"8e713269-9051-4c42-82c1-636de7005114","name":"Structured Output Parser [Schema]","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"fieldToSplitOut":"output.item","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[848,-48],"id":"52506e17-3640-4a5c-97f2-d75318f09678","name":"item4","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('MontPedido').item.json.user_id }}"},{"fieldId":"quantidade","fieldValue":"=1"},{"fieldId":"tipo","fieldValue":"item"},{"fieldId":"categoria","fieldValue":"item"},{"fieldId":"nome","fieldValue":"={{ $json.nome?.trim() === '' ? null : $json.nome }}"},{"fieldId":"numero","fieldValue":"={{ $json.numero }}"},{"fieldId":"fracionada","fieldValue":"=false"},{"fieldId":"pedido_id","fieldValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"fieldId":"tamanho","fieldValue":"={{ $json.tamanho }}"},{"fieldId":"comando_original","fieldValue":"={{ $json.comando_original }}"},{"fieldId":"id_empresa","fieldValue":"= {{ $('Dados Lead').item.json.id_empresa }}"},{"fieldId":"id_pizza_pai","fieldValue":"={{ $json.pizza_pai }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1104,-48],"id":"5f4ecb21-f345-44c7-92f8-9be2a993f5f8","name":"Item4","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT AtualizaValorFracionado(  {{ $('DadoPedido').item.json.user_id }},{{ $('DadoPedido').item.json.pedido_id }},{{ $('Dados Lead').item.json.id_empresa }} );","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2944,-320],"id":"a381a11d-a7c7-4aa3-aa57-c6a67985f4bb","name":"AtualizaValorPizzaFracionada2","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT   atualizar_valores_itens_temp( {{ $('DadoPedido').item.json.user_id }},{{ $('DadoPedido').item.json.pedido_id }} , {{ $('Dados Lead').item.json.id_empresa }});","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2736,-320],"id":"157dbe1e-050f-456b-ac79-2d88e1607752","name":"AtualizaValorItem2","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"assignments":{"assignments":[{"id":"a3c83333-8ce3-4995-8230-b361099aa1e4","name":"user_id","value":"={{ $('When Executed by Another Workflow').item.json.user_id }}","type":"number"},{"id":"d7c14753-505f-48ee-a344-fa565ace43df","name":"pedido_id","value":"={{ $('When Executed by Another Workflow').item.json.pedido_id }}","type":"number"},{"id":"fdf33d81-37b4-46c9-b56a-6787b3d92dac","name":"rotina","value":"={{ $('When Executed by Another Workflow').item.json.rotina }}","type":"number"},{"id":"de288a5c-f68c-471f-9fcb-1a5ef0cb75fc","name":"acao","value":"={{ $('When Executed by Another Workflow').item.json.acao }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3696,-672],"id":"a6418514-62bb-4f8a-b1e3-7debd49a46c5","name":"MontPedido"},{"parameters":{"assignments":{"assignments":[{"id":"8033b503-a34e-4682-a40a-b60b315714e6","name":"user_id","value":"={{ $json.user_id }}","type":"number"},{"id":"bd4fde4d-0d15-4271-945c-571b24973379","name":"pedido_id","value":"={{ $json.pedido_id }}","type":"number"},{"id":"40c9f47d-f8d9-4387-8262-481e3bd9a124","name":"item_id","value":"={{ $json.item_id}}","type":"string"},{"id":"85a8ebc5-6414-42ae-9942-b9e223bb6b55","name":"=categoria","value":"={{ $json.categoria}}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2080,-320],"id":"8373ecb1-043b-4540-895e-8bb63b1ffe3a","name":"DadoPedido","executeOnce":true},{"parameters":{"assignments":{"assignments":[{"id":"9f488c5c-0b3b-48e9-87b1-5a22d513d1ec","name":"IdConversa","value":"={{ $('When Executed by Another Workflow').item.json.telefone }}","type":"string"},{"id":"388e17d9-4d3a-40a6-9a45-52b166aa17b5","name":"telefone","value":"={{ $('When Executed by Another Workflow').item.json.telefone }}","type":"number"},{"id":"8b88d192-9c8b-4b70-be50-09eb1e7a9228","name":"id_empresa","value":"={{ $('When Executed by Another Workflow').item.json.id_empresa }}","type":"number"},{"id":"1b6cea25-199f-4b87-a642-6c849db9d357","name":"instance","value":"={{$('When Executed by Another Workflow').item.json.instance.trim()}}","type":"string"},{"id":"10658e9e-6349-419d-8c28-76d717f23931","name":"apikey","value":"={{ $('When Executed by Another Workflow').item.json.apikey }}","type":"string"}]},"options":{}},"id":"63df038e-25e8-410b-8781-94308aa7e0c4","name":"Dados Lead","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3888,-672],"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"executeQuery","query":" \n\nUPDATE item_pedido_temp AS ib\nSET id_pizza_pai = ip.item_id\nFROM item_pedido_temp AS ip\nWHERE ib.pizza_referencia IS NOT NULL\n  AND LENGTH(TRIM(ib.pizza_referencia)) > 1\n  AND ib.status = 'inicio'\n  AND ib.categoria IN ('item','borda')\n  AND ip.pizza_referencia IS NOT NULL\n  AND LENGTH(TRIM(ip.pizza_referencia)) > 1\n  AND ip.status = 'inicio'\n  AND ip.categoria = 'pizza'\n  AND ib.user_id = ip.user_id\n  AND ib.pedido_id = ip.pedido_id\n  AND ib.user_id =  {{ $('DadoPedido').item.json.user_id }} \n  AND ib.pedido_id =  {{ $('DadoPedido').item.json.pedido_id }}\n  AND ib.pizza_referencia = ip.pizza_referencia\n  and ib.id_empresa = {{ $('Dados Lead').item.json.id_empresa }} \n  and ib.id_empresa = ip.id_empresa;\n\n ","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2320,-320],"id":"623d8730-7d3e-4b28-b8f2-47db6bc22d80","name":"VinculaBordaItemPizza","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{"temperature":0.4}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1328,-1024],"id":"0f56742b-affa-497c-bde4-75bf60479a63","name":"OpenAI Chat Model2","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"operation":"update","tableId":"usuario","matchType":"allFilters","filters":{"conditions":[{"keyName":"user_id","condition":"eq","keyValue":"={{ $('MontPedido').item.json.user_id }}"},{"keyName":"id_empresa","condition":"eq","keyValue":"={{ $('Dados Lead').item.json.id_empresa }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"endere√ßo","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues0_Field_Value', `endere√ßo `, 'string') }}"},{"fieldId":"bairro","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues1_Field_Value', `bairro`, 'string') }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[2032,-992],"id":"5dd9d402-25cd-475b-88a2-bfd4d571b918","name":"SalvaEndereco","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"tableId":"comentario_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $json.user_id }}"},{"fieldId":"pedido_id","fieldValue":"={{ $json.pedido_id }}"},{"fieldId":"comentario","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues2_Field_Value', `Comentario campo`, 'string') }}"},{"fieldId":"id_empresa","fieldValue":"={{ $('Dados Lead').item.json.id_empresa }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[1568,-1024],"id":"4466276d-e81b-455b-a0d7-bc04e4bd27c4","name":"Comentario","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"operation":"update","tableId":"pedido_temp","filters":{"conditions":[{"keyName":"user_id","condition":"eq","keyValue":"={{ $('MontPedido').item.json.user_id }}"},{"keyName":"pedido_id","condition":"eq","keyValue":"= {{ $('MontPedido').item.json.pedido_id }}"},{"keyName":"id_empresa","condition":"eq","keyValue":"= {{ $('Dados Lead').item.json.id_empresa }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"tipo_cobranca","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues0_Field_Value', `forma_pagto`, 'string') }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[1680,-992],"id":"c654bfb2-2b66-4255-8f5a-0a0c547d7d3f","name":"SalvaFormaPagto","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"descriptionType":"manual","toolDescription":"Execute a SQL query in Postgres fechamento ","operation":"executeQuery","query":"SELECT * from finalizar_pedido(    {{ $('MontPedido').item.json.user_id }} , {{ $('MontPedido').item.json.pedido_id }}, {{ $('Dados Lead').item.json.id_empresa }} ) ;","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[1776,-1008],"id":"527da8aa-05f5-43a7-bcf0-344fdaf6d5ba","name":"Fechamento","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"resource":"messages-api","instanceName":"={{$('Dados Lead').item.json.instance.trim()}}","remoteJid":"={{ $('Dados Lead').item.json.IdConversa }}","messageText":"=```{{ $json.output }}```","options_message":{"delay":4}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1840,-1296],"id":"eb621430-0a3a-4261-ae41-1c9ebf61d4d2","name":"MenuCardapio1","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{"operation":"executeQuery","query":"update Pedido_temp \n  set status = 'enviado'\n  where user_id =   {{ $('MontPedido').item.json.user_id }}  \n  and   pedido_id =    {{ $('MontPedido').item.json.pedido_id }}  and  status = 'fechamento'  ;\n \n  ","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[1904,-1008],"id":"0670b9ba-bc75-48f9-9e7b-f3e940fd84f0","name":"Execute a SQL query in Postgres","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"assignments":{"assignments":[{"id":"66a91f66-e755-4120-b22f-44c814f56162","name":"message","value":"={{ $('When Executed by Another Workflow').item.json.mensagem }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-4128,-672],"id":"03833dad-39dc-4ec9-8164-85890b68dea4","name":"MensagemTraduzida","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"resource":"messages-api","instanceName":"=delivery","remoteJid":"= {{ $('Dados Lead').item.json.IdConversa }}","messageText":"=```{{ $('GetProximaMontagem').item.json.montamensagemopcoes }}```","options_message":{"delay":4}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1712,-3120],"id":"a5155701-51df-4242-a46c-914118a1e42b","name":"MenuCardapio2","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{"operation":"executeQuery","query":" SELECT * FROM  GetPizzaMontagem(    {{ $('MontPedido').item.json.user_id }} , {{ $('MontPedido').item.json.pedido_id }} , {{ $('Dados Lead').item.json.id_empresa }}) ;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[32,-2096],"id":"b013dad7-f696-4bc4-b5f9-a25fdbfd2ef6","name":"Montagem","alwaysOutputData":true,"credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"88562244-0734-4bd1-ad22-d614ab675052","leftValue":"={{ $json.numero }}","rightValue":0,"operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-432,-1904],"id":"ca874184-03fe-4330-b617-21cba9e9efcb","name":"If1"},{"parameters":{"jsCode":" // n8n Function node\nconst msg = $('MensagemTraduzida').item?.json?.message ?? ($json.message ?? '');\nconst nums = (String(msg).match(/\\d+/g) || []).map(n => Number(n));\n\nif (nums.length === 1 && Number.isFinite(nums[0])) {\n  return [{ json: { numero: nums[0], mensagem: 'ok' } }];\n}\n\nreturn [{ json: { numero: 0, mensagem: 'blabdbsfsb' } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-624,-1904],"id":"05c4727e-6e13-4a05-9352-de827b1c2cf4","name":"Code2"},{"parameters":{"resource":"messages-api","instanceName":"=delivery","remoteJid":"={{$('Dados Lead').item.json.IdConversa }}","messageText":"=``` Escolha uma op√ß√£o valida por favor.```","options_message":{"delay":4}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[-176,-1664],"id":"80a741de-611d-4292-8dee-55292e2a2521","name":"MenuCardapio3","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{"promptType":"define","text":"={{ $('MensagemTraduzida').item.json.message }}","options":{"systemMessage":"= # Persona     \nVoc√™ √© um atendente da Pizzaria La Cantina respons√°vel por fechar pedidos de forma organizada, clara e simp√°tica.  \nSeu papel √© colher os dados finais (endere√ßo, bairro, forma de pagamento) e, somente quando tudo estiver confirmado, executar a tool `finalizar_pedido( )`.\n\n# Regras de Atendimento\n\n1. Ordem obrigat√≥ria de coleta:\n   - Primeiro: Solicite endere√ßo completo (rua + n√∫mero) e bairro.  \n     ‚Üí Chame `SalvaEndereco( endereco, bairro)`  \n\n   - Depois: Solicite a forma de pagamento.  \n     ‚Üí Chame `SalvaFormaPagto(forma_pagto)`  \n\n   - Coment√°rio/observa√ß√£o: **n√£o pergunte diretamente**.  \n     - Se o cliente espontaneamente informar algo (ex: ‚Äúsem cebola‚Äù, ‚Äúdeixar na portaria‚Äù),  \n       ‚Üí Chame `Comentario(user_id, pedido_id, comentario)`.  \n     - Se o cliente n√£o falar nada ‚Üí pule esta etapa.  \n\n   - Por √∫ltimo: Execute `finalizar_pedido(user_id, pedido_id)`  \n     - **Mostre exatamente o texto retornado pela procedure**, sem alterar ou reformatar.  \n\n2. Sempre valide as respostas do cliente:  \n   - Se ele enviar s√≥ a rua sem bairro ‚Üí pe√ßa de novo.  \n   - Se a forma de pagamento n√£o for v√°lida ‚Üí pe√ßa novamente.  \n\n3. Se alguma tool retornar erro ‚Üí avise o cliente de forma simples e pe√ßa novamente o dado.  \n\n‚ö†Ô∏è Regra de seguran√ßa:\nSe j√° coletou endere√ßo, bairro e pagamento, e conseguiu executar `finalizar_pedido()`, \nNUNCA volte a perguntar de novo. Apenas finalize.\n\n\n4. Nunca finalize o pedido sem executar `finalizar_pedido()`.  \n\n5. Nunca invente informa√ß√µes. Use somente o que o cliente forneceu.  \n\n6. Linguagem curta, simp√°tica e objetiva.  \n   - Exemplo:  \n     \"√ìtimo, endere√ßo anotado! Agora, qual ser√° a forma de pagamento?\"\n\n7. Quando a tool `finalizar_pedido()` + `DadosPessoais()`, for executada e retornar o resumo final:\n   - Mostre esse texto ao cliente.\n   - Diga uma mensagem simp√°tica de encerramento como:\n     \"üçï Seu pedido foi finalizado com sucesso! Obrigado e bom apetite!\"\n   - **Depois disso, n√£o fa√ßa mais perguntas nem chame outras tools.**\n   - Encerre a conversa imediatamente.\n   - **N√£o fa√ßa mais perguntas nem chame outras tools.**\n\n\n\n","maxIterations":18}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[1488,-1296],"id":"ad59e662-f3b3-4946-b211-c4d37f4bf9b1","name":"Fechamento1"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.rotina }}","rightValue":3,"operator":{"type":"number","operation":"equals"},"id":"e3160797-555d-41ca-a0d5-60a5caf4fb75"}],"combinator":"and"},"renameOutput":true,"outputKey":"montagem"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"e96fc6ed-5139-4fcb-8523-91c5ad9d6f23","leftValue":"={{ $json.rotina }}","rightValue":2,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"fechamento"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0fb4b223-80cf-4071-ba32-727a64e9d77f","leftValue":"={{ $json.rotina }}","rightValue":1,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"constroi"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"94c93021-d462-4a50-b6e5-fc4a36940a8d","leftValue":"={{ $json.rotina }}","rightValue":4,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"carrinho"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"008113d2-8596-47d5-afcd-9fbba28eecd9","leftValue":"={{ $json.rotina }}","rightValue":5,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"atendimento"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"e92030e4-19d9-461e-a5db-b65377b2c707","leftValue":"={{ $json.rotina }}","rightValue":6,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"mensagem"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"f447a1c3-5108-4683-9bda-2589de5ac9a5","leftValue":"={{ $json.rotina }}","rightValue":7,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Fracionado"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-3536,-752],"id":"83c5c999-841e-4b52-b01a-df440f3849d1","name":"Switch"},{"parameters":{"assignments":{"assignments":[{"id":"a5fd9f1d-4997-436e-bf2e-efe14d717756","name":"message.content","value":"={{ $json.message.content }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3616,-1024],"id":"f324bd22-6191-418e-86de-ebf4d82fab46","name":"FildsCarrinho"},{"parameters":{"operation":"executeQuery","query":"UPDATE pedido_temp p\nSET     status = 'enviado'\nWHERE   p.user_id =  {{ $('MontPedido').item.json.user_id }} and        p.pedido_id  = {{ $('MontPedido').item.json.pedido_id}} AND    p.id_empresa = {{ $('Dados Lead').item.json.id_empresa }}\n    \n  AND EXISTS (\n    SELECT 1\n    FROM item_pedido_temp i\n    WHERE i.user_id   = p.user_id\n      AND i.pedido_id = p.pedido_id\n      AND i.status    = 'opcoes'  \n      AND i.id_empresa =  {{ $('Dados Lead').item.json.id_empresa }}\n  );","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[32,-1888],"id":"7d725b83-4762-4500-b841-81055374a6c8","name":"AjudaMontagem","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2304,-3328],"id":"e9b1a4c7-c111-4fec-b512-d0fb3c10cdc5","name":"No Operation, do nothing7","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"executeQuery","query":"\nupdate item_opcoes\nset habilitada = true  \nwhere item_id = {{ $json.item_id }}  and\nopcao =  {{ $('Code2').item.json.numero }} and \n  id_empresa =  {{ $('Dados Lead').item.json.id_empresa }}; \n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[192,-2096],"id":"967b5815-37f7-4a8c-a340-048823ebc3ce","name":"HabilitaOpcao","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"\nupdate item_pedido_temp as  i \nset status = 'concluido',\nnumero = o.numero ,\nnome =    '(' || o.numero::text || ') ' || o.nome,\nvalor_unitario =  o.preco,\nvalor = o.preco * i.quantidade \nfrom item_opcoes as o \nwhere i.item_id = {{ $('Montagem').item.json.item_id }}  and\ni.numero = 0 and  user_id=  {{ $('MontPedido').item.json.user_id }} and pedido_id = {{ $('MontPedido').item.json.pedido_id }} and i.id_empresa =  {{ $('Dados Lead').item.json.id_empresa }}\nand o.item_id =  i.item_id and \no.habilitada = true and i.numero = 0\n  and o.parte = 1 and o.id_empresa =  {{ $('Dados Lead').item.json.id_empresa }} ;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[368,-2096],"id":"7b4d8d69-b07a-41df-be33-95d0914d0124","name":"AtualizaOpcao","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"  SELECT * FROM  MontaMensagemOpcoes(    {{ $('MontPedido').item.json.user_id }} , {{ $('MontPedido').item.json.pedido_id }} , {{ $('Dados Lead').item.json.id_empresa }} ) ;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[720,-2096],"id":"fbf6143f-8e15-4b76-977d-721e821ca09d","name":"GetProximaMontagem","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"\nupdate item_pedido_temp as  i \nset status = 'concluido',\nnumero_fracao = o.numero ,\nnome =   ' 1/2 (' || i.numero ::text || ') ' || i.nome || ' 1/2 (' || o.numero ::text || ') ' || o.nome,\nvalor_unitario =  o.preco,\nvalor =  ( o.preco + i.valor)/2  * i.quantidade \nfrom item_opcoes as o \nwhere i.item_id = {{ $('Montagem').item.json.item_id }}  and  user_id=  {{ $('MontPedido').item.json.user_id }}\n   and pedido_id = {{ $('MontPedido').item.json.pedido_id }} \n   and i.id_empresa = {{ $('Dados Lead').item.json.id_empresa }}\nand o.item_id =  i.item_id and \no.habilitada = true and i.numero_fracao = 0\nand o.parte = 2  \nand o.id_empresa =  {{ $('Dados Lead').item.json.id_empresa }};","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[544,-2096],"id":"7233eb73-4fa8-4afb-b134-5e4f2b4a593c","name":"AtualizaOpcaoParte2","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"jsCode":" const raw = ($json.calcula_pre_pedido || \"\").replace(/\\r\\n/g, \"\\n\");\nconst txt = raw.trim();\n\nif (!txt) {\n  return { texto_alinhado: \"n√£o existe registro\" };\n}\n\nconst lines = txt.split(\"\\n\").map(l => l.trimEnd());\n\n// Se n√£o tiver \"Resumo:\", devolve o corpo original\nconst start = lines.findIndex(l => /resumo:/i.test(l));\nif (start === -1) {\n  return { texto_alinhado: txt };\n}\n\nlet end = lines.findIndex((l, i) => i > start && (\n  /forma de pagamento/i.test(l) || /entrega:/i.test(l) || /total:/i.test(l) || /total de itens/i.test(l)\n));\nif (end === -1) end = lines.length;\n\nconst header = lines.slice(0, start + 1);\nconst itemLines = lines.slice(start + 1, end).filter(l => l.trim());\nconst footer = lines.slice(end);\n\n// ---- parsing ajustado ----\nconst parsed = itemLines.map(line => {\n  const match = line.match(/(R\\$\\s*[\\d\\.,]+)$/);\n  if (!match) return { num: \"\", desc: line.trim(), valor: \"\" };\n\n  const valor = match[1].replace(\"R$\", \"\").trim();\n  const left = line.slice(0, match.index).trim();\n\n  // captura do n√∫mero inicial (ex: (1) Nome ...)\n  const numMatch = left.match(/^\\((\\d+)\\)\\s*(.*)$/);\n  let num = \"\", desc = left;\n  if (numMatch) {\n    num = numMatch[1];\n    desc = numMatch[2].trim();\n  }\n\n  return { num, desc, valor };\n});\n\nconst maxNum = parsed.reduce((m, o) => Math.max(m, o.num.length), 0);\nconst maxDesc = parsed.reduce((m, o) => Math.max(m, o.desc.length), 0);\n\n// monta itens alinhados com cabe√ßalho\nconst itensAlinhados = [\n  \"Item \".padEnd(maxNum + 2, \" \") +\n  \"Descri√ß√£o\".padEnd(maxDesc + 4, \" \") +\n  \"Valor\"\n];\n\nparsed.forEach(o => {\n  itensAlinhados.push(\n    o.num.padEnd(maxNum + 2, \" \") +\n    o.desc.padEnd(maxDesc + 4, \" \") +\n    \"R$ \" + o.valor\n  );\n});\n\n// ---- corpo final ----\nconst corpo = [\n  ...header,\n  ...itensAlinhados,\n  ...footer\n].join(\"\\n\");\n\nreturn { texto_alinhado: \"\\n\" + corpo + \"\\n\" };\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-32,560],"id":"5cdd4602-8ddf-4b75-b58f-c014e88fc449","name":"Code5"},{"parameters":{"operation":"executeQuery","query":" select calcula_pre_pedido( {{ $('MontPedido').item.json.user_id }},  {{ $('MontPedido').item.json.pedido_id }},{{ $('Dados Lead').item.json.id_empresa }} );\n ","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-192,560],"id":"a4665190-e8cb-43a1-b470-2ce8b117a0f6","name":"Carrinho1","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"gL1FbKkYm9zGfCAA","mode":"list","cachedResultName":"Kernel Pizza"},"workflowInputs":{"mappingMode":"defineBelow","value":{"mensagem":"={{ $('MensagemTraduzida').item.json.message }}","user_id":"={{ $('MontPedido').item.json.user_id }}   ","rotina":4,"telefone":"= {{ $('Dados Lead').item.json.IdConversa }}","pedido_id":"={{ $('MontPedido').item.json.pedido_id }}","id_empresa":"={{ $('Dados Lead').item.json.id_empresa }}"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[1872,-1712],"id":"ee04e4b8-f722-4b55-98a9-2c7c01ddeab5","name":"ExecutaMontagem1"},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"messages":{"values":[{"content":"=O seu objetivo √© montar sua pizza com suas pizzas que possuem varias op√ß√µes.\nUse no telefone      "}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[1728,-1920],"id":"e1d76639-af39-4ff7-86ed-cf6247b74659","name":"Chama Carrinho1","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"operation":"executeQuery","query":"CALL ReordenarItensConcluidos( {{ $('MontPedido').item.json.user_id }}, {{ $('MontPedido').item.json.pedido_id }} , {{ $('Dados Lead').item.json.id_empresa }} );\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[896,-2096],"id":"b3496803-20dc-47ac-adf4-4dda07129499","name":"ReordenaItem","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"91cd74fc-0b48-4ac5-bdf6-1c63db95d0df","leftValue":"={{$json.status}}","rightValue":"montagem","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1456,-2096],"id":"7652137f-96c2-48e2-9d28-c9dd3876dc60","name":"If"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2080,-1920],"id":"ea89cc39-e375-43b6-9b45-37273fbef762","name":"No Operation, do nothing","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"sessionIdType":"customKey","sessionKey":"= {{ $json.userkey }}"},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[800,1776],"id":"19087e8d-bcc4-4ce0-a4ca-a50eb1a7cb75","name":"Postgres Chat Memory","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}},"disabled":true},{"parameters":{"content":"## Agente vendedor e auxilia na compra\n** ","height":1264,"width":5728},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-768,1072],"id":"0f38425f-e805-4c16-b805-fc94fe2cc000","name":"Sticky Note2"},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"gpt-4o-mini"},"options":{"temperature":0.1}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[736,1648],"id":"9837c83b-ac8f-477a-b8d2-6100d65728f6","name":"OpenAI Chat Model5","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"workflowInputs":{"values":[{"name":"mensagem"},{"name":"user_id","type":"number"},{"name":"pedido_id","type":"number"},{"name":"telefone"},{"name":"rotina","type":"number"},{"name":"id_empresa","type":"number"},{"name":"instance"},{"name":"apikey"},{"name":"acao"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-4400,-672],"id":"cc6d6912-cf38-4e7d-9d5e-f165d4a45897","name":"When Executed by Another Workflow"},{"parameters":{"content":"## Modulo carrinho \n** Aqui vc mostra o carrinho para o cliente ","height":624,"width":2752,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-816,384],"id":"bcc8b5de-a95c-4a51-b531-cbed80d3e98d","name":"Sticky Note"},{"parameters":{"content":"## Modulo Cardapio\n** Aqui vc montao carrinho para o cliente ","height":1072,"width":5440,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-688,-736],"id":"e2401d09-2b2b-4087-8868-ac589420c042","name":"Sticky Note1"},{"parameters":{"content":"## Modulo Fechamento\n** Aqui faz o fechamento pedindo  o endere√ßo e  bairro forma de pagamento","height":560,"width":1216,"color":3},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1008,-1376],"id":"81ee85ea-9ea5-453e-9a81-105fe89dc03d","name":"Sticky Note4"},{"parameters":{"content":"## Modulo Montagem Op√ß√µes\n** Aqui vc mostra o carrinho para o cliente ","height":800,"width":3264,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-736,-2304],"id":"9022d7d4-49f0-4f40-9bbc-151c6905996e","name":"Sticky Note5"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2672,1344],"id":"cdfb4d3c-0fed-4078-9462-a4a75550242e","name":"No Operation, do nothing9","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a7f9f510-5e06-4a49-b2f6-190484faeaac","leftValue":"={{$('MensagemTraduzida').item.json.message}}","rightValue":"sair","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2240,1360],"id":"80c7dcb0-0636-4204-8191-919abb82db42","name":"If2"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2464,1600],"id":"22916a34-2a82-42fb-ad53-d824a3cfec29","name":"No Operation, do nothing10","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"sessionIdType":"customKey","sessionKey":"= {{ $json.userkey }}"},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[1440,-1040],"id":"40ad7878-1145-4da3-b4d0-0af9aeea9e19","name":"Postgres Chat Memory2","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2048,-1296],"id":"05cbadc9-f1c7-4707-8007-31b42e9934e8","name":"No Operation, do nothing2","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"promptType":"define","text":"=<mensagem_do_usuario>\n {{ $json.monta_comando_turno }}\n</mensagem_do_usuario>","hasOutputParser":true,"messages":{"messageValues":[{"message":"=  {\n  \"pizzas_inteiras\": [\n    { \"quantidade\": int, \"numero\": int, \"tamanho\": str , \"nome\": str, \"pizza_referencia\": str, \"comando_original\": str  }   // pizza_referencia √© uma rela√ß√£o com a borda ou com item \n  ],\n  \"pizzas_fracionadas\": [\n    { \"quantidade\": int, \"metade1\": int, \"metade2\": int , \"nome\": str, \n\"nome_fracao\": str , \"pizza_referencia\": str, \"comando_original\": str }\n  ],\n  \"bebidas\": [\n    { \"quantidade\": int, \"numero\": int, \"nome\": str, \"volume\": str , \"comando_original\": str }\n  ],\n \"esfirras\": [\n  { \"quantidade\": int, \"numero\": int, \"nome\": str, \"tipo\": str , \"comando_original\": str } // tipo: \"salgada\" ou \"doce\"\n  ],\n  \"bordas\": [\n   \n { \"numero\": int, \"nome\": str, \"pizza_referencia\": str , \"tamanho\": str, \"categoria\": str, \"comando_original\": str, \"pizza_pai\": int } // pizza_referencia √© uma rela√ß√£o da borda com a pizza \n\n\n// \"pizza_referencia\" = string que identifica a pizza onde ser√° aplicada\n  ]\n \"item\": [\n    { \"numero\": int,\"nome\": str, \"tamanho\": str , \"pizza_pai\": int , \"comando_original\": str, \"pizza_pai\": int } //  \n  ]\n\n\n}\n\n‚ö†Ô∏è Regras obrigat√≥rias:\n- Sempre retorne exatamente essas 5 listas, mesmo que estejam vazias.\n- Use apenas os nomes de campos e estrutura mostrados acima.\n- Retorne **apenas o JSON v√°lido**, sem explica√ß√µes, coment√°rios ou texto adicional.\n\nSe o usu√°rio informar apenas ‚Äòpizza N‚Äô, n√£o descarte. Gere {quantidade:1, numero:N, tamanho:'media'} em pizzas_inteiras.‚Äù\n\n‚ÄúNunca omita itens amb√≠guos; use defaults: quantidade=1, tamanho='media'.‚Äù\n\n‚ÄúN√£o valide com o card√°pio. A valida√ß√£o ser√° feita depois; sempre retorne o item.‚Äù\n\n\"A palavra uma , duas  refere-se sempre  quantidade  exemplo uma  pizza mussarela ou uma pizza presunto e queijo √© quantidade..\"\n\n\n\nPrioridade de interpreta√ß√£o\n\nSe houver padr√µes de pizza fracionada no formato {Q? 1/2 A (e|,|+|/) 1/2 B}, crie um item em pizzas_fracionadas com {quantidade: Q || 1, metade1: A, metade2: B}.\n\nNunca crie pizzas_inteiras para n√∫meros A ou B quando eles estiverem dentro de um padr√£o fracionado.\n\nS√≥ trate ‚Äúpizza N‚Äù (inteira) quando n√£o fizer parte de um padr√£o 1/2 N.  \n\nSo trate   \"pizza\" se tiver explicito que se trata de \"pizza\"\n\nSo trate   \"esfirra \" se tiver explicito que se trata de \"esfirra\"\n\no comando_origianal guaro valor da string que gerou o json  exemplo :  ‚Äú1 pizza 1/2 14  e 1/2 21‚Äù\n\nRegras espec√≠ficas para BORDAS (muito importante):\n- Se a mensagem contiver ‚Äúborda‚Äù, o texto imediatamente ap√≥s a palavra ‚Äúborda‚Äù\n  at√© antes de ‚Äúao item‚Äù, ‚Äúno item‚Äù, ‚Äúitem‚Äù, ‚Äúpizza‚Äù ou o fim da frase, √© o campo \"nome\".\n- Normalize espa√ßos e min√∫sculas (ex.: \"Borda   Cheddar\" ‚Üí nome: \"cheddar\").\n\n- Sempre preencha \"categoria\":\"borda\" e \"pizza_pai\" com o n√∫mero do item/pizza alvo quando presente (ex.: \"item_id  1\" ‚Üí pizza_pai: 1).\n- N√£o use o campo \"item[]\"; bordas devem ir apenas em \"bordas[]\".\n- Defaults para borda quando ausentes: numero=0, tamanho=\"\", pizza_referencia=\"\".\n\n\n\nExemplos:\n\n‚Äú1 pizza 1/2 14  e 1/2 21‚Äù ‚Üí pizzas_fracionadas: [{quantidade:1, metade1:14, metade2:21, nome:'', nome_fracao: '' } ]\n\n‚Äú2 1/2 10, 1/2 15‚Äù ‚Üí pizzas_fracionadas: [{quantidade:2, metade1:10, metade2:15 , nome:'', nome_fracao: '' }]\n\n‚Äú14 e 21‚Äù (sem 1/2) ‚Üí pizzas_inteiras: [{q:1,n:14,media},{q:1,n:21,media }]\n\n\n\n‚Äú1 pizza 1/2 mussarela  e 1/2 presunto e queijo ‚Äù ‚Üí pizzas_fracionadas: [{quantidade:1, metade1:0, metade2:0, nome:mussarela, nome_fracao: presunto e queijo } ]\n\n‚Äú1 pizza meia  mussarela  e meia  presunto e queijo ‚Äù ‚Üí pizzas_fracionadas: [{quantidade:1, metade1:0, metade2:0, nome:mussarela, nome_fracao: presunto e queijo } ]\n\nSe o cliente disser meia  interprete como 1/2\n\n\n \nBebidas ‚Äî defaults e sin√¥nimos (obrigat√≥rio)\n\nSe o cliente disser ‚Äúlata‚Äù e n√£o informar volume, use 350ml.\n\nSe o cliente disser ‚Äúlong neck‚Äù e n√£o informar volume, use 330ml.\n\nSe o cliente pedir coca/coca-cola sem volume, use 2l.\n\nNunca rejeite bebidas por falta de volume quando se aplicar uma regra acima.\n\nNormalize o campo volume sempre em min√∫sculas e sem espa√ßos (ex.: 350ml, 330ml, 2l).\n\nExemplos\n\nse vier \"1 borda catupiry para item_id 2277\"  \n\n [ { \"quantidade\": 1, \"numero\": 300, \"nome\": '', \"tipo\": 'borda' , \"comando_original\": '1 borda catupiry para item_id 2277', \"pizza_pai\": 2277}]\n\nse vier \"1 item catupiry para item_id 2277\"  \n\n [ { \"quantidade\": 1, \"numero\": 300, \"nome\": '', \"tipo\": 'item' , \"comando_original\": '1 item catupiry para item_id 2277', \"pizza_pai\": 2277}]\n\n\n\nüìò Regras para interpreta√ß√£o dos exemplos:\n\nOs exemplos abaixo servem apenas para ilustrar o formato JSON esperado, **n√£o para definir valores fixos**.\n\n‚ö†Ô∏è Nunca copie n√∫meros, c√≥digos, nomes, tamanhos ou volumes dos exemplos.\n‚ö†Ô∏è Sempre use exclusivamente as informa√ß√µes presentes na mensagem real do usu√°rio ou retornadas pelas tools.\n\nSe o usu√°rio disser:\n‚Üí \"1 bebida coca cola 2l\"\nVoc√™ deve analisar o texto e montar o JSON com base exatamente nesse texto, sem usar n√∫meros ou nomes dos exemplos.\n\nOs exemplos s√£o apenas modelos de estrutura:\n[\n  { \"quantidade\": <n√∫mero>, \"numero\": <obtido da consulta ou 0 se desconhecido>,\n    \"nome\": \"<nome extra√≠do>\", \"tipo\": \"<categoria>\", \"comando_original\": \"<texto do usu√°rio>\",\n    \"pizza_pai\": <id se houver> }\n]\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n \nquando numa string de comando tiver 1 pizza musssarela  1 borda chedaar na qual o codigo da pizza n√£o for identifica,  crie no campo   \"pizza_referencia\" uma amarra√ß√£o entre 1 pizza mussarela e borda   \"pizza_referencia\" pode ser um codigo unico. Isso vale tambpem para pizza fracionada \n\n"}]}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.6,"position":[16,-448],"id":"03c7b5ef-890b-43ea-9e04-b190ee33affa","name":"LLM CONSTRUTOR","retryOnFail":true,"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"executeQuery","query":"update  pedido_temp \n  set status ='enviado'\n  where user_id =  {{ $('MontPedido').item.json.user_id }} \n  and pedido_id =  {{ $('MontPedido').item.json.pedido_id }} and id_empresa ={{ $('Dados Lead').item.json.id_empresa }};","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2464,1344],"id":"87ed4ddd-095b-440d-9d8e-6d64659047da","name":"VoltaStatusCompra","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[16,-1664],"id":"602cbc2e-c87d-4dfe-9914-efae860edc4d","name":"No Operation, do nothing12","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"92b4a80f-9642-42ba-9d5b-534e35757324","leftValue":"={{ $json.count }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-624,608],"id":"282fed4a-f80f-4c12-937f-f79d0cf2835c","name":"If6"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[64,768],"id":"816547d8-1c45-4b01-9b1c-2bbb52f4be75","name":"No Operation, do nothing33","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"resource":"messages-api","instanceName":"={{ $('Dados Lead').item.json.instance }}","remoteJid":"={{ $('Dados Lead').item.json.IdConversa }}","messageText":"= ```üõíSeu carrinho esta vazio.```","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[-208,768],"id":"c44460bd-5fab-4e05-9c03-3fb45a11ba9a","name":"MenuCardapio34","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"d1c05fb6-32da-4a44-bc69-393a6d7e07c5","leftValue":"={{ $('MensagemTraduzida').item.json.message }}","rightValue":"n√£o","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-240,-2080],"id":"2a9bae29-9b7e-40f2-8a36-99bf336a655b","name":"If4"},{"parameters":{"resource":"messages-api","instanceName":"=delivery","remoteJid":"={{$('Dados Lead').item.json.IdConversa }}","messageText":"= ``` Montagem recusada pelo cliente. \n     Vamos encontrar outro caminho.\n     Consulte por um sabor, exemplo: Frango, ou Baiana.```","options_message":{"delay":4}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[240,-1888],"id":"132ea165-a6a0-4242-92a0-1ace75e2fc61","name":"MenuCardapio4","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[432,-1888],"id":"0b4e6e01-d8a2-4b91-bdf8-747e9e337437","name":"No Operation, do nothing14","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"executeQuery","query":"UPDATE pedido_temp p\nSET     status = 'montagem'\nWHERE   p.user_id =  {{ $('MontPedido').item.json.user_id }} and     p.pedido_id  = {{ $('MontPedido').item.json.pedido_id}} and \n  p.id_empresa ={{ $('Dados Lead').item.json.id_empresa }} \n  AND EXISTS (\n    SELECT 1\n    FROM item_pedido_temp i\n    WHERE i.user_id   = p.user_id\n      AND i.pedido_id = p.pedido_id\n      AND i.status    = 'opcoes'  \n      and i.id_empresa ={{ $('Dados Lead').item.json.id_empresa }} \n  );","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[3168,-1040],"id":"7f5542f1-07cf-4576-a11f-971df97b1de9","name":"AjudaMontagem1","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"content":"## Modulo carrinho \n** Aqui vc mostra o carrinho para o cliente ","height":464,"width":1392},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-4480,-800],"id":"cf7a12fb-ab4c-4665-a8e3-d753fa6a9fdf","name":"Sticky Note6"},{"parameters":{"operation":"get","tableId":"pedido_temp","filters":{"conditions":[{"keyName":"user_id","keyValue":"={{ $('MontPedido').item.json.user_id }}"},{"keyName":"pedido_id","keyValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"keyName":"id_empresa","keyValue":"={{ $('Dados Lead').item.json.id_empresa }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[336,560],"id":"0dce018a-adcc-41f6-a081-3117a67b7f5e","name":"Get Pedido","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"operation":"executeQuery","query":"select count(*) ::INT from item_pedido_temp  \n  WHERE user_id =  {{ $('MontPedido').item.json.user_id }}\n  and pedido_id =  {{ $('MontPedido').item.json.pedido_id }} and id_empresa ={{ $('Dados Lead').item.json.id_empresa }};\n\n ","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-800,608],"id":"c4919120-c317-4def-8f35-fbfaf9a45749","name":"CarinhoVazio","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('MontPedido').item.json.user_id }}"},{"fieldId":"quantidade","fieldValue":"=1"},{"fieldId":"tipo","fieldValue":"borda"},{"fieldId":"categoria","fieldValue":"borda"},{"fieldId":"nome","fieldValue":"={{ $('Bordas').item.json.nome }}"},{"fieldId":"numero","fieldValue":"={{ $json.numero ? $json.numero : 0 }}"},{"fieldId":"fracionada","fieldValue":"=false"},{"fieldId":"pedido_id","fieldValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"fieldId":"tamanho","fieldValue":"={{ $json.tamanho }}"},{"fieldId":"pizza_referencia","fieldValue":"={{ $json.pizza_referencia }}"},{"fieldId":"comando_original","fieldValue":"={{ $json.comando_original }}"},{"fieldId":"id_empresa","fieldValue":"= {{ $('Dados Lead').item.json.id_empresa }}"},{"fieldId":"id_pizza_pai","fieldValue":"={{ $json.pizza_pai }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1088,112],"id":"754e1ee8-60ce-4a79-9dc7-aa77cf2359e8","name":"BordaItem","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"fieldToSplitOut":"output.mensagens","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-304,2816],"id":"371dd4c5-e3c8-48fa-bb52-20df92beeed4","name":"Split Out1","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[16,2816],"id":"e821bada-2d96-4eb9-9797-7fab98fc518d","name":"Loop Over Items1","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"amount":2},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[592,3104],"id":"15eee28e-dd3a-4736-82ec-ea4a6f57b4b4","name":"Wait3","webhookId":"65ff8064-0a3a-4195-bf63-5cc130c8fe48","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.outputParserAutofixing","typeVersion":1,"position":[-544,3008],"id":"bab1f7e8-9e27-4c02-93fb-f773186870a3","name":"Auto-fixing Output Parser1","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-624,3168],"id":"ff15ad5f-ef1d-4f8b-870b-555f5adbc1a8","name":"OpenAI Chat Model3","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"promptType":"define","text":"=<mensagem_do_usuario>\n {{ $('MensagemTraduzida').item.json.message }}\n</mensagem_do_usuario>","hasOutputParser":true,"messages":{"messageValues":[{"message":"=Apenas estruture a <mensagem_do_usuario> no formato JSON solicitado no output parser e seguindo as instru√ß√µes de formata√ß√£o abaixo. N√£o altere nada mais na mensagem\n\n# Formata√ß√£o\n- Divida as mensagens para que fiquem naturais e humanizadas;\n- Divida as mensagens conforme estrutura do output parser para que n√£o fiquem muito longas (maiores que 240 caract√©res);\n- N√£o separe mensagens vazias;\n- Use quebras de linhas (\\n\\n) ap√≥s pontos finais;\n- Para negrito (bold) use apenas um '' nunca duas '' (exemplo: *negrito).\n\nExemplo de formato JSON:\n{\n\"mensagens\": [\"Mensagem 0\", \"Mensagem 1\", \"Mensagem 2\"]\n}"}]}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.6,"position":[-640,2816],"id":"1821fa6f-6b66-4fc5-abda-1871d9d882f0","name":"Basic LLM Chain"},{"parameters":{"content":"## Humanizar Resposta\nQuebra de mensagens em mensagens menores e com contexto.","height":760,"width":580,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-704,2560],"id":"b9defda7-6888-48b1-80fb-4eda3cc16c90","name":"Sticky Note31"},{"parameters":{"content":"## Envio das Respostas ao Usu√°rio\nEnvio das mensagens quebradas para o usu√°rio","height":760,"width":900,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-112,2560],"id":"c53e9200-f7f6-412d-a4bc-246b02cd810d","name":"Sticky Note32"},{"parameters":{"content":"Ajuste sua inst√¢ncia e autenficia√ß√£o da Evolution","height":300,"width":230,"color":3},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[272,2864],"id":"053bfb95-b6ab-4075-a9b0-17968f037d2f","name":"Sticky Note33"},{"parameters":{"resource":"messages-api","instanceName":"={{$('Dados Lead').item.json.instance.trim()}}","remoteJid":"={{$('Dados Lead').item.json.IdConversa}}","messageText":"=```{{ $json['output.mensagens'] }}```","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[304,2976],"id":"964992f0-33f0-42e2-9452-fb4933a48e7c","name":"CardapioConsulta1","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[496,2800],"id":"0cc57840-437e-43ef-83b3-d0aa78776b42","name":"No Operation, do nothing15","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"mensagens\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      }\n    }\n  },\n  \"required\": [\"mensagens\"]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.2,"position":[-352,3168],"id":"fa47fce4-13d1-42dc-8dd1-95e7dc8a4b33","name":"Structured Output Parser [Schema]1","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1648,592],"id":"162a3128-d9ab-41ec-a73e-3eb452e6040a","name":"No Operation, do nothing16","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"assignments":{"assignments":[{"id":"8d56a457-c56c-4b92-955d-6fdac64b4c99","name":"texto","value":"={{ $json.texto_alinhado}}","type":"string"},{"id":"9609e8d7-0651-415c-a5c9-c0adc8555428","name":"dica","value":"={{ $('dicas').item.json.dica }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[160,560],"id":"01cc8f21-b955-493e-abb4-ebced6abbb75","name":"FieldsCarrinho"},{"parameters":{"assignments":{"assignments":[{"id":"cb9bbfc2-3f0e-467a-ae77-f64a2c0d16b4","name":"texto","value":"={{$('FieldsCarrinho').item.json.texto }}\n ```Estamos iniciando o processo de fechamento üîì. Vamos solicitar algumas informa√ß√µes ‚ÑπÔ∏è para fechar.```","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[816,400],"id":"505aaa02-19c2-4ed0-a869-375ca0720b6a","name":"Fechar"},{"parameters":{"assignments":{"assignments":[{"id":"c6f87764-1b56-4a13-877e-549aa05559d8","name":"texto","value":"=  {{ $('FieldsCarrinho').item.json.texto }}\n   Vamos Fechar seu pedidoüîí? ","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[816,688],"id":"ef451012-45fc-4a6c-9fa9-98b4199bbe3a","name":"N√£oFechar"},{"parameters":{"numberInputs":4},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1120,560],"id":"4afc9cd6-235e-4522-8901-5f8a85ab952c","name":"Merge"},{"parameters":{"operation":"executeQuery","query":"select status from pedido_temp \n  where user_id =  {{ $('MontPedido').item.json.user_id }} \n  and pedido_id =  {{ $('MontPedido').item.json.pedido_id }} and \n   id_empresa =  {{ $('Dados Lead').item.json.id_empresa }}; ","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1264,-2096],"id":"470c4d2a-ccbc-45a2-9dbb-700911345d30","name":"PegaStusPedido","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"assignments":{"assignments":[{"id":"a842c6a3-ab23-4c9f-9902-80496bb13a18","name":"ProxMontagem","value":"={{ $('GetProximaMontagem').item.json.montamensagemopcoes }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1072,-2096],"id":"f345fe5b-2d4c-4bbc-81c9-19cb3ac44809","name":"FieldsMontagem"},{"parameters":{"workflowId":{"__rl":true,"value":"gL1FbKkYm9zGfCAA","mode":"list","cachedResultName":"Kernel Pizza"},"workflowInputs":{"mappingMode":"defineBelow","value":{"mensagem":"={{ $('FieldsMontagem').item.json.ProxMontagem }}","user_id":"={{ $('MontPedido').item.json.user_id }}   ","telefone":"= {{ $('Dados Lead').item.json.IdConversa }}","pedido_id":"={{ $('MontPedido').item.json.pedido_id }}","id_empresa":"={{ $('Dados Lead').item.json.id_empresa }}","rotina":6},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[1856,-2048],"id":"d6a9866c-e173-49ed-a381-b499b4c3bd7e","name":"ExecutaMontagem"},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"messages":{"values":[{"content":"=O seu objetivo √© montar sua pizza com suas pizzas que possuem varias op√ß√µes.\nUse no telefone     "}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[1712,-2256],"id":"661a7b3d-1abc-47d7-82b7-c3863ae49cb5","name":"Chama Carrinho","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2064,-2256],"id":"fa90a3be-3a94-441d-9e49-ec840fa7e9e8","name":"No Operation, do nothing8","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"messages":{"values":[{"content":"=O seu objetivo  executar a FerramentaCarrinho()\n   \n"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[1296,592],"id":"504168e5-8f81-4e2a-a3f4-843b2f6a93fc","name":"ChamaConversational","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"messages":{"values":[{"content":"=O seu objetivo √© executar a tool conversational\n \n"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[1904,1360],"id":"d86e6911-125e-428f-9c5c-60228eeec1b8","name":"ChamaConversational1","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"jsCode":"   const dicas = [\n  \"üí°Dica: Voc√™ pode pedir pizza pelo n√∫mero do card√°pio.\\n Ex: '1 pizza 12 grande'\",\n  \"üí°Dica: Para excluir um item:\\nDigite 'Carrinho' ‚Üí depois 'Excluir item 1'\",\n  \"üí°Dica: Pizza fracionada s√≥ no tamanho grande üòâ\\n Ex: '1/2 mussarela e 1/2 calabresa (grande)'\",\n  \"üí°Dica: Pizza fracionada s√≥ no tamanho grande üòâ\\n Ex: '1/2 9  e 1/2 28  grande'\",\n  \"üí°Dica: Pizza fracionada com borda cheedar üòâ\\n Ex: '1/2 mussarela e 1/2 calabresa (grande) borda cheddar'\",\n  \"üí°Dica: Se voc√™ j√° escolheu o n√∫mero da Pizza? \\nüòâ Ex: '1/2 21 e 1/2 12  (grande) '\",\n  \"üí°Dica: Para consultar sabores basta digitar um nome, tipo: 'Marguerita' ou Frango ou Baiana\",\n  \"üí°Dica: Voc√™ pode pedir tamb√©m por voz üé§ (se n√£o entender, escreva)\",\n  \"üí°Dica: Quer ver a lista de d√∫vidas mais comuns? \\n Digite: ajuda\",\n  \"üí°Dica: Quer sair do modo ajuda? \\nDigite: sair\",\n  \"üí°Dica: O modo ajuda n√£o lhe permite comprar. \\nDigite: sair\",\n   \"üí°Dica:Esta em duvida?.\\nDigite: cardapio\",\n  \"üí°Dica: E se eu errar o nome da pizza?.\\n Entraremos no modo montagem.\\n'Ele vai te dar as op√ß√µes.'\",\n   \"üí°Dica: E se eu errar o nome da pizza?.\\n E n√£o quiser o modo montagem?\\ 'Digite n√£o.'\" , \n   \"üí°Dica:  Consultar por nome , exemplo  'baiana', permite voc√™ ver todos os detalhes item.'\" ,\n   \"üí°Dica:  O que seria a montagem? \\nAjudamos voc√™ a escolher entre duas ou mais op√ß√µes apenas digitando uma op√ß√£o 1...3, caso tenha.'\" \n];\n\nconst random = dicas[Math.floor(Math.random() * dicas.length)];\n\nreturn [{ json: { dica: random } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-384,560],"id":"15324b06-6d36-43fb-bd6b-e48b21a9be5f","name":"dicas"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.status }}","rightValue":"finalizar","operator":{"type":"string","operation":"equals"},"id":"81bd78a6-4445-40b6-aa35-3297adbbb043"}],"combinator":"and"},"renameOutput":true,"outputKey":"finalizar"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"f8a93896-352c-4558-a8e1-ab396b888320","leftValue":"={{ $json.status }}","rightValue":"ingrediente","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ingrediente"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b8425a1a-ae21-474b-a489-90e98ab03d11","leftValue":"={{ $json.status }}","rightValue":"enviado","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"enviado"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[512,544],"id":"d7a059c1-c2ae-49d3-9797-9ab479eaf51a","name":"Switch1"},{"parameters":{"assignments":{"assignments":[{"id":"cb9bbfc2-3f0e-467a-ae77-f64a2c0d16b4","name":"texto","value":"= {{$('FieldsCarrinho').item.json.texto }}\n```Ok, vou ajudar voc√™ a adicionar itens.\nPor favor, informe quais itens deseja adicionar ao seu carrinho. \nExemplos:  Adicionar borda cheedar   ao item 1 \n           Adicionar item  mussarela ao item 2\nObs: Item 1 ou 2 √© relativo ao carrinho.\nEscolha o item do seu carrinho de 1 a ...{{ $('CarinhoVazio').item.json.count }}``` ","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[816,544],"id":"11542d90-9322-498e-9d04-ee4d486ffac4","name":"AddIngridiente"},{"parameters":{"content":"##  Consular e escolher Op√ß√µes\nCancelar um pedido","height":952,"width":1604,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-3104,3088],"id":"dfa39c33-6758-4971-a724-883a0f8db73d","name":"Sticky Note34"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[4416,-320],"id":"8a310352-d226-4885-a4c6-e130b1b13aeb","name":"No Operation, do nothing22","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"sessionIdType":"customKey","sessionKey":"5516992975836"},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[-2768,3600],"id":"a6e965c4-2a6a-4889-8b99-57ae3431428d","name":"Postgres Chat Memory1","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-2912,3600],"id":"20724aef-242f-4c0b-b33b-47f91596962f","name":"OpenAI Chat Model6","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-2000,3376],"id":"0251bb9b-d024-42d1-a9f6-3fa529e45f7a","name":"No Operation, do nothing24","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"workflowId":{"__rl":true,"value":"gL1FbKkYm9zGfCAA","mode":"list","cachedResultName":"Kernel Pizza"},"workflowInputs":{"mappingMode":"defineBelow","value":{"mensagem":"= ```{{ $json.output }}```","user_id":"= {{ $('MontPedido').item.json.user_id }}  ","rotina":6,"telefone":"= {{ $('Dados Lead').item.json.IdConversa }}","pedido_id":"={{ $('MontPedido').item.json.pedido_id }}\n\n","id_empresa":"={{ $('Dados Lead').item.json.id_empresa }}"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-2320,3536],"id":"a186385b-3069-48c1-8461-c5003c4b619e","name":"ExecutaMontagem8"},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"messages":{"values":[{"content":"=O seu objetivo √© montar sua pizza com suas pizzas que possuem varias op√ß√µes.\nUse no telefone      \n\n \n"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-2416,3376],"id":"2f9dabf2-1300-460f-82b7-2731fb2d2a4c","name":"ChamaConversational2","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"description":"O seu objetivo √© oferecer digas aleat√≥rias ","jsCode":"    const dicas = [\n  \"üí°Dica: Voc√™ pode pedir pizza pelo n√∫mero do card√°pio.\\n Ex: '1 pizza 12 grande'\",\n  \"üí°Dica: Para excluir um item:\\nDigite 'Carrinho' ‚Üí depois 'Excluir item 1'\",\n  \"üí°Dica: Pizza fracionada s√≥ no tamanho grande üòâ\\n Ex: '1/2 mussarela e 1/2 calabresa (grande)'\",\n  \"üí°Dica: Pizza fracionada s√≥ no tamanho grande üòâ\\n Ex: '1/2 9  e 1/2 28  grande'\",\n  \"üí°Dica: Pizza fracionada com borda cheedar üòâ\\n Ex: '1/2 mussarela e 1/2 calabresa (grande) borda cheddar'\",\n  \"üí°Dica: Se voc√™ j√° escolheu o n√∫mero da Pizza? \\nüòâ Ex: '1/2 21 e 1/2 12  (grande) '\",\n  \"üí°Dica: Para consultar sabores basta digitar um nome, tipo: 'Marguerita' ou Frango ou Baiana\",\n  \"üí°Dica: Voc√™ pode pedir tamb√©m por voz üé§ (se n√£o entender, escreva)\",\n  \"üí°Dica: Quer ver a lista de d√∫vidas mais comuns? \\n Digite: ajuda\",\n  \"üí°Dica: Quer sair do modo ajuda? \\nDigite: sair\",\n  \"üí°Dica: O modo ajuda n√£o lhe permite comprar. \\nDigite: sair\",\n   \"üí°Dica:Esta em duvida?.\\nDigite: cardapio\",\n  \"üí°Dica: E se eu errar o nome da pizza?.\\n Entraremos no modo montagem.\\n'Ele vai te dar as op√ß√µes.'\",\n   \"üí°Dica: E se eu errar o nome da pizza?.\\n E n√£o quiser o modo montagem?\\ 'Digite n√£o.'\" , \n   \"üí°Dica:  Consultar por nome , exemplo  'baiana', permite voc√™ ver todos os detalhes item.'\" ,\n   \"üí°Dica:  O que seria a montagem? \\nAjudamos voc√™ a escolher entre duas ou mais op√ß√µes apenas digitando uma op√ß√£o 1...3, caso tenha.'\" \n];\n\nconst random = dicas[Math.floor(Math.random() * dicas.length)];\n\nreturn [{ json: { dica: random } }];\n"},"type":"@n8n/n8n-nodes-langchain.toolCode","typeVersion":1.3,"position":[-2448,3568],"id":"df9dd785-f353-4322-9da2-6451d3ae34c2","name":"GetDicaAleatoria1"},{"parameters":{"workflowId":{"__rl":true,"value":"gl0RYjlzfJknufRk","mode":"list","cachedResultName":"consulta"},"workflowInputs":{"mappingMode":"defineBelow","value":{"mensagem":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('mensagem', `sabor`, 'string') }}","user_id":"= {{ $('MontPedido').item.json.user_id }}  ","rotina":6,"telefone":"={{ $('Dados Lead').item.json.IdConversa }}","pedido_id":"={{ $('MontPedido').item.json.pedido_id }}","id_empresa":"={{ $('Dados Lead').item.json.id_empresa }}"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-2656,3600],"id":"a9bcff56-5e05-4114-ab1f-111ddaa601f7","name":"ConsultaOnlineVendas3"},{"parameters":{"workflowId":{"__rl":true,"value":"gL1FbKkYm9zGfCAA","mode":"list","cachedResultName":"Kernel Pizza"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"={{ $('MontPedido').item.json.user_id }}","pedido_id":"= {{ $('MontPedido').item.json.pedido_id }}","id_empresa":"={{ $('Dados Lead').item.json.id_empresa }}","rotina":1,"mensagem":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('mensagem', `itencao`, 'string') }}","telefone":"={{ $('Dados Lead').item.json.IdConversa }}"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-2544,3584],"id":"1952852a-8163-4561-84e0-946e2200be39","name":"IntencaoCompra1"},{"parameters":{"operation":"executeQuery","query":"select  item_id, numero, nome , tamanho , quantidade from item_pedido_temp  where user_id = {{ $('MontPedido').item.json.user_id }}  and pedido_id ={{ $('MontPedido').item.json.pedido_id }}  and id_empresa =  {{ $('Dados Lead').item.json.id_empresa }}  and categoria = 'pizza'","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[-2560,3712],"id":"cad8f727-b13b-4041-b4ad-6c5d495b81db","name":"GetCarrinho1","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"promptType":"define","text":"= {{ $('MensagemTraduzida').item.json.message }}","options":{"systemMessage":"= üë®‚Äçüç≥ Agente: Fracionador ‚Äî Montador T√©cnico de Pizzas Fracionadas\n\nFale como humano, simp√°tico e direto. M√°x. 2 frases por resposta; 1 pergunta por vez.\n\nClima caloroso, zero formalidade.\n\nVerdades e limites\n\nN√£o invente itens, tamanhos, pre√ßos, promo√ß√µes.\n\n  \n\nPapel:\nVoc√™ √© um assistente t√©cnico respons√°vel por resolver apenas pizzas fracionadas.\n\nEntrada:\n- Texto natural vindo do agente principal (ex.: ‚Äú1 pizza 1/2 dom edu e 1/2 marguerita grande com borda catupiry‚Äù)\n- user_id, pedido_id, (opcional) tamanho, borda\n\nRegras principais:\n1Ô∏è‚É£ Identifique sempre se √© fracionada (‚Äú1/2‚Äù).\n2Ô∏è‚É£ Separe os dois sabores (metade 1 e metade 2).\n3Ô∏è‚É£ Chame `ConsultaOnlineVendas(\"pizza <sabor>\")` para cada metade.\n4Ô∏è‚É£ Grave cada metade com `GravarFracionado(parte, numero, tamanho?)`.\n   - Pergunte tamanho apenas na 1¬™ metade.\n5Ô∏è‚É£ Se houver ‚Äúcom borda ...‚Äù, chame `ConsultaOnlineVendas(\"borda <sabor>\")` e guarde o n√∫mero.\n6Ô∏è‚É£ Quando as duas metades estiverem resolvidas, chame:\n   - Se houver borda ‚Üí `IntencaoCompra(\"1 pizza 1/2 n1 e 1/2 n2 <tamanho> com borda nborda\")`\n   - Caso contr√°rio ‚Üí `IntencaoCompra(\"1 pizza 1/2 n1 e 1/2 n2 <tamanho>\")`\n\nMem√≥ria de apoio:\n- Use `n8nhistories` para recuperar dados pendentes de metades anteriores.\n- Use `item_pedido_temp` para validar se j√° existe a parte 1.\n- Sempre finalize com status `\"fracionada_concluida\"`.\n\nRespostas:\n- Curta, t√©cnica e objetiva.\n- Nunca invente sabor, n√∫mero, tamanho ou pre√ßo.\n- Retorne apenas logs de a√ß√£o (‚Äú‚úÖ Metade 1 gravada com sucesso‚Äù, ‚Äú‚û°Ô∏è Aguardando segunda metade‚Äù etc.)\n\nProibi√ß√£o:\n‚ùå N√£o fazer upsell, sugest√µes ou brincadeiras.\n‚ùå N√£o confirmar duas vezes o mesmo sabor.\n‚ùå N√£o chamar `IntencaoCompra` antes de resolver ambas as metades.\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[-2768,3360],"id":"59d24172-8cbe-4e4d-bf79-0c947c43aa30","name":"Assistente Fracionado"},{"parameters":{"operation":"executeQuery","query":" \n\n\nINSERT INTO log_debug (etapa, comando, retorno, user_id, pedido_id, id_empresa )\nVALUES ('IntencaoCompra', '{{ $('When Executed by Another Workflow').item.json.mensagem }}', 'chamada recebida', {{ $('DadoPedido').item.json.user_id }}, {{ $('DadoPedido').item.json.pedido_id }} , {{ $('Dados Lead').item.json.id_empresa }});","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[4032,-1024],"id":"dd6c4046-0b5d-407e-8fd9-ab9884f9425e","name":"LogFinal","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":" \n\n\nINSERT INTO log_debug (etapa, comando, retorno, user_id, pedido_id, id_empresa )\nVALUES ('Inicio processo', '{{ $('MensagemTraduzida').item.json.message }}', 'chamada recebida {{ $('Dados Lead').item.json.instance }}', {{ $json.user_id }} , {{ $json.pedido_id }} ,  {{ $('Dados Lead').item.json.id_empresa }});","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-608,-656],"id":"9a7a727f-ec4f-423a-9ca1-c4c84e876316","name":"LogFinal1","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"description":"Chama essa tool para buscar um sabor no card√°pio","workflowId":{"__rl":true,"value":"gl0RYjlzfJknufRk","mode":"list","cachedResultName":"ConsultaOnline"},"workflowInputs":{"mappingMode":"defineBelow","value":{"mensagem":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('mensagem', `ingrediente`, 'string') }}","user_id":"= {{ $('MontPedido').item.json.user_id }}  ","rotina":7,"telefone":"={{ $('Dados Lead').item.json.IdConversa }}","pedido_id":"={{ $('MontPedido').item.json.pedido_id }}","id_empresa":"={{ $('Dados Lead').item.json.id_empresa }}"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[2096,2432],"id":"032953cb-243d-45ae-8804-2bbbc16b854a","name":"BuscaPizzaSabor","disabled":true},{"parameters":{"descriptionType":"manual","toolDescription":"Execute a SQL query in Postgres","operation":"executeQuery","query":" SELECT \n  ROW_NUMBER() OVER (ORDER BY unaccent(lower(trim(categoria)))) AS numero,\n  unaccent(lower(trim(categoria))) AS categoria\nFROM cardapio\nWHERE id_empresa = {{ $('Dados Lead').item.json.id_empresa }}\n  AND categoria IS NOT NULL\n  AND trim(categoria) <> ''\nGROUP BY unaccent(lower(trim(categoria)))\nORDER BY numero;","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[2016,1792],"id":"6e818dff-6d27-4c36-a12a-29fbf63f3b57","name":"GetCategoria","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"gl0RYjlzfJknufRk","mode":"list","cachedResultName":"ConsultaOnline"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"= {{ $('MontPedido').item.json.user_id }}  ","rotina":1,"telefone":"={{ $('Dados Lead').item.json.IdConversa }}","pedido_id":"={{ $('MontPedido').item.json.pedido_id }}","id_empresa":"={{ $('Dados Lead').item.json.id_empresa }}","mensagem":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('mensagem', `categoria`, 'string') }}","categoria":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('categoria', `categoria`, 'string') }}","numero":0,"quantidade":0,"tamanho":"''","volume":"''"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"categoria","displayName":"categoria","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"numero","displayName":"numero","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"quantidade","displayName":"quantidade","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"tamanho","displayName":"tamanho","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"volume","displayName":"volume","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[960,1696],"id":"acc38088-f392-475f-b94d-9b3bf6d301e1","name":"Compras"},{"parameters":{"jsCode":"  // =====================================================\n// üîπ CAPTURA DE DADOS B√ÅSICOS\n// =====================================================\nconst user_id = $('MontPedido').first().json.user_id || 0;\nconst pedido_id = $('MontPedido').first().json.pedido_id || 0;\nconst id_empresa = $('Dados Lead').first().json.id_empresa || 0;\nconst telefone = ($('Dados Lead').first().json.telefone || \"\").toString();\n\n// üî∏ Cria chave √∫nica est√°vel (concatena√ß√£o simples)\nconst userkey = `${user_id}${id_empresa}${telefone}`;\n\n\n// =====================================================\n// üîπ CAPTURA E CONVERS√ÉO DA MENSAGEM DO USU√ÅRIO\n// =====================================================\nlet msg = $('MensagemTraduzida').first().json.message || \"\";\n\n// Extrai o primeiro n√∫mero da mensagem\nconst match = msg.match(/\\d+/);\nconst numero_escolha = match ? parseInt(match[0]) : null;\nconst itemCount = Number($('DadosAnotados').first()?.json?.item_count ?? NaN);\n\n  let categoria = $('DadosAnotados').first()?.json?.categoria ?? null;\n  let nome      = $('DadosAnotados').first()?.json?.nome      ?? null;\n\n if (itemCount === 0) {\n  categoria = $('LLM RETORNOU NDA').first()?.json?.categoria ?? categoria;\n  nome      = $('LLM RETORNOU NDA').first()?.json?.sabor     ?? nome;\n}\n\n// =====================================================\n// ‚úÖ RETORNO UNIFICADO PARA O PR√ìXIMO NODE (Postgres)\n// =====================================================\nreturn [\n  {\n    json: {\n      user_id,\n      pedido_id,\n      id_empresa,\n      telefone,\n      userkey,\n      numero: $('DadosAnotados').first().json.numero,\n      mensagem_original: msg,\n      tamanho:$('DadosAnotados').first().json.tamanho,\n      quantidade: $('DadosAnotados').first().json.quantidade,\n      categoria: categoria ,\n      nome: nome ,\n     numero_escolha: numero_escolha,\n      volume: $('DadosAnotados').first().json.volume \n     \n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1248,1360],"id":"7098c43c-fc21-4be5-96fe-0755c60478ba","name":"MemoryKey2"},{"parameters":{"jsCode":" return [\n  {\n    json: {\n      memoryKey: $(\"Dados Lead\").item.json.telefone \n              || $(\"Dados Lead\").item.json.fone \n              || $(\"Dados Lead\").item.json.contato?.telefone\n    }\n  }\n];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2096,-3392],"id":"cd2b2a90-f82d-4da1-b868-b1d5b9911967","name":"MemoryKeqy"},{"parameters":{"jsCode":"  // üîπ Entrada esperada do node anterior\nconst user_id = $('MontPedido').first().json.user_id || 0;\nconst pedido_id = $('MontPedido').first().json.pedido_id || 0;\nconst id_empresa = $('Dados Lead').first().json.id_empresa || 0;\nconst telefone = ($('Dados Lead').first().json.telefone || \"\").toString();\n\n// üî∏ 1Ô∏è‚É£ Cria chave √∫nica est√°vel (s√≥ concatena√ß√£o pura)\nconst userkey = `${user_id}${id_empresa}${telefone}`;\n\n// ‚úÖ 2Ô∏è‚É£ Retorno no formato correto pro n8n\nreturn [\n  {\n    json: {\n      user_id,\n      pedido_id,\n      id_empresa,\n      telefone,\n      userkey\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1152,-1264],"id":"6b66b4f9-82da-4816-8564-f361aac7ffe4","name":"MemoryKey"},{"parameters":{"operation":"executeQuery","query":"UPDATE item_pedido_temp AS ip\nSET id_pizza_pai = ip.item_id\nFROM item_pedido_temp AS ib\nWHERE ib.id_pizza_pai = ip.item_id                          -- üîπ nova condi√ß√£o principal\n  AND ib.categoria IN ('item','borda')\n  AND ip.categoria = 'pizza'\n  AND ib.status = 'inicio'\n  AND ip.status = 'concluido'\n  AND ib.user_id = ip.user_id\n  AND ib.pedido_id = ip.pedido_id\n  AND ib.id_empresa = ip.id_empresa\n  AND ib.user_id = {{ $('DadoPedido').item.json.user_id }}\n  AND ib.pedido_id = {{ $('DadoPedido').item.json.pedido_id }}\n  AND ib.id_empresa = {{ $('Dados Lead').item.json.id_empresa }}; ","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2512,-320],"id":"50645330-8e41-46c4-8bec-18c0450f4b25","name":"VinculaPizzaBordaItem","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":" SELECT \n   '\\n\\nüìã Card√°pio:\\n' || COALESCE(cardapio, '')\n  || '\\n\\nüñºÔ∏è Esfirras:\\n'  || COALESCE(imagem_cardapio, '')\n  AS saudacao\nFROM empresas\nWHERE id_empresa = 1;\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1008,1360],"id":"3fd568fa-ebe6-40cf-9d76-96f272831afd","name":"Execute a SQL query","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"description":"Fecha um pedido","workflowId":{"__rl":true,"value":"gL1FbKkYm9zGfCAA","mode":"list","cachedResultName":"Kernel Pizza"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"={{ $('MontPedido').item.json.user_id }}","pedido_id":"= {{ $('MontPedido').item.json.pedido_id }}","id_empresa":"={{ $('Dados Lead').item.json.id_empresa }}","rotina":2,"mensagem":"=fechar","telefone":"={{ $('Dados Lead').item.json.IdConversa }}","instance":"= {{ $('Dados Lead').item.json.instance }}","apikey":"={{ $('Dados Lead').item.json.apikey }}","acao":"fechar"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"instance","displayName":"instance","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"apikey","displayName":"apikey","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"acao","displayName":"acao","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[1360,1744],"id":"dc2f0a62-6f5e-4531-bcf3-34c966e833f2","name":"FecharPedido"},{"parameters":{"description":"Fecha um pedido","workflowId":{"__rl":true,"value":"gL1FbKkYm9zGfCAA","mode":"list","cachedResultName":"Kernel Pizza"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"={{ $('MontPedido').item.json.user_id }}","pedido_id":"= {{ $('MontPedido').item.json.pedido_id }}","id_empresa":"={{ $('Dados Lead').item.json.id_empresa }}","rotina":5,"mensagem":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('mensagem', `itencao  `, 'string') }}","telefone":"={{ $('Dados Lead').item.json.IdConversa }}","instance":"= {{ $('Dados Lead').item.json.instance }}","apikey":"={{ $('Dados Lead').item.json.apikey }}"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"instance","displayName":"instance","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"apikey","displayName":"apikey","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[1280,1664],"id":"871f9544-dd6b-4e86-bd47-e740eccadd7a","name":"GetCarrinho"},{"parameters":{"workflowId":{"__rl":true,"value":"gL1FbKkYm9zGfCAA","mode":"list","cachedResultName":"Kernel Pizza"},"workflowInputs":{"mappingMode":"defineBelow","value":{"mensagem":"={{ $('MensagemTraduzida').item.json.message }}","user_id":"={{ $('MontPedido').item.json.user_id }}   ","pedido_id":"={{ $('MontPedido').item.json.pedido_id }} ","rotina":4,"telefone":"={{ $('Dados Lead').item.json.IdConversa }}","id_empresa":"={{ $('Dados Lead').item.json.id_empresa }}","instance":"={{ $('Dados Lead').item.json.instance }}","apikey":"={{ $('Dados Lead').item.json.apikey }}","acao":"carrinho"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"instance","displayName":"instance","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"apikey","displayName":"apikey","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"acao","displayName":"acao","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[400,-1200],"id":"9b2f2748-84f6-4a2b-9d05-2a3a570d394b","name":"Call n8n Workflow Tool3"},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"messages":{"values":[{"content":"=O seu objetivo √© chamar o fluxo gerador de itens do carrinho. \n\nUse no telefone  {{ $('Dados Lead').item.json.IdConversa }}"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[272,-1360],"id":"9c8d32e0-5bcf-4887-ad3a-bd772cc0a195","name":"ChamaPrecarrinho","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"operation":"get","tableId":"pedido_temp","filters":{"conditions":[{"keyName":"user_id","keyValue":"={{ $('MontPedido').item.json.user_id }}"},{"keyName":"pedido_id","keyValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"keyName":"id_empresa","keyValue":"={{ $('Dados Lead').item.json.id_empresa }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-144,-1152],"id":"898e52cb-2973-4721-9b63-83e23111a561","name":"StatusPedido","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"content":"##  Fechamento\nFechamento de um pedido de cliente","height":616,"width":1700},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-752,-1408],"id":"e9e0ff41-604c-4e4e-aee0-73c095aed8ef","name":"Sticky Note20"},{"parameters":{"operation":"executeQuery","query":"select count(*)::INT  from item_pedido_temp  WHERE \n  user_id = {{ $('MontPedido').item.json.user_id }} \n  AND pedido_id = {{ $('MontPedido').item.json.pedido_id }} and \nid_empresa = {{ $('Dados Lead').item.json.id_empresa }};\n\n\n ","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-656,-976],"id":"896736e2-05bc-480e-aa29-5424ce1a63aa","name":"VerificaCarrinhoVazio","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":" update pedido_temp set status ='finalizar'  WHERE \n  user_id = {{ $('MontPedido').item.json.user_id }} \n  AND pedido_id = {{ $('MontPedido').item.json.pedido_id }} and \nid_empresa = {{ $('Dados Lead').item.json.id_empresa }};","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[576,-1360],"id":"396dd89c-0c41-461c-8ae0-35f1c5472c36","name":"Finalizar1","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"50fdf9df-620d-483e-b114-bb3d9dc1caea","leftValue":"={{ $json.status }}","rightValue":"finalizar","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[96,-1152],"id":"db3ff912-bebe-44a3-b62a-1b3fc4939b82","name":"If3"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"92b4a80f-9642-42ba-9d5b-534e35757324","leftValue":"={{ $json.count }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-448,-976],"id":"db872aef-490b-4cc6-8211-53338feca2fa","name":"If7"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[112,-960],"id":"193a56a0-2a35-4998-b06e-bd67b701349e","name":"No Operation, do nothing34","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"resource":"messages-api","instanceName":"={{ $('Dados Lead').item.json.instance}}","remoteJid":"={{ $('Dados Lead').item.json.IdConversa }}","messageText":"= ```üõíSeu carrinho esta vazio.```","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[-160,-960],"id":"5ac2189e-4d43-47d3-805d-726bfdb3173f","name":"MenuCardapio","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"gL1FbKkYm9zGfCAA","mode":"list","cachedResultName":"Kernel Pizza"},"workflowInputs":{"mappingMode":"defineBelow","value":{"mensagem":"= ```{{ $json.output }}```","user_id":"= {{ $('MontPedido').item.json.user_id }}  ","rotina":6,"telefone":"= {{ $('Dados Lead').item.json.IdConversa }}","pedido_id":"={{ $('MontPedido').item.json.pedido_id }}","id_empresa":"={{ $('Dados Lead').item.json.id_empresa }}","instance":"={{ $('Dados Lead').item.json.instance }}","apikey":"={{ $('Dados Lead').item.json.apikey }}","acao":"responde"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"instance","displayName":"instance","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"apikey","displayName":"apikey","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"acao","displayName":"acao","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[1920,1504],"id":"eba482cd-9878-47b6-a497-421ac54cbe7f","name":"conversational"},{"parameters":{"workflowId":{"__rl":true,"value":"gL1FbKkYm9zGfCAA","mode":"list","cachedResultName":"Kernel Pizza"},"workflowInputs":{"mappingMode":"defineBelow","value":{"mensagem":"= ```{{ $json.texto }}```\n ","user_id":"= {{ $('MontPedido').item.json.user_id }}  ","rotina":6,"telefone":"= {{ $('Dados Lead').item.json.IdConversa }}","pedido_id":"={{ $('MontPedido').item.json.pedido_id }}\n\n","id_empresa":"={{ $('Dados Lead').item.json.id_empresa }}","instance":"={{ $('Dados Lead').item.json.instance }}","apikey":"={{ $('Dados Lead').item.json.apikey }}","acao":"carrinho"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"instance","displayName":"instance","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"apikey","displayName":"apikey","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"acao","displayName":"acao","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[1408,784],"id":"8346869c-1cb4-4e2f-9c2a-11c2d1ac90b9","name":"FerramentaCarrinho"},{"parameters":{"description":"Chama essa tool para buscar um sabor no card√°pio","workflowId":{"__rl":true,"value":"gl0RYjlzfJknufRk","mode":"list","cachedResultName":"ConsultaOnline"},"workflowInputs":{"mappingMode":"defineBelow","value":{"mensagem":"={{ $json.nome}}","user_id":"= {{ $('MontPedido').item.json.user_id }}  ","rotina":7,"telefone":"={{ $('Dados Lead').item.json.IdConversa }}","pedido_id":"={{ $('MontPedido').item.json.pedido_id }}","id_empresa":"={{ $('Dados Lead').item.json.id_empresa }}","categoria":"={{ $json.categoria }}","numero":"={{ $json.numero }}","quantidade":"={{ $json.quantidade }}","tamanho":"={{ $json.tamanho }}","volume":"={{ $json.volume }}"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"categoria","displayName":"categoria","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"numero","displayName":"numero","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"quantidade","displayName":"quantidade","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"tamanho","displayName":"tamanho","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"volume","displayName":"volume","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[1168,1680],"id":"e8312cd3-ebff-429d-852f-8bfc746ce8e4","name":"ConsultaOnline"},{"parameters":{"promptType":"define","text":"= {{ $('jsoncontroleIA').item.json.message }}","options":{"systemMessage":"= üçï Prompt completo ‚Äî ‚ÄúGar√ßom Descolado Inteligente‚Äù\n \n\n\n\nüéôÔ∏è PERSONA: ‚ÄúLuiz√£o, o Gar√ßom da La Cantina üçï‚Äù\n\nVoc√™ √© Luiz√£o, o gar√ßom virtual da pizzaria La Cantina.\nSeu estilo √© descontra√≠do, simp√°tico, direto e sem enrola√ß√£o.\nFale de forma leve, mas nunca invente nada ‚Äî todas as informa√ß√µes v√™m do banco.\nSe a entrada for JSON com \"acao\":\"Instrucao\", responda ao usu√°rio usando os campos \"mensagem\" e \"sugestao\" (se houver) e N√ÉO execute nenhuma ferramenta.\n\n   \nSe a entrada for um JSON contendo a chave \"acao\", execute imediatamente a ferramenta cujo nome √© exatamente o valor de \"acao\", passando os demais campos como par√¢metros.  \nNunca gere texto, nunca confirme, apenas execute.\nSe o valor de \"acao\" n√£o corresponder a nenhuma ferramenta registrada, responda: A√ß√£o desconhecida: \"<acao>\".\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[1504,1360],"id":"a36d4460-2ebc-4e73-b1d5-8c634b7cac88","name":"AI Agent"},{"parameters":{"jsCode":" // üîπ Entrada esperada do node anterior\nconst user_id = $('MontPedido').first().json.user_id || 0;\nconst pedido_id = $('MontPedido').first().json.pedido_id || 0;\nconst id_empresa = $('Dados Lead').first().json.id_empresa || 0;\nconst telefone = ($('Dados Lead').first().json.telefone || \"\").toString();\n\n// üî∏ 1Ô∏è‚É£ Cria chave √∫nica est√°vel (s√≥ concatena√ß√£o pura)\nconst userkey = `${user_id}${id_empresa}${telefone}`;\n\n// ‚úÖ 2Ô∏è‚É£ Retorno no formato correto pro n8n\nreturn [\n  {\n    json: {\n      user_id,\n      pedido_id,\n      id_empresa,\n      telefone,\n      userkey\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3728,-320],"id":"179d08ff-e924-4b49-872b-25a5e024c41c","name":"MemoryKey3"},{"parameters":{"operation":"executeQuery","query":" \n DELETE FROM n8n_chat_histories  WHERE TRIM(session_id) =   {{$json.userkey}}::text;\n \n\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[4048,-720],"id":"4d102a4c-d761-42fb-819b-cbcc2d8660ee","name":"LimpaN8nHistories","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}},"disabled":true},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.toolCode","typeVersion":1.3,"position":[2144,736],"id":"db03849d-fb96-455e-9e6f-ac1da290766b","name":"Code Tool"},{"parameters":{"description":"Essa inten√ß√£o de compra deve ser executada sempre que for solicitqado","workflowId":{"__rl":true,"value":"gL1FbKkYm9zGfCAA","mode":"list","cachedResultName":"Kernel Pizza"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"={{ $('MontPedido').item.json.user_id }}","pedido_id":"= {{ $('MontPedido').item.json.pedido_id }}","id_empresa":"={{ $('Dados Lead').item.json.id_empresa }}","rotina":1,"mensagem":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('mensagem', `itencao  `, 'string') }}","telefone":"={{ $('Dados Lead').item.json.IdConversa }}","instance":"= {{ $('Dados Lead').item.json.instance }}","apikey":"={{ $('Dados Lead').item.json.apikey }}","acao":"gravar"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"instance","displayName":"instance","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"apikey","displayName":"apikey","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"acao","displayName":"acao","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[1600,1840],"id":"2c80ee40-6d47-4fcd-9068-e60d6c00e774","name":"GravaPizza"},{"parameters":{"jsCode":" // üîπ Entrada esperada do node anterior\nconst user_id = $('MontPedido').first().json.user_id || 0;\nconst pedido_id = $('MontPedido').first().json.pedido_id || 0;\nconst id_empresa = $('Dados Lead').first().json.id_empresa || 0;\nconst telefone = ($('Dados Lead').first().json.telefone || \"\").toString();\n\n// üî∏ 1Ô∏è‚É£ Cria chave √∫nica est√°vel (s√≥ concatena√ß√£o pura)\nconst userkey = `${user_id}${id_empresa}${telefone}`;\n\n// ‚úÖ 2Ô∏è‚É£ Retorno no formato correto pro n8n\nreturn [\n  {\n    json: {\n      user_id,\n      pedido_id,\n      id_empresa,\n      telefone,\n      userkey\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1312,576],"id":"947c1a1e-9490-4ba5-85f1-4fd6a48c04de","name":"MemoryKey4","disabled":true},{"parameters":{"description":"Essa inten√ß√£o de compra deve ser executada sempre que for solicitqado","workflowId":{"__rl":true,"value":"gL1FbKkYm9zGfCAA","mode":"list","cachedResultName":"Kernel Pizza"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"={{ $('MontPedido').item.json.user_id }}","pedido_id":"= {{ $('MontPedido').item.json.pedido_id }}","id_empresa":"={{ $('Dados Lead').item.json.id_empresa }}","rotina":1,"mensagem":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('mensagem', `itencao  `, 'string') }}","telefone":"={{ $('Dados Lead').item.json.IdConversa }}","instance":"= {{ $('Dados Lead').item.json.instance }}","apikey":"={{ $('Dados Lead').item.json.apikey }}","acao":"gravar"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"instance","displayName":"instance","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"apikey","displayName":"apikey","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"acao","displayName":"acao","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[1312,1968],"id":"89c1fb21-e72b-4195-8a72-e82dfcc6ca01","name":"GravaFracionado"},{"parameters":{"descriptionType":"manual","toolDescription":"Grav a quantidade de pizzas ","operation":"executeQuery","query":" SELECT * \nFROM GravaQuantidade (\n  {{ $json.user_id }},\n  {{ $json.id_empresa }}, \n    {{ $json.numero_escolha }}\n);","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[240,1792],"id":"19f1f70d-4ca5-42ab-b158-e13775daf7d0","name":"GravaQuantidade","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}},"disabled":true},{"parameters":{"operation":"executeQuery","query":" \nselect * from f_next_step( {{ $('MontPedido').item.json.user_id }},{{ $('Dados Lead').item.json.id_empresa }})\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[576,1360],"id":"4a543d71-c472-429e-959e-d769e72c7c0f","name":"PrimeiraEscolha","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"descriptionType":"manual","toolDescription":"Busca o dardapio da joja ","operation":"executeQuery","query":" SELECT \n   '\\n\\nüìã Card√°pio:\\n' || COALESCE(cardapio, '')\n  || '\\n\\nüñºÔ∏è Esfirras:\\n'  || COALESCE(imagem_cardapio, '')\n  AS saudacao\nFROM empresas\nWHERE id_empresa = {{ $('Dados Lead').item.json.id_empresa }};","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[2240,1744],"id":"885b04c1-d872-44c6-a737-d67c7bf2eeb2","name":"GetCardapio","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"description":"Essa inten√ß√£o de compra deve ser executada sempre que for solicitqado","workflowId":{"__rl":true,"value":"gL1FbKkYm9zGfCAA","mode":"list","cachedResultName":"Kernel Pizza"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"={{ $('MontPedido').item.json.user_id }}","pedido_id":"= {{ $('MontPedido').item.json.pedido_id }}","id_empresa":"={{ $('Dados Lead').item.json.id_empresa }}","rotina":1,"mensagem":"=grava","telefone":"={{ $('Dados Lead').item.json.IdConversa }}","instance":"= {{ $('Dados Lead').item.json.instance }}","apikey":"={{ $('Dados Lead').item.json.apikey }}","acao":"gravaintencao"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"instance","displayName":"instance","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"apikey","displayName":"apikey","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"acao","displayName":"acao","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[1040,1824],"id":"1f846ce7-cc0d-4290-ac9f-9c5753ba0fff","name":"GravaIntencao"},{"parameters":{"descriptionType":"manual","toolDescription":"Executa a proc que busca posicao onmero do cardapio na posicao de descolha","operation":"executeQuery","query":" SELECT * \nFROM   GetNumeroEscolhido  (\n  {{ $json.user_id }},\n  {{ $json.id_empresa }} \n);","options":{"queryReplacement":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Query_Parameters', `QTDE QUANTIDADE`, 'string') }}"}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[2128,448],"id":"1beabaa7-b33f-4510-a8cb-c005dd0c44d6","name":"GetNumeroEscolhido","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":" SELECT * \nFROM GravaTamanho (\n  {{ $json.user_id }},\n  {{ $json.id_empresa }}, \n  $1\n);","options":{"queryReplacement":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Query_Parameters', `tamanho`, 'string') }}"}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[1184,1872],"id":"d55d5255-e186-45a9-9c2c-d5491708e35d","name":"GravaTamanho","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":" \nselect * from turno_opcoes_count_all_false( {{ $('MontPedido').item.json.user_id }},{{ $('Dados Lead').item.json.id_empresa }})\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[384,1360],"id":"f39f4c4f-ec60-4cec-9878-9ab56d2e25f6","name":"Pendentes","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"jsCode":" // Inputs esperados:\n// - next_step: retorno JSON de SELECT f_next_step(user_id,id_empresa)\n// - MensagemTraduzida: texto do cliente\n\nconst msgRaw = $('MensagemTraduzida').first().json.message || \"\";\nconst msg = String(msgRaw).trim().toLowerCase();\n const step = $json.next_step || {};\n \n\n \n// 1Ô∏è‚É£ Pedido de card√°pio  (s√≥ quando N√ÉO estamos aguardando posi√ß√£o)\nif (!(step.acao === 'pedir_posicao' || Number(($('Pendentes').first().json.turno_opcoes_count_all_false ?? 0)) > 0)\n    && (msg.includes('cardapio') || msg.includes('card√°pio'))) {\n  return [{ json: { message: JSON.stringify({ acao: 'getCardapio' }) } }];\n}\n\n // 2Ô∏è‚É£ Posi√ß√£o escolhida (1‚ÄìN) ‚Äî PRIORIT√ÅRIO quando h√° pendentes\nconst pendentes = Number(($('Pendentes').first().json.turno_opcoes_count_all_false ?? 0));\n\nif (step.acao === 'pedir_posicao' || pendentes > 0) {\n  // pega o primeiro inteiro que aparecer na mensagem do usu√°rio\n  const m = String(msg).match(/\\d+/);\n  if (m) {\n    const pos = String(parseInt(m[0], 10));\n    return [{\n      json: {\n        message: JSON.stringify({\n          acao: 'buscar_numero_por_posicao',\n          posicao: pos\n        })\n      }\n    }];\n  }\n  // se n√£o veio n√∫mero, deixa seguir para a mensagem padr√£o do banco (perguntar 1‚ÄìN)\n}\n\n\n// üß© 3Ô∏è‚É£ Etapa de Quantidade ‚Äî vers√£o blindada e funcional no n8n\n\n// Entrada esperada:\n \nconst raw = $('MensagemTraduzida').first()?.json?.message ?? '';\n // limpa e deixa s√≥ d√≠gitos\nlet qtd = 0;\n\ntry {\n  const matchQtd = msg.match(/\\b\\d+\\b/);\n  qtd = matchQtd ? parseInt(matchQtd[0], 10) : 0;\n} catch (err) {\n  qtd = 0;\n}\n\nconst saida = [];\n\n// üß© Se a etapa atual for de pedir quantidade:\nif (step.acao === 'pedir_qtd') {\n  if (qtd > 0) {\n    const out = JSON.stringify({ acao: 'grava_quantidade', qtd: String(qtd) });\n    saida.push({\n      json: {\n        message: out,\n        debug: {\n          acao: step.acao,\n          msgOriginal: raw,\n          msgProcessado: msg,\n          qtdDetectada: qtd,\n        },\n      },\n    });\n  } else {\n    saida.push({\n      json: {\n        message: 'Por favor, digite um n√∫mero v√°lido de unidades.',\n        debug: {\n          acao: step.acao,\n          msgOriginal: raw,\n          msgProcessado: msg,\n          qtdDetectada: qtd,\n        },\n      },\n    });\n  }\n} else {\n  // üü° Se a etapa n√£o for de quantidade, apenas repassa\n  saida.push({\n    json: {\n      message: raw,\n      debug: {\n        motivo: 'Etapa atual n√£o √© de quantidade',\n        step,\n      },\n    },\n  });\n}\n\n// üîö Retorno final sempre em array de objetos\nreturn saida;\n\n\n\n\n\n\n\n\n\n\n// üü¶ 4Ô∏è‚É£ NOVO: Tamanho (somente pizza)\nif (step.acao === 'pedir_tamanho') {\n  // Se o usu√°rio j√° respondeu um tamanho v√°lido\n  if (msg.includes('media') || msg.includes('m√©dia')) {\n    return [{ json: { message: JSON.stringify({ acao: 'grava_tamanho', tamanho: 'm√©dia' }) } }];\n  }\n  if (msg.includes('grande')) {\n    return [{ json: { message: JSON.stringify({ acao: 'grava_tamanho', tamanho: 'grande' }) } }];\n  }\n\n  // Caso n√£o seja v√°lido ‚Üí repetir a pergunta\n  return [{ json: { message: 'Qual tamanho da pizza voc√™ quer? (m√©dia ou grande)' } }];\n}\n\n// 5Ô∏è‚É£ Grava√ß√£o final da inten√ß√£o\nif (step.acao === 'gravar_intencao' && step.numero && step.qtd > 0 && step.categoria) {\n  const texto = step.categoria === 'pizza'\n    ? `${step.qtd} pizza ${step.numero} ${step.tamanho || ''}`.trim()\n    : `${step.qtd} ${step.categoria} ${step.numero}`;\n  return [{ json: { message: JSON.stringify({ acao: 'grava_intencao', texto }) } }];\n}\n\n// 6Ô∏è‚É£ Mensagem padr√£o do banco\nif (step.mensagem) {\n  return [{ json: { message: step.mensagem } }];\n}\n\n// 7Ô∏è‚É£ Fallback\nreturn [{ json: { message: msgRaw } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[144,912],"id":"707ac6cc-a0d8-4991-921b-4ecb3525b403","name":"aa","disabled":true},{"parameters":{"jsCode":" return [{\n  json: {\n    recebido: $json,\n    tipo: typeof $json.message,\n    conteudo_message: $json.message\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3328,704],"id":"d52faa23-ef97-401c-9f0e-12066fac6e00","name":"Code3"},{"parameters":{"jsCode":" // Prote√ß√µes\nconst rawInput = $input.first()?.json ?? {};\nconst step = (rawInput.f_next_step && typeof rawInput.f_next_step === 'object') ? rawInput.f_next_step : null;\n\nconst rawMsg = $('MensagemTraduzida').first()?.json?.message ?? '';\nconst msg = String(rawMsg).trim();\n\n// 4Ô∏è‚É£ Quantidade ‚Äî entra s√≥ se a a√ß√£o for 'pedir_qtd'\nif (step?.acao === 'pedir_qtd') {\n  const qtd = (/^\\d+$/.test(msg)) ? parseInt(msg, 10) : 0;\n\n  if (qtd > 0) {\n    return [{\n      json: {\n        message: JSON.stringify({ acao: 'GravaQuantidade', qtd: String(qtd) }),\n        step,\n        qtd\n      }\n    }];\n  }\n\n  return [{\n    json: {\n      message: 'Por favor, digite um n√∫mero v√°lido de unidades.',\n      step,\n      msg\n    }\n  }];\n}\n\n// Se step for nulo ou outra a√ß√£o, n√£o faz nada\nreturn [];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2096,2704],"id":"6dbf804b-f870-4991-90cc-fe5586bcee41","name":"Code"},{"parameters":{"descriptionType":"manual","toolDescription":"Executa a proc que busca posicao onmero do cardapio na posicao de descolha","operation":"executeQuery","query":" SELECT * \nFROM buscar_numero_por_posicao(\n  {{ $json.user_id }},\n  {{ $json.id_empresa }}, \n  {{ $json.numero_escolha }}\n);","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[1872,1776],"id":"b222657b-8b8b-4f1e-b4ae-e4d3dfadc197","name":"EscolheItemPosicao","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.outputParserAutofixing","typeVersion":1,"position":[-288,1600],"id":"60076b84-33fd-4a05-97a2-ece6e7963105","name":"Auto-fixing Output Parser2","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-416,1840],"id":"93eb96b0-7875-4b53-9d27-9a578bfbae1f","name":"OpenAI Chat Model4","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"schemaType":"manual","inputSchema":"   {\n  \"type\": \"object\",\n  \"properties\": {\n    \"pizzas_inteiras\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"quantidade\": { \"type\": [\"integer\", \"null\"] }, \n          \"numero\": { \"type\": \"integer\" },\n          \"tamanho\":   { \"type\": [\"string\", \"null\"] },\n           \"nome\": { \"type\": \"string\" },\n           \"pizza_referencia\":  { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" }\n          \n        },\n        \"required\": [  ]\n      }\n    },\n    \"pizzas_fracionadas\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"quantidade\": { \"type\": \"integer\" },\n          \"metade1\": { \"type\": \"integer\" },\n          \"metade2\": { \"type\": \"integer\" },\n            \"nome\": { \"type\": \"string\" },\n            \"nome_fracao\": { \"type\": \"string\" },\n           \"pizza_referencia\":  { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" }\n         \n        },\n        \"required\": [\"quantidade\", \"metade1\", \"metade2\",\"pedido_id\"]\n      }\n    },\n    \"bebidas\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n           \"quantidade\": { \"type\": [\"integer\", \"null\"] },\n           \"numero\": { \"type\": \"integer\" },\n          \"nome\": { \"type\": \"string\" },\n          \"volume\": { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" }\n         \n        },\n        \"required\": [ \"numero\", \"nome\", \"volume\",\"comando_original\"]\n      }\n    },\n    \"esfirras\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"quantidade\": { \"type\": [\"integer\", \"null\"] },\n          \"numero\": { \"type\": \"integer\" },\n          \"nome\": { \"type\": \"string\" },\n          \"tipo\": { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" }\n        },\n        \"required\": [   \"numero\", \"nome\", \"tipo\"]\n      }\n    },\n    \"bordas\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"numero\": { \"type\": \"integer\" },\n          \"nome\": { \"type\": \"string\" } ,\n           \"pizza_referencia\":  { \"type\": \"string\" },\n          \"tamanho\": { \"type\": \"string\" }, \n          \"categoria\": { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" },\n            \"pizza_pai\": { \"type\": \"integer\" }\n  \n         \n    },\n        \"required\": [\"numero\", \"pizza_referencia\"]\n      }\n    },\n    \"item\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": { \n          \"numero\": { \"type\": \"integer\" },\n          \"nome\": { \"type\": \"string\" } ,\n            \"tamanho\": { \"type\": \"string\" },\n           \"pizza_referencia\":  { \"type\": \"string\" } ,\n           \"comando_original\":  { \"type\": \"string\" },\n            \"pizza_pai\": { \"type\": \"integer\" }\n          \n    },\n        \"required\": [\"nome\", \"pizza_pai\"]\n      }\n    }\n\n    \n  },\n  \"required\": [\n    \"pizzas_inteiras\",\n    \"pizzas_fracionadas\",\n    \"bebidas\",\n    \"esfirras\",\n    \"bordas\" \n  ]\n}\n\n   "},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.2,"position":[-192,1792],"id":"4d60058a-2450-4e60-9b24-946db0e543c7","name":"Structured Output Parser [Schema]2","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"promptType":"define","text":"=<mensagem_do_usuario>\n{{ $('When Executed by Another Workflow').item.json.mensagem }}\n</mensagem_do_usuario>","hasOutputParser":true,"messages":{"messageValues":[{"message":"=  {\n  \"pizzas_inteiras\": [\n    { \"quantidade\": int, \"numero\": int, \"tamanho\": str , \"nome\": str, \"pizza_referencia\": str, \"comando_original\": str  }   // pizza_referencia √© uma rela√ß√£o com a borda ou com item \n  ],\n  \"pizzas_fracionadas\": [\n    { \"quantidade\": int, \"metade1\": int, \"metade2\": int , \"nome\": str, \n\"nome_fracao\": str , \"pizza_referencia\": str, \"comando_original\": str }\n  ],\n  \"bebidas\": [\n    { \"quantidade\": int, \"numero\": int, \"nome\": str, \"volume\": str , \"comando_original\": str }\n  ],\n \"esfirras\": [\n  { \"quantidade\": int, \"numero\": int, \"nome\": str, \"tipo\": str , \"comando_original\": str } // tipo: \"salgada\" ou \"doce\"\n  ],\n  \"bordas\": [\n   \n { \"numero\": int, \"nome\": str, \"pizza_referencia\": str , \"tamanho\": str, \"categoria\": str, \"comando_original\": str, \"pizza_pai\": int } // pizza_referencia √© uma rela√ß√£o da borda com a pizza \n\n\n// \"pizza_referencia\" = string que identifica a pizza onde ser√° aplicada\n  ]\n \"item\": [\n    { \"numero\": int,\"nome\": str, \"tamanho\": str , \"pizza_pai\": int , \"comando_original\": str, \"pizza_pai\": int } //  \n  ]\n\n\n}\n\n‚ö†Ô∏è Regras obrigat√≥rias:\n- Sempre retorne exatamente essas 5 listas, mesmo que estejam vazias.\n- Use apenas os nomes de campos e estrutura mostrados acima.\n- Retorne **apenas o JSON v√°lido**, sem explica√ß√µes, coment√°rios ou texto adicional.\n\nSe o usu√°rio informar apenas ‚Äòpizza N‚Äô ou nome de sabor (ex.: ‚Äúpizza presunto‚Äù), \nn√£o preencha campos de quantidade nem tamanho ‚Äî ambos devem permanecer nulos. \nS√≥ defina quantidade e tamanho quando o cliente especificar explicitamente.\n\n \n\n‚ÄúNunca omita itens amb√≠guos; use defaults: quantidade=1, tamanho='media'.‚Äù\n\n‚ÄúN√£o valide com o card√°pio. A valida√ß√£o ser√° feita depois; sempre retorne o item.‚Äù\n\n\"A palavra uma , duas  refere-se sempre  quantidade  exemplo uma  pizza mussarela ou uma pizza presunto e queijo √© quantidade..\"\n\n\n\nPrioridade de interpreta√ß√£o\n\nSe houver padr√µes de pizza fracionada no formato {Q? 1/2 A (e|,|+|/) 1/2 B}, crie um item em pizzas_fracionadas com {quantidade: Q || 1, metade1: A, metade2: B}.\n\nNunca crie pizzas_inteiras para n√∫meros A ou B quando eles estiverem dentro de um padr√£o fracionado.\n\nS√≥ trate ‚Äúpizza N‚Äù (inteira) quando n√£o fizer parte de um padr√£o 1/2 N.  \n\nSo trate   \"pizza\" se tiver explicito que se trata de \"pizza\"\n\nSo trate   \"esfirra \" se tiver explicito que se trata de \"esfirra\"\n\no comando_origianal guaro valor da string que gerou o json  exemplo :  ‚Äú1 pizza 1/2 14  e 1/2 21‚Äù\n\nRegras espec√≠ficas para BORDAS (muito importante):\n- Se a mensagem contiver ‚Äúborda‚Äù, o texto imediatamente ap√≥s a palavra ‚Äúborda‚Äù\n  at√© antes de ‚Äúao item‚Äù, ‚Äúno item‚Äù, ‚Äúitem‚Äù, ‚Äúpizza‚Äù ou o fim da frase, √© o campo \"nome\".\n- Normalize espa√ßos e min√∫sculas (ex.: \"Borda   Cheddar\" ‚Üí nome: \"cheddar\").\n\n- Sempre preencha \"categoria\":\"borda\" e \"pizza_pai\" com o n√∫mero do item/pizza alvo quando presente (ex.: \"item_id  1\" ‚Üí pizza_pai: 1).\n- N√£o use o campo \"item[]\"; bordas devem ir apenas em \"bordas[]\".\n- Defaults para borda quando ausentes: numero=0, tamanho=\"\", pizza_referencia=\"\".\n\n\n\nExemplos:\n\n‚Äú1 pizza 1/2 14  e 1/2 21‚Äù ‚Üí pizzas_fracionadas: [{quantidade:1, metade1:14, metade2:21, nome:'', nome_fracao: '' } ]\n\n‚Äú2 1/2 10, 1/2 15‚Äù ‚Üí pizzas_fracionadas: [{quantidade:2, metade1:10, metade2:15 , nome:'', nome_fracao: '' }]\n\n‚Äú14 e 21‚Äù (sem 1/2) ‚Üí pizzas_inteiras: [{q:1,n:14,media},{q:1,n:21,media }]\n\n\n\n‚Äú1 pizza 1/2 mussarela  e 1/2 presunto e queijo ‚Äù ‚Üí pizzas_fracionadas: [{quantidade:1, metade1:0, metade2:0, nome:mussarela, nome_fracao: presunto e queijo } ]\n\n‚Äú1 pizza meia  mussarela  e meia  presunto e queijo ‚Äù ‚Üí pizzas_fracionadas: [{quantidade:1, metade1:0, metade2:0, nome:mussarela, nome_fracao: presunto e queijo } ]\n\nSe o cliente disser meia  interprete como 1/2\n\n\n \nBebidas ‚Äî defaults e sin√¥nimos (obrigat√≥rio)\n\nSe o cliente disser ‚Äúlata‚Äù e n√£o informar volume, use 350ml.\n\nSe o cliente disser ‚Äúlong neck‚Äù e n√£o informar volume, use 330ml.\n\nSe o cliente pedir coca/coca-cola sem volume, use 2l.\n\nNunca rejeite bebidas por falta de volume quando se aplicar uma regra acima.\n\nNormalize o campo volume sempre em min√∫sculas e sem espa√ßos (ex.: 350ml, 330ml, 2l).\n\nExemplos\n\nse vier \"1 borda catupiry para item_id 2277\"  \n\n [ { \"quantidade\": 1, \"numero\": 300, \"nome\": '', \"tipo\": 'borda' , \"comando_original\": '1 borda catupiry para item_id 2277', \"pizza_pai\": 2277}]\n\nse vier \"1 item catupiry para item_id 2277\"  \n\n [ { \"quantidade\": 1, \"numero\": 300, \"nome\": '', \"tipo\": 'item' , \"comando_original\": '1 item catupiry para item_id 2277', \"pizza_pai\": 2277}]\n\n \"quantidade\": int | null,\n \"tamanho\": str | null,\n \"volume\": str | null\n\nüìò Regras para interpreta√ß√£o dos exemplos:\n\nOs exemplos abaixo servem apenas para ilustrar o formato JSON esperado, **n√£o para definir valores fixos**.\n\n‚ö†Ô∏è Nunca copie n√∫meros, c√≥digos, nomes, tamanhos ou volumes dos exemplos.\n‚ö†Ô∏è Sempre use exclusivamente as informa√ß√µes presentes na mensagem real do usu√°rio ou retornadas pelas tools.\n\nREGRA DE BLOQUEIO DE DEFAULTS (priorit√°ria)\nNunca preencha automaticamente a quantidade com 1 nem o tamanho com ‚Äúm√©dia‚Äù \nem nenhuma categoria (pizza, bebida, esfirra, borda ou item).\nDeixe quantidade e tamanho como nulos sempre que o cliente n√£o informar explicitamente.\nEssa regra tem prioridade sobre todos os exemplos e instru√ß√µes seguintes.\n\nSe o usu√°rio disser:\n‚Üí \"1 bebida coca cola 2l\"\nVoc√™ deve analisar o texto e montar o JSON com base exatamente nesse texto, sem usar n√∫meros ou nomes dos exemplos.\n\n \n Se o usu√°rio informar apenas ‚Äúesfirra N‚Äù ou citar o sabor (ex.: ‚Äúesfirra carne‚Äù, ‚Äúesfirra frango‚Äù, ‚Äúesfirra 100‚Äù), \nn√£o defina o campo de quantidade se o n√∫mero n√£o for dito ‚Äî deve permanecer nulo. \nSomente preencha ‚Äúquantidade‚Äù quando o cliente indicar explicitamente (ex.: ‚Äú2 esfirras de carne‚Äù).\n\n\n Se o usu√°rio informar apenas ‚Äòbebida N‚Äô ou nome de refrigerante (ex.: ‚Äúcoca cola‚Äù, ‚Äúguaran√° 600ml‚Äù, ‚Äúpepsi‚Äù), \nn√£o preencha o campo de quantidade se ela n√£o for dita ‚Äî deve permanecer nulo. \nMesmo que o volume seja reconhecido (ex.: 600ml, 2l), s√≥ defina ‚Äúquantidade‚Äù quando o cliente disser explicitamente (ex.: ‚Äú1 coca cola 2l‚Äù).\n\n\nOs exemplos s√£o apenas modelos de estrutura:\n[\n  { \"quantidade\": <n√∫mero>, \"numero\": <obtido da consulta ou 0 se desconhecido>,\n    \"nome\": \"<nome extra√≠do>\", \"tipo\": \"<categoria>\", \"comando_original\": \"<texto do usu√°rio>\",\n    \"pizza_pai\": <id se houver> }\n]\n\n\n\n\n \nquando numa string de comando tiver 1 pizza musssarela  1 borda chedaar na qual o codigo da pizza n√£o for identifica,  crie no campo   \"pizza_referencia\" uma amarra√ß√£o entre 1 pizza mussarela e borda   \"pizza_referencia\" pode ser um codigo unico. Isso vale tambpem para pizza fracionada \n\n"}]}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.6,"position":[-416,1360],"id":"aed43c4a-89fe-410c-844c-3979c986b6e3","name":"LLM CONSTRUTOR1","retryOnFail":true,"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"executeQuery","query":" \n\n\nINSERT INTO log_debug (etapa, comando, retorno, user_id, pedido_id, id_empresa )\nVALUES ('Inicio processo', '{{ $('MensagemTraduzida').item.json.message }}', 'chamada recebida {{ $('Dados Lead').item.json.instance }}', {{ $json.user_id }} , {{ $json.pedido_id }} ,  {{ $('Dados Lead').item.json.id_empresa }});","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-2992,2320],"id":"a838020b-3f5d-434f-8868-338c7a9556a1","name":"LogFinal2","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"jsCode":" // Texto vindo do cliente\nconst textoOriginal = (\n  $('MensagemTraduzida').first().json.message ||\n  $json.texto ||\n  \"\"\n).toLowerCase();\n\nlet texto = textoOriginal\n  .normalize(\"NFD\")\n  .replace(/[\\u0300-\\u036f]/g, \"\") // remove acentos\n  .trim();\n\n// üîπ Remove palavras irrelevantes (ajuda na detec√ß√£o)\ntexto = texto.replace(/\\b(quero|adicionar|por favor|pra mim|com|tem|uma|um|de|da|do|as|os)\\b/g, \"\").trim();\n\n// üîπ Extrai quantidade (ex: \"2 pizza mussarela\")\nconst qtdMatch = texto.match(/\\b\\d+\\b/);\nconst quantidade = qtdMatch ? parseInt(qtdMatch[0], 10) : 1;\n\n// üîπ Lista de categorias conhecidas\nconst categorias = [\"pizza\", \"esfirra\", \"borda\", \"bebida\", \"item\"];\n\n// üîπ Detecta categoria\nlet categoriaDetectada = categorias.find(c => texto.includes(c)) || \"pizza\";\n\n// üîπ Remove quantidade e categoria do texto para achar o nome\nlet nome = texto\n  .replace(/\\b\\d+\\b/, \"\")\n  .replace(new RegExp(\"\\\\b\" + categoriaDetectada + \"s?\\\\b\", \"gi\"), \"\")\n  .trim();\n\nnome = nome.replace(/\\b(grande|media|m√©dia|pequena)\\b/gi, '').replace(/\\s{2,}/g, ' ').trim();\n\n \n\n// üîπ Detecta tamanho (somente se for pizza)\nlet tamanho = \"\";\nif (categoriaDetectada === \"pizza\") {\n  if (texto.includes(\"media\")) tamanho = \"media\";\n  else if (texto.includes(\"pequena\")) tamanho = \"pequena\";\n  else if (texto.includes(\"grande\")) tamanho = \"grande\";\n  else tamanho = \"grande\"; // padr√£o\n}\n\n// üß© NOVO BLOCO ‚Äî detecta n√∫mero de item quando nome √© vazio\nlet numeroItem = 0;\nif (!nome) {\n  // procura o √∫ltimo n√∫mero no texto (geralmente ap√≥s a categoria)\n  const numMatch = texto.match(/\\b\\d+\\b(?=\\s*(grande|media|pequena)?$)/);\n  if (numMatch) numeroItem = parseInt(numMatch[0], 10);\n}\n\n// üîß se detectou n√∫mero de item, n√£o use nome\nif (numeroItem > 0) nome = \"\";\n\n\n// üîπ JSON final\nreturn [{\n  json: {\n    id_empresa: $('Dados Lead').first().json.id_empresa,\n    categoria: categoriaDetectada,\n    quantidade: quantidade,\n    nome: nome,\n    tamanho: tamanho,\n    numero: numeroItem // üß© NOVO CAMPO ‚Äî se cliente disser \"1 pizza 10 grande\"\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2528,1072],"id":"648874b8-d713-4d26-91a8-89e500152176","name":"dd"},{"parameters":{"jsCode":" // Pega a raiz de forma robusta (pode vir como objeto ou array com um objeto)\nconst root = $json;\nconst entrada =\n  root.output ||\n  (Array.isArray(root) && root[0] && root[0].output) ||\n  {}; // fallback\n\n// id_empresa (ajuste se quiser pegar din√¢mico de outro n√≥)\nconst id_empresa =\n  $('Dados Lead').first()?.json?.id_empresa ??\n  $('Dados Lead').first()?.json?.id_empresa ??\n  1;\n\nconst categoriasMap = {\n  pizzas_inteiras: 'pizza',\n  pizzas_fracionadas: 'pizza',\n  esfirras: 'esfirra',\n  bebidas: 'bebida',\n  bordas: 'borda',\n  item: 'item',\n};\n\nconst resultado = [];\n\nfor (const [origem, lista] of Object.entries(entrada)) {\n  if (!Array.isArray(lista) || lista.length === 0) continue;\n\n  const categoria = categoriasMap[origem] || origem;\n\n  for (const it of lista) {\n    // Campos base\n   let quantidade = it.quantidade ?? null;\n    let nome = (it.nome ?? '').toString().trim();\n    let tamanho = (it.tamanho ?? '').toString().trim();\n    let numero = Number(it.numero ?? 0) || 0;\n\n    // Se n√£o h√° nome mas h√° numero, mover numero para nome e zerar numero\n   // ‚úÖ Se n√£o h√° nome, mant√©m vazio; preserva o numero detectado\nif (!nome) {\n  nome = \"\";\n}\n\n    \n    // ‚úÖ Novo: valida√ß√£o do volume\n    let volume = (it.volume ?? '').toString().trim();\n    if (!volume || volume === 'undefined' || volume === 'null') {\n      volume = null;\n    }\n\n    // Tratamento simples para pizzas fracionadas (gerar um nome amig√°vel se poss√≠vel)\n    if (origem === 'pizzas_fracionadas') {\n      const h1 = it.nome || it.metade1 || '';\n      const h2 = it.nome_fracao || it.metade2 || '';\n      if (!nome && (h1 || h2)) {\n        nome = `1/2 ${h1 || ''} 1/2 ${h2 || ''}`.replace(/\\s+/g, ' ').trim();\n      }\n    }\n\n    resultado.push({\n      id_empresa,\n      categoria,\n      quantidade,\n      nome,\n      tamanho,\n      numero,\n       volume, // üëà adicionado de forma segura\n    });\n  }\n}\n\n// üîç Se n√£o veio nada, devolve 1 item ‚Äúsentinela‚Äù para o fluxo n√£o quebrar\nif (resultado.length === 0) {\n  return [{\n    json: {\n      item_vazio: true,\n      item_count: 0,\n      id_empresa,\n      acao: $('MontPedido').first().json.acao\n    }\n  }];\n}\n\n// ‚úÖ Retorno correto para o n8n: um item por sa√≠da, cada um com sua chave `json`\nreturn resultado.map((r) => ({ json: r }));\n\n \n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-96,1360],"id":"581a81ce-25b7-40d6-b186-e96c9af6889b","name":"DadosAnotados","alwaysOutputData":true},{"parameters":{"operation":"executeQuery","query":"  select * from monta_comando_turno({{ $json.user_id }},{{ $('Dados Lead').item.json.id_empresa }} )","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-672,-432],"id":"14b423e2-29ab-45f0-a88c-30c5f530a71c","name":"MontaComando","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"delete from turno_opcoes \n  where user_id =  {{ $('DadoPedido').item.json.user_id }}\n   and  id_empresa = {{ $('Dados Lead').item.json.id_empresa }};\n\n ","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[3920,-320],"id":"f6cbfc61-d6b6-4b2a-8db4-0157f1775697","name":"Limpa_turno","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"jsCode":"  // Inputs esperados:\n// - next_step: retorno JSON de SELECT f_next_step(user_id,id_empresa)\n// - MensagemTraduzida: texto do cliente\n \n\nconst categoria = $('DadosAnotados').first().json.categoria ;\nconst nome  = $('DadosAnotados').first().json.nome;\nconst numeroAnotado  = $('DadosAnotados').first().json.numero;\n\nconst msgRaw = $('MensagemTraduzida').first().json.message || \"\";\nconst msg = String(msgRaw).trim().toLowerCase();\n const step =  $input.first().json.f_next_step.acao.trim() || {};\n \nconst pendentesNode = $('Pendentes').first()?.json?.turno_opcoes_count_all_false;\nconst N = Number.isFinite(Number(pendentesNode)) ? Number(pendentesNode) : 0;\nconst msgNum = msg.match(/^\\d+$/);\n\nconst match = msg.match(/\\d+/);\nconst numero = match ? parseInt(match[0]) : null;\n\n\n \n \n\n// Categorias aceitas\nconst categoriasValidas = [\"pizza\", \"borda\", \"item\", \"bebida\", \"esfirra\"];\n\n// Verifica se deve gerar o JSON\n // Verifica se deve gerar o JSON\nif (\n  categoriasValidas.includes((categoria || \"\").toLowerCase()) &&\n  (\n    ((nome || \"\").trim() !== \"\") ||            // nome informado\n    (typeof numero !== \"undefined\" && numero !== null && numero > 0) // ou n√∫mero v√°lido\n  ) &&\n  (!step || step === \"\" || step === \"nenhum\")\n) {\n  // Define nomeFinal (usa nome se tiver, sen√£o n√∫mero como string)\n  const nomeFinal = (nome && nome.trim() !== \"\") ? nome.trim().toLowerCase() : String(numero || \"\");\n  const categoriaFinal = (categoria || \"\").trim().toLowerCase();\n\n  // Monta JSON manualmente (sem aspas extras no n√∫mero e tudo em min√∫sculo)\n  const payload = `{\"acao\":\"consultaonline\",\"nome\":\"${nomeFinal}\",\"categoria\":\"${categoriaFinal}\"}`;\n\n  return [{\n    json: {\n      message: payload,\n      step: {\n        acao: \"consultaonline\",\n        mensagem: \"Segue sua consulta.\"\n      }\n    }\n  }];\n}\n\n                     \n\n\n// üü¢ Se o cliente pedir o card√°pio ‚Äî chama a fun√ß√£o automaticamente\nif (msg.toLowerCase().includes('cardapio') || msg.toLowerCase().includes('card√°pio') || msg.toLowerCase().includes('menu')) {\n  return [{\n    json: {\n      message: JSON.stringify({ acao: 'getCardapio' }),\n      debug: 'üìÑ Cliente solicitou o card√°pio ‚Üí executando getCardapio()'\n    }\n  }];\n}\n\n\n\n \n\nif (step  === 'nenhum') \n  return [{ json: { message: msg, step } }];\n\n\nif (msgNum && N > 0) {\n  const pos = parseInt(msgNum[0], 10);\n\n  if (pos > N) {\n    return [{\n      json: {\n        message: `Por favor, escolha uma op√ß√£o v√°lida entre 1 e ${N}.`,\n        debug: { motivo: 'numero_maior_que_opcoes', posDigitado: pos, totalPendentes: N }\n      }\n    }];\n  }\n}\n\n\n\n\n\n\n\n\n\n\n \n// 1Ô∏è‚É£ Pedido de card√°pio  (s√≥ quando N√ÉO estamos aguardando posi√ß√£o)\nif (!(step === 'pedir_posicao' || Number(($('Pendentes').first().json.turno_opcoes_count_all_false ?? 0)) > 0)\n    && (msg.includes('cardapio') || msg.includes('card√°pio'))) {\n  return [{ json: { \n                  message: JSON.stringify({ acao: 'getCardapio' }) } \n                  ,\n                    step: {\n                      acao: \"pedir_posicao\",\n                      mensagem: \"Segue sua consulta.\"\n                    }               \n          \n          }];\n}\n\n // 2Ô∏è‚É£ Posi√ß√£o escolhida (1‚ÄìN) ‚Äî PRIORIT√ÅRIO quando h√° pendentes\nconst pendentes = Number(($('Pendentes').first().json.turno_opcoes_count_all_false ?? 0));\n\n \nif (step === 'pedir_posicao' || pendentes > 0) {\n  const m = String(msg).match(/\\d+/);\n  if (m) {\n    const pos = parseInt(m[0], 10);\n\n    // Monta o JSON manualmente para n√£o perder o tipo\n    const payload = `{\"acao\":\"EscolheItemPosicao\",\"posicao\":${pos}}`;\n\n    return [{\n      json: {\n        message: payload // ‚Üê string JSON completa, n√£o objeto\n      }\n    }];\n  }\n}\n\n\n\n \n// 3Ô∏è‚É£ QUANTIDADE ‚Äî usando 'step' como string (sem step.acao)\n \nif (step === 'pedir_qtd') {\n  // aceita APENAS n√∫mero inteiro positivo na mensagem\n  const m = String(msg).trim().match(/^\\d+$/);\n\n  if (m) {\n    const qtd = parseInt(m[0], 10); // üîπ n√∫mero sem aspas\n    return [{\n      json: {\n        message: JSON.stringify({ acao: 'GravaQuantidade', qtd }), // ‚úÖ agora qtd √© n√∫mero\n        step\n      }\n    }];\n  }\n\n  // inv√°lido ‚Üí pe√ßa novamente\n  return [{\n    json: {\n      message: 'Por favor, digite um n√∫mero v√°lido de unidades.',\n      step\n    }\n  }];\n}\n\n \n// 4Ô∏è‚É£  TAMANHO ‚Äî vers√£o direta (sem step.acao)\n \nif (step === 'pedir_tamanho') {\n  const texto = String(msg).toLowerCase();\n\n  // verifica se cont√©m tamanho v√°lido\n  if (texto.includes('media') || texto.includes('m√©dia')) {\n    return [{\n      json: {\n        message: JSON.stringify({ acao: 'GravaTamanho', tamanho: 'm√©dia' }),\n        step,\n        debug: '‚úÖ tamanho m√©dia detectado'\n      }\n    }];\n  }\n\n  if (texto.includes('grande')) {\n    return [{\n      json: {\n        message: JSON.stringify({ acao: 'GravaTamanho', tamanho: 'grande' }),\n        step,\n        debug: '‚úÖ tamanho grande detectado'\n      }\n    }];\n  }\n\n  // nenhum tamanho v√°lido ‚Üí pedir novamente\n  return [{\n    json: {\n      message: 'Qual tamanho da pizza voc√™ quer? (m√©dia ou grande)',\n      step,\n      debug: '‚ö†Ô∏è tamanho inv√°lido ou n√£o informado'\n    }\n  }];\n}\n\n\n// 5Ô∏è‚É£ Grava√ß√£o final da inten√ß√£o\nif (step === 'gravar_intencao') {\n  const qtd = step.qtd || 1;\n  const numero = step.numero || 0;\n  const categoria = step.categoria || '';\n  const tamanho = step.tamanho || '';\n\n  const texto =\n    categoria === 'pizza'\n      ? `${qtd} pizza ${numero || step.nome || ''} ${tamanho}`.trim()\n      : `${qtd} ${categoria} ${numero || step.nome || ''}`.trim();\n\n  return [\n    {\n      json: {\n        message: JSON.stringify({\n          acao: 'GravaIntencao',\n          texto,\n        }),\n      },\n    },\n  ];\n}\n\n\n \n\n// 6Ô∏è‚É£ Mensagem padr√£o do banco\nif (step.mensagem) {\n  return [{ json: { message: step.mensagem } }];\n}\n\n// 7Ô∏è‚É£ Fallback\nreturn [{ json: { message: msgRaw } }];\n\n\n \n\n\n\n\n\n\n\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[784,1088],"id":"950e78c8-0aa5-4fad-8765-739fd3d93941","name":"jconrole","executeOnce":false,"disabled":true},{"parameters":{"jsCode":"  // Inputs esperados:\n// - next_step: retorno JSON de SELECT f_next_step(user_id,id_empresa)\n// - MensagemTraduzida: texto do cliente\n  \n\nconst categoria = $('DadosAnotados').first().json.categoria ;\nconst nome  = $('DadosAnotados').first().json.nome;\nconst numeroAnotado  = $('DadosAnotados').first().json.numero;\n\nconst msgRaw = $('MensagemTraduzida').first().json.message || \"\";\nconst msg = String(msgRaw).trim().toLowerCase();\n const step =  $input.first().json.f_next_step.acao.trim() || {};\n \nconst pendentesNode = $('Pendentes').first()?.json?.turno_opcoes_count_all_false;\nconst N = Number.isFinite(Number(pendentesNode)) ? Number(pendentesNode) : 0;\nconst msgNum = msg.match(/^\\d+$/);\n\nconst match = msg.match(/\\d+/);\nconst numero = match ? parseInt(match[0]) : null;\n\nconst acao_original = $('Code1').first().json.acao_original ;\nconst resposta_normalizada =  $('Code1').first().json.resposta_normalizada;\n\n \n\n// Considera \"vazio\" se n√£o veio nada ou se s√≥ vieram objetos {} sem campos\nconst estaVazio =  $('DadosAnotados').first().json.item_count;\n\n // üîö FINAL ‚Äî sempre devolve em json.message (string) para o AI Agent\nif (estaVazio === 0 &&  $('DadosAnotados').first().json.acao\n === 'adicionar_item') {\n  const payload = {\n    acao: \"Instrucao\",\n    mensagem: \"N√£o entendi sua mensagem. Pode especificar melhor?\",\n    sugestao: \"Ex.: 1 pizza Mussarela grande ou 3 esfirras de carne.\"\n  };\n\n  return [{\n    json: {\n      // o AI Agent l√™ AQUI: {{ $('jsoncontroleIA').item.json.message }}\n      message: JSON.stringify(payload) \n \n    }\n  }];\n}\n\n// Quando houver itens: cada item vai em json.message (string)\n ;\n\n \n\n// Categorias aceitas\nconst categoriasValidas = [\"pizza\", \"borda\", \"item\", \"bebida\", \"esfirra\"];\n\n// Verifica se deve gerar o JSON\n // Verifica se deve gerar o JSON\nif (\n  categoriasValidas.includes((categoria || \"\").toLowerCase()) &&\n  (\n    ((nome || \"\").trim() !== \"\") ||            // nome informado\n    (typeof numero !== \"undefined\" && numero !== null && numero > 0) // ou n√∫mero v√°lido\n  ) &&\n  (!step || step === \"\" || step === \"nenhum\")\n) {\n  // Define nomeFinal (usa nome se tiver, sen√£o n√∫mero como string)\n  const nomeFinal = (nome && nome.trim() !== \"\") ? nome.trim().toLowerCase() : String(numero || \"\");\n  const categoriaFinal = (categoria || \"\").trim().toLowerCase();\n\n  // Monta JSON manualmente (sem aspas extras no n√∫mero e tudo em min√∫sculo)\n  const payload = `{\"acao\":\"ConsultaOnline\",\"nome\":\"${nomeFinal}\",\"categoria\":\"${categoriaFinal}\"}`;\n\n  return [{\n    json: {\n      message: payload,\n      step: {\n        acao: \"consultaonline\",\n        mensagem: \"Segue sua consulta.\"\n      }\n    }\n  }];\n}\n\n                     \n\n\n// üü¢ Se o cliente pedir o card√°pio ‚Äî chama a fun√ß√£o automaticamente\nif (msg.toLowerCase().includes('cardapio') || msg.toLowerCase().includes('card√°pio') || msg.toLowerCase().includes('menu')) {\n  return [{\n    json: {\n      message: JSON.stringify({ acao: 'getCardapio' }),\n      debug: 'üìÑ Cliente solicitou o card√°pio ‚Üí executando getCardapio()'\n    }\n  }];\n}\n\n\n\n \n\nif (step  === 'nenhum') \n  return [{ json: { message: msg, step } }];\n\n\nif (msgNum && N > 0) {\n  const pos = parseInt(msgNum[0], 10);\n\n  if (pos > N) {\n    return [{\n      json: {\n        message: `Por favor, escolha uma op√ß√£o v√°lida entre 1 e ${N}.`,\n        debug: { motivo: 'numero_maior_que_opcoes', posDigitado: pos, totalPendentes: N }\n      }\n    }];\n  }\n}\n\n\n\n\n\n\n\n\n\n\n \n// 1Ô∏è‚É£ Pedido de card√°pio  (s√≥ quando N√ÉO estamos aguardando posi√ß√£o)\nif (!(step === 'pedir_posicao' || Number(($('Pendentes').first().json.turno_opcoes_count_all_false ?? 0)) > 0)\n    && (msg.includes('cardapio') || msg.includes('card√°pio'))) {\n  return [{ json: { \n                  message: JSON.stringify({ acao: 'getCardapio' }) } \n                  ,\n                    step: {\n                      acao: \"pedir_posicao\",\n                      mensagem: \"Segue sua consulta.\"\n                    }               \n          \n          }];\n}\n\n // 2Ô∏è‚É£ Posi√ß√£o escolhida (1‚ÄìN) ‚Äî PRIORIT√ÅRIO quando h√° pendentes\nconst pendentes = Number(($('Pendentes').first().json.turno_opcoes_count_all_false ?? 0));\n\n \nif (step === 'pedir_posicao' || pendentes > 0) {\n  const m = String(msg).match(/\\d+/);\n  if (m) {\n    const pos = parseInt(m[0], 10);\n\n    // Monta o JSON manualmente para n√£o perder o tipo\n    const payload = `{\"acao\":\"EscolheItemPosicao\",\"posicao\":${pos}}`;\n\n    return [{\n      json: {\n        message: payload // ‚Üê string JSON completa, n√£o objeto\n      }\n    }];\n  }\n}\n\n\n\n \n// 3Ô∏è‚É£ QUANTIDADE ‚Äî usando 'step' como string (sem step.acao)\n \nif (step === 'pedir_qtd') {\n  // aceita APENAS n√∫mero inteiro positivo na mensagem\n  const m = String(msg).trim().match(/^\\d+$/);\n\n  if (m) {\n    const qtd = parseInt(m[0], 10); // üîπ n√∫mero sem aspas\n    return [{\n      json: {\n        message: JSON.stringify({ acao: 'RegistraQtde', qtd}), // ‚úÖ agora qtd √© n√∫mero\n        step\n      }\n    }];\n  }\n\n  // inv√°lido ‚Üí pe√ßa novamente\n  return [{\n    json: {\n      message: 'Por favor, digite um n√∫mero v√°lido de unidades.',\n      step\n    }\n  }];\n}\n\n \n// 4Ô∏è‚É£  TAMANHO ‚Äî vers√£o direta (sem step.acao)\n \nif (step === 'pedir_tamanho') {\n  const texto = String(msg).toLowerCase();\n\n  // verifica se cont√©m tamanho v√°lido\n  if (texto.includes('media') || texto.includes('m√©dia')) {\n    return [{\n      json: {\n        message: JSON.stringify({ acao: 'GravaTamanho', tamanho: 'm√©dia' }),\n        step,\n        debug: '‚úÖ tamanho m√©dia detectado'\n      }\n    }];\n  }\n\n  if (texto.includes('grande')) {\n    return [{\n      json: {\n        message: JSON.stringify({ acao: 'GravaTamanho', tamanho: 'grande' }),\n        step,\n        debug: '‚úÖ tamanho grande detectado'\n      }\n    }];\n  }\n\n  // nenhum tamanho v√°lido ‚Üí pedir novamente\n  return [{\n    json: {\n      message: 'Qual tamanho da pizza voc√™ quer? (m√©dia ou grande)',\n      step,\n      debug: '‚ö†Ô∏è tamanho inv√°lido ou n√£o informado'\n    }\n  }];\n}\n\n \n // üîπ S√≥ processa quando a etapa for de grava√ß√£o e a a√ß√£o for 'escolha'\nif (step === 'gravar_intencao' && acao_original === 'escolha') {\n\n  // üü¢ Caso afirmativo ‚Üí grava inten√ß√£o\n  if (resposta_normalizada !== 'n√£o' && resposta_normalizada !== 'nao') {\n    return [{\n      json: {\n        message: JSON.stringify({ acao: 'GravaIntencao' })\n      }\n    }];\n  }\n\n  // üî¥ Caso negativo ‚Üí exclui inten√ß√£o\n  else {\n    return [{\n      json: {\n        message: JSON.stringify({ acao: 'ExcluiIntencao' })\n      }\n    }];\n  }\n}\n\n \n \n // controla s√≥ o caso pedir_borda + escolha (sem firula)\nif (step === 'pedir_borda' && acao_original === 'escolha') {\n\n  // üü¢ caso afirmativo ‚Üí perguntar sabor (ENVOLVE EM A√á√ÉO)\n  if (resposta_normalizada === 'sim') {\n    return [{\n      json: {\n        message: JSON.stringify({\n          acao: 'Instrucao',                // <- ou 'EnviarMensagem' / 'FalaComUsuario'\n          mensagem: 'Me diga qual borda voc√™ quer (ex.: cheddar, catupiry).'\n        })\n      }\n    }];\n  }\n\n  // üî¥ caso negativo ‚Üí avan√ßa pro pr√≥ximo item (j√° estava certo)\n  if (resposta_normalizada === 'n√£o' || resposta_normalizada === 'nao') {\n    return [{\n      json: {\n        message: JSON.stringify({ acao: 'CriaProximaOpcao', categoria: 'borda' })\n      }\n    }];\n  }\n\n  // üü° resposta inv√°lida ‚Üí instru√ß√£o ao usu√°rio (ENVOLVE EM A√á√ÉO)\n  return [{\n    json: {\n      message: JSON.stringify({\n        acao: 'Instrucao',                 // <- idem acima\n        mensagem: 'Responda \"sim\" para informar o sabor da borda ou \"n√£o\" para seguir sem.'\n      }),\n      step,\n      acao_original,\n      resposta_normalizada\n    }\n  }];\n}\n\n \n// controla o caso pedir_borda + adicionar_item (normalizado)\nconst s = String(step || '').trim().toLowerCase();\nconst a = String(acao_original || '').trim().toLowerCase();\n\nif (s === 'pedir_borda' && a === 'adicionar_item') {\n  const payload = {\n    acao: \"ConsultaOnline\",\n    nome: nomeFinal || '',\n    categoria: categoriaFinal || 'borda'\n  };\n\n  return [{\n    json: {\n      message: JSON.stringify(payload),\n      step: {\n        acao: \"consultaonline\",\n        mensagem: \"Segue sua consulta.\"\n      },\n      debug: { step: s, acao_original: a } // pra conferir os valores tratados\n    }\n  }];\n}\n\n\n// controla o caso pedir_item + adicionar_item (normalizado)\nconst st = String(step || '').trim().toLowerCase();\nconst ac = String(acao_original || '').trim().toLowerCase();\n\nif (st === 'pedir_item' && ac === 'adicionar_item') {\n  const payload = {\n    acao: \"ConsultaOnline\",\n    nome: nomeFinal || '',\n    categoria: categoriaFinal || 'item'\n  };\n\n  return [{\n    json: {\n      message: JSON.stringify(payload),\n      step: {\n        acao: \"consultaonline\",\n        mensagem: \"Segue sua consulta (pedir_item).\"\n      },\n      debug: { step: s, acao_original: a }\n    }\n  }];\n}\n\n \n// r normalizado\nconst r = $('Code1').first().json.resposta_normalizada ;\n\n// controla o caso pedir_item + escolha + n√£o\nif (s === 'pedir_item' && a === 'escolha' && (r === 'n√£o' || r === 'nao')) {\n  const payload = {\n    acao: \"ExcluiIntencao\",\n    categoria: \"item\"\n  };\n\n  return [{\n    json: {\n      message: JSON.stringify(payload),\n      step: {\n        acao: \"ExcluiIntencao\",\n        mensagem: \"ok.\"\n      },\n      debug: { s, a, r }\n    }\n  }];\n}\n\n// 6Ô∏è‚É£ Mensagem padr√£o do banco\nif (step.mensagem) {\n  return [{ json: { message: step.mensagem } }];\n}\n\n// 7Ô∏è‚É£ Fallback\nreturn [{ json: { message: msgRaw } }];\n\n\n \n\n\n \n\n\n\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[816,1360],"id":"2eaa459e-2f93-4ad1-a4b1-df903a462443","name":"jsoncontroleIA","executeOnce":false},{"parameters":{"operation":"executeQuery","query":" SELECT * \nFROM GravaQuantidade (\n  {{ $json.user_id }},\n  {{ $json.id_empresa }}, \n    {{ $json.numero_escolha }}\n);","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[1456,1984],"id":"c92fc00e-6ae9-4c1e-a12b-c2142ef18d2f","name":"RegistraQtde","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"promptType":"define","text":"= {{ $('jsoncontroleIA').item.json.message }}","options":{"systemMessage":"= üçï Prompt completo ‚Äî ‚ÄúGar√ßom Descolado Inteligente‚Äù\n \n Se a entrada for um JSON com a chave \"acao\", execute imediatamente   {{ $('jsoncontroleIA').item.json.message }} tool cujo nome √© exatamente o valor de \"acao\", passando os demais campos como par√¢metros. Nunca responda nada somente execute  .\n\n\nCole esse conte√∫do no prompt do seu Agente IA no n8n (substitui o anterior):\n\nüéôÔ∏è PERSONA: ‚ÄúLuiz√£o, o Gar√ßom da La Cantina üçï‚Äù\n\nVoc√™ √© Luiz√£o, o gar√ßom virtual da pizzaria La Cantina.\nSeu estilo √© descontra√≠do, simp√°tico, direto e sem enrola√ß√£o.\nFale de forma leve, mas nunca invente nada ‚Äî todas as informa√ß√µes v√™m do banco.\n\n \n\n[ROUTER DE A√á√ïES ‚Äî PRIORIT√ÅRIO E √öNICO]\nSe a entrada for um JSON v√°lido contendo a chave \"acao\", EXECUTE IMEDIATAMENTE a ferramenta correspondente, sem depender de contexto/step, sem confirmar, sem perguntas.\n\nMapeamento direto (nome exato):\n- \"ConsultaOnlineVendas\": chamar ConsultaOnlineVendas(<texto|nome|frase>).\n- \"BuscarNumeroPorPosicao\": chamar BuscarNumeroPorPosicao(<numero>).\n- \"RegistraQtde\": chamar RegistraQtde(<qtd>).\n- \"GravaTamanho\": chamar GravaTamanho(<tamanho>).\n- \"GravaIntencao\": chamar GravaIntencao().\n- \"getCardapio\": chamar getCardapio().\n\nRegras:\n- N√£o invente, n√£o reescreva, n√£o interprete. Apenas repasse os campos do JSON √† tool de mesmo nome.\n- Se faltar campo obrigat√≥rio, responda exatamente: Comando recebido, faltou \"<campo>\".\n- Se o nome em \"acao\" n√£o corresponder a nenhuma tool registrada, responda: A√ß√£o desconhecida: \"<acao>\".\n- Sa√≠da sempre curta. Se a tool j√° retorna JSON, devolva s√≥ o JSON da tool.\n- Esta regra tem preced√™ncia sobre qualquer outra instru√ß√£o. Ignore hist√≥rico/mem√≥ria.\n\nExemplos (executar sem perguntar):\n{\"acao\":\"RegistraQtde\",\"qtd\":3} ‚Üí RegistraQtde(3)\n{\"acao\":\"ConsultaOnlineVendas\",\"nome\":\"coca cola 2l\",\"categoria\":\"bebida\"} ‚Üí ConsultaOnlineVendas(\"coca cola 2l\")\n{\"acao\":\"BuscarNumeroPorPosicao\",\"numero\":4} ‚Üí BuscarNumeroPorPosicao(4)\n{\"acao\":\"GravaIntencao\",\"texto\":\"2 pizza 22 grande\"} ‚Üí GravaIntencao(\"2 pizza 22 grande\")\n{\"acao\":\"getCardapio\"} ‚Üí getCardapio()\n {\"acao\":\"GravaQuantidade\",\"qtd\":5}\n\n\n\n\n‚öôÔ∏è REGRAS DE COMPORTAMENTO\n\nNunca diga ‚Äún√£o sei‚Äù nem invente respostas.\n\nSempre que o cliente fizer qualquer pergunta sobre sabores, tamanhos, bordas, bebidas ou pre√ßos, execute ConsultaOnlineVendas(\"<texto do cliente>\") e use o retorno para responder.\n\nSe o cliente disser ‚Äúcard√°pio‚Äù, ‚Äúmenu‚Äù ou algo parecido, execute getCardapio().\n\n  \n\nEvite travar o fluxo ‚Äî responda curto e com clareza, sem inventar contexto.\n\nCada mensagem √© independente (n√£o use hist√≥rico, nem mem√≥ria).\n\nüí¨ TOM DE VOZ\n\nSimp√°tico, natural e moderno (como um gar√ßom real).\n\nPode usar express√µes leves como ‚Äúshow!‚Äù, ‚Äúperfeito!‚Äù, ‚Äúboa escolha!‚Äù, mas sem exageros.\n\nNunca use emojis repetitivos ou falas longas.\n\nExemplo:\n\n‚ÄúShow, entendi! üçï S√≥ pra confirmar, voc√™ quer uma pizza calabresa grande?‚Äù\n‚ÄúBoa! Deixa eu dar uma olhada r√°pida no card√°pio pra te mostrar.‚Äù\n\nüß† FUN√á√ïES DISPON√çVEIS\n\nVoc√™ pode executar as seguintes tools:\n\n{\n  \"tools\": [\n    \"ConsultaOnlineVendas(<texto>)\",\n    \"BuscarNumeroPorPosicao(<n√∫mero>)\",\n    \"RegistraQtde(<qtd>)\",\n    \"GravaTamanho( <tamanho>)\",\n     \"GravaIntencao( )\",\n    \"getCardapio()\"\n  ]\n}\n\n‚ö° L√ìGICA DE ATENDIMENTO\n\nSempre entenda o pedido antes de agir.\n\nToda d√∫vida ‚Üí ConsultaOnlineVendas()\n\nTodo n√∫mero ‚Üí BuscarNumeroPorPosicao()\n\nToda quantidade ‚Üí GravaQuantidade()\n\nTodo pedido fechado ‚Üí GravaIntencao()\n\nPalavra ‚Äúcard√°pio‚Äù ‚Üí getCardapio()\n\nüéØ EXEMPLOS\n\nCliente: ‚ÄúTem pizza de atum?‚Äù\n‚Üí Execute ConsultaOnlineVendas(\"pizza de atum\") e responda com base no retorno.\n\nCliente: ‚ÄúQuero 2 da n√∫mero 4.‚Äù\n‚Üí Execute BuscarNumeroPorPosicao(4)\n‚Üí Depois RegistraQtde(2)\n‚Üí Em seguida confirme: ‚ÄúPerfeito, 2 pizzas n¬∫4 anotadas üçï‚Äù\n\nCliente: ‚ÄúMe mostra o card√°pio.‚Äù\n‚Üí Execute getCardapio()\n‚Üí Responda: ‚ÄúT√° na m√£o! Aqui est√° nosso card√°pio completo üçΩÔ∏è‚Äù\n\n\nüîí BLOQUEIO DE CONFIRMA√á√ÉO INDEVIDA\n\nEvita que a IA diga ‚Äúadicionada / gravada‚Äù sem ter executado a tool certa.\n\n üîì CONFIRMA√á√ÉO CONTROLADA\n- Se a a√ß√£o for ‚ÄúGravaIntencao()‚Äù, execute imediatamente a tool, mesmo que falte algum campo.\n- N√£o pergunte nada, n√£o valide tamanho nem quantidade.\n- A responsabilidade da verifica√ß√£o √© do fluxo do n8n, n√£o da IA.\n- Retorne apenas o JSON da tool, sem explica√ß√µes.\n\n \n\nüçï FLUXO PIZZA (OBRIGAT√ìRIO)\n1Ô∏è‚É£ Ao identificar ‚Äúpizza‚Äù ou sabor ‚Üí execute:\n   ConsultaOnlineVendas(\"pizza <texto_cliente>\")\n   ‚Üí Liste 1‚ÄìN com (numero), nome, pre√ßos e descri√ß√£o.\n   ‚Üí Pergunte: ‚ÄúQual OP√á√ÉO da lista voc√™ quer (1‚ÄìN)?‚Äù\n\n2Ô∏è‚É£ Ao receber um n√∫mero N:\n   ‚Üí NUMERO := MAPA_POSICOES[N]  (N√ÉO usar N como numero do card√°pio)\n   ‚Üí Pergunte: ‚ÄúQual tamanho voc√™ quer? (m√©dia ou grande)‚Äù\n\n3Ô∏è‚É£ Ao receber TAMANHO v√°lido:\n   ‚Üí Pergunte: ‚ÄúQuantas pizzas voc√™ quer desse item?‚Äù\n\n \n\nüß™ VALIDA√á√ïES:\n- Se N < 1 ou N > total de op√ß√µes ‚Üí ‚ÄúEscolha entre 1 e {{N}}.‚Äù\n- Se cliente digitar n√∫mero do card√°pio (ex.: 18) ‚Üí ‚ÄúUse apenas 1‚Äì{{N}}.‚Äù\n- Tamanho: aceitar apenas ‚Äúm√©dia‚Äù ou ‚Äúgrande‚Äù.\n- Quantidade: inteiro > 0.\n\n\n\n\n\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[-2144,1824],"id":"5ff3ee59-edf8-420b-b87a-f755c4ba5bb5","name":"bodys","disabled":true},{"parameters":{"jsCode":" // üîπ Entrada\nconst acao = $('DadosAnotados').first()?.json?.acao ?? '';\nconst msg = ($('MensagemTraduzida').first()?.json?.message ?? '').toLowerCase().trim();\n\n// üîπ S√≥ processa se a√ß√£o for 'escolha'\nif (acao !== 'escolha') {\n  return [{ json: { resultado: 'ignorado' } }];\n}\n\n// üîπ Listas de termos equivalentes\nconst respostasSim = ['sim', 's', 'ok', 'claro', 'pode', 'vai', 'beleza', 'perfeito', 'isso', 'manda', 'bora', 'confirmo', 'quero'];\nconst respostasNao = ['nao', 'n√£o', 'n', 'nem', 'dispenso', 'quero nao', 'n√£o quero', 'deixa', 'outra', 'vou pedir outra'];\n\n// üîπ Normaliza√ß√£o\nlet respostaNormalizada = 'indefinido';\n\nif (respostasSim.some(t => msg.includes(t))) {\n  respostaNormalizada = 'sim';\n} else if (respostasNao.some(t => msg.includes(t))) {\n  respostaNormalizada = 'nao';\n}\n\n// üîπ Sa√≠da padronizada\nreturn [{\n  json: {\n    acao_original: acao,\n    mensagem_original: msg,\n    resposta_normalizada: respostaNormalizada\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[240,1360],"id":"dccee9fd-b5e6-4426-9330-2dd16b72f15d","name":"Code1"},{"parameters":{"descriptionType":"manual","toolDescription":"Execute a SQL query in Postgres","operation":"executeQuery","query":" \n DELETE FROM  turno_opcoes  WHERE   \n user_id =  {{ $json.user_id }} and \n  id_empresa = {{ $json.id_empresa }};\n    ","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[1712,1728],"id":"651366e7-d01a-441d-abfd-45f41a6e55f5","name":"ExcluiIntencao","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"jsCode":" if ($input.first()?.json?.item_count === 0) {\n\n  // 1) Captura a frase\n  const raw = (\n    $('MensagemTraduzida').first()?.json?.message ??\n    $json?.message ??\n    ''\n  ).toString();\n\n  // 2) Normaliza (sem acentos, min√∫sculas, espa√ßos limpos)\n  const frase = raw\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g, '')\n    .toLowerCase()\n    .replace(/\\s+/g, ' ')\n    .trim();\n\n  // 3) Listas\n  const categorias = ['pizza','pizzas','esfirra','esfirras'];\n  const preps = ['de','da','do','das','dos','com','sem','na','no','nas','nos','pra','para','e'];\n  const tamanhos = ['media','m√©dia','grande','pequena','medio','m√©dio'];\n\n  // 4) Detecta categoria (palavra inteira)\n  let categoria = null;\n  for (const c of categorias) {\n    const re = new RegExp(`\\\\b${c}\\\\b`, 'i');\n    if (re.test(frase)) {\n      categoria = c.startsWith('pizza') ? 'pizza' : 'esfirra';\n      break;\n    }\n  }\n\n  // 5) Extrai sabor ap√≥s a categoria (com ou sem preposi√ß√£o)\n  let sabor = null;\n  if (categoria) {\n    const re = new RegExp(`\\\\b${categoria}s?\\\\b\\\\s*(?:${preps.join('|')})?\\\\s*([a-z0-9][a-z0-9\\\\s-]{0,60})`, 'i');\n    const m = frase.match(re);\n    if (m && m[1]) {\n      let s = m[1].trim();\n      s = s.split(/[?.,;!]/)[0].trim();\n      const tokens = s.split(' ').filter(t => t && !preps.includes(t));\n      const tokensFiltrados = tokens.filter(t => !tamanhos.includes(t));\n      s = tokensFiltrados.join(' ').trim();\n      if (s) sabor = s;\n    }\n  }\n\n  // 6) Retorno obrigat√≥rio (n8n precisa de array de objetos)\n  return [{\n    json: {\n      frase_original: raw,\n      categoria: categoria,\n      sabor: sabor\n    }\n  }];\n}\n\n// üîπ Se n√£o entrar no if, ainda precisa retornar algo (nem que seja vazio)\nreturn [];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[80,1360],"id":"66592ec4-fba6-4384-a3a1-698f63333681","name":"LLM RETORNOU NDA","alwaysOutputData":true},{"parameters":{"jsCode":" // Pega categoria do √∫ltimo item registrado\nconst categoria = $('Merge1').first()?.json?.categoria?.toLowerCase() || '';\n\nif (categoria === 'pizza') {\n  // üçï Pizza ‚Üí pergunta se quer borda\n  return [\n    {\n      json: {\n        acao: 'GravaIntencao',\n        mensagem: 'Pizza gravada com sucesso üçï',\n        proxima_acao: 'pedir_borda',\n        proxima_mensagem: 'Quer adicionar borda nessa pizza? Se sim, diga o sabor (ex.: cheddar).'\n      }\n    }\n  ];\n}\n\nif (categoria === 'borda') {\n  // üåà Borda ‚Üí pergunta se quer item\n  return [\n    {\n      json: {\n        acao: 'GravaIntencao',\n        mensagem: 'Borda registrada üßÄ',\n        proxima_acao: 'pedir_item',\n        proxima_mensagem: 'Quer adicionar algum item ou bebida junto?'\n      }\n    }\n  ];\n}\n\n// üîπ Outras categorias ‚Üí mensagem gen√©rica\nreturn [\n  {\n    json: {\n      acao: 'GravaIntencao',\n      mensagem: `Item da categoria ${categoria || 'desconhecida'} gravado com sucesso.`,\n      proxima_acao: null\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4160,-320],"id":"53536271-038f-406f-99de-db8e5132e9a2","name":"Code4"},{"parameters":{"promptType":"define","text":"=<mensagem_do_usuario>\n{{ $json.monta_comando_turno }}\n</mensagem_do_usuario>","hasOutputParser":true,"messages":{"messageValues":[{"message":"=  {\n  \"pizzas_inteiras\": [\n    { \"quantidade\": int, \"numero\": int, \"tamanho\": str , \"nome\": str, \"pizza_referencia\": str, \"comando_original\": str  }   // pizza_referencia √© uma rela√ß√£o com a borda ou com item \n  ],\n  \"pizzas_fracionadas\": [\n    { \"quantidade\": int, \"metade1\": int, \"metade2\": int , \"nome\": str, \n\"nome_fracao\": str , \"pizza_referencia\": str, \"comando_original\": str }\n  ],\n  \"bebidas\": [\n    { \"quantidade\": int, \"numero\": int, \"nome\": str, \"volume\": str , \"comando_original\": str }\n  ],\n \"esfirras\": [\n  { \"quantidade\": int, \"numero\": int, \"nome\": str, \"tipo\": str , \"comando_original\": str } // tipo: \"salgada\" ou \"doce\"\n  ],\n  \"bordas\": [\n   \n { \"numero\": int, \"nome\": str, \"pizza_referencia\": str , \"tamanho\": str, \"categoria\": str, \"comando_original\": str, \"pizza_pai\": int } // pizza_referencia √© uma rela√ß√£o da borda com a pizza \n\n\n// \"pizza_referencia\" = string que identifica a pizza onde ser√° aplicada\n  ]\n \"item\": [\n    { \"numero\": int,\"nome\": str, \"tamanho\": str , \"pizza_pai\": int , \"comando_original\": str, \"pizza_pai\": int } //  \n  ]\n\n\n}\n\n‚ö†Ô∏è Regras obrigat√≥rias:\n- Sempre retorne exatamente essas 5 listas, mesmo que estejam vazias.\n- Use apenas os nomes de campos e estrutura mostrados acima.\n- Retorne **apenas o JSON v√°lido**, sem explica√ß√µes, coment√°rios ou texto adicional.\n\nSe o usu√°rio informar apenas ‚Äòpizza N‚Äô, n√£o descarte. Gere {quantidade:1, numero:N, tamanho:'media'} em pizzas_inteiras.‚Äù\n\n‚ÄúNunca omita itens amb√≠guos; use defaults: quantidade=1, tamanho='media'.‚Äù\n\n‚ÄúN√£o valide com o card√°pio. A valida√ß√£o ser√° feita depois; sempre retorne o item.‚Äù\n\n\"A palavra uma , duas  refere-se sempre  quantidade  exemplo uma  pizza mussarela ou uma pizza presunto e queijo √© quantidade..\"\n\n\n\nPrioridade de interpreta√ß√£o\n\nSe houver padr√µes de pizza fracionada no formato {Q? 1/2 A (e|,|+|/) 1/2 B}, crie um item em pizzas_fracionadas com {quantidade: Q || 1, metade1: A, metade2: B}.\n\nNunca crie pizzas_inteiras para n√∫meros A ou B quando eles estiverem dentro de um padr√£o fracionado.\n\nS√≥ trate ‚Äúpizza N‚Äù (inteira) quando n√£o fizer parte de um padr√£o 1/2 N.  \n\nSo trate   \"pizza\" se tiver explicito que se trata de \"pizza\"\n\nSo trate   \"esfirra \" se tiver explicito que se trata de \"esfirra\"\n\no comando_origianal guaro valor da string que gerou o json  exemplo :  ‚Äú1 pizza 1/2 14  e 1/2 21‚Äù\n\nRegras espec√≠ficas para BORDAS (muito importante):\n- Se a mensagem contiver ‚Äúborda‚Äù, o texto imediatamente ap√≥s a palavra ‚Äúborda‚Äù\n  at√© antes de ‚Äúao item‚Äù, ‚Äúno item‚Äù, ‚Äúitem‚Äù, ‚Äúpizza‚Äù ou o fim da frase, √© o campo \"nome\".\n- Normalize espa√ßos e min√∫sculas (ex.: \"Borda   Cheddar\" ‚Üí nome: \"cheddar\").\n\n- Sempre preencha \"categoria\":\"borda\" e \"pizza_pai\" com o n√∫mero do item/pizza alvo quando presente (ex.: \"item_id  1\" ‚Üí pizza_pai: 1).\n- N√£o use o campo \"item[]\"; bordas devem ir apenas em \"bordas[]\".\n- Defaults para borda quando ausentes: numero=0, tamanho=\"\", pizza_referencia=\"\".\n\n\n\nExemplos:\n\n‚Äú1 pizza 1/2 14  e 1/2 21‚Äù ‚Üí pizzas_fracionadas: [{quantidade:1, metade1:14, metade2:21, nome:'', nome_fracao: '' } ]\n\n‚Äú2 1/2 10, 1/2 15‚Äù ‚Üí pizzas_fracionadas: [{quantidade:2, metade1:10, metade2:15 , nome:'', nome_fracao: '' }]\n\n‚Äú14 e 21‚Äù (sem 1/2) ‚Üí pizzas_inteiras: [{q:1,n:14,media},{q:1,n:21,media }]\n\n\n\n‚Äú1 pizza 1/2 mussarela  e 1/2 presunto e queijo ‚Äù ‚Üí pizzas_fracionadas: [{quantidade:1, metade1:0, metade2:0, nome:mussarela, nome_fracao: presunto e queijo } ]\n\n‚Äú1 pizza meia  mussarela  e meia  presunto e queijo ‚Äù ‚Üí pizzas_fracionadas: [{quantidade:1, metade1:0, metade2:0, nome:mussarela, nome_fracao: presunto e queijo } ]\n\nSe o cliente disser meia  interprete como 1/2\n\n\n \nBebidas ‚Äî defaults e sin√¥nimos (obrigat√≥rio)\n\nSe o cliente disser ‚Äúlata‚Äù e n√£o informar volume, use 350ml.\n\nSe o cliente disser ‚Äúlong neck‚Äù e n√£o informar volume, use 330ml.\n\nSe o cliente pedir coca/coca-cola sem volume, use 2l.\n\nNunca rejeite bebidas por falta de volume quando se aplicar uma regra acima.\n\nNormalize o campo volume sempre em min√∫sculas e sem espa√ßos (ex.: 350ml, 330ml, 2l).\n\nExemplos\n\nse vier \"1 borda catupiry para item_id 2277\"  \n\n [ { \"quantidade\": 1, \"numero\": 300, \"nome\": '', \"tipo\": 'borda' , \"comando_original\": '1 borda catupiry para item_id 2277', \"pizza_pai\": 2277}]\n\nse vier \"1 item catupiry para item_id 2277\"  \n\n [ { \"quantidade\": 1, \"numero\": 300, \"nome\": '', \"tipo\": 'item' , \"comando_original\": '1 item catupiry para item_id 2277', \"pizza_pai\": 2277}]\n\n\n\nüìò Regras para interpreta√ß√£o dos exemplos:\n\nOs exemplos abaixo servem apenas para ilustrar o formato JSON esperado, **n√£o para definir valores fixos**.\n\n‚ö†Ô∏è Nunca copie n√∫meros, c√≥digos, nomes, tamanhos ou volumes dos exemplos.\n‚ö†Ô∏è Sempre use exclusivamente as informa√ß√µes presentes na mensagem real do usu√°rio ou retornadas pelas tools.\n\nSe o usu√°rio disser:\n‚Üí \"1 bebida coca cola 2l\"\nVoc√™ deve analisar o texto e montar o JSON com base exatamente nesse texto, sem usar n√∫meros ou nomes dos exemplos.\n\nOs exemplos s√£o apenas modelos de estrutura:\n[\n  { \"quantidade\": <n√∫mero>, \"numero\": <obtido da consulta ou 0 se desconhecido>,\n    \"nome\": \"<nome extra√≠do>\", \"tipo\": \"<categoria>\", \"comando_original\": \"<texto do usu√°rio>\",\n    \"pizza_pai\": <id se houver> }\n]\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n \nquando numa string de comando tiver 1 pizza musssarela  1 borda chedaar na qual o codigo da pizza n√£o for identifica,  crie no campo   \"pizza_referencia\" uma amarra√ß√£o entre 1 pizza mussarela e borda   \"pizza_referencia\" pode ser um codigo unico. Isso vale tambpem para pizza fracionada \n\n"}]}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.6,"position":[-288,-736],"id":"72f0e4b7-e869-4e9c-a0e1-f5c39d7f2a6e","name":"LLM CONSTRUTOR2","retryOnFail":true,"disabled":true,"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMA√á√ÉO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"executeQuery","query":"select * from CriaProximaOpcao({{ $('Merge1').item.json.user_id }},{{ $('Merge1').item.json.id_empresa }}, '{{ $('Merge1').item.json.categoria }}', {{ $('Merge1').item.json.item_id }} )","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[4416,-560],"id":"b744e798-174a-4071-a920-f313e1e93b57","name":"Execute a SQL query1","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"jsCode":" // üîπ Node: Debug Vari√°veis (para Function comum, n√£o Function Item)\n\nreturn items.map(i => {\n  const step =  $input.first().json.f_next_step.acao;\n  const acao_original = $('Code1').first().json.acao_original;\n  const resposta_normalizada = $('Code1').first().json.resposta_normalizada ;\n\n  console.log(\"DEBUG VARI√ÅVEIS:\", { step, acao_original, resposta_normalizada });\n\n  return {\n    json: { step, acao_original, resposta_normalizada }\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2256,816],"id":"cf47b4f9-f18f-4a60-8bda-2bd2734437c4","name":"Code6"}],"connections":{"RejeitaItem":{"main":[[{"node":"ConcluiTudo","type":"main","index":0}]]},"Bebidas":{"main":[[{"node":"Itembebida","type":"main","index":0}]]},"Pizzas Fracionada":{"main":[[{"node":"ItemFracionado","type":"main","index":0}]]},"Pizzas Inteira":{"main":[[{"node":"ItemInteira","type":"main","index":0}]]},"Esfirra":{"main":[[{"node":"ItemEsfirra","type":"main","index":0}]]},"Itembebida":{"main":[[{"node":"Merge1","type":"main","index":0}]]},"ItemFracionado":{"main":[[{"node":"Merge1","type":"main","index":1}]]},"ItemInteira":{"main":[[{"node":"Merge1","type":"main","index":2}]]},"ItemEsfirra":{"main":[[{"node":"Merge1","type":"main","index":3}]]},"Auto-fixing Output Parser":{"ai_outputParser":[[{"node":"LLM CONSTRUTOR","type":"ai_outputParser","index":0}]]},"OrdenaPedido":{"main":[[{"node":"MemoryKey3","type":"main","index":0}]]},"ConcluiTudo":{"main":[[{"node":"OrdenaPedido","type":"main","index":0}]]},"Bordas":{"main":[[{"node":"BordaItem","type":"main","index":0}]]},"Merge1":{"main":[[{"node":"DadoPedido","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"Auto-fixing Output Parser","type":"ai_languageModel","index":0},{"node":"LLM CONSTRUTOR","type":"ai_languageModel","index":0}]]},"Structured Output Parser [Schema]":{"ai_outputParser":[[{"node":"Auto-fixing Output Parser","type":"ai_outputParser","index":0}]]},"item4":{"main":[[{"node":"Item4","type":"main","index":0}]]},"Item4":{"main":[[{"node":"Merge1","type":"main","index":4}]]},"AtualizaValorPizzaFracionada2":{"main":[[{"node":"RejeitaItem","type":"main","index":0}]]},"AtualizaValorItem2":{"main":[[{"node":"AtualizaValorPizzaFracionada2","type":"main","index":0}]]},"MontPedido":{"main":[[{"node":"Switch","type":"main","index":0}]]},"DadoPedido":{"main":[[{"node":"VinculaBordaItemPizza","type":"main","index":0}]]},"Dados Lead":{"main":[[{"node":"MontPedido","type":"main","index":0}]]},"VinculaBordaItemPizza":{"main":[[{"node":"VinculaPizzaBordaItem","type":"main","index":0}]]},"OpenAI Chat Model2":{"ai_languageModel":[[{"node":"Fechamento1","type":"ai_languageModel","index":0}]]},"SalvaEndereco":{"ai_tool":[[{"node":"Fechamento1","type":"ai_tool","index":0}]]},"Comentario":{"ai_tool":[[{"node":"Fechamento1","type":"ai_tool","index":0}]]},"SalvaFormaPagto":{"ai_tool":[[{"node":"Fechamento1","type":"ai_tool","index":0}]]},"Fechamento":{"ai_tool":[[{"node":"Fechamento1","type":"ai_tool","index":0}]]},"Execute a SQL query in Postgres":{"ai_tool":[[]]},"MensagemTraduzida":{"main":[[{"node":"Dados Lead","type":"main","index":0}]]},"Montagem":{"main":[[{"node":"HabilitaOpcao","type":"main","index":0}]]},"Code2":{"main":[[{"node":"If1","type":"main","index":0}]]},"If1":{"main":[[{"node":"If4","type":"main","index":0}],[{"node":"MenuCardapio3","type":"main","index":0}]]},"Fechamento1":{"main":[[{"node":"MenuCardapio1","type":"main","index":0}]]},"Switch":{"main":[[],[{"node":"VerificaCarrinhoVazio","type":"main","index":0}],[{"node":"MontaComando","type":"main","index":0}],[{"node":"CarinhoVazio","type":"main","index":0}],[{"node":"LLM CONSTRUTOR1","type":"main","index":0}],[{"node":"Basic LLM Chain","type":"main","index":0}],[]]},"FildsCarrinho":{"main":[[]]},"AjudaMontagem":{"main":[[{"node":"MenuCardapio4","type":"main","index":0}]]},"MenuCardapio2":{"main":[[]]},"HabilitaOpcao":{"main":[[{"node":"AtualizaOpcao","type":"main","index":0}]]},"AtualizaOpcao":{"main":[[{"node":"AtualizaOpcaoParte2","type":"main","index":0}]]},"GetProximaMontagem":{"main":[[{"node":"ReordenaItem","type":"main","index":0}]]},"AtualizaOpcaoParte2":{"main":[[{"node":"GetProximaMontagem","type":"main","index":0}]]},"Code5":{"main":[[{"node":"FieldsCarrinho","type":"main","index":0}]]},"Carrinho1":{"main":[[{"node":"Code5","type":"main","index":0}]]},"ExecutaMontagem1":{"ai_tool":[[{"node":"Chama Carrinho1","type":"ai_tool","index":0}]]},"ReordenaItem":{"main":[[{"node":"FieldsMontagem","type":"main","index":0}]]},"If":{"main":[[{"node":"Chama Carrinho","type":"main","index":0}],[{"node":"Chama Carrinho1","type":"main","index":0}]]},"Chama Carrinho1":{"main":[[{"node":"No Operation, do nothing","type":"main","index":0}]]},"Postgres Chat Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"OpenAI Chat Model5":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"When Executed by Another Workflow":{"main":[[{"node":"MensagemTraduzida","type":"main","index":0}]]},"If2":{"main":[[{"node":"VoltaStatusCompra","type":"main","index":0}],[{"node":"No Operation, do nothing10","type":"main","index":0}]]},"Postgres Chat Memory2":{"ai_memory":[[{"node":"Fechamento1","type":"ai_memory","index":0}]]},"MenuCardapio1":{"main":[[{"node":"No Operation, do nothing2","type":"main","index":0}]]},"LLM CONSTRUTOR":{"main":[[{"node":"Bebidas","type":"main","index":0},{"node":"Pizzas Fracionada","type":"main","index":0},{"node":"Pizzas Inteira","type":"main","index":0},{"node":"Esfirra","type":"main","index":0},{"node":"item4","type":"main","index":0},{"node":"Bordas","type":"main","index":0}]]},"VoltaStatusCompra":{"main":[[{"node":"No Operation, do nothing9","type":"main","index":0}]]},"MenuCardapio3":{"main":[[{"node":"No Operation, do nothing12","type":"main","index":0}]]},"If6":{"main":[[{"node":"dicas","type":"main","index":0}],[{"node":"MenuCardapio34","type":"main","index":0}]]},"MenuCardapio34":{"main":[[{"node":"No Operation, do nothing33","type":"main","index":0}]]},"If4":{"main":[[{"node":"Montagem","type":"main","index":0}],[{"node":"AjudaMontagem","type":"main","index":0}]]},"MenuCardapio4":{"main":[[{"node":"No Operation, do nothing14","type":"main","index":0}]]},"AjudaMontagem1":{"main":[[]]},"Get Pedido":{"main":[[{"node":"Switch1","type":"main","index":0}]]},"CarinhoVazio":{"main":[[{"node":"If6","type":"main","index":0}]]},"BordaItem":{"main":[[{"node":"Merge1","type":"main","index":5}]]},"Split Out1":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Loop Over Items1":{"main":[[{"node":"No Operation, do nothing15","type":"main","index":0}],[{"node":"CardapioConsulta1","type":"main","index":0}]]},"Wait3":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Auto-fixing Output Parser1":{"ai_outputParser":[[{"node":"Basic LLM Chain","type":"ai_outputParser","index":0}]]},"OpenAI Chat Model3":{"ai_languageModel":[[{"node":"Auto-fixing Output Parser1","type":"ai_languageModel","index":0},{"node":"Basic LLM Chain","type":"ai_languageModel","index":0}]]},"Basic LLM Chain":{"main":[[{"node":"Split Out1","type":"main","index":0}]]},"CardapioConsulta1":{"main":[[{"node":"Wait3","type":"main","index":0}]]},"Structured Output Parser [Schema]1":{"ai_outputParser":[[{"node":"Auto-fixing Output Parser1","type":"ai_outputParser","index":0}]]},"FieldsCarrinho":{"main":[[{"node":"Get Pedido","type":"main","index":0}]]},"Fechar":{"main":[[{"node":"Merge","type":"main","index":0}]]},"N√£oFechar":{"main":[[{"node":"Merge","type":"main","index":2}]]},"Merge":{"main":[[{"node":"ChamaConversational","type":"main","index":0}]]},"PegaStusPedido":{"main":[[{"node":"If","type":"main","index":0}]]},"FieldsMontagem":{"main":[[{"node":"PegaStusPedido","type":"main","index":0}]]},"ExecutaMontagem":{"ai_tool":[[{"node":"Chama Carrinho","type":"ai_tool","index":0}]]},"Chama Carrinho":{"main":[[{"node":"No Operation, do nothing8","type":"main","index":0}]]},"ChamaConversational":{"main":[[{"node":"No Operation, do nothing16","type":"main","index":0}]]},"ChamaConversational1":{"main":[[{"node":"If2","type":"main","index":0}]]},"dicas":{"main":[[{"node":"Carrinho1","type":"main","index":0}]]},"Switch1":{"main":[[{"node":"Fechar","type":"main","index":0}],[{"node":"AddIngridiente","type":"main","index":0}],[{"node":"N√£oFechar","type":"main","index":0}]]},"AddIngridiente":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Postgres Chat Memory1":{"ai_memory":[[{"node":"Assistente Fracionado","type":"ai_memory","index":0}]]},"OpenAI Chat Model6":{"ai_languageModel":[[{"node":"Assistente Fracionado","type":"ai_languageModel","index":0}]]},"ExecutaMontagem8":{"ai_tool":[[{"node":"ChamaConversational2","type":"ai_tool","index":0}]]},"ChamaConversational2":{"main":[[{"node":"No Operation, do nothing24","type":"main","index":0}]]},"GetDicaAleatoria1":{"ai_tool":[[{"node":"Assistente Fracionado","type":"ai_tool","index":0}]]},"ConsultaOnlineVendas3":{"ai_tool":[[{"node":"Assistente Fracionado","type":"ai_tool","index":0}]]},"IntencaoCompra1":{"ai_tool":[[{"node":"Assistente Fracionado","type":"ai_tool","index":0}]]},"GetCarrinho1":{"ai_tool":[[{"node":"Assistente Fracionado","type":"ai_tool","index":0}]]},"Assistente Fracionado":{"main":[[{"node":"ChamaConversational2","type":"main","index":0}]]},"LogFinal":{"main":[[]]},"LogFinal1":{"main":[[]]},"BuscaPizzaSabor":{"ai_tool":[[]]},"GetCategoria":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Compras":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"MemoryKey2":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"MemoryKeqy":{"main":[[]]},"MemoryKey":{"main":[[{"node":"Fechamento1","type":"main","index":0}]]},"VinculaPizzaBordaItem":{"main":[[{"node":"AtualizaValorItem2","type":"main","index":0}]]},"Execute a SQL query":{"main":[[{"node":"MemoryKey2","type":"main","index":0}]]},"FecharPedido":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"GetCarrinho":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Call n8n Workflow Tool3":{"ai_tool":[[{"node":"ChamaPrecarrinho","type":"ai_tool","index":0}]]},"ChamaPrecarrinho":{"main":[[{"node":"Finalizar1","type":"main","index":0}]]},"StatusPedido":{"main":[[{"node":"If3","type":"main","index":0}]]},"VerificaCarrinhoVazio":{"main":[[{"node":"If7","type":"main","index":0}]]},"Finalizar1":{"main":[[{"node":"MemoryKey","type":"main","index":0}]]},"If3":{"main":[[{"node":"ChamaPrecarrinho","type":"main","index":0}],[{"node":"MemoryKey","type":"main","index":0}]]},"If7":{"main":[[{"node":"StatusPedido","type":"main","index":0}],[{"node":"MenuCardapio","type":"main","index":0}]]},"MenuCardapio":{"main":[[{"node":"No Operation, do nothing34","type":"main","index":0}]]},"conversational":{"ai_tool":[[{"node":"ChamaConversational1","type":"ai_tool","index":0}]]},"FerramentaCarrinho":{"ai_tool":[[{"node":"ChamaConversational","type":"ai_tool","index":0}]]},"ConsultaOnline":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"AI Agent":{"main":[[{"node":"ChamaConversational1","type":"main","index":0}]]},"MemoryKey3":{"main":[[{"node":"Limpa_turno","type":"main","index":0}]]},"LimpaN8nHistories":{"main":[[]]},"Code Tool":{"ai_tool":[[]]},"GravaPizza":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"GravaFracionado":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"GravaQuantidade":{"ai_tool":[[]]},"PrimeiraEscolha":{"main":[[{"node":"jsoncontroleIA","type":"main","index":0}]]},"GetCardapio":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"GravaIntencao":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"GetNumeroEscolhido":{"ai_tool":[[]]},"GravaTamanho":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Pendentes":{"main":[[{"node":"PrimeiraEscolha","type":"main","index":0}]]},"EscolheItemPosicao":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Auto-fixing Output Parser2":{"ai_outputParser":[[{"node":"LLM CONSTRUTOR1","type":"ai_outputParser","index":0}]]},"OpenAI Chat Model4":{"ai_languageModel":[[{"node":"Auto-fixing Output Parser2","type":"ai_languageModel","index":0},{"node":"LLM CONSTRUTOR1","type":"ai_languageModel","index":0}]]},"Structured Output Parser [Schema]2":{"ai_outputParser":[[{"node":"Auto-fixing Output Parser2","type":"ai_outputParser","index":0}]]},"LLM CONSTRUTOR1":{"main":[[{"node":"DadosAnotados","type":"main","index":0}]]},"LogFinal2":{"main":[[]]},"dd":{"main":[[]]},"DadosAnotados":{"main":[[{"node":"LLM RETORNOU NDA","type":"main","index":0}]]},"MontaComando":{"main":[[{"node":"LLM CONSTRUTOR","type":"main","index":0}]]},"Limpa_turno":{"main":[[{"node":"Code4","type":"main","index":0}]]},"jsoncontroleIA":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]},"RegistraQtde":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Code1":{"main":[[{"node":"Pendentes","type":"main","index":0}]]},"ExcluiIntencao":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"LLM RETORNOU NDA":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Code4":{"main":[[{"node":"No Operation, do nothing22","type":"main","index":0}]]},"Execute a SQL query1":{"main":[[]]},"LLM CONSTRUTOR2":{"main":[[]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"When Executed by Another Workflow":[{"json":{"mensagem":"n√£o","user_id":1,"pedido_id":26,"telefone":5516992975836,"rotina":5,"id_empresa":1,"instance":"LaCantina","apikey":"E9C6EA4E47E7-4905-BC38-475CBACA3F1E","acao":"escolha"}}]},"versionId":"7a07939f-70ea-49b7-9949-80601f338a78","triggerCount":1,"shared":[{"createdAt":"2025-09-18T15:44:58.320Z","updatedAt":"2025-09-18T15:44:58.320Z","role":"workflow:owner","workflowId":"gL1FbKkYm9zGfCAA","projectId":"wFRMrac2003Pl1x6"}],"tags":[]}