{"createdAt":"2025-08-25T01:29:03.078Z","updatedAt":"2025-09-01T16:05:05.177Z","id":"70DboVrDJn4vGDE7","name":"finalizapedido","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"finalizapedido","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-2000,48],"id":"ac9482a5-62ee-4872-a9ce-b0d6daa348aa","name":"Webhook","webhookId":"a9907ab7-afbf-4ee8-b19e-e3dc89aa791d"},{"parameters":{"jsCode":" return $('Webhook').first().json.body.itens"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[256,64],"id":"30e4d75b-d258-417d-8633-4d626ec38179","name":"Code"},{"parameters":{"options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.4,"position":[2352,64],"id":"8047cda5-1260-4df6-a1f3-a910646c180a","name":"Respond to Webhook"},{"parameters":{"operation":"get","tableId":"usuario_lacantina","filters":{"conditions":[{"keyName":"telefone","keyValue":"={{ $('Dados Lead').item.json.IdConversa }}"}]}},"id":"8df72a1e-6623-49ec-b912-4680d58633f5","name":"Encontrar Cliente1","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-1136,48],"alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"wfRfDKyFhOQc6c4W","name":"Supabase account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"3419c30f-4400-401b-bf40-db1579507f96","leftValue":"={{ $json.user_id }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"317aeb83-d61d-4ebc-b767-247cac6cd0d8","name":"Cliente Existe?1","type":"n8n-nodes-base.if","typeVersion":2.1,"position":[-928,48],"alwaysOutputData":false,"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"tableId":"usuario_lacantina","fieldsUi":{"fieldValues":[{"fieldId":"nome","fieldValue":"={{ $('Dados Lead').item.json.LeadNome }}"},{"fieldId":"telefone","fieldValue":"={{ $('Dados Lead').item.json.IdConversa }}"}]}},"id":"eeeadc98-fa05-46f4-8e1e-e6e4d026782b","name":"Criar Cliente1","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-496,336],"credentials":{"supabaseApi":{"id":"wfRfDKyFhOQc6c4W","name":"Supabase account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{},"id":"5c0c85ac-c00f-42d9-b5ca-629a594688f6","name":"Merge1","type":"n8n-nodes-base.merge","typeVersion":3,"position":[-144,64],"alwaysOutputData":false,"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"00d2650d-52f9-4bf5-9b50-ec548c105222","leftValue":"={{ $json.lead_id }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-352,64],"id":"746f4328-2486-4107-a661-df4e8251c1ae","name":"Concatena"},{"parameters":{"tableId":"pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('Merge1').item.json.user_id }}"},{"fieldId":"status","fieldValue":"aberto"},{"fieldId":"valor","fieldValue":"={{ $('Dados Lead').item.json.total }}"},{"fieldId":"tipo_cobranca","fieldValue":"={{ $('Dados Lead').item.json.pagamento }}"}]}},"id":"e560dd9a-1286-4194-9459-0363449dd348","name":"CriaPedido","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[48,64],"credentials":{"supabaseApi":{"id":"wfRfDKyFhOQc6c4W","name":"Supabase account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"041e18dc-788b-45e7-9348-cca03ac28eee","leftValue":"={{ $json.status }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-736,0],"id":"4eb88abc-cf9a-4f31-8fed-341ad5cd8cad","name":"If2"},{"parameters":{"operation":"update","tableId":"usuario_lacantina","filters":{"conditions":[{"keyName":"user_id","condition":"eq","keyValue":"={{ $json.user_id }}"},{"keyName":"status","condition":"is","keyValue":"null"}]},"fieldsUi":{"fieldValues":[{"fieldId":"status","fieldValue":"iniciado"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-560,-80],"id":"25b03e77-8240-41ac-a460-8502d00bd277","name":"IniciaAtendimento","credentials":{"supabaseApi":{"id":"wfRfDKyFhOQc6c4W","name":"Supabase account"}}},{"parameters":{"operation":"update","tableId":"usuario_lacantina","filters":{"conditions":[{"keyName":"user_id","condition":"eq","keyValue":"={{ $json.user_id }}"},{"keyName":"status","condition":"eq","keyValue":"iniciado"},{"keyName":"status","condition":"eq","keyValue":"iniciado"}]},"fieldsUi":{"fieldValues":[{"fieldId":"status","fieldValue":"enviado"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-560,96],"id":"273884e7-0a6e-40d3-a88d-582bc1916cb8","name":"AtendimentoEnviado","credentials":{"supabaseApi":{"id":"wfRfDKyFhOQc6c4W","name":"Supabase account"}}},{"parameters":{"assignments":{"assignments":[{"id":"9f488c5c-0b3b-48e9-87b1-5a22d513d1ec","name":"IdConversa","value":"= {{ $('Webhook').item.json.body.cliente.telefone }}","type":"string"},{"id":"69f6217f-9063-423f-abf4-e94f6b70f94e","name":"LeadNome","value":"={{ $('Webhook').item.json.body.cliente.nome }}","type":"string"},{"id":"4ca3ec90-96f0-4871-80d9-124d382dfee6","name":"total","value":"={{ $json.body.total }}","type":"number"},{"id":"1ef262ca-6155-4b16-b9f3-b4069d848419","name":"pagamento","value":"={{ $json.body.cliente.pagamento }}","type":"string"},{"id":"11f541c8-608b-48d0-9d19-07be38565e98","name":"endereco","value":"={{ $json.body.cliente.endereco }}","type":"string"},{"id":"daaec687-9849-43a3-ae2f-b30fc6a2b05b","name":"endereco","value":"={{ $json.body.cliente.endereco }}","type":"string"},{"id":"1cd8b6c4-dc43-4d5f-95aa-a6174d3a8fe9","name":"bairro","value":"={{ $json.body.cliente.bairro }}","type":"string"},{"id":"6f29b573-bf99-4b53-b814-7310512744b9","name":"comentario","value":"= {{ $json.body.cliente.comentarios }}","type":"string"},{"id":"0c719a93-3cb1-4eb5-91ec-facc726d53ff","name":"telefone","value":"= {{ $json.body.cliente.telefone }}","type":"string"}]},"options":{}},"id":"32c7ad0c-f7d9-4e9e-9513-9c534aa6ace6","name":"Dados Lead","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1392,48],"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"content":"Ajuste o Node Set com os campos relevantes fornecidos.\n","height":248,"width":226,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1456,-16],"id":"3bf7a80a-317b-440a-af5f-3b114fd49a21","name":"Sticky Note"},{"parameters":{"content":"Ajustes os filtros necessários conforme seu gatilho de entrada","height":248,"width":190,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1744,-16],"id":"d3c86589-b248-4869-b2ea-a61abe5cad54","name":"Sticky Note1"},{"parameters":{"content":"Ajuste tempos de buffer e inatividade do agente conforme necessidade.\n","height":280,"width":190,"color":3},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2032,-32],"id":"78697bab-8053-4fbe-9d35-9f1d430b2064","name":"Sticky Note18"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"204f54b0-e3ed-4ff4-8302-8c20d3b8aa78","leftValue":"={{ $('Webhook').item.json.body.isGroup }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}},{"id":"c51986d9-f347-4198-89bb-9e4cd0f021c9","leftValue":"={{ $('Webhook').item.json.body.broadcast }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}},{"id":"05ee6414-0164-473b-8f82-225cfba55ad2","leftValue":"={{ $('Webhook').item.json.body.key.fromMe }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"id":"19b34b92-6be6-4bdf-9fde-3d7c5d1260fc","name":"Filtro Inicial1","type":"n8n-nodes-base.filter","typeVersion":2.1,"position":[-1712,48],"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"jsCode":" const arr = $('Webhook').first().json.body.itens || [];\n\nfunction normalizaTamanho(desc) {\n  const m = desc.match(/\\((G|M|P)\\)/i);\n  if (!m) return { tamanho: null, descSemTamanho: desc };\n  const letra = m[1].toUpperCase();\n  const mapa = { G: 'grande', M: 'medio', P: 'pequena' };\n  const descSemTamanho = desc.replace(/\\s*\\((G|M|P)\\)\\s*/i, ' ').replace(/\\s+/g, ' ').trim();\n  return { tamanho: mapa[letra] || null, descSemTamanho };\n}\n\nfunction extraiFracao(desc) {\n  const r = /Meia\\s+(\\d+)[^+]*\\+\\s*Meia\\s+(\\d+)/i.exec(desc);\n  if (!r) return null;\n  return { n1: Number(r[1]), n2: Number(r[2]) };\n}\n\nfunction primeiroNumero(desc) {\n  const m = desc.match(/^\\s*(\\d+)\\s*-\\s*/) || desc.match(/\\b(\\d+)\\b/);\n  return m ? Number(m[1]) : null;\n}\n\nreturn arr.map(it => {\n  const raw = String(it.descricao || '').trim();\n  const { tamanho, descSemTamanho } = normalizaTamanho(raw);\n  const frac = extraiFracao(descSemTamanho);\n  const fracionada = !!frac;\n  const numero = fracionada ? frac.n1 : primeiroNumero(descSemTamanho);\n  const numero_fracao = fracionada ? frac.n2 : null;\n\n  const preco = Number(it.preco ?? it.valor ?? 0);\n  const qtd = Number(it.qtd ?? it.quantidade ?? 1);\n  const valor_total = preco * qtd;\n\n  return {\n    json: {\n      ...it,\n      descricao: descSemTamanho,\n      tamanho,\n      fracionada,\n      numero,\n      numero_fracao,\n      preco,\n      qtd,\n      valor_total\n    }\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[464,64],"id":"77ff02f9-7802-426f-964e-857d617c31b5","name":"Code1"},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"numero","fieldValue":"= {{ $json.numero }}"},{"fieldId":"quantidade","fieldValue":"={{ $json.qtd }}"},{"fieldId":"pedido_id","fieldValue":"={{ $('CriaPedido').item.json.pedido_id }}"},{"fieldId":"valor","fieldValue":"={{ $json.valor_total }}"},{"fieldId":"user_id","fieldValue":"={{ $('Merge1').item.json.user_id }}"},{"fieldId":"fracionada","fieldValue":"= {{ $json.fracionada }}"},{"fieldId":"tamanho","fieldValue":"={{ $json.tamanho }}"},{"fieldId":"valor_unitario","fieldValue":"= {{ $json.preco }}"},{"fieldId":"nome","fieldValue":"= {{ $json.descricao }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[688,64],"id":"2e0f9fc0-57a0-4de0-a60b-562815bb13f9","name":"InsereItens","credentials":{"supabaseApi":{"id":"wfRfDKyFhOQc6c4W","name":"Supabase account"}}},{"parameters":{"operation":"executeQuery","query":"  UPDATE Item_pedido_temp AS i\nSET volume = c.volume,\n  tipo = c.tipo,\n  categoria = c.categoria,\n  valor_unitario = valor / quantidade\nFROM cardapio AS c\nWHERE i.numero = c.numero\n    AND i.user_id =  {{ $('Merge1').item.json.user_id }}\n   AND i.pedido_id = {{ $('CriaPedido').item.json.pedido_id }};\n\n\n ","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[896,64],"id":"2bcbad57-a59c-4d9f-b315-836c4ceec00f","name":"Execute a SQL query","credentials":{"postgres":{"id":"UaH67kvWXxdMMhJt","name":"Postgres account"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2560,64],"id":"fbb03e0d-27be-4fb5-9137-27935a4b2a43","name":"No Operation, do nothing5","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"executeQuery","query":"SELECT * from finalizar_pedido(   {{ $('Merge1').item.json.user_id }}  ,{{ $('CriaPedido').item.json.pedido_id }}  ) ;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1328,64],"id":"4c61d5e7-47ac-4f4a-aa0f-35e2bac8d96d","name":"ConcluiPedido","credentials":{"postgres":{"id":"UaH67kvWXxdMMhJt","name":"Postgres account"}}},{"parameters":{"method":"POST","url":"= https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-MyrBo2u0n7N/text","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer MyrBo2u0n7N"}]},"sendBody":true,"specifyBody":"json","jsonBody":"= {\n  \"messageData\": {\n    \"to\": \"{{ $('Dados Lead').item.json.IdConversa }}\",\n    \"text\": \"Estamos encerrando seu chamado. Muito Obrigado!!\\n© 2025 Luis Gustavo Landucci — Right by LG™\"\n  }\n}\n ","options":{}},"id":"e1398dc6-b0be-41aa-8187-7a9e71020720","name":"MegaApi9","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1920,64]},{"parameters":{"method":"POST","url":"= https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-MyrBo2u0n7N/text","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer MyrBo2u0n7N"}]},"sendBody":true,"specifyBody":"json","jsonBody":"= {\n  \"messageData\": {\n    \"to\": \"{{ $('Dados Lead').item.json.IdConversa }}\",\n    \"text\": \"{{ $json.finalizar_pedido.replace(/\\n/g, '\\\\n') }}\"\n  }\n}\n","options":{}},"id":"60b900ee-20b1-4fb1-ba3c-7af69fa9c005","name":"MegaApi16","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1536,64]},{"parameters":{"amount":1},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1728,64],"id":"2b96dbe8-470f-4650-8685-ef7ec3c94ccd","name":"Wait","webhookId":"33c5308c-6ef7-4028-8fb7-f0f46b8d615d","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"tableId":"comentario_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"pedido_id","fieldValue":"= {{ $('CriaPedido').item.json.pedido_id }}"},{"fieldId":"user_id","fieldValue":"={{ $('Merge1').item.json.user_id }} "},{"fieldId":"comentario","fieldValue":"= {{ $('Dados Lead').item.json.comentario }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1120,64],"id":"6e1d9ccd-16af-4e13-be3e-77bcf8315854","name":"CriaComentario","credentials":{"supabaseApi":{"id":"wfRfDKyFhOQc6c4W","name":"Supabase account"}}},{"parameters":{"assignments":{"assignments":[{"id":"36437aa3-1b24-4d0c-b8df-f37bb7b4c3ec","name":"numero","value":"={{ $('CriaPedido').item.json.pedido_id }}","type":"number"},{"id":"74b87cb3-8ca6-4f86-8c39-0a354257c401","name":"mensagem","value":"= {{ $('ConcluiPedido').item.json.finalizar_pedido }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2128,64],"id":"7b2285c2-2f39-4e51-9414-4feffea46cee","name":"Edit Fields"}],"connections":{"Webhook":{"main":[[{"node":"Filtro Inicial1","type":"main","index":0}]]},"Code":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Encontrar Cliente1":{"main":[[{"node":"Cliente Existe?1","type":"main","index":0}]]},"Cliente Existe?1":{"main":[[{"node":"If2","type":"main","index":0}],[{"node":"Criar Cliente1","type":"main","index":0}]]},"Criar Cliente1":{"main":[[{"node":"Concatena","type":"main","index":0}]]},"Merge1":{"main":[[{"node":"CriaPedido","type":"main","index":0}]]},"Concatena":{"main":[[{"node":"Merge1","type":"main","index":0}],[{"node":"Merge1","type":"main","index":1}]]},"CriaPedido":{"main":[[{"node":"Code","type":"main","index":0}]]},"If2":{"main":[[{"node":"IniciaAtendimento","type":"main","index":0}],[{"node":"AtendimentoEnviado","type":"main","index":0}]]},"IniciaAtendimento":{"main":[[{"node":"Concatena","type":"main","index":0}]]},"AtendimentoEnviado":{"main":[[{"node":"Concatena","type":"main","index":0}]]},"Filtro Inicial1":{"main":[[{"node":"Dados Lead","type":"main","index":0}]]},"Dados Lead":{"main":[[{"node":"Encontrar Cliente1","type":"main","index":0}]]},"Code1":{"main":[[{"node":"InsereItens","type":"main","index":0}]]},"InsereItens":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]},"Execute a SQL query":{"main":[[{"node":"CriaComentario","type":"main","index":0}]]},"ConcluiPedido":{"main":[[{"node":"MegaApi16","type":"main","index":0}]]},"MegaApi9":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"MegaApi16":{"main":[[{"node":"Wait","type":"main","index":0}]]},"Wait":{"main":[[{"node":"MegaApi9","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"No Operation, do nothing5","type":"main","index":0}]]},"CriaComentario":{"main":[[{"node":"ConcluiPedido","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"58ed0ea6-4294-4424-b126-4030ca8870a7","triggerCount":1,"shared":[{"createdAt":"2025-08-25T01:29:03.078Z","updatedAt":"2025-08-25T01:29:03.078Z","role":"workflow:owner","workflowId":"70DboVrDJn4vGDE7","projectId":"kDZetBR3Erj53CH1"}],"tags":[]}