{"createdAt":"2025-09-18T15:44:58.320Z","updatedAt":"2025-09-22T23:43:08.839Z","id":"gL1FbKkYm9zGfCAA","name":"teste final fluxo reduzido pizzaria","active":true,"isArchived":false,"nodes":[{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.chatTrigger","typeVersion":1.3,"position":[-3216,-800],"id":"1ea74531-5006-4059-bc21-c31f29416ee7","name":"When chat message received","webhookId":"d8fabc58-bc32-4374-9024-6ddf8884d885"},{"parameters":{"operation":"executeQuery","query":"delete from item_pedido_temp where status <> 'concluido';","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1008,-1232],"id":"262d4433-ad79-4217-aeaa-116d5aee466b","name":"Execute a SQL query1","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":" SELECT rejeita_item( {{ $('DadoPedido').item.json.user_id }}, {{ $('DadoPedido').item.json.pedido_id }}  );","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[3104,-672],"id":"d5d30080-47a6-459c-b463-883f0f46f96a","name":"RejeitaItem","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"fieldToSplitOut":"output.bebidas","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[400,-944],"id":"7a608843-94ae-4a9d-8a55-9f4222a0f6ab","name":"Bebidas","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"fieldToSplitOut":" output.pizzas_fracionadas","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[400,-816],"id":"49dbeeb0-7863-4321-abc5-6aa8716b5d4c","name":"Pizzas Fracionada","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"fieldToSplitOut":"output.pizzas_inteiras","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[400,-672],"id":"e738ed86-7847-426a-928a-9dd96bf35e0a","name":"Pizzas Inteira","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"fieldToSplitOut":"output.esfirras","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[400,-528],"id":"158da210-0bc8-433a-9120-6fd036ad4d85","name":"Esfirra","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('MontPedido').item.json.user_id }}"},{"fieldId":"quantidade","fieldValue":"={{ $json.quantidade }}"},{"fieldId":"tipo","fieldValue":"bebida"},{"fieldId":"categoria","fieldValue":"bebida"},{"fieldId":"nome","fieldValue":"={{ $json.nome }}"},{"fieldId":"volume","fieldValue":"= {{ (($json.volume ?? '').toString().replace(/[\\s\\u00A0\\u200B-\\u200D\\uFEFF]+/g, '') === '')\n    ? ' volume desconhecido'\n    : ($json.volume ?? '').toString().replace(/[\\s\\u00A0\\u200B-\\u200D\\uFEFF]+/g, '') }}"},{"fieldId":"fracionada","fieldValue":"false"},{"fieldId":"pedido_id","fieldValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"fieldId":"numero","fieldValue":"={{ $json.numero ? $json.numero : 0 }}"},{"fieldId":"comando_original","fieldValue":"={{ $json.comando_original }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[656,-944],"id":"f7635034-812e-4fbd-aa0d-9042e5cc4409","name":"Itembebida","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('MontPedido').item.json.user_id }}"},{"fieldId":"quantidade","fieldValue":"={{ $json.quantidade }}"},{"fieldId":"categoria","fieldValue":"pizza"},{"fieldId":"fracionada","fieldValue":"true"},{"fieldId":"numero","fieldValue":"= {{ $json.metade1 }}"},{"fieldId":"numero_fracao","fieldValue":"={{ $json.metade2 }}"},{"fieldId":"tamanho","fieldValue":"grande"},{"fieldId":"fracionada","fieldValue":"true"},{"fieldId":"pedido_id","fieldValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"fieldId":"nome","fieldValue":"={{ $json.nome }}"},{"fieldId":"nome_fracao","fieldValue":"={{ $json.nome_fracao }}"},{"fieldId":"pizza_referencia","fieldValue":"={{$json.pizza_referencia.trim()}}"},{"fieldId":"comando_original","fieldValue":"={{ $json.comando_original }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[656,-816],"id":"1a425d55-acc5-40b3-8035-6dea956073b8","name":"ItemFracionado","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('MontPedido').item.json.user_id }}"},{"fieldId":"quantidade","fieldValue":"={{ $json.quantidade }}"},{"fieldId":"categoria","fieldValue":"pizza"},{"fieldId":"fracionada","fieldValue":"false"},{"fieldId":"numero","fieldValue":"={{ String($json.numero ?? '').trim() === '' ? null : $json.numero }}"},{"fieldId":"tamanho","fieldValue":"={{ $json.tamanho.toLowerCase() }}"},{"fieldId":"fracionada","fieldValue":"false"},{"fieldId":"pedido_id","fieldValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"fieldId":"nome","fieldValue":"={{ $json.nome?.trim() === '' ? null : $json.nome }}"},{"fieldId":"pizza_referencia","fieldValue":"={{ $json.pizza_referencia }}"},{"fieldId":"comando_original","fieldValue":"={{ $json.comando_original }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[656,-672],"id":"09a72d7a-7fcc-4cd4-97a6-28bd531c962c","name":"ItemInteira","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('MontPedido').item.json.user_id }}"},{"fieldId":"quantidade","fieldValue":"={{ $json.quantidade }}"},{"fieldId":"tipo","fieldValue":"bebida"},{"fieldId":"categoria","fieldValue":"esfirra"},{"fieldId":"nome","fieldValue":"={{ $json.nome?.trim() === '' ? null : $json.nome }}"},{"fieldId":"tipo","fieldValue":"={{ $json.tipo?.trim() === '' ? null : $json.tipo }}"},{"fieldId":"fracionada","fieldValue":"false"},{"fieldId":"pedido_id","fieldValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"fieldId":"numero","fieldValue":"={{ (String($json.numero ?? '').trim() === '' \n    || Number(String($json.numero).replace(',','.').trim()) === 0)\n  ? null \n  : $json.numero }}"},{"fieldId":"comando_original","fieldValue":"={{ $json.comando_original }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[656,-528],"id":"59df7bdc-aed6-46b7-9f35-1a2bf7ec7cf3","name":"ItemEsfirra","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.outputParserAutofixing","typeVersion":1,"position":[-304,-544],"id":"b399cce6-9e20-4758-989a-b43190cb9942","name":"Auto-fixing Output Parser","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"executeQuery","query":"WITH ordenado AS (\n  SELECT \n    item_id,\n    user_id,\n    pedido_id,\n    ROW_NUMBER() OVER (PARTITION BY user_id, pedido_id ORDER BY item_id) AS nova_ordem\n  FROM item_pedido_temp\n)\nUPDATE item_pedido_temp i\nSET ordem_item = o.nova_ordem\nFROM ordenado o\nWHERE i.item_id = o.item_id\n  AND i.user_id = o.user_id\n  AND i.pedido_id = o.pedido_id \n   and i.user_id =   {{ $('DadoPedido').item.json.user_id }} \n  and i.pedido_id = {{ $('DadoPedido').item.json.pedido_id }}  and  status = 'concluido'  ;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[3504,-672],"id":"86faff93-e8fb-47a4-84e7-6d67471a8cd9","name":"OrdenaPedido","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":" UPDATE Item_pedido_temp AS i\nSET  status = 'concluido',\n   ordem_item = 0\n \nWHERE  status = 'inicio' and\n    user_id =  {{ $('DadoPedido').item.json.user_id }} and i.pedido_id = {{ $('DadoPedido').item.json.pedido_id }} and i.numero <> 0 ;\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[3344,-672],"id":"b5ebf3b9-d2df-4845-8e4c-e0c83e3097fa","name":"ConcluiTudo","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"fieldToSplitOut":"output.bordas","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[400,-256],"id":"e56769d0-adcf-4271-8573-80a1dc184634","name":"Bordas","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"numberInputs":6},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1424,-704],"id":"ec18115b-1dc9-4971-b260-adebc6788470","name":"Merge1","alwaysOutputData":false,"onError":"continueRegularOutput"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-432,-304],"id":"29668865-9ed1-45b0-941b-049371b5e133","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"schemaType":"manual","inputSchema":" {\n  \"type\": \"object\",\n  \"properties\": {\n    \"pizzas_inteiras\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"quantidade\": { \"type\": \"integer\" },\n          \"numero\": { \"type\": \"integer\" },\n          \"tamanho\": { \"type\": \"string\" },\n           \"nome\": { \"type\": \"string\" },\n           \"pizza_referencia\":  { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" }\n          \n        },\n        \"required\": [\"quantidade\", \"numero\", \"tamanho\", \"pedido_id\"]\n      }\n    },\n    \"pizzas_fracionadas\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"quantidade\": { \"type\": \"integer\" },\n          \"metade1\": { \"type\": \"integer\" },\n          \"metade2\": { \"type\": \"integer\" },\n            \"nome\": { \"type\": \"string\" },\n            \"nome_fracao\": { \"type\": \"string\" },\n           \"pizza_referencia\":  { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" }\n         \n        },\n        \"required\": [\"quantidade\", \"metade1\", \"metade2\",\"pedido_id\"]\n      }\n    },\n    \"bebidas\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"quantidade\": { \"type\": \"integer\" },\n          \"nome\": { \"type\": \"string\" },\n          \"volume\": { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" }\n         \n        },\n        \"required\": [\"quantidade\", \"nome\", \"volume\",\"pedido_id\"]\n      }\n    },\n    \"esfirras\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"quantidade\": { \"type\": \"integer\" },\n          \"numero\": { \"type\": \"integer\" },\n          \"nome\": { \"type\": \"string\" },\n          \"tipo\": { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" }\n        },\n        \"required\": [\"quantidade\", \"numero\", \"nome\", \"tipo\"]\n      }\n    },\n    \"bordas\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"numero\": { \"type\": \"integer\" },\n          \"nome\": { \"type\": \"string\" } ,\n           \"pizza_referencia\":  { \"type\": \"string\" },\n          \"tamanho\": { \"type\": \"string\" }, \n          \"categoria\": { \"type\": \"string\" },\n           \"comando_original\":  { \"type\": \"string\" }\n  \n         \n    },\n        \"required\": [\"numero\", \"pizza_referencia\"]\n      }\n    },\n    \"item\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": { \n          \"nome\": { \"type\": \"string\" } ,\n           \"pizza_referencia\":  { \"type\": \"string\" } ,\n           \"comando_original\":  { \"type\": \"string\" }\n          \n    },\n        \"required\": [\"nome\", \"pizza_pai\"]\n      }\n    }\n\n    \n  },\n  \"required\": [\n    \"pizzas_inteiras\",\n    \"pizzas_fracionadas\",\n    \"bebidas\",\n    \"esfirras\",\n    \"bordas\" \n  ]\n}\n"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.2,"position":[-208,-352],"id":"8e713269-9051-4c42-82c1-636de7005114","name":"Structured Output Parser [Schema]","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"promptType":"define","text":"=<mensagem_do_usuario>\n{{ $('When Executed by Another Workflow').item.json.mensagem }}\n</mensagem_do_usuario>","hasOutputParser":true,"messages":{"messageValues":[{"message":"=  {\n  \"pizzas_inteiras\": [\n    { \"quantidade\": int, \"numero\": int, \"tamanho\": str , \"nome\": str, \"pizza_referencia\": str, \"comando_original\": str  }   // pizza_referencia é uma relação com a borda ou com item \n  ],\n  \"pizzas_fracionadas\": [\n    { \"quantidade\": int, \"metade1\": int, \"metade2\": int , \"nome\": str, \n\"nome_fracao\": str , \"pizza_referencia\": str, \"comando_original\": str }\n  ],\n  \"bebidas\": [\n    { \"quantidade\": int, \"nome\": str, \"volume\": str , \"comando_original\": str }\n  ],\n \"esfirras\": [\n  { \"quantidade\": int, \"numero\": int, \"nome\": str, \"tipo\": str , \"comando_original\": str} // tipo: \"salgada\" ou \"doce\"\n  ],\n  \"bordas\": [\n   \n { \"numero\": int, \"nome\": str, \"pizza_referencia\": str , \"tamanho\": str, \"categoria\": str, \"comando_original\": str } // pizza_referencia é uma relação da borda com a pizza \n\n\n// \"pizza_referencia\" = string que identifica a pizza onde será aplicada\n  ]\n \"item\": [\n    { \"nome\": str , \"pizza_pai\": int , \"comando_original\": str} //  \n  ]\n\n\n}\n\n⚠️ Regras obrigatórias:\n- Sempre retorne exatamente essas 5 listas, mesmo que estejam vazias.\n- Use apenas os nomes de campos e estrutura mostrados acima.\n- Retorne **apenas o JSON válido**, sem explicações, comentários ou texto adicional.\n\nSe o usuário informar apenas ‘pizza N’, não descarte. Gere {quantidade:1, numero:N, tamanho:'media'} em pizzas_inteiras.”\n\n“Nunca omita itens ambíguos; use defaults: quantidade=1, tamanho='media'.”\n\n“Não valide com o cardápio. A validação será feita depois; sempre retorne o item.”\n\n\"A palavra uma , duas  refere-se sempre  quantidade  exemplo uma  pizza mussarela ou uma pizza presunto e queijo é quantidade..\"\n\n\n\nPrioridade de interpretação\n\nSe houver padrões de pizza fracionada no formato {Q? 1/2 A (e|,|+|/) 1/2 B}, crie um item em pizzas_fracionadas com {quantidade: Q || 1, metade1: A, metade2: B}.\n\nNunca crie pizzas_inteiras para números A ou B quando eles estiverem dentro de um padrão fracionado.\n\nSó trate “pizza N” (inteira) quando não fizer parte de um padrão 1/2 N.  \n\nSo trate   \"pizza\" se tiver explicito que se trata de \"pizza\"\n\nSo trate   \"esfirra \" se tiver explicito que se trata de \"esfirra\"\n\no comando_origianal guaro valor da string que gerou o json  exemplo :  “1 pizza 1/2 14  e 1/2 21”\n\nRegras específicas para BORDAS (muito importante):\n- Se a mensagem contiver “borda”, o texto imediatamente após a palavra “borda”\n  até antes de “ao item”, “no item”, “item”, “pizza” ou o fim da frase, é o campo \"nome\".\n- Normalize espaços e minúsculas (ex.: \"Borda   Cheddar\" → nome: \"cheddar\").\n- Sempre preencha \"categoria\":\"borda\" e \"pizza_pai\" com o número do item/pizza alvo quando presente (ex.: \"item 1\" → pizza_pai: 1).\n- Não use o campo \"item[]\"; bordas devem ir apenas em \"bordas[]\".\n- Defaults para borda quando ausentes: numero=0, tamanho=\"\", pizza_referencia=\"\".\n\n\n\nExemplos:\n\n“1 pizza 1/2 14  e 1/2 21” → pizzas_fracionadas: [{quantidade:1, metade1:14, metade2:21, nome:'', nome_fracao: '' } ]\n\n“2 1/2 10, 1/2 15” → pizzas_fracionadas: [{quantidade:2, metade1:10, metade2:15 , nome:'', nome_fracao: '' }]\n\n“14 e 21” (sem 1/2) → pizzas_inteiras: [{q:1,n:14,media},{q:1,n:21,media }]\n\n\n\n“1 pizza 1/2 mussarela  e 1/2 presunto e queijo ” → pizzas_fracionadas: [{quantidade:1, metade1:0, metade2:0, nome:mussarela, nome_fracao: presunto e queijo } ]\n\n“1 pizza meia  mussarela  e meia  presunto e queijo ” → pizzas_fracionadas: [{quantidade:1, metade1:0, metade2:0, nome:mussarela, nome_fracao: presunto e queijo } ]\n\nSe o cliente disser meia  interprete como 1/2\n\n\n \nBebidas — defaults e sinônimos (obrigatório)\n\nSe o cliente disser “lata” e não informar volume, use 350ml.\n\nSe o cliente disser “long neck” e não informar volume, use 330ml.\n\nSe o cliente pedir coca/coca-cola sem volume, use 2l.\n\nNunca rejeite bebidas por falta de volume quando se aplicar uma regra acima.\n\nNormalize o campo volume sempre em minúsculas e sem espaços (ex.: 350ml, 330ml, 2l).\n\nExemplos\n\n“3 long neck heineken” → bebidas: [{ \"quantidade\": 3, \"nome\": \"heineken\", \"volume\": \"330ml\" }]\n\n“lata bud” → bebidas: [{ \"quantidade\": 1, \"nome\": \"budweiser\", \"volume\": \"350ml\" }]\n\n“2 coca” → bebidas: [{ \"quantidade\": 2, \"nome\": \"coca cola\", \"volume\": \"2l\" }]\nPedido:\n{pedido}\n\nquando numa string de comando tiver 1 pizza musssarela  1 borda chedaar na qual o codigo da pizza não for identifica,  crie no campo   \"pizza_referencia\" uma amarração entre 1 pizza mussarela e borda   \"pizza_referencia\" pode ser um codigo unico. Isso vale tambpem para pizza fracionada \n\n"}]}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.6,"position":[-368,-784],"id":"03c7b5ef-890b-43ea-9e04-b190ee33affa","name":"Basic LLM Chain","retryOnFail":true,"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"fieldToSplitOut":"output.item","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[400,-400],"id":"52506e17-3640-4a5c-97f2-d75318f09678","name":"item4","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('MontPedido').item.json.user_id }}"},{"fieldId":"quantidade","fieldValue":"=1"},{"fieldId":"tipo","fieldValue":"item"},{"fieldId":"categoria","fieldValue":"item"},{"fieldId":"nome","fieldValue":"={{ $json.nome?.trim() === '' ? null : $json.nome }}"},{"fieldId":"numero","fieldValue":"=0"},{"fieldId":"fracionada","fieldValue":"=false"},{"fieldId":"pedido_id","fieldValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"fieldId":"tamanho","fieldValue":"=0"},{"fieldId":"comando_original","fieldValue":"={{ $json.comando_original }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[656,-400],"id":"5f4ecb21-f345-44c7-92f8-9be2a993f5f8","name":"Item4","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT AtualizaValorFracionado(  {{ $('DadoPedido').item.json.user_id }},{{ $('DadoPedido').item.json.pedido_id }});","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2880,-672],"id":"a381a11d-a7c7-4aa3-aa57-c6a67985f4bb","name":"AtualizaValorPizzaFracionada2","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT   atualizar_valores_itens_temp( {{ $('DadoPedido').item.json.user_id }},{{ $('DadoPedido').item.json.pedido_id }} );","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2656,-672],"id":"157dbe1e-050f-456b-ac79-2d88e1607752","name":"AtualizaValorItem2","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('MontPedido').item.json.user_id }}"},{"fieldId":"quantidade","fieldValue":"=1"},{"fieldId":"tipo","fieldValue":"borda"},{"fieldId":"categoria","fieldValue":"borda"},{"fieldId":"nome","fieldValue":"={{ $('Bordas').item.json.nome }}"},{"fieldId":"numero","fieldValue":"={{ $json.numero ? $json.numero : 0 }}"},{"fieldId":"fracionada","fieldValue":"=false"},{"fieldId":"pedido_id","fieldValue":"={{ $('MontPedido').item.json.pedido_id }}"},{"fieldId":"tamanho","fieldValue":"={{ $json.tamanho }}"},{"fieldId":"pizza_referencia","fieldValue":"={{ $json.pizza_referencia }}"},{"fieldId":"comando_original","fieldValue":"={{ $json.comando_original }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[656,-256],"id":"754e1ee8-60ce-4a79-9dc7-aa77cf2359e8","name":"Item5","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"assignments":{"assignments":[{"id":"a3c83333-8ce3-4995-8230-b361099aa1e4","name":"user_id","value":"={{ $('When Executed by Another Workflow').item.json.user_id }}","type":"number"},{"id":"d7c14753-505f-48ee-a344-fa565ace43df","name":"pedido_id","value":"={{ $('When Executed by Another Workflow').item.json.pedido_id }}","type":"number"},{"id":"fdf33d81-37b4-46c9-b56a-6787b3d92dac","name":"rotina","value":"={{ $('When Executed by Another Workflow').item.json.rotina }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1920,-768],"id":"a6418514-62bb-4f8a-b1e3-7debd49a46c5","name":"MontPedido"},{"parameters":{"assignments":{"assignments":[{"id":"8033b503-a34e-4682-a40a-b60b315714e6","name":"user_id","value":"={{ $json.user_id }}","type":"number"},{"id":"bd4fde4d-0d15-4271-945c-571b24973379","name":"pedido_id","value":"={{ $json.pedido_id }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1776,-672],"id":"8373ecb1-043b-4540-895e-8bb63b1ffe3a","name":"DadoPedido","executeOnce":true},{"parameters":{"operation":"executeQuery","query":"call valida_nome_item_pedido( {{ $json.user_id }} , {{ $json.pedido_id }});","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1968,-672],"id":"fe8bc0da-85fc-4616-8f56-8b2747cc414e","name":"ValidaItemNome","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"resource":"messages-api","instanceName":"delivery","remoteJid":"= {{$('Dados Lead').first().json.IdConversa}}","messageText":"= {{ $json.texto_alinhado }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1808,-1792],"id":"10406ba5-51dd-442c-8de1-aebbdba35711","name":"MenuCardapio10","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{"jsCode":" const raw = ($json.calcula_pre_pedido || \"\").replace(/\\r\\n/g, \"\\n\");\nconst txt = raw.trim();\n\nif (!txt) {\n  return { texto_alinhado: \"não existe registro\" };\n}\n\nconst lines = txt.split(\"\\n\").map(l => l.trimEnd());\n\n// Se não tiver \"Resumo:\", devolve o corpo original\nconst start = lines.findIndex(l => /resumo:/i.test(l));\nif (start === -1) {\n  return { texto_alinhado: txt };\n}\n\nlet end = lines.findIndex((l, i) => i > start && (\n  /forma de pagamento/i.test(l) || /entrega:/i.test(l) || /total:/i.test(l) || /total de itens/i.test(l)\n));\nif (end === -1) end = lines.length;\n\nconst header = lines.slice(0, start + 1);\nconst itemLines = lines.slice(start + 1, end).filter(l => l.trim());\nconst footer = lines.slice(end);\n\n// ---- parsing ajustado ----\nconst parsed = itemLines.map(line => {\n  const match = line.match(/(R\\$\\s*[\\d\\.,]+)$/);\n  if (!match) return { num: \"\", desc: line.trim(), valor: \"\" };\n\n  const valor = match[1].replace(\"R$\", \"\").trim();\n  const left = line.slice(0, match.index).trim();\n\n  // captura do número inicial (ex: (1) Nome ...)\n  const numMatch = left.match(/^\\((\\d+)\\)\\s*(.*)$/);\n  let num = \"\", desc = left;\n  if (numMatch) {\n    num = numMatch[1];\n    desc = numMatch[2].trim();\n  }\n\n  return { num, desc, valor };\n});\n\nconst maxNum = parsed.reduce((m, o) => Math.max(m, o.num.length), 0);\nconst maxDesc = parsed.reduce((m, o) => Math.max(m, o.desc.length), 0);\n\n// monta itens alinhados com cabeçalho\nconst itensAlinhados = [\n  \"Item \".padEnd(maxNum + 2, \" \") +\n  \"Descrição\".padEnd(maxDesc + 4, \" \") +\n  \"Valor\"\n];\n\nparsed.forEach(o => {\n  itensAlinhados.push(\n    o.num.padEnd(maxNum + 2, \" \") +\n    o.desc.padEnd(maxDesc + 4, \" \") +\n    \"R$ \" + o.valor\n  );\n});\n\n// ---- corpo final ----\nconst corpo = [\n  ...header,\n  ...itensAlinhados,\n  ...footer\n].join(\"\\n\");\n\nreturn { texto_alinhado: \"```\\n\" + corpo + \"\\n```\" };\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1600,-1792],"id":"bc5d27b1-c892-437b-9ebf-a0000affef2d","name":"Code5"},{"parameters":{"jsCode":" const input =  $input.first().json.chatInput || \"\";\n\n// Normaliza\nconst frase = input.toLowerCase().replace(/\\s+/g, \" \").trim();\n\nconst result = {\n  pizzas_inteiras: [],\n  pizzas_fracionadas: [],\n  bebidas: [],\n  bordas: []\n};\n\n// Quebra em pedaços por \" e \", \" , \", \" + \" etc\nconst partes = frase.split(/,| e | \\+ | \\/ /).map(p => p.trim()).filter(Boolean);\n\nfor (let p of partes) {\n  let qtd = 1;\n  const qtdMatch = p.match(/^(\\d+)/);\n  if (qtdMatch) qtd = parseInt(qtdMatch[1]);\n\n  // 🍕 Fracionada\n  if (p.includes(\"1/2\")) {\n    const fracoes = p.split(/1\\/2/).map(f => f.trim()).filter(Boolean);\n    if (fracoes.length === 2) {\n      result.pizzas_fracionadas.push({\n        quantidade: qtd,\n        metade1: isNaN(fracoes[0]) ? fracoes[0] : parseInt(fracoes[0]),\n        metade2: isNaN(fracoes[1]) ? fracoes[1] : parseInt(fracoes[1]),\n        tamanho: \"media\"\n      });\n    }\n  }\n\n  // 🧀 Borda\n  else if (p.includes(\"borda\")) {\n    result.bordas.push({\n      quantidade: qtd,\n      nome: p.replace(/borda|pizza|item|\\d+/gi, \"\").trim(),\n      pizza_referencia: \"\"\n    });\n  }\n\n  // 🥤 Bebidas\n  else if (p.includes(\"coca\") || p.includes(\"refrigerante\") || p.includes(\"guaraná\") || p.includes(\"suco\")) {\n    let volume = \"\";\n    if (p.includes(\"2l\")) volume = \"2l\";\n    else if (p.includes(\"350ml\") || p.includes(\"lata\")) volume = \"350ml\";\n    else if (p.includes(\"330ml\") || p.includes(\"long neck\")) volume = \"330ml\";\n\n    result.bebidas.push({\n      quantidade: qtd,\n      nome: p.replace(/\\d+|coca|cola|refrigerante|guaraná|suco|lata|long neck|ml|l/gi, \"\").trim(),\n      volume: volume || \"2l\"\n    });\n  }\n\n  // 🍕 Pizza inteira\n  else if (p.includes(\"pizza\")) {\n    let tamanho = \"media\";\n    if (p.includes(\"grande\")) tamanho = \"grande\";\n    else if (p.includes(\"brotinho\")) tamanho = \"brotinho\";\n\n    const numeroMatch = p.match(/(\\d+)/);\n    if (numeroMatch) {\n      result.pizzas_inteiras.push({\n        quantidade: qtd,\n        numero: parseInt(numeroMatch[1]),\n        tamanho\n      });\n    } else {\n      result.pizzas_inteiras.push({\n        quantidade: qtd,\n        nome: p.replace(/\\d+|pizza|grande|media|brotinho/gi, \"\").trim(),\n        tamanho\n      });\n    }\n  }\n}\n\nreturn [{ json: result }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2656,-2720],"id":"0255a680-b4f6-4b28-b9c0-9fa8c31aeabc","name":"Code"},{"parameters":{"resource":"messages-api","instanceName":"=delivery","remoteJid":"= {{$('Dados Lead').first().json.IdConversa}}","messageText":"={{$json.mensagem}}\n","options_message":{"delay":4}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[2704,-1792],"id":"05813221-b1d8-4a04-bf03-3a4ee752daa8","name":"MenuCardapio40","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{"jsCode":" // ===== Emojis =====\nconst HDR_EMOJI  = '🔹';\nconst DESC_EMOJI = '▫️';\n\n// -------- Helpers --------\nfunction toNum(x) {\n  if (typeof x === 'number' && isFinite(x)) return x;\n  if (x == null) return 0;\n  const s = String(x).replace(/[^\\d,.-]/g, '').replace(/\\.(?=\\d{3}(?:\\D|$))/g, '').replace(',', '.');\n  const n = Number(s);\n  return isFinite(n) ? n : 0;\n}\nfunction moneyTrim(n) {\n  const s = toNum(n).toFixed(2).replace(/(\\.\\d*?)0+$/, '$1').replace(/\\.$/, '');\n  return s;\n}\nfunction clean(txt) {\n  return String(txt || '')\n    .replace(/\\uFFFD/g, '')\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g,'')\n    .replace(/\\s*-\\s*/g, ' - ')\n    .replace(/[ \\t]+/g, ' ')\n    .trim();\n}\nconst bold = s => `*${s}*`;\n\n// -------- Inferência de Categoria & Tipo --------\nconst BEBIDAS_RX = /\\b(coca(?:\\s*cola)?|guaran[aá]|heineken|bud(?:weiser)?|cerveja|água|agua|fanta|sprite|pepsi|refrigerante|long\\s*neck|lata)\\b/i;\nconst BORDA_RX   = /\\bborda\\b/i;\nconst ESFIRRA_RX = /\\besfirra\\b/i;\n\nconst DOCES_RX = /\\b(chocolate|nutella|goiabada|doce\\s+de\\s+leite|brigadeiro|beijinho|romeu\\s*e\\s*julieta|banana|morango|paçoca|pacoca|prestígio|prestigio)\\b/i;\n\nfunction guessCategoria(nome, desc, cat) {\n  if (cat && String(cat).trim()) return String(cat).toLowerCase(); // já veio do backend\n  const hay = `${nome} ${desc}`;\n  if (BEBIDAS_RX.test(hay)) return 'bebida';\n  if (BORDA_RX.test(hay))   return 'borda';\n  if (ESFIRRA_RX.test(hay)) return 'esfirra';\n  return 'pizza'; // default\n}\n\nfunction guessTipo(nome, desc, tipo) {\n  if (tipo && String(tipo).trim()) return String(tipo).toLowerCase();\n  const hay = `${nome} ${desc}`;\n  return DOCES_RX.test(hay) ? 'doce' : 'salgada';\n}\n\n// -------- Entrada --------\nconst items = $input.all();\nlet rows = [];\nif (items.length > 1) rows = items.map(i => i.json);\nelse {\n  let p = items?.[0]?.json ?? {};\n  if (p && typeof p === 'object' && 'result' in p) p = p.result;\n  rows = Array.isArray(p) ? p : (p && typeof p === 'object' ? [p] : []);\n}\n\n// -------- Saída formatada --------\nconst lines = rows.map(r => {\n  const numero = r.numero ?? r.id ?? r.code ?? '';\n  const nome   = clean(r.nome ?? r.name ?? 'Item');\n  const desc   = clean(r.descricao ?? r.description ?? '');\n\n  const g = r.preco_grande ?? r.precoG ?? r.preco_g;\n  const m = r.preco_media  ?? r.precoM ?? r.preco_m;\n\n  const categoria = guessCategoria(nome, desc, r.categoria);\n  const tipo      = guessTipo(nome, desc, r.tipo);\n\n  const parts = [];\n  if (g != null && g !== '') parts.push(`(G) R$${moneyTrim(g)}`);\n  if (m != null && m !== '') parts.push(`(M) R$${moneyTrim(m)}`);\n  const precoStr = parts.join(' / ') || 'R$0';\n\n  const header = `${HDR_EMOJI} ${ bold(`(${numero})`) } ${nome} – ${bold(precoStr)} ${bold(` [${categoria}] [${tipo}]`)}`;\n  const body   = `${DESC_EMOJI} Descrição: ${desc || '-'}`\n  return `${header}\\n${body}`;\n});\n\nreturn [{\n  json: {Opções: \"Opções dos itens não encontrados\\n\",\n    descricao: lines.join('\\n'),\n    user_id: $json.user_id ?? null,\n    pedido_id: $json.pedido_id ?? null\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2272,-1792],"id":"0eaa0e8a-be3b-48f5-af58-245debcfeedb","name":"VariasPizzas1"},{"parameters":{"jsCode":" const descricao = $json.descricao || \"\";\nreturn {\n  mensagem: \"```\\n\" +  \"Suas opções dos itens não encontrados:\\nDois exemplos validos: 1 pizza 32 grande ou 1 pizza 1/2 14 e meia 12\\nEscolha sua opção abaixo ⬇️\\n\\n\" +   descricao + \" ```\"\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2464,-1792],"id":"e7972fe9-b687-4292-bce3-792f58828e6c","name":"Code13"},{"parameters":{"assignments":{"assignments":[{"id":"9f488c5c-0b3b-48e9-87b1-5a22d513d1ec","name":"IdConversa","value":"={{ $('When Executed by Another Workflow').item.json.telefone }}","type":"string"}]},"options":{}},"id":"63df038e-25e8-410b-8781-94308aa7e0c4","name":"Dados Lead","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2272,-768],"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{"temperature":0.1}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1408,-2016],"id":"9b8d34e4-e87d-4570-970a-8b413af3ddbf","name":"OpenAI Chat Model1","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"23232313233223","contextWindowLength":3},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[1472,-1968],"id":"b4ddbccd-8ad3-4b46-ab8b-ce88beab4a3b","name":"Simple Memory"},{"parameters":{"operation":"executeQuery","query":" select calcula_pre_pedido({{ $('DadoPedido').item.json.user_id }}, {{ $('DadoPedido').item.json.pedido_id }}  );","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1360,-1792],"id":"2cf0ee35-f685-43fc-8f84-7ecfc3c9c52c","name":"GetCarrinhoFlx","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":" \n\n\n   SELECT  'não fracionado' , * FROM busca_cardapio( ( SELECT string_agg(num, ', ')\n \n  FROM ( select  distinct c.numero::text AS num\n \n        FROM item_pedido_temp AS i2\n        LEFT JOIN cardapio AS c\n          ON c.categoria in( 'pizza', 'item','borda')\n         AND c.nome ILIKE '%' || TRIM(i2.nome) || '%'\n        WHERE i2.status = 'opcoes'\n          AND i2.user_id = {{ $('DadoPedido').item.json.user_id }}    \n          AND i2.pedido_id =  {{ $('DadoPedido').item.json.pedido_id }}   \n          AND i2.numero = 0 and\n          c.categoria  = i2.categoria and i2.fracionada = false )  \n   )\n   )\n\n  \n\n    union   all    SELECT 'Fracionado', * FROM busca_cardapio( ( SELECT string_agg(num, ', ')\n \n  FROM ( select  distinct c.numero::text AS num\n \n        FROM item_pedido_temp AS i2\n        LEFT JOIN cardapio AS c\n          ON c.categoria in( 'pizza', 'item','borda')\n         AND c.nome ILIKE '%' || TRIM(i2.nome) || '%'\n        WHERE i2.status = 'opcoes'\n          AND i2.user_id = {{ $('DadoPedido').item.json.user_id }}\n          AND i2.pedido_id =  {{ $('DadoPedido').item.json.pedido_id }}\n          AND i2.numero = 0 and\n          c.categoria  = i2.categoria and i2.fracionada = true  )  \n   )\n   )\n\n\n    union   all    SELECT 'Fracionado', * FROM busca_cardapio( ( SELECT string_agg(num, ', ')\n \n  FROM ( select  distinct c.numero::text AS num\n \n        FROM item_pedido_temp AS i2\n        LEFT JOIN cardapio AS c\n          ON c.categoria in( 'pizza', 'item','borda')\n         AND c.nome ILIKE '%' || TRIM(i2.nome_fracao) || '%'\n        WHERE i2.status = 'opcoes'\n          AND i2.user_id =  {{ $('DadoPedido').item.json.user_id }}  \n          AND i2.pedido_id =    {{ $('DadoPedido').item.json.pedido_id }}\n          AND i2.numero_fracao = 0 and\n          c.categoria  = i2.categoria and i2.fracionada = true  )  \n   )\n   )","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2064,-1792],"id":"6a4b54f9-02ac-4076-9fbd-c51cea1a1f8d","name":"GetNEncontradoFxl","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"\nselect numero, tamanho, fracionada, categoria, nome,  \n(case when categoria <> 'bebida' then '' else volume end)  , status, valor  from item_pedido_temp where status not in ('opcoes', 'concluido')\nand user_id =    {{ $('DadoPedido').item.json.user_id }} \nand pedido_id =  {{ $('DadoPedido').item.json.pedido_id }}","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1104,-1776],"id":"784770ff-1d07-4964-8ad8-145716e974d3","name":"GetNãoEncontrado","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"resource":"messages-api","instanceName":"=delivery","remoteJid":"= {{$('Dados Lead').first().json.IdConversa}}","messageText":"=```{{ $json.message.content }}```","options_message":{"delay":4}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[4016,-672],"id":"d942bd11-aad4-4a6e-aba8-6544cb118f2a","name":"MenuCardapio","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{"operation":"executeQuery","query":"\nselect numero, tamanho, fracionada, categoria, nome,  \n(case when categoria <> 'bebida' then '' else volume end)  , status, valor  from item_pedido_temp where status  ='rejeitado'\nand user_id =    {{ $('DadoPedido').item.json.user_id }} \nand pedido_id =  {{ $('DadoPedido').item.json.pedido_id }}","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[4352,-416],"id":"a924e254-623b-401d-a3b7-3c07de02ad05","name":"GetProblemas","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"       select count(*) opções ,  o.item_id , comando_original  , categoria   , fracionada, valor \n   from item_opcoes  o    \n   join  item_pedido_temp i \n   on  o.item_id = i.item_id  where\n            i.user_id =   {{ $('DadoPedido').item.json.user_id }}\n          AND i.pedido_id =    {{ $('DadoPedido').item.json.pedido_id }}\n    group by o.item_id ,   comando_original  , fracionada , categoria  , valor \n\n\n ","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[4896,-480],"id":"75ed7fd2-e03e-46bc-a36e-7015dd00fbbc","name":"GetOpcoes","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"  select calcula_pre_pedido({{ $('DadoPedido').item.json.user_id }}, {{ $('DadoPedido').item.json.pedido_id }}  );","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[3824,-416],"id":"11117d42-0441-4708-b771-ddacf0ea0356","name":"GetCarrinho","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":" \n\nUPDATE item_pedido_temp AS ib\nSET id_pizza_pai = ip.item_id\nFROM item_pedido_temp AS ip\nWHERE ib.pizza_referencia IS NOT NULL\n  AND LENGTH(TRIM(ib.pizza_referencia)) > 1\n  AND ib.status = 'inicio'\n  AND ib.categoria IN ('item','borda')\n  AND ip.pizza_referencia IS NOT NULL\n  AND LENGTH(TRIM(ip.pizza_referencia)) > 1\n  AND ip.status = 'inicio'\n  AND ip.categoria = 'pizza'\n  AND ib.user_id = ip.user_id\n  AND ib.pedido_id = ip.pedido_id\n  AND ib.user_id =  {{ $('DadoPedido').item.json.user_id }} \n  AND ib.pedido_id =  {{ $('DadoPedido').item.json.pedido_id }}\n  AND ib.pizza_referencia = ip.pizza_referencia;\n\n ","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2192,-672],"id":"623d8730-7d3e-4b28-b8f2-47db6bc22d80","name":"VinculaBordaItemPizza","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"promptType":"define","text":"={{ $('MensagemTraduzida').item.json.message }}","options":{"systemMessage":"= # Persona\nVocê é um atendente de pizzaria responsável por fechar pedidos de forma organizada e simpática.  \nSeu papel é colher os dados finais (endereço, bairro, forma de pagamento e comentário), salvar cada um deles usando as ferramentas disponíveis e, somente quando tudo estiver confirmado, executar o fechamento do pedido.\n\n# Regras de Atendimento\n1. Ordem obrigatória de coleta:\n\n   - Primeiramente: Mostrar o carrinho atual usando GetCarrinho1( ) e perguntar se o cliente confirma o fechamento do pedido.   \n     - Se o cliente disser \"sim\", prossiga para os próximos passos Fechamento().   \n     - Se o cliente disser \"não\", conitunua antendendo.\n\n   - Depois: Endereço completo (rua + número) e Bairro → use SalvaEndereco(user_id, pedido_id, endereco, bairro).\n   - Depois: Forma de pagamento → use SalvaFormaPagto(user_id, pedido_id, forma_pagto).\n   - Depois: Comentário ou observações → use Comentario(user_id, pedido_id, comentario).\n   - Por último: Execute PosFechamento(user_id, pedido_id).\n2. Sempre valide se o cliente forneceu a informação correta.  \n   - Se faltar algo (ex: o cliente manda só a rua sem bairro), peça novamente de forma clara e curta.\n3. Somente quando endereço, bairro, forma de pagamento e comentário tiverem sido salvos com sucesso, execute PosFechamento().\n4. Se alguma tool retornar erro, informe o cliente e peça o dado novamente.\n5. Nunca finalize o pedido sem executar PosFechamento().\n6. Nunca invente dados; sempre utilize o que o cliente informou.\n7. Use uma linguagem simpática e objetiva.\n\n \n \n \n\n- Nunca pergunte ao cliente o user_id ou pedido_id.\n- Esses dados já são fornecidos automaticamente pelo fluxo e você deve usá-los diretamente ao chamar as tools.\n\n\n# Tools disponíveis\n- GetCarrinho1( )\n- SalvaEndereco  endereco, bairro)\n- SalvaFormaPagto(  forma_pagto)\n- Comentario(  comentario)\n- PosFechamento  pedido_id)\n-VoltaPedido( ) \n\n# Fluxo esperado\n1. Mostrar carrinho → chamar GetCarrinho() → perguntar se o cliente confirma.\n   - Se sim → seguir para próximo passo.\n   - Se não → encerrar sem fechar pedido.\n2. Perguntar endereço e bairro → chamar SalvaEndereco().\n3. Perguntar forma de pagamento → chamar SalvaFormaPagto().\n4. Perguntar se há comentário ou observação extra → chamar Comentario().\n5. Confirmar que tudo foi salvo com sucesso.\n6. Executar PosFechamento() e avisar o cliente que o pedido foi finalizado com sucesso 🎉.\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[-752,-1648],"id":"ad59e662-f3b3-4946-b211-c4d37f4bf9b1","name":"AI Agent"},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{"temperature":0.1}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-864,-1424],"id":"0f56742b-affa-497c-bde4-75bf60479a63","name":"OpenAI Chat Model2","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"43534543534","contextWindowLength":3},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[-752,-1456],"id":"f5e05165-597b-4bc3-aa8c-f577775e46a5","name":"Simple Memory1"},{"parameters":{"operation":"update","tableId":"usuario_lacantina","filters":{"conditions":[{"keyName":"user_id","condition":"eq","keyValue":"={{ $('MontPedido').item.json.user_id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"endereço","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues0_Field_Value', `endereço `, 'string') }}"},{"fieldId":"bairro","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues1_Field_Value', `bairro`, 'string') }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[-320,-1440],"id":"5dd9d402-25cd-475b-88a2-bfd4d571b918","name":"SalvaEndereco","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"tableId":"comentario_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $json.user_id }}"},{"fieldId":"pedido_id","fieldValue":"={{ $json.pedido_id }}"},{"fieldId":"comentario","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues2_Field_Value', `Comentario campo`, 'string') }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[-720,-1328],"id":"4466276d-e81b-455b-a0d7-bc04e4bd27c4","name":"Comentario","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"operation":"update","tableId":"pedido_temp","filters":{"conditions":[{"keyName":"user_id","condition":"eq","keyValue":"={{ $('MontPedido').item.json.user_id }}"},{"keyName":"pedido_id","condition":"eq","keyValue":"= {{ $('MontPedido').item.json.pedido_id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"tipo_cobranca","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues0_Field_Value', `forma_pagamento`, 'string') }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[-528,-1360],"id":"c654bfb2-2b66-4255-8f5a-0a0c547d7d3f","name":"SalvaFormaPagto","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"descriptionType":"manual","toolDescription":"Execute a SQL query in Postgres fechamento ","operation":"executeQuery","query":"SELECT * from finalizar_pedido(    {{ $('MontPedido').item.json.user_id }} , {{ $('MontPedido').item.json.pedido_id }} ;) ;","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[-432,-1296],"id":"527da8aa-05f5-43a7-bcf0-344fdaf6d5ba","name":"Fechamento","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"resource":"messages-api","instanceName":"=delivery","remoteJid":"={{ $('Dados Lead').item.json.IdConversa }}","messageText":"=```{{ $json.output }}```","options_message":{"delay":4}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[-352,-1648],"id":"eb621430-0a3a-4261-ae41-1c9ebf61d4d2","name":"MenuCardapio1","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{"operation":"executeQuery","query":"  select calcula_pre_pedido(   {{ $('MontPedido').item.json.user_id }} , {{ $('MontPedido').item.json.pedido_id }}) ;","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[-608,-1264],"id":"5267879a-d5b7-4e4a-8c7f-a08b6f436970","name":"GetCarrinho1","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"update item_pedido_temp \n  set status = 'enviado'\n  where user_id =   {{ $('MontPedido').item.json.user_id }}  \n  and   pedido_id =    {{ $('MontPedido').item.json.pedido_id }}  and  status = 'fechamento'  ;\n \n  ","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[-272,-1296],"id":"0670b9ba-bc75-48f9-9e7b-f3e940fd84f0","name":"Execute a SQL query in Postgres","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"assignments":{"assignments":[{"id":"66a91f66-e755-4120-b22f-44c814f56162","name":"message","value":"={{ $json.mensagem }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2512,-768],"id":"03833dad-39dc-4ec9-8164-85890b68dea4","name":"MensagemTraduzida","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"workflowInputs":{"values":[{"name":"mensagem"},{"name":"user_id","type":"number"},{"name":"pedido_id","type":"number"},{"name":"telefone"},{"name":"rotina","type":"number"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-2768,-768],"id":"cc6d6912-cf38-4e7d-9d5e-f165d4a45897","name":"When Executed by Another Workflow"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ae1def85-0f06-48cc-8ecf-bb1d02fe27f1","leftValue":"={{ $json.rotina }}","rightValue":2,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1664,-752],"id":"8ca574dc-0864-4f80-aef6-ec4448a9dade","name":"If"},{"parameters":{"jsCode":" let input =  $('When Executed by Another Workflow').first().json.mensagem.toLowerCase().trim();\n\n// Remove \" e \" entre itens (só se for separador, não dentro de nomes)\ninput = input.replace(/\\se\\s(?=1\\s)/g, \" \");\n\n// Quebra em tokens sempre que aparecer \"1 \"\nconst tokens = input.split(/\\s(?=1\\s)/g);\n\n// Limpa tokens vazios e monta saída\nconst resultados = tokens\n  .map((t, i) => ({\n    json: {\n      id: i + 1,\n      item: t.trim()\n    }\n  }))\n  .filter(r => r.json.item.length > 0);\n\nreturn resultados;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2784,-272],"id":"31519c88-859f-4092-8c22-20ef85ec7b1f","name":"Code1"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-2608,-272],"id":"29b8f017-c70c-4258-8a49-91a837a493a6","name":"Loop Over Items","executeOnce":false},{"parameters":{},"type":"n8n-nodes-base.noOp","name":"Replace Me","typeVersion":1,"position":[2512,224],"id":"4719add5-4ab4-48e0-bd51-5888ce8ce2eb"},{"parameters":{"promptType":"define","text":"Você é um assistente pos venda de pizzaria a La Cantinha. Seggue pedido do usuario    {{ $('MensagemTraduzida').item.json.message }}","options":{"systemMessage":"=# Persona\nVocê é um atendente de pizzaria responsável por revisar pedidos antes da finalização.  \nSeu papel é **mostrar o carrinho consolidado**, **guiar o cliente na escolha de opções** quando houver mais de uma, e **avisar se houve itens rejeitados ou não encontrados**.  \nVocê nunca deve inventar itens ou preços.\n\n# Regras de Atendimento\n1. Use sempre os valores de `user_id` e `pedido_id` já fornecidos pelo fluxo.  \n   Nunca pergunte esses dados ao cliente.  \n2. Sempre chame **exatamente uma vez** na ordem:  \n   - Primeiro: GetCarrinho()  \n   - Depois: GetOpcoes()  \n   - Depois: GetProblemas()  \n3. Nunca repita a mesma tool mais de uma vez na mesma resposta.  \n4. Depois de executar as tools necessárias, finalize a resposta.  \n5. Mostre os resultados em etapas claras:  \n   - Primeiro carrinho ✅  \n   - Depois opções ✅  \n   - Depois problemas ⚠️  \n6. Sempre finalize a resposta com um fechamento simpático, ex:  \n   - “Esses são os detalhes do seu pedido até agora. Deseja continuar ou finalizar?”\n\n# Tools disponíveis\n- GetCarrinho()\n- GetOpcoes()\n- GetProblemas()\n\nSempre siga esta sequência:\n1. Mostrar resultado de GetCarrinho ✅\n2. Mostrar resultado de GetOpcoes ✅\n3. Se houver problemas, mostrar aviso ⚠️\n4. Encerrar.\n\nNunca omita ou reordene etapas. Sempre mostre GetCarrinho → GetOpcoes → GetProblemas (quando houver).\n\n⚠️ Nunca invente, nunca opine, nunca sugira, nunca dê exemplos adicionais. Apenas mostre os dados das tools.\n\n\n# Restrições\n- Nunca invente dados de cardápio ou preços.  \n- Nunca pule nenhuma das três etapas.  \n- Nunca repita tool em loop.  \n- Nunca peça user_id ou pedido_id ao cliente.  \n- Sempre use linguagem simpática, clara e objetiva.  \n- Encerre a resposta após usar as três tools necessárias.\n\n# Regras Carrinho\n- Quando usar GetCarrinho, mostre o resultado exatamente como recebido.\n- Nunca agrupe, resuma ou ocultar bordas, itens ou pizzas.\n- Sempre mantenha os números do carrinho.\n-  Não omita nenhum numero do carrinho. è muito importante mostrar o numero da pizza.\nExemplo:\n\n1  (22) Pizzaiolo (media)-pizza                           R$ 36.50\n2  1/2 (45) Confete 1/2 (34) Marguerita (grande)-pizza    R$ 64.00\n3  skol (grande)-bebida                                   R$ 12.00\n4  (12) Salaminho (media)-pizza                           R$ 38.50\n \nNão omita esses numeros (22), (45) vindos do resultado das execução das ferramentas \n\nNão omita nada  a pizza Mussarela (grande)-pizza   é a numero (1)\nEmm resumo não omita nada nem borda nem item nem refrigerante\n\n# Regras Opções \n- Quando usar GetOpcoes, mostre o resultado exatamente como recebido.\n- Se voltar mais de uma linha na função diga , encontramos mais opções no nosso cardápio\nou algo assim. Tente criar uma frase bem curta mas expressiva.\n- Nunca agrupe, resuma ou ocultar bordas, itens ou pizzas.\n- tente identificar na frase  {{ $('MensagemTraduzida').item.json.message }}  qual o item que gerou mais de uma opção  . Se na frase tiver frango e as oopções tiver frango com catupiry diga que encontrou mais de uma opção com o item frango .\n- Sempre mantenha os números das pizzas  , muito importante para fazzer uma boa compra.\n-Mostre um exemplo de compra 1 pizza 23 grande onde 23 é uma das pizzas das opções.  \n- Faça sugestão não peça confirmação , Mostre um exemplo . Não esqueça do exemplo. de dois \\n para mostrar o exemplo.  \nLembre-se vc não é a IA que vai receber este comando.\n \n- Nunca sugira itens, bordas, sabores ou variações que não vierem das ferramentas.\n- Nunca invente combinações ou dê palpites. Apenas exiba os dados retornados pelas ferramentas.\n- É proibido comentar ou dar opinião sobre itens já consolidados.\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[1424,-2240],"id":"dcbc6ca6-77b5-4a9a-ac3e-70273f9e0204","name":"Agente Pos Venda","executeOnce":true},{"parameters":{"promptType":"define","text":"Você é um assistente pos venda de pizzaria a La Cantinha. Seggue pedido do usuario    {{ $('MensagemTraduzida').item.json.message }}","options":{"systemMessage":"=# Persona\nVocê é um atendente de pizzaria responsável por revisar pedidos antes da finalização.  \nSeu papel é **mostrar o carrinho consolidado**, **guiar o cliente na escolha de opções** quando houver mais de uma, e **avisar se houve itens rejeitados ou não encontrados**.  \nVocê nunca deve inventar itens ou preços.\n\n# Regras de Atendimento\n1. Use sempre os valores de `user_id` e `pedido_id` já fornecidos pelo fluxo.  \n   Nunca pergunte esses dados ao cliente.  \n2. Sempre chame **exatamente uma vez** na ordem:  \n   - Primeiro: GetCarrinho()  \n   - Depois: GetOpcoes()  \n   - Depois: GetProblemas()  \n3. Nunca repita a mesma tool mais de uma vez na mesma resposta.  \n4. Depois de executar as tools necessárias, finalize a resposta.  \n5. Mostre os resultados em etapas claras:  \n   - Primeiro carrinho ✅  \n   - Depois opções ✅  \n   - Depois problemas ⚠️  \n6. Sempre finalize a resposta com um fechamento simpático, ex:  \n   - “Esses são os detalhes do seu pedido até agora. Deseja continuar ou finalizar?”\n\n# Tools disponíveis\n- GetCarrinho()\n- GetOpcoes()\n- GetProblemas()\n\nSempre siga esta sequência:\n1. Mostrar resultado de GetCarrinho ✅\n2. Mostrar resultado de GetOpcoes ✅\n3. Se houver problemas, mostrar aviso ⚠️\n4. Encerrar.\n\nNunca omita ou reordene etapas. Sempre mostre GetCarrinho → GetOpcoes → GetProblemas (quando houver).\n\n⚠️ Nunca invente, nunca opine, nunca sugira, nunca dê exemplos adicionais. Apenas mostre os dados das tools.\n\n\n# Restrições\n- Nunca invente dados de cardápio ou preços.  \n- Nunca pule nenhuma das três etapas.  \n- Nunca repita tool em loop.  \n- Nunca peça user_id ou pedido_id ao cliente.  \n- Sempre use linguagem simpática, clara e objetiva.  \n- Encerre a resposta após usar as três tools necessárias.\n\n# Regras Carrinho\n- Quando usar GetCarrinho, mostre o resultado exatamente como recebido.\n- Nunca agrupe, resuma ou ocultar bordas, itens ou pizzas.\n- Sempre mantenha os números do carrinho.\n-  Não omita nenhum numero do carrinho. è muito importante mostrar o numero da pizza.\nExemplo:\n\n1  (22) Pizzaiolo (media)-pizza                           R$ 36.50\n2  1/2 (45) Confete 1/2 (34) Marguerita (grande)-pizza    R$ 64.00\n3  skol (grande)-bebida                                   R$ 12.00\n4  (12) Salaminho (media)-pizza                           R$ 38.50\n \nNão omita esses numeros (22), (45) vindos do resultado das execução das ferramentas \n\nNão omita nada  a pizza Mussarela (grande)-pizza   é a numero (1)\nEmm resumo não omita nada nem borda nem item nem refrigerante\n\n# Regras Opções \n- Quando usar GetOpcoes, mostre o resultado exatamente como recebido.\n- Se voltar mais de uma linha na função diga , encontramos mais opções no nosso cardápio\nou algo assim. Tente criar uma frase bem curta mas expressiva.\n- Nunca agrupe, resuma ou ocultar bordas, itens ou pizzas.\n- tente identificar na frase  {{ $('MensagemTraduzida').item.json.message }}  qual o item que gerou mais de uma opção  . Se na frase tiver frango e as oopções tiver frango com catupiry diga que encontrou mais de uma opção com o item frango .\n- Sempre mantenha os números das pizzas  , muito importante para fazzer uma boa compra.\n-Mostre um exemplo de compra 1 pizza 23 grande onde 23 é uma das pizzas das opções.  \n- Faça sugestão não peça confirmação , Mostre um exemplo . Não esqueça do exemplo. de dois \\n para mostrar o exemplo.  \nLembre-se vc não é a IA que vai receber este comando.\n \n- Nunca sugira itens, bordas, sabores ou variações que não vierem das ferramentas.\n- Nunca invente combinações ou dê palpites. Apenas exiba os dados retornados pelas ferramentas.\n- É proibido comentar ou dar opinião sobre itens já consolidados.\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[2096,-256],"id":"8a6a0cd7-b80f-4bea-b9d0-84f6a144c48c","name":"Agente Pos Venda1","executeOnce":true},{"parameters":{"resource":"assistant","assistantId":{"__rl":true,"mode":"list","value":""},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[2480,-256],"id":"137e75d4-4b3e-45d6-89b6-5ee40b713f98","name":"Message a model","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"messages":{"values":[{"content":"=# Persona\nVocê é responsável por mostrar o carrinho do cliente de forma clara e objetiva.\n\n# Regras\n1. Sempre chame GetCarrinho( ).\n2. Mostre os itens numerados, quantidade, descrição e valor.\n3. Finalize com subtotal, entrega e total.\n4. Não invente itens nem preços.\n5. Seja simpático, mas não dê opiniões ou sugestões.\n\n# Regras adicionais\n- Sempre inicie a resposta com exatamente:\n  🛒 Carrinho:\n- Nunca remova ou altere esse cabeçalho. Ele deve aparecer sempre na primeira linha. mostre os dados não altere nada e nem de sugestões. Você so mostra dados. No maximo diga aqui esta o seu carrinho. algo agradável apois exibir os dados. Não mexa nos dados\n\n\n\n# Tool disponível\n- GetCarrinho( )\n","role":"system"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[3696,-672],"id":"07710563-a738-4c6b-b817-dd306235cab4","name":"Carinnho","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"messages":{"values":[{"content":"= # Persona\nVocê informa de forma clara e curta se houve itens rejeitados ou não encontrados.\n\n# Regras\n1. Sempre chame GetRejeitados() mas não mostre para usuario.\n2. Mostre os itens rejeitados numa lista simples.\n3. Nunca invente substituições.\n4. Apenas diga: “Deseja tentar escolher outra coisa para esses itens?”\n \n\n- Nunca remova ou altere esse cabeçalho. Ele deve aparecer sempre na primeira linha. mostre os dados não altere nada e nem de sugestões. Você so mostra dados. \n\n\n \n# Tool disponível\n- GetRejeitados()","role":"system"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[4208,-672],"id":"10d4654e-5a34-4874-9f8f-e9980c232a27","name":"Issue","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"resource":"messages-api","instanceName":"=delivery","remoteJid":"= {{$('Dados Lead').first().json.IdConversa}}","messageText":"=```{{ $json.message.content }}```","options_message":{"delay":4}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[4528,-672],"id":"ebe4104e-7f71-468e-88a3-716a8563a1ac","name":"Issue1","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{"resource":"messages-api","instanceName":"=delivery","remoteJid":"= {{$('Dados Lead').first().json.IdConversa}}","messageText":"=```{{ $json.message.content }}```","options_message":{"delay":4}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[5072,-672],"id":"34a4487d-2877-4838-a8d4-b0b4e25adbf5","name":"Issue3","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"messages":{"values":[{"content":"= # Persona\nVocê ajuda o cliente a escolher quando um item tem múltiplas opções.\n\n# Regras\n1. Sempre chame GetOpcoes ().\n2. Mostre as opções numeradas e inclua sempre:\n   - Número do cardápio (ex: `(23)`)\n   - Nome da pizza\n   - Preços (grande / média, se disponíveis)\n   - Indicação de fracionada: `🍕 Fracionada: Sim` ou `❌ Fracionada: Não`\n3. Cada opção deve ser exibida em **duas ou três linhas**:\n   - Linha 1: número sequencial + número do cardápio + nome + preço.\n    \n   - Linha 2 (se existir campo fracionada): status da fracionada.\n4. Diga ao cliente que: “Vamos lhe ajudar com a montagem. OK?” \n5. Nunca invente opções extras, use apenas o retorno da tool.\n\n# Tool disponível\n- GetOpcoes()\n","role":"system"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[4752,-672],"id":"392376a1-567b-4410-b5dd-454429e4e315","name":"Opcoes","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"httpMethod":"POST","path":"agente","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-2432,-1920],"id":"a5faf8cf-3ff7-4b2e-a69d-820f663b9329","name":"Webhook","webhookId":"66949457-5339-4325-b499-9a15d57ff6a1"},{"parameters":{"assignments":{"assignments":[{"id":"a3c83333-8ce3-4995-8230-b361099aa1e4","name":"user_id","value":"=72","type":"number"},{"id":"d7c14753-505f-48ee-a344-fa565ace43df","name":"pedido_id","value":"=18","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1696,-1920],"id":"4b938162-d19c-4b67-8fcc-5bbbcedad775","name":"MontPedido2"},{"parameters":{"assignments":{"assignments":[{"id":"9f488c5c-0b3b-48e9-87b1-5a22d513d1ec","name":"IdConversa","value":"=5516992975836","type":"string"}]},"options":{}},"id":"807a7a22-5c0f-48b6-95f1-af7c9103f468","name":"Dados Lead1","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1920,-1920],"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"assignments":{"assignments":[{"id":"66a91f66-e755-4120-b22f-44c814f56162","name":"message","value":"={{ $json.body.data.message.conversation }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2160,-1920],"id":"8bed62c6-6564-42a1-ae42-e0bc523413c6","name":"MensagemTraduzida1","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"executeQuery","query":"  select distinct  o.*, descricao, fracionada,comando_original from item_opcoes  o   join  item_pedido_temp i on  o.item_id = i.item_id  where\n            i.user_id = {{ $('MontPedido2').item.json.user_id }}    \n          AND i.pedido_id =  {{ $('MontPedido2').item.json.pedido_id }}    \norder by o.item_id   ","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[-1472,-1744],"id":"c78b7be0-579b-4a2c-bd9a-b10d2381f3d1","name":"GetOpcoes1","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"resource":"messages-api","instanceName":"=delivery","remoteJid":"= {{ $('Dados Lead1').item.json.IdConversa }}","messageText":"=```{{ $json.message.content }}```","options_message":{"delay":4}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[-1104,-1920],"id":"a5155701-51df-4242-a46c-914118a1e42b","name":"MenuCardapio2","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{"operation":"update","tableId":"item_pedido_temp","filters":{"conditions":[{"keyName":"item_id","condition":"eq","keyValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conditions0_Field_Value', ``, 'string') }}"},{"keyName":"user_id","condition":"eq","keyValue":"=  {{ $('MontPedido2').item.json.user_id }}"},{"keyName":"pedido_id","condition":"eq","keyValue":"= {{ $('MontPedido2').item.json.pedido_id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"nome_fracao","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues0_Field_Value', `numero da pizza`, 'string') }}"},{"fieldId":"tamanho","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues1_Field_Value', `tamanho`, 'string') }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[-1216,-1712],"id":"9bab435b-cb21-4f3b-b3fc-664ca0d37e8d","name":"AtualizaItemfracao","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"operation":"update","tableId":"item_pedido_temp","filters":{"conditions":[{"keyName":"item_id","condition":"eq","keyValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conditions0_Field_Value', ``, 'string') }}"},{"keyName":"user_id","condition":"eq","keyValue":"=  {{ $('MontPedido2').item.json.user_id }}"},{"keyName":"pedido_id","condition":"eq","keyValue":"= {{ $('MontPedido2').item.json.pedido_id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"numero","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues0_Field_Value', `numero da pizza`, 'string') }}"},{"fieldId":"tamanho","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues1_Field_Value', `tamanho`, 'string') }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[-1344,-1712],"id":"5bda10f6-328c-4569-b7d5-652aaf58e10e","name":"AtualizaItem","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"operation":"executeQuery","query":"  call popula_item_opcoes( {{ $('DadoPedido').item.json.user_id }}, {{ $('DadoPedido').item.json.pedido_id }}  );","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2416,-672],"id":"de0d183a-8dcd-42c0-b5e8-39a52c8170f4","name":"InsereOpcoesItens","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"messages":{"values":[{"content":"= Persona\n\nVocê é um atendente de pizzaria responsável por ajudar o cliente a resolver itens que ficaram em “opções” no carrinho.\nMostre um item pendente por vez, liste todas as opções desse item e registre a escolha do cliente.\n\nRegras de Atendimento\n\nSempre chame GetOpcoes(user_id, pedido_id) para buscar os itens pendentes.\n\nNunca peça user_id ou pedido_id ao cliente (o fluxo já fornece).\n\nSe não houver itens pendentes → responda apenas:\n✅ Todas as opções foram resolvidas, podemos prosseguir com o fechamento do pedido.\n\nSe houver itens:\n\nTrabalhe somente o primeiro item pendente retornado.\n\nComece mostrando o comando_original do cliente:\n\n📌 Pedido original: \"…\"\n\n\nListe TODAS as opções desse item, numeradas 1…N, no formato:\n\n1️⃣ (23) Calabresa com Catupiry – R$ 57,00\n2️⃣ (31) Frango com Cheddar – R$ 59,00\n…\n\n\nApós a lista, mostre uma vez só:\n\nℹ️ Descrição: (ingredientes do item)\n🍕 Fracionada: Sim/Não\n\n\nFinalize perguntando: “Qual opção você escolhe?”\n\nQuando o cliente responder:\n\nInterprete apenas números 1…N.\n\nConverta o número escolhido para o código do cardápio (campo numero) da opção correspondente.\n\nChame AtualizaItem(item_id, numero, tamanho):\n\nitem_id: do item pendente atual (ou do registro da opção).\n\nnumero: código do cardápio da opção escolhida.\n\ntamanho: se o item exigir e não estiver definido, pergunte “grande ou média?” e só então chame a tool.\n\nDepois de atualizar, chame GetOpcoes novamente:\n\nSe ainda houver itens pendentes → repita o passo 3 para o próximo item.\n\nSe não houver → envie a mensagem do passo 2.\n\nValidação de entrada: se o cliente responder algo fora de 1…N, diga\n“Não entendi. Por favor, responda com um número de 1 a N.” e reexiba a mesma lista.\n\nNunca invente opções, preços ou códigos. Use somente o retorno das tools.\n\nMantenha a resposta objetiva: lista → detalhes (uma vez) → pergunta. Sem textos adicionais.\n\nTools disponíveis\n\nGetOpcoes(user_id, pedido_id)\n(retorna itens pendentes, incluindo item_id, comando_original e a lista de opções com numero, nome, preços, descrição, fracionada)\n\nAtualizaItem(item_id, numero, tamanho)\n\nOrdem obrigatória\n\nGetOpcoes → (listar todas as opções do primeiro item) → receber número → (se preciso, pedir tamanho) → AtualizaItem → GetOpcoes → repetir / encerrar.","role":"system"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-1456,-1920],"id":"16b47ecc-3038-43d7-a676-61b466231438","name":"Montagem","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}}],"connections":{"When chat message received":{"main":[[]]},"Execute a SQL query1":{"main":[[]]},"RejeitaItem":{"main":[[{"node":"ConcluiTudo","type":"main","index":0}]]},"Bebidas":{"main":[[{"node":"Itembebida","type":"main","index":0}]]},"Pizzas Fracionada":{"main":[[{"node":"ItemFracionado","type":"main","index":0}]]},"Pizzas Inteira":{"main":[[{"node":"ItemInteira","type":"main","index":0}]]},"Esfirra":{"main":[[{"node":"ItemEsfirra","type":"main","index":0}]]},"Itembebida":{"main":[[{"node":"Merge1","type":"main","index":0}]]},"ItemFracionado":{"main":[[{"node":"Merge1","type":"main","index":1}]]},"ItemInteira":{"main":[[{"node":"Merge1","type":"main","index":2}]]},"ItemEsfirra":{"main":[[{"node":"Merge1","type":"main","index":3}]]},"Auto-fixing Output Parser":{"ai_outputParser":[[{"node":"Basic LLM Chain","type":"ai_outputParser","index":0}]]},"OrdenaPedido":{"main":[[{"node":"Carinnho","type":"main","index":0}]]},"ConcluiTudo":{"main":[[{"node":"OrdenaPedido","type":"main","index":0}]]},"Bordas":{"main":[[{"node":"Item5","type":"main","index":0}]]},"Merge1":{"main":[[{"node":"DadoPedido","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"Auto-fixing Output Parser","type":"ai_languageModel","index":0},{"node":"Basic LLM Chain","type":"ai_languageModel","index":0}]]},"Structured Output Parser [Schema]":{"ai_outputParser":[[{"node":"Auto-fixing Output Parser","type":"ai_outputParser","index":0}]]},"Basic LLM Chain":{"main":[[{"node":"Bebidas","type":"main","index":0},{"node":"Pizzas Fracionada","type":"main","index":0},{"node":"Pizzas Inteira","type":"main","index":0},{"node":"Esfirra","type":"main","index":0},{"node":"item4","type":"main","index":0},{"node":"Bordas","type":"main","index":0}]]},"item4":{"main":[[{"node":"Item4","type":"main","index":0}]]},"Item4":{"main":[[{"node":"Merge1","type":"main","index":4}]]},"AtualizaValorPizzaFracionada2":{"main":[[{"node":"RejeitaItem","type":"main","index":0}]]},"AtualizaValorItem2":{"main":[[{"node":"AtualizaValorPizzaFracionada2","type":"main","index":0}]]},"Item5":{"main":[[{"node":"Merge1","type":"main","index":5}]]},"MontPedido":{"main":[[{"node":"If","type":"main","index":0}]]},"DadoPedido":{"main":[[{"node":"ValidaItemNome","type":"main","index":0}]]},"ValidaItemNome":{"main":[[{"node":"VinculaBordaItemPizza","type":"main","index":0}]]},"Code5":{"main":[[{"node":"MenuCardapio10","type":"main","index":0}]]},"MenuCardapio10":{"main":[[{"node":"GetNEncontradoFxl","type":"main","index":0}]]},"Code":{"main":[[]]},"VariasPizzas1":{"main":[[{"node":"Code13","type":"main","index":0}]]},"Code13":{"main":[[{"node":"MenuCardapio40","type":"main","index":0}]]},"Dados Lead":{"main":[[{"node":"MontPedido","type":"main","index":0}]]},"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"Agente Pos Venda","type":"ai_languageModel","index":0}]]},"Simple Memory":{"ai_memory":[[{"node":"Agente Pos Venda","type":"ai_memory","index":0}]]},"GetCarrinhoFlx":{"main":[[{"node":"Code5","type":"main","index":0}]]},"GetNEncontradoFxl":{"main":[[{"node":"VariasPizzas1","type":"main","index":0}]]},"GetNãoEncontrado":{"main":[[{"node":"GetCarrinhoFlx","type":"main","index":0}]]},"GetProblemas":{"ai_tool":[[{"node":"Issue","type":"ai_tool","index":0}]]},"GetOpcoes":{"ai_tool":[[{"node":"Opcoes","type":"ai_tool","index":0}]]},"GetCarrinho":{"ai_tool":[[{"node":"Carinnho","type":"ai_tool","index":0}]]},"VinculaBordaItemPizza":{"main":[[{"node":"InsereOpcoesItens","type":"main","index":0}]]},"OpenAI Chat Model2":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Simple Memory1":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"SalvaEndereco":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Comentario":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"SalvaFormaPagto":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Fechamento":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"AI Agent":{"main":[[{"node":"MenuCardapio1","type":"main","index":0}]]},"GetCarrinho1":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Execute a SQL query in Postgres":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"MensagemTraduzida":{"main":[[{"node":"Dados Lead","type":"main","index":0}]]},"When Executed by Another Workflow":{"main":[[{"node":"MensagemTraduzida","type":"main","index":0}]]},"If":{"main":[[{"node":"AI Agent","type":"main","index":0}],[{"node":"Basic LLM Chain","type":"main","index":0}]]},"Code1":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[]]},"Replace Me":{"main":[[]]},"Agente Pos Venda":{"main":[[]]},"Agente Pos Venda1":{"main":[[]]},"Message a model":{"main":[[]]},"Carinnho":{"main":[[{"node":"MenuCardapio","type":"main","index":0}]]},"MenuCardapio":{"main":[[{"node":"Issue","type":"main","index":0}]]},"Issue":{"main":[[{"node":"Issue1","type":"main","index":0}]]},"Issue1":{"main":[[{"node":"Opcoes","type":"main","index":0}]]},"Opcoes":{"main":[[{"node":"Issue3","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"MensagemTraduzida1","type":"main","index":0}]]},"Dados Lead1":{"main":[[{"node":"MontPedido2","type":"main","index":0}]]},"MensagemTraduzida1":{"main":[[{"node":"Dados Lead1","type":"main","index":0}]]},"MontPedido2":{"main":[[{"node":"Montagem","type":"main","index":0}]]},"GetOpcoes1":{"ai_tool":[[{"node":"Montagem","type":"ai_tool","index":0}]]},"AtualizaItemfracao":{"ai_tool":[[{"node":"Montagem","type":"ai_tool","index":0}]]},"AtualizaItem":{"ai_tool":[[{"node":"Montagem","type":"ai_tool","index":0}]]},"InsereOpcoesItens":{"main":[[{"node":"AtualizaValorItem2","type":"main","index":0}]]},"Montagem":{"main":[[{"node":"MenuCardapio2","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"When Executed by Another Workflow":[{"json":{"mensagem":"1 pizza 1/2 calabresa meia frango 1 pizza 23 media 1 pizza 11 grande 1 coca cola 2l e 1 cerveja sckol lata 2 coca cola grande, 1 pizza baiana grande 1 bacon grande com borda catupiry","user_id":72,"pedido_id":18,"telefone":"5516992975836","rotina":1}}],"Webhook":[{"json":{"headers":{"host":"n8n.lglducci.com.br","user-agent":"axios/1.7.7","content-length":"1035","accept-encoding":"gzip, br","cdn-loop":"cloudflare; loops=1","cf-connecting-ip":"159.69.117.195","cf-ipcountry":"DE","cf-ray":"9822ec862e76d262-FRA","cf-visitor":"{\"scheme\":\"https\"}","content-type":"application/json","x-forwarded-for":"172.71.164.229","x-forwarded-host":"n8n.lglducci.com.br","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"traefik_traefik.1","x-real-ip":"172.71.164.229"},"params":{},"query":{},"body":{"event":"messages.upsert","instance":"delivery","data":{"key":{"remoteJid":"5516992975836@s.whatsapp.net","fromMe":false,"id":"3EB05A18532EDAB0F17091"},"pushName":"Luis Gustavo Landucci","message":{"conversation":"ok","messageContextInfo":{"deviceListMetadata":{"senderKeyHash":"qsa2uhWhGgSvcA==","senderTimestamp":"1757369973","senderAccountType":"E2EE","receiverAccountType":"E2EE","recipientKeyHash":"tPXKkPhX8YIDCg==","recipientTimestamp":"1757207594"},"deviceListMetadataVersion":2,"messageSecret":"lLhnXYoxZ/6fSntpNe1zpgiuSCDimCm9+MvueDRCM2s="}},"messageType":"conversation","messageTimestamp":1758388096,"instanceId":"4dd4c0e0-99c0-4837-ad50-a467024f723a","source":"web"},"destination":"https://n8n.lglducci.com.br/webhook-test/agente","date_time":"2025-09-20T14:08:16.934Z","sender":"5516991216319@s.whatsapp.net","server_url":"https://evolution.lglducci.com.br","apikey":"61E902EA720B-492E-9768-BE78CE95B224"},"webhookUrl":"https://webhook.lglducci.com.br/webhook-test/agente","executionMode":"test"}}]},"versionId":"c18aaba1-6cd7-4423-acd5-a97e6b8f3019","triggerCount":2,"shared":[{"createdAt":"2025-09-18T15:44:58.320Z","updatedAt":"2025-09-18T15:44:58.320Z","role":"workflow:owner","workflowId":"gL1FbKkYm9zGfCAA","projectId":"wFRMrac2003Pl1x6"}],"tags":[]}