 CREATE OR REPLACE FUNCTION adianta_etapa(
  p_user_id INT,
  p_id_empresa INT
)
RETURNS text
LANGUAGE plpgsql
AS $$
DECLARE
  v_count INT;
  v_turno RECORD;
BEGIN
  -- Conta quantas op√ß√µes existem pro usu√°rio
  SELECT COUNT(*) INTO v_count
  FROM turno_opcoes
  WHERE user_id = p_user_id
    AND id_empresa = p_id_empresa;

  -- Se h√° v√°rias op√ß√µes, etapa √© pedir_posicao
  IF v_count > 1 THEN
    UPDATE turno_opcoes
       SET etapa = 'pedir_posicao'
     WHERE user_id = p_user_id
       AND id_empresa = p_id_empresa;
    RETURN  ' Qual OP√á√ÉO da lista voc√™ quer (1-> N)?';
  END IF;

  -- Se n√£o h√° nenhuma, n√£o faz nada
  IF v_count = 0 THEN
    RETURN ' ';
  END IF;


IF v_count = 1 THEN
  -- Marca a √∫nica op√ß√£o como escolhida e captura campos √∫teis
  UPDATE turno_opcoes
     SET escolhido = true
   WHERE user_id    = p_user_id
     AND id_empresa = p_id_empresa;
    RETURN '‚úÖ Pizza pronta para grava√ß√£o! Deseja adicionar ao seu carrinho? üõí';
  END IF;


  -- Busca a √∫nica linha
  SELECT *
  INTO v_turno
  FROM turno_opcoes
  WHERE user_id = p_user_id
    AND id_empresa = p_id_empresa
  LIMIT 1;

  -- Se j√° tem quantidade e tamanho ‚Üí etapa pronta
  IF v_turno.quantidade IS NOT NULL
     AND v_turno.tamanho IS NOT NULL THEN
     UPDATE turno_opcoes
        SET etapa = 'ready'
      WHERE   user_id = p_user_id
    AND id_empresa = p_id_empresa;
     RETURN;
  END IF;

  -- Se falta tamanho mas tem quantidade
  IF v_turno.quantidade IS NOT NULL
     AND v_turno.tamanho IS NULL THEN
     UPDATE turno_opcoes
        SET etapa = 'pedir_tamanho'
      WHERE  user_id = p_user_id
    AND id_empresa = p_id_empresa;
     RETURN;
  END IF;

  -- Se falta quantidade
  IF v_turno.quantidade IS NULL THEN
     UPDATE turno_opcoes
        SET etapa = 'pedir_qtd'
      WHERE  user_id = p_user_id
    AND id_empresa = p_id_empresa;
     RETURN;
  END IF;

END;
$$;
