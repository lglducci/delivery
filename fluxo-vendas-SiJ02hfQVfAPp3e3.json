{"createdAt":"2025-09-17T13:36:13.881Z","updatedAt":"2025-10-29T00:03:32.828Z","id":"SiJ02hfQVfAPp3e3","name":"Fluxo Vendas","active":false,"isArchived":false,"nodes":[{"parameters":{},"id":"7a9247fa-e5ca-4aa8-a26b-c2be6a58b135","name":"No Operation, do nothing","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-19680,-1456]},{"parameters":{"assignments":{"assignments":[{"id":"69f6217f-9063-423f-abf4-e94f6b70f94e","name":"ClienteNome","value":"={{ $json.body.data.pushName }}","type":"string"},{"id":"9f488c5c-0b3b-48e9-87b1-5a22d513d1ec","name":"ClienteTelefone","value":"={{ $json.body.data.key.remoteJid.replace('@s.whatsapp.net','') }}","type":"string"},{"id":"1ae1a51c-00cb-47f9-8dc8-5a05c66fc0c8","name":"Mensagem","value":"={{ $json.body.data.message.conversation }}","type":"string"}]},"includeOtherFields":"=","options":{}},"id":"d548f41e-4aa0-4abf-bf44-4e98bdee0216","name":"Simplificação de Dados","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-27648,-3264]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"24aa4532-80db-4c1e-977a-0036b82a8e5f","leftValue":"={{ $json.body.isEdit }}","rightValue":"false","operator":{"type":"boolean","operation":"false","singleValue":true}},{"id":"204f54b0-e3ed-4ff4-8302-8c20d3b8aa78","leftValue":"={{ $json.body.isGroup }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}},{"id":"130cc493-a17a-4cc1-955b-816799583076","leftValue":"={{ $json.body.isNewsletter }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}},{"id":"c51986d9-f347-4198-89bb-9e4cd0f021c9","leftValue":"={{ $json.body.broadcast }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}},{"id":"cc7281fe-f597-43d4-820e-241f0f4c0410","leftValue":"={{ $json.body.fromApi }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"id":"ba8ecd86-f370-4297-a5fc-53783c556e05","name":"Filtro Inicial","type":"n8n-nodes-base.filter","typeVersion":2.1,"position":[-27840,-3264]},{"parameters":{"operation":"get","tableId":"usuario_lacantina","filters":{"conditions":[{"keyName":"telefone","keyValue":"={{$json.ClienteTelefone}}"}]}},"id":"e4c2d6b4-e055-4143-8130-6917f287998f","name":"Buscar Cliente","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-27424,-3264],"alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"3419c30f-4400-401b-bf40-db1579507f96","leftValue":"={{ $json.user_id }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"ceafb22a-eb5e-43dd-abcd-1de86db1fc5a","name":"Cliente Existe?","type":"n8n-nodes-base.if","typeVersion":2.1,"position":[-27200,-3264],"alwaysOutputData":false},{"parameters":{"tableId":"usuario_lacantina","fieldsUi":{"fieldValues":[{"fieldId":"nome","fieldValue":"={{ $('Simplificação de Dados').item.json.ClienteNome }}"},{"fieldId":"telefone","fieldValue":"={{ $('Simplificação de Dados').item.json.ClienteTelefone }}"},{"fieldId":"thread_id","fieldValue":"={{ $json.id }}"}]}},"id":"bcd2ee02-936a-4d57-b5b7-b57bae0cc90f","name":"Criar Cliente","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-26784,-3200],"credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"method":"POST","url":"https://api.z-api.io/instances/3CCB76D5C423A0191FA39E692ED0BBB5/token/2FEBF455B542CA12B231414C/send-text","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"bodyParameters":{"parameters":[{"name":"phone","value":"={{ $('Simplificação de Dados').item.json.ClienteTelefone }}"},{"name":"message","value":"={{ $json.data[0].content[0].text.value }}"}]},"options":{}},"id":"a769fa07-5cdb-4f4a-8b70-eaaa63c894e9","name":"(Z-API) Enviar Mensagem","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-14480,-3888],"credentials":{"httpHeaderAuth":{"id":"YFnA9v8RManId8pD","name":"Header Auth account"}}},{"parameters":{},"id":"9e038b70-3f4b-4b03-9dcd-e3b8bf1a57fe","name":"Merge","type":"n8n-nodes-base.merge","typeVersion":3,"position":[-26560,-3264]},{"parameters":{"method":"POST","url":"https://api.openai.com/v1/threads","authentication":"predefinedCredentialType","nodeCredentialType":"openAiApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"OpenAI-Beta","value":"assistants=v2"}]},"options":{}},"id":"ea181019-3828-4576-a12e-9c238aba3dca","name":"[OpenAI] Criar Thread","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-26944,-3200],"credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"method":"POST","url":"=https://api.openai.com/v1/threads/{{ $json.thread_id }}/runs","authentication":"predefinedCredentialType","nodeCredentialType":"openAiApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"OpenAI-Beta","value":"assistants=v2"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"assistant_id","value":"asst_Nl6qely1IPELJLannr7R6VNk"}]},"options":{}},"id":"f8be5077-f457-4fec-8331-9147e2476938","name":"[OpenAI] Criar Run","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-21296,-1472],"credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"errorMessage":"Algum erro na execução na Run"},"id":"83378847-8c8e-4957-8fc9-a4e2941d8bf8","name":"Stop and Error","type":"n8n-nodes-base.stopAndError","typeVersion":1,"position":[-20352,-1216]},{"parameters":{"amount":3},"id":"255eea6e-1c37-4255-b203-3da2fdc803e1","name":"Espera 3 seg","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-21056,-1456],"webhookId":"34bdfd2e-07e9-4436-95cb-87d8a1893014"},{"parameters":{"url":"=https://api.openai.com/v1/threads/{{ $('Merge4').item.json.thread_id }}/runs","authentication":"predefinedCredentialType","nodeCredentialType":"openAiApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"OpenAI-Beta","value":"assistants=v2"}]},"options":{}},"id":"a5031d20-37ae-4398-a2db-548a71d29e47","name":"[OpenAI] Listar Runs","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-21472,-1232],"credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"method":"POST","url":"=https://api.openai.com/v1/threads/{{ $('Merge4').item.json.thread_id }}/messages","authentication":"predefinedCredentialType","nodeCredentialType":"openAiApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"OpenAI-Beta","value":"assistants=v2"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"role","value":"user"},{"name":"content","value":"={{ $('MensagemTraduzida').item.json.message }}"}]},"options":{}},"id":"97841e82-be75-4759-8821-e74deb5ef4b5","name":"[OpenAI] Adicionar Mensagem na Thread","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-21504,-1456],"credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}},"onError":"continueErrorOutput"},{"parameters":{"method":"POST","url":"=https://api.openai.com/v1/threads/{{$json.data[0].thread_id }}/runs/{{$json.data[0].id }}/cancel","authentication":"predefinedCredentialType","nodeCredentialType":"openAiApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"OpenAI-Beta","value":"assistants=v2"}]},"options":{}},"id":"1c08daa5-110b-40b8-81ff-6883d75869ce","name":"[OpenAI] Cancelar Run","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-21472,-1040],"credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"fieldToSplitOut":"tool_calls","options":{}},"id":"7373f3df-ca84-47a1-971f-9b2e008412c0","name":"Split Out","type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-20272,-1888]},{"parameters":{"assignments":{"assignments":[{"id":"28ce9dad-36a0-4015-9072-a74e35bcd33a","name":"name","value":"={{ $json.function.name }}","type":"string"},{"id":"0156c707-54c3-4bc8-a404-5810683ddc2f","name":"arguments","value":"={{ $json.function.arguments }}","type":"string"},{"id":"15947de1-0f0f-4968-a40c-7e36a540ea6d","name":"type","value":"={{ $json.type }}","type":"string"},{"id":"00f6f57f-7f82-4193-afd8-ded4c5824cad","name":"id","value":"={{ $json.id }}","type":"string"}]},"options":{}},"id":"3c6a2c94-9fe3-4260-acb5-003ba5bdc1fd","name":"Dados individuais das tools","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-20048,-1888]},{"parameters":{"assignments":{"assignments":[{"id":"44673af0-d1a2-46a4-aa4a-42df4a6270a4","name":"arguments","value":"={{ $json.arguments }}","type":"object"}]},"includeOtherFields":true,"options":{}},"id":"98fade96-0cbe-4d04-bb89-4bc4f39f1fe9","name":"Argumentos da Tools","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-19520,-1872]},{"parameters":{"assignments":{"assignments":[{"id":"83ad07d2-6655-4675-8ea6-8d4bd6296f5c","name":"thread_id","value":"={{ $json.thread_id }}","type":"string"},{"id":"b00c6dba-371d-4aa2-900f-a108f112cace","name":"run_id","value":"={{ $json.id }}","type":"string"},{"id":"1aa088be-5f08-48aa-a30d-27ce153fae36","name":"tool_calls","value":"={{ $json.required_action.submit_tool_outputs.tool_calls }}","type":"array"}]},"options":{}},"id":"de012881-baf0-4a3d-9444-50f0dedaf703","name":"Parâmentros das Tools","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-20528,-1888],"executeOnce":false},{"parameters":{"url":"=https://api.openai.com/v1/threads/{{ $json.thread_id }}/runs/{{ $json.id }}","authentication":"predefinedCredentialType","nodeCredentialType":"openAiApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"OpenAI-Beta","value":"assistants=v2"}]},"options":{}},"id":"c3b6f3a0-f3bd-4872-adb7-d0feda617d94","name":"[OpenAI] Buscar Status da Run","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-20864,-1456],"credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"aggregate":"aggregateAllItemData","destinationFieldName":"tool_outputs","options":{}},"id":"2e4e9042-232f-4d8f-8c99-26f0bf500b44","name":"Aggregate","type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-19664,-2256]},{"parameters":{"assignments":{"assignments":[{"id":"411123bf-7975-4d79-a766-351a605f414c","name":"tool_outputs","value":"={{ $json.tool_outputs }}","type":"string"}]},"options":{}},"id":"c0103bf0-8dce-46cd-96c1-5158c4b4e716","name":"Edit Fields5","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-19504,-2256]},{"parameters":{"content":"## Gestão de usuários e conversas","height":470.66144701482347,"width":1548.498147684436,"color":4},"id":"3049b775-ffac-48d8-997d-474961156825","name":"Sticky Note","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-27936,-3440]},{"parameters":{"content":"## Loop Funções","height":385,"width":1422,"color":6},"id":"580c4672-f923-4fb2-88ca-ee362fc7df66","name":"Sticky Note3","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-20560,-2016]},{"parameters":{"content":"## Função 1: getPizza","height":489,"width":1210,"color":3},"id":"c6cdcf7b-bcea-4f78-8bc7-80270345379f","name":"Sticky Note4","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-18528,-3856]},{"parameters":{"content":"## Função 3: getUsers","height":668,"width":1189,"color":3},"id":"ea343106-e0ca-4756-a962-2bd886240aa9","name":"Sticky Note5","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-16896,-4736]},{"parameters":{"content":"## Função 2: Add Pizza Carrinho","height":492,"width":1201,"color":4},"id":"683c5325-1b37-4c1c-8110-ba69790fa0f8","name":"Sticky Note6","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-18496,-3264]},{"parameters":{"content":"## Respondendo Função","height":261.7237534100784,"width":589.0475656915123,"color":6},"id":"4040b10b-2519-40e6-8f35-80d7004a9926","name":"Sticky Note7","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-19744,-2304]},{"parameters":{"content":"## Respondendo Usuário","height":297.2479283127495,"width":478.7211802391986,"color":7},"id":"757a6d5f-4d00-4955-8a6d-9820e11a0f28","name":"Sticky Note8","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-20016,-1520]},{"parameters":{"content":"## Gatilhos","height":470.66144701482347,"width":401.92272567732755},"id":"ac7ccbca-68f6-4863-9527-a48187146ba8","name":"Sticky Note10","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-28400,-3440]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"d0132960-a69b-46f0-ab2b-7fe3b67c965d","leftValue":"={{ $json.status }}","rightValue":"requires_action","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"requires_action"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"a8e31c39-770b-47f4-9d72-62ba8cd3ed96","leftValue":"={{ $json.status }}","rightValue":"completed","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"completed"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"9c3456a0-d550-4b1e-9eea-8e620c31b2f2","leftValue":"={{ $json.status }}","rightValue":"in_progress","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"in_progress"}]},"options":{"fallbackOutput":"extra","renameFallbackOutput":"error"}},"id":"cb41d143-e23c-4a75-8b5a-7e58414d8508","name":"Qual o status da Run?","type":"n8n-nodes-base.switch","typeVersion":3.1,"position":[-20640,-1456],"executeOnce":false},{"parameters":{"operation":"getAll","tableId":"cardapio","filters":{"conditions":[{"keyName":"nome","condition":"ilike","keyValue":"={{ $json.arguments.nome }}*"}]}},"id":"939daba1-7a58-4160-8403-91858531e1ce","name":"Buscar Produtos pelo Nome","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-13920,-4272],"alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"fieldsToSummarize":{"values":[{"aggregation":"concatenate","field":"mensagem"}]},"options":{}},"id":"4a014c1a-d015-471a-aca8-04f52a8055ae","name":"Concatenando String","type":"n8n-nodes-base.summarize","typeVersion":1,"position":[-17696,-3760]},{"parameters":{"options":{"reset":"={{ $node['Loop Over Items'].context[\"done\"] }}"}},"id":"7427d6f7-3320-4155-b914-efa6a5f8420c","name":"Loop Over Items","type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-19744,-1888]},{"parameters":{"method":"POST","url":"=https://api.openai.com/v1/threads/{{ $('Parâmentros das Tools').item.json.thread_id }}/runs/{{ $('Parâmentros das Tools').item.json.run_id }}/submit_tool_outputs","authentication":"predefinedCredentialType","nodeCredentialType":"openAiApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"OpenAI-Beta","value":"assistants=v2"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"tool_outputs\": {{ $json.tool_outputs }}\n}","options":{}},"id":"37c1bdd6-a31e-4029-9d08-a5c88e4d9f9a","name":"Responder a Function Calling","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-19344,-2256],"credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"url":"=https://api.openai.com/v1/threads/{{ $('[OpenAI] Buscar Status da Run').first().item.json.thread_id }}/messages\n","authentication":"predefinedCredentialType","nodeCredentialType":"openAiApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"OpenAI-Beta","value":"assistants=v2"}]},"options":{}},"id":"e6f5d6ba-346a-4a42-ab39-196cc6ab298a","name":"[OpenAI] Listar Mensagens Thread","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-20336,-1472],"credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{},"id":"8c178813-72a2-4e15-b1fc-f619109c04c1","name":"Merge1","type":"n8n-nodes-base.merge","typeVersion":3,"position":[-13728,-4192]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json.name }}","rightValue":"getPizza","operator":{"type":"string","operation":"equals"},"id":"560a861b-de35-401a-ab78-5e656593d23c"}],"combinator":"and"},"renameOutput":true,"outputKey":"getPizza"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"936ba126-e0c3-4d74-bb33-ed509e691e03","leftValue":"={{ $json.name }}","rightValue":"posGravaItem","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"posGravaItem"}]},"options":{}},"id":"58db7134-2d9c-4fb4-88b9-00c6a4ca77f4","name":"Switch","type":"n8n-nodes-base.switch","typeVersion":3.1,"position":[-19312,-2000],"executeOnce":false},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $('Argumentos da Tools').item.json.arguments.nome }}","rightValue":"=","operator":{"type":"string","operation":"notEmpty","singleValue":true},"id":"30515c3f-b81c-4db4-89cd-108bc678c025"}],"combinator":"and"},"renameOutput":true,"outputKey":"nome existe"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"78f68ee4-ef94-4366-930b-a254fddaa7d6","leftValue":"={{ $('Argumentos da Tools').item.json.arguments.categoria }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"categoria existe"}]},"options":{"allMatchingOutputs":true}},"id":"ffac448f-76f6-49a5-ab3b-d3fd86cef238","name":"Switch1","type":"n8n-nodes-base.switch","typeVersion":3.1,"position":[-14128,-4176]},{"parameters":{"httpMethod":"POST","path":"vende","options":{}},"id":"05ab6436-5081-4267-b3e0-e57edc96613e","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-28256,-3264],"webhookId":"6798dba6-fdde-4111-afea-5666baf77e8d"},{"parameters":{"operation":"getAll","tableId":"cardapio","filters":{"conditions":[{"keyName":"categoria","condition":"eq","keyValue":"={{ $json.arguments.categoria }}"}]}},"id":"98efe244-c26a-40e6-9031-f1fd65c19a43","name":"Buscar protudos pela categoria","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-13920,-4112],"credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"operation":"get","tableId":"usuario_lacantina","filters":{"conditions":[{"keyName":"telefone","keyValue":"={{ $('Simplificação de Dados').item.json.ClienteTelefone }}"}]}},"id":"e25615cf-0cdf-4295-8a02-291ec2fe8b3c","name":"Buscar Cliente1","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-26880,-3344],"alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"resource":"messages-api","instanceName":"={{ $('Dados Lead').item.json.instance }}","remoteJid":"= {{ $('Dados Lead').item.json.IdConversa }}","messageText":"={{ $json.data[0].content[0].text.value }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[-19888,-1456],"id":"aee3e241-b9a5-47f9-ae69-b99f7651e82d","name":"MenuCardapio44","credentials":{"evolutionApi":{"id":"ApqS5DPziUrzonYT","name":"Evolution account"}}},{"parameters":{"fieldToSplitOut":"output.item","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-15968,-2560],"id":"96cd2d34-8762-4528-a73e-8b53e00d9f23","name":"item1","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-14080,-2800],"id":"0f42c410-b693-49a1-977f-fa657af8ab22","name":"Loop Over Items1"},{"parameters":{"operation":"executeQuery","query":" SELECT\n    numero,\n    nome,\n    descricao,\n    tipo,\n    cardapio,\n    CASE \n        WHEN '{{ $json.tamanho }}' = 'grande' THEN preco_grande\n        WHEN '{{ $json.tamanho }}' = 'media'  THEN preco_media\n        ELSE preco_grande\n    END AS valor\nFROM busca_cardapio((\n    SELECT string_agg(num, ', ')\n    FROM (\n        SELECT DISTINCT c.numero::text AS num\n        FROM cardapio AS c\n        WHERE c.nome ILIKE '%' || '{{ $json.nome }}' || '%'\n          AND categoria = '{{ $json.categoria }}' and  categoria not in ( 'borda','item')\n    )\n))\n  union all \n SELECT\n    numero,\n    nome,\n    descricao,\n    tipo,\n    cardapio,\n    CASE \n        WHEN '{{ $json.tamanho }}' = 'grande' THEN preco_grande\n        WHEN '{{ $json.tamanho }}' = 'media'  THEN preco_media\n        ELSE preco_grande\n    END AS valor\nFROM busca_cardapio((\n    SELECT string_agg(num, ', ')\n    FROM (\n        SELECT DISTINCT c.numero::text AS num\n        FROM cardapio AS c\n        WHERE  ( c.nome ILIKE '%' || '{{ $json.nome }}' || '%' or   c.palavras_chave  ILIKE '%' || '{{ $json.nome }}' || '%')\n          AND tipo  = '{{ $json.categoria }}'\n    )\n))\n   \n     union all \n SELECT\n    numero,\n    nome,\n    descricao,\n    tipo,\n    cardapio,\n    CASE \n        WHEN '{{ $json.tamanho }}' = 'grande' THEN preco_grande\n        WHEN '{{ $json.tamanho }}' = 'media'  THEN preco_media\n        ELSE preco_grande\n    END AS valor\nFROM busca_cardapio((\n    SELECT string_agg(num, ', ')\n    FROM (\n        SELECT DISTINCT c.numero::text AS num\n        FROM cardapio AS c\n        WHERE ( c.nome ILIKE '%' || '{{ $json.nome }}' || '%' or   c.palavras_chave  ILIKE '%' || '{{ $json.nome }}' || '%')\n          AND  categoria  = 'borda'\n    )\n))\n   \n   ;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-15472,-2544],"id":"8b4a5929-66f8-4d99-9709-3d8f02572731","name":"ConsultaBorda1","alwaysOutputData":true,"credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"assignments":{"assignments":[{"id":"3a3fbf83-7260-4dfa-97f2-4f323816d776","name":"tool_call_id","value":"={{ $('Argumentos da Tools').item.json.id }}","type":"string"},{"id":"3c185636-3fe8-4d4b-8a6b-e3bf5613c503","name":"output","value":"=''","type":"string"}]},"options":{}},"id":"8f94b77b-5056-4e03-9ed4-601cc5a98782","name":"Resposta da Tool postPedidos","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-17216,-3152]},{"parameters":{"tableId":"pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('Merge').item.json.user_id }}"},{"fieldId":"status","fieldValue":"aberto"},{"fieldId":"valor","fieldValue":"0"}]}},"id":"e3c58b9c-c7a0-4491-a05d-52a4bfaf574b","name":"CriaPedido","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-25552,-3088],"credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"3419c30f-4400-401b-bf40-db1579507f96","leftValue":"={{ $json.user_id }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"c6b0d8a6-08d3-446b-b038-a9e5b3647b70","name":"Cliente Pedido","type":"n8n-nodes-base.if","typeVersion":2.1,"position":[-25696,-3264],"alwaysOutputData":false,"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"get","tableId":"pedido_temp","filters":{"conditions":[{"keyName":"user_id","keyValue":"={{ $json.user_id }}"}]}},"id":"6ee84362-81e1-48d3-a15a-9b3ce9d4f77b","name":"EncontrarPedido","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-25856,-3264],"alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"00d2650d-52f9-4bf5-9b50-ec548c105222","leftValue":"={{ $json.pedido_id }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-13840,-2864],"id":"080b7c92-de12-42f6-a670-024e95960828","name":"ConcatenaPedido"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[-25424,-3264],"id":"11a03318-d462-41b3-9838-c67b5921b25d","name":"Merge2"},{"parameters":{"content":"## Função 4: GetPedido","height":844,"width":1677,"color":3},"id":"b64e0019-89d6-4743-933a-5a738fd66268","name":"Sticky Note12","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-21680,-1520]},{"parameters":{"assignments":{"assignments":[{"id":"f45a1483-7a89-4da8-a09a-8b878e83a3aa","name":"usuario","value":"=(user_id: {{ $json.user_id }}  , pedido_id:{{ $json.pedido_id }} , id_empresa:{{ $json.id_empresa }} )","type":"string"}]},"options":{}},"id":"a00aa3c2-0811-48da-bfb7-9a0183263616","name":"Construindo String4","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-22496,-1424]},{"parameters":{"assignments":{"assignments":[{"id":"760bd5f6-7f3d-4499-842e-9a17ab13408f","name":"pedido_id","value":"= {{ $('Cliente Pedido1').item.json.pedido_id }}","type":"number"},{"id":"6c967f81-1255-4087-a441-3ec73721d4fe","name":"user_id","value":"= {{ $('Cliente Pedido1').item.json.user_id }}","type":"number"}]},"options":{}},"id":"0361814c-57b1-4cf8-9dd1-d1bbf4e028a8","name":"Resposta da Tool GetPedidos","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-22224,-1424]},{"parameters":{"assignments":{"assignments":[{"id":"3a3fbf83-7260-4dfa-97f2-4f323816d776","name":"tool_call_id","value":"={{ $('Argumentos da Tools').all().map(x => x.json.id).join(',') }}","type":"string"},{"id":"3c185636-3fe8-4d4b-8a6b-e3bf5613c503","name":"output","value":"={{ $json.concatenated_mensagem }}","type":"string"}]},"options":{}},"id":"6946df84-9bec-4f2b-84cd-9a1abc7b3d37","name":"Resposta da Tool Get_Pizza","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-17552,-3760]},{"parameters":{"tableId":"item_pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"=62"},{"fieldId":"quantidade","fieldValue":"=1"},{"fieldId":"tipo","fieldValue":"salgado"},{"fieldId":"categoria","fieldValue":"item"},{"fieldId":"nome","fieldValue":"= {{ $('Loop Over Items2').item.json.nome }}"},{"fieldId":"fracionada","fieldValue":"=false"},{"fieldId":"pedido_id","fieldValue":"=11"},{"fieldId":"tamanho","fieldValue":"={{ $json.tamanho }}"},{"fieldId":"volume","fieldValue":"={{ $json.volume }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-13440,-2640],"id":"6bae9183-8dfb-4851-8fd4-acbb4b4a8d16","name":"Item","credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"9f620984-016b-4b6b-bd32-a5be81b30118","leftValue":"={{ $items().length }}","rightValue":1,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-13696,-2624],"id":"c8689ab5-c3fe-484c-9aaa-b7fbceb1da33","name":"If"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-15728,-2560],"id":"ca00ec33-08cd-42f3-bf33-779150b396e9","name":"Loop Over Items2"},{"parameters":{"operation":"executeQuery","query":" SELECT\n    numero,\n    nome,\n    descricao,\n    tipo,\n    cardapio,\n    CASE \n        WHEN '{{ $json.arguments.tamanho }}' = 'grande' THEN preco_grande\n        WHEN '{{ $json.arguments.tamanho }}' = 'media'  THEN preco_media\n        ELSE preco_grande\n    END AS valor\nFROM busca_cardapio((\n    SELECT string_agg(num, ', ')\n    FROM (\n        SELECT DISTINCT c.numero::text AS num\n        FROM cardapio AS c\n        WHERE c.nome ILIKE '%' || '{{ $json.arguments.nome }}' || '%'\n          AND categoria = '{{ $json.arguments.categoria }}' and  categoria not in ( 'borda','item')\n    )\n))\n  union all \n SELECT\n    numero,\n    nome,\n    descricao,\n    tipo,\n    cardapio,\n    CASE \n        WHEN '{{ $json.arguments.tamanho }}' = 'grande' THEN preco_grande\n        WHEN '{{ $json.arguments.tamanho }}' = 'media'  THEN preco_media\n        ELSE preco_grande\n    END AS valor\nFROM busca_cardapio((\n    SELECT string_agg(num, ', ')\n    FROM (\n        SELECT DISTINCT c.numero::text AS num\n        FROM cardapio AS c\n        WHERE  ( c.nome ILIKE '%' || '{{ $json.arguments.nome }}' || '%' or   c.palavras_chave  ILIKE '%' || '{{ $json.arguments.nome }}' || '%')\n          AND tipo  = '{{ $json.arguments.categoria }}'\n    )\n))\n   \n     union all \n SELECT\n    numero,\n    nome,\n    descricao,\n    tipo,\n    cardapio,\n    CASE \n        WHEN '{{ $json.arguments.tamanho }}' = 'grande' THEN preco_grande\n        WHEN '{{ $json.arguments.tamanho }}' = 'media'  THEN preco_media\n        ELSE preco_grande\n    END AS valor\nFROM busca_cardapio((\n    SELECT string_agg(num, ', ')\n    FROM (\n        SELECT DISTINCT c.numero::text AS num\n        FROM cardapio AS c\n        WHERE ( c.nome ILIKE '%' || '{{ $json.arguments.nome }}' || '%' or   c.palavras_chave  ILIKE '%' || '{{ $json.arguments.nome }}' || '%')\n          AND categoria  = '{{ $json.arguments.categoria }}' and  categoria  = 'borda'\n    )\n))\n   \n   ;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-13488,-2912],"id":"8ca1594a-59d0-4a16-b6c2-8ed9edbe94fc","name":"ConsultaBorda2","alwaysOutputData":true,"credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-16320,-2912],"id":"0770c5b3-eddc-433c-80d0-fea4fcad85ec","name":"Edit Fields"},{"parameters":{"operation":"get","tableId":"usuario","filters":{"conditions":[{"keyName":"telefone","keyValue":"={{ $('Dados Lead').item.json.IdConversa.trim() }}"},{"keyName":"id_empresa","keyValue":"={{ $('DadosEmpresa').item.json.id_empresa }}"}]}},"id":"3764e023-e253-4a62-b157-3eb66c6a1205","name":"Encontrar Cliente1","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-24880,-1392],"alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"3419c30f-4400-401b-bf40-db1579507f96","leftValue":"={{ $json.user_id }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"19fc9823-8c27-40a2-a0e8-f074a8b2b0f6","name":"Cliente Existe?1","type":"n8n-nodes-base.if","typeVersion":2.1,"position":[-24656,-1392],"alwaysOutputData":false,"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"content":"## Gatilho\nChat Trigger, WhatsApp, Instagram, Telegram, Messenger, etc..","height":572,"width":340,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-27248,-1552],"id":"c7c7195c-6b70-4cf6-99e0-3aa11f50eb54","name":"Sticky Note2"},{"parameters":{"assignments":{"assignments":[{"id":"9f488c5c-0b3b-48e9-87b1-5a22d513d1ec","name":"IdConversa","value":"={{ $('Webhook1').item.json.body.data.key.remoteJid.replace(\"@s.whatsapp.net\",\"\") }}","type":"string"},{"id":"69f6217f-9063-423f-abf4-e94f6b70f94e","name":"LeadNome","value":"= {{ $('Webhook1').item.json.body.data.pushName }}","type":"string"},{"id":"6ba1d721-f125-47fb-ad7b-194cc478a856","name":"input_usuario","value":"={{ $('Webhook1').item.json.body.data.message.conversation }}","type":"string"},{"id":"ba4188f4-3672-477b-a776-7eadc863140c","name":"mensagem_usuario","value":"={{ $('Webhook1').item.json.body.data.message.conversation }}","type":"string"},{"id":"33d4eb69-2991-4188-8b18-2ac04b7b2f74","name":"telefoneEmpresa","value":"={{ $('Webhook1').item.json.body.sender.replace(\"@s.whatsapp.net\",\"\") }}","type":"string"},{"id":"8231bcd2-8b3a-460a-b0ea-2b933a6b9804","name":"instance","value":"={{ $('Webhook1').item.json.body.instance }}","type":"string"},{"id":"198cfcfe-5eea-41f8-80a8-09aaeef5e6e5","name":"apikey","value":"={{ $('Webhook1').item.json.body.apikey }}","type":"string"}]},"options":{}},"id":"7783779d-774f-4955-8dd0-70aeb6eb89a8","name":"Dados Lead","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-25920,-1312],"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"content":"Ajustes os filtros necessários conforme seu gatilho de entrada","height":280,"width":190,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-26384,-1392],"id":"d3558ea4-b991-41a6-9c82-a036a2ef63ee","name":"Sticky Note1"},{"parameters":{"content":"Ajuste tempos de buffer e inatividade do agente conforme necessidade.\n","height":280,"width":190,"color":3},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-26736,-1408],"id":"04e3e534-6b7b-4d17-8b5a-0c680a71c38e","name":"Sticky Note18"},{"parameters":{"assignments":{"assignments":[{"id":"3bdce7b6-d0f1-442c-aafd-8cd123aa21b6","name":"EsperaBuffer","value":1,"type":"number"},{"id":"c38e8985-4494-40a4-878e-f25467849842","name":"TempoInatividadeAgente","value":150,"type":"number"},{"id":"ac619a5e-1438-4e19-aaf5-21dfcbc32312","name":"ModeloTemperatura","value":0.4,"type":"number"},{"id":"cd3b0a32-e454-406e-84ad-b5efedc9c545","name":"empresa","value":"1","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-26704,-1312],"id":"396ff8d8-ed30-4b1c-9754-1abd69fdf8b0","name":"Parametros Fluxo","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"00d2650d-52f9-4bf5-9b50-ec548c105222","leftValue":"={{ $json.lead_id }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-24080,-1408],"id":"f71f4a01-dd1a-41a1-8c0e-d7b4777f4ee4","name":"Concatena"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"204f54b0-e3ed-4ff4-8302-8c20d3b8aa78","leftValue":"={{ $('Webhook1').item.json.body.isGroup }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}},{"id":"c51986d9-f347-4198-89bb-9e4cd0f021c9","leftValue":"={{ $('Webhook1').item.json.body.broadcast }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}},{"id":"05ee6414-0164-473b-8f82-225cfba55ad2","leftValue":"={{ $('Webhook1').item.json.body.key.fromMe }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"id":"5288c4eb-4f6c-496f-8d4c-060caca3f214","name":"Filtro Inicial1","type":"n8n-nodes-base.filter","typeVersion":2.1,"position":[-26336,-1312],"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{},"id":"09e3a11e-7b66-4bf0-b519-4d9b279bef76","name":"MergePedido","type":"n8n-nodes-base.merge","typeVersion":3,"position":[-23088,-1408],"alwaysOutputData":false,"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"resource":"audio","operation":"transcribe","binaryPropertyName":"=data","options":{"language":"pt"}},"id":"efd9e158-f544-477d-800b-ef157ee84d8e","name":"Transcrever Áudio1","type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.4,"position":[-27760,-3088],"credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"resource":"image","operation":"analyze","modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"text":"=#Instruções\nO usuário te enviou uma imagem a qual você deve descrever.\n\nA imagem pode vir acompanhada de uma mensagem de texto (<MensagemUsuario>)\n\nCaso venha, utilize a mensagem anexa como contexto extra, tente capturar o sentimento da mensagem e objetivo pelo qual o usuário esteja enviando esta imagem na conversa.\n\nCrie uma resposta descrevendo as informações enviadas para que estas sejam utilizadas por um agente no futuro.\n\nLembre-se:\nEste agente apenas terá as informações que você fornecer, portanto repasse toda informação que julgar importante.\n\n#Dados\n<MensagemUsuario>\n{{ $json.MensagemImagem }}\n</MensagemUsuario>\n","inputType":"base64","options":{}},"id":"34331f39-b48d-4dae-99e5-0a3788ea4d54","name":"OpenAI1","type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.4,"position":[-27760,-2928],"credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"amount":"={{ $('Parametros Fluxo').item.json.EsperaBuffer }}"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-26960,-3024],"id":"159ce35e-991c-4b69-9362-a6abaa98685d","name":"Wait1","webhookId":"169ea291-c3dc-4bca-854f-05520c979d7d","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"get","propertyName":"messages","key":"={{ $('Dados Lead').item.json.IdConversa }}_buffer","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-27168,-3008],"id":"dd4aadd2-fa8f-4c53-bccd-b6798282a8df","name":"Buffer ","credentials":{"redis":{"id":"AvuP6JWzf8sxsD3n","name":"Redis account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"get","propertyName":"messages","key":"={{ $('Dados Lead').item.json.IdConversa }}_buffer","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-26784,-2240],"id":"b40ca90c-8930-472d-9fa5-79ed9ad2f1ed","name":"Buffer 3","credentials":{"redis":{"id":"AvuP6JWzf8sxsD3n","name":"Redis account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"push","list":"={{ $('Dados Lead').item.json.IdConversa }}_buffer","messageData":"={{ $json.Texto }}","tail":true},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-27456,-3408],"id":"58dfe6f0-f0df-4bd7-81cf-630119012d42","name":"Add Texto Buffer1","credentials":{"redis":{"id":"AvuP6JWzf8sxsD3n","name":"Redis account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"delete","key":"={{ $('Dados Lead').item.json.IdConversa }}_buffer"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-26464,-2320],"id":"eb5c31aa-dc70-4bd9-a559-a49ea09c12f2","name":"Apagar Buffer1","credentials":{"redis":{"id":"AvuP6JWzf8sxsD3n","name":"Redis account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"assignments":{"assignments":[{"id":"c1ce011b-bd95-468e-863e-f2076f644cf9","name":"Texto","value":"={{ $('Webhook1').item.json.body.data.message.conversation }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-28240,-3408],"id":"151928cd-be88-4c2d-be33-3982153f333e","name":"Mensagem Texto1","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"assignments":{"assignments":[{"id":"5efc6961-1ff7-4ef2-a772-7e9761592a3e","name":"Audio","value":"={{ $('Webhook1').item.json.body.data.message.base64 }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-28240,-3088],"id":"763bab2a-8818-408f-b586-57d2f9ccdc3d","name":"Mensagem Audio1","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"assignments":{"assignments":[{"id":"5efc6961-1ff7-4ef2-a772-7e9761592a3e","name":"Imagem","value":"={{ $('Webhook1').item.json.body.data.message.base64 }}","type":"string"},{"id":"f5c70ab5-7671-4bc8-9d23-65b8954ddb08","name":"MensagemImagem","value":"={{ $('Webhook1').item.json.body.data.message.imageMessage.caption }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-28240,-2928],"id":"3f9a9368-7f60-4c2d-af86-30e0f3130a36","name":"Mensagem Imagem1","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"push","list":"={{ $('Dados Lead').item.json.IdConversa }}_buffer","messageData":"={{ $json.text }}","tail":true},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-27456,-3088],"id":"81f5ed00-5f59-405d-b87a-1ac8ce5ca058","name":"Add Audio Buffer1","credentials":{"redis":{"id":"AvuP6JWzf8sxsD3n","name":"Redis account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"push","list":"={{ $('Dados Lead').item.json.IdConversa }}_buffer","messageData":"={{ $json.Erro }}","tail":true},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-27456,-2592],"id":"fb5a58b3-52cb-491b-a6a5-e98feaf7085c","name":"Add Error Buffer1","credentials":{"redis":{"id":"AvuP6JWzf8sxsD3n","name":"Redis account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"pdf","options":{}},"type":"n8n-nodes-base.extractFromFile","typeVersion":1,"position":[-27760,-2768],"id":"2aa49de3-b9a5-482f-81f2-e94bb3581aee","name":"Extract from File","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"assignments":{"assignments":[{"id":"11dc126a-e72e-431b-8db5-c78168c69439","name":"Erro","value":"<ErroFormatoMensagem>","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-28240,-2592],"id":"1eb4d194-82d8-43f4-a664-95150ba73ce6","name":"Mensagem Erro1","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"push","list":"={{ $('Dados Lead').item.json.IdConversa }}_buffer","messageData":"=<ContextoPDF>\n  <TranscricaoPDF>\n{{ $json.text }}\n  </TranscricaoPDF>\nContexto Extra: O usuário encaminhou a mensagem a seguir junto ao PDF.\n  <MensagemUsuario>\n{{ $('Mensagem Documento PDF').item.json.MensagemDocumento }}\n  </MensagemUsuario>\n</ContextoPDF>","tail":true},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-27456,-2768],"id":"b66c3c1f-e5c4-484c-8373-cb6f653ffa5c","name":"Add PDF Buffer1","credentials":{"redis":{"id":"AvuP6JWzf8sxsD3n","name":"Redis account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"push","list":"={{ $('Dados Lead').item.json.IdConversa }}_buffer","messageData":"=<ContextoImagem>\n\n  <DetalheImagem>\n{{ $json.content }}\n  </DetalheImagem>\n\nContexto Extra: O usuário encaminhou a mensagem a seguir junto á imagem.\n  <MensagemUsuario>\n{{ $('Mensagem Imagem1').item.json.MensagemImagem }}\n  </MensagemUsuario>\n\n</ContextoImagem>","tail":true},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-27456,-2928],"id":"d24aed3e-d3e1-4195-86e6-71e6ffc18b45","name":"Add Imagem Buffer1","credentials":{"redis":{"id":"AvuP6JWzf8sxsD3n","name":"Redis account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"get","propertyName":"AgenteStatus","key":"={{ $('Parametros Fluxo').item.json.IdAgente }}_status_{{ $('Dados Lead').item.json.IdConversa }}\n\n ","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-29232,-2208],"id":"84f391e4-82f4-418e-b511-c13713504c54","name":"Redis","credentials":{"redis":{"id":"AvuP6JWzf8sxsD3n","name":"Redis account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-26224,-2144],"id":"aa90d15e-265e-4505-8fe4-105290b548f2","name":"No Operation, do nothing6","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"756ab323-31a2-4a59-92e8-c2c695027962","leftValue":"={{ $json.AgenteStatus }}","rightValue":"Desativado","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-28752,-3056],"id":"4a30d301-195b-4f24-91eb-562601c50da7","name":"Bot Desativado?1","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"assignments":{"assignments":[{"id":"5efc6961-1ff7-4ef2-a772-7e9761592a3e","name":"Documento","value":"={{ $('Webhook1').item.json.body.data.message.base64 }}","type":"string"},{"id":"003323ec-ffbe-4c91-b8b5-623466b5014d","name":"MensagemDocumento","value":"={{ $('Webhook1').item.json.body.data.message.documentWithCaptionMessage.message.documentMessage.caption }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-28240,-2768],"id":"084acbd4-7b4c-433b-a342-f2ddf042ca01","name":"Mensagem Documento PDF","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"toBinary","sourceProperty":"Imagem","options":{"mimeType":"image/png"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[-27984,-2928],"id":"634e0846-eda6-4452-bac7-e7b31d1f044b","name":"Convert to File"},{"parameters":{"operation":"toBinary","sourceProperty":"Audio","options":{"mimeType":"audio/mp4"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[-27984,-3088],"id":"d6d022a5-a611-4cdf-9d05-7d3123865a8f","name":"Convert to File1"},{"parameters":{"operation":"toBinary","sourceProperty":"Documento","options":{}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[-27984,-2768],"id":"a6ab093e-156a-41f3-bf91-728c014dfdee","name":"Convert to File2"},{"parameters":{"assignments":{"assignments":[{"id":"c1ce011b-bd95-468e-863e-f2076f644cf9","name":"Texto","value":"={{ $('Webhook1').item.json.body.data.message.extendedTextMessage.text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-28240,-3248],"id":"88f56c89-cc9f-464f-ae7f-3a5a46dedfa6","name":"Mensagem Texto2","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"assignments":{"assignments":[{"id":"66a91f66-e755-4120-b22f-44c814f56162","name":"message","value":"={{ $('Webhook1').item.json.body.data.message.conversation }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-25072,-1392],"id":"65f8dd92-a9ff-4e68-8d29-f6dccdab5a04","name":"MensagemTraduzida","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"jsCode":" const input =  $input.first().json.comando_normalizado || $input.first().json.message || \"\";\nlet clean = input.toLowerCase().trim();\nlet tokens = clean.split(/\\s+/);\n\n// Mapa de palavras para números (quando a 1ª palavra é quantidade)\nconst mapaQtd = { \"uma\":\"1\", \"um\":\"1\", \"duas\":\"2\", \"dois\":\"2\", \"três\":\"3\", \"tres\":\"3\", \"quatro\":\"4\", \"cinco\":\"5\" };\nif (mapaQtd[tokens[0]]) {\n  tokens[0] = mapaQtd[tokens[0]];\n  clean = tokens.join(\" \");\n}\n\n// Normaliza plural básico (caso o pré-LLM não tenha feito)\nif (tokens[1] === \"pizzas\") {\n  tokens[1] = \"pizza\";\n  clean = tokens.join(\" \");\n}\n\n// Resposta padrão (com sugestão educada)\nlet resultado = {\n  original: input,\n  comando: clean,\n  valido: false,\n  tipo: null,\n  erro: \"não entendi seu comando\",\n  sugestao: `O seu pedido ou comando não foi identificado. Você quis dizer: ${clean} ?`\n};\n\n// --- Caso 1: Pizza inteira ---\n// \"1 pizza 14\", \"1 pizza mussarela grande\"\nif (\n  tokens.length >= 3 &&\n  /^\\d+$/.test(tokens[0]) &&\n  tokens[1] === \"pizza\" &&\n  !tokens.includes(\"1/2\")\n) {\n  resultado = {\n    original: input,\n    comando: clean,\n    valido: true,\n    tipo: \"pizza_inteira\",\n    acao: \"adicionar_item\"\n  };\n}\n\n// --- Caso 2: Pizza fracionada ---\n// \"1 pizza 1/2 14 e 1/2 19\"  (aceita nomes no lugar de números)\nelse if (\n  /^\\d+$/.test(tokens[0]) &&\n  tokens[1] === \"pizza\" &&\n  tokens.filter(t => t === \"1/2\").length === 2\n) {\n  resultado = {\n    original: input,\n    comando: clean,\n    valido: true,\n    tipo: \"pizza_fracionada\",\n    acao: \"adicionar_item\"\n  };\n}\n\n// --- Caso 3: Esfirra ---\n// \"1 esfirra carne\"\nelse if (\n  tokens.length >= 3 &&\n  /^\\d+$/.test(tokens[0]) &&\n  tokens[1] === \"esfirra\"\n) {\n  resultado = {\n    original: input,\n    comando: clean,\n    valido: true,\n    tipo: \"esfirra\",\n    acao: \"adicionar_item\"\n  };\n}\n\n// --- Caso 4: Bebida ---\n// \"1 coca cola 2l\", \"2 guarana 350ml\", \"1 água 500ml\", \"1 heineken long neck\"\nelse if (\n  /^\\d+$/.test(tokens[0]) &&\n  /\\b(coca(?:\\s+cola)?|cola|guaran[áa]|heineken|bud(?:weiser)?|cerveja|agua|água|fanta|sprite)\\b/.test(clean)\n) {\n  resultado = {\n    original: input,\n    comando: clean,\n    valido: true,\n    tipo: \"bebida\",\n    acao: \"adicionar_item\"\n  };\n}\n\n// --- Caso 5: Adicionar ingrediente ---\n// \"adicionar mussarela item 1\", \"adicionar ingrediente cheddar ao item 3\"\nelse if (\n  tokens[0] === \"adicionar\" &&\n  tokens.includes(\"item\")\n) {\n  resultado = {\n    original: input,\n    comando: clean,\n    valido: true,\n    tipo: \"adicionar_item\",\n    acao: \"adicionar_item\"\n  };\n}\n\n// --- Caso 6: Excluir item ---\n// \"excluir item 1\", \"excluir 2\"\nelse if (\n  tokens[0] === \"excluir\" &&\n  (\n    (tokens[1] === \"item\" && /^\\d+$/.test(tokens[2])) ||\n    (/^\\d+$/.test(tokens[1]))\n  )\n) {\n  resultado = {\n    original: input,\n    comando: clean,\n    valido: true,\n    tipo: \"excluir_item\",\n    acao: \"excluir_item\"\n  };\n}\n\nreturn resultado;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-25856,-2160],"id":"170e5e0b-17ce-4372-9d4a-879955898b4a","name":"Validador"},{"parameters":{"content":"Ajuste tempos de buffer e inatividade do agente conforme necessidade.\n","height":968,"width":1822},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-28656,-3408],"id":"1f5217cd-c36c-471d-a841-a486565c0833","name":"Sticky Note19"},{"parameters":{"operation":"executeQuery","query":"select  id_empresa::int  from empresa_telefones where telefone = '{{ $json.telefoneEmpresa }}'","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-25744,-1312],"id":"bacf3535-d1c2-4b2d-85ad-b58b9ae3a27a","name":"Execute a SQL query1","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"assignments":{"assignments":[{"id":"ae27ddc3-121b-470f-a83c-a7b53f38c0da","name":"id_empresa","value":"={{ $json.id_empresa }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-25520,-1296],"id":"d1f84c0c-ddf0-4cf6-aa5f-e42ca6f07b6f","name":"DadosEmpresa"},{"parameters":{"assignments":{"assignments":[{"id":"7413dfd7-1dbd-4551-be34-2e1c6e8181ec","name":"texto","value":"={{ $json.messages[0] }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-26304,-2368],"id":"0be24a7c-35e7-4432-8713-e6a37bb7c137","name":"FielsMsgBuffer"},{"parameters":{"jsCode":" const input =  $('Webhook1').first().json.body.data.message.conversation   || \"\";\n\n// 1) minúsculas\nlet clean = input.toLowerCase();\n\n// 2) remove moeda: \"r$\", \"r $\", \"$\"\nclean = clean.replace(/r\\s*\\$/gi, \"\").replace(/\\$/g, \"\");\n\n// 3) remove o \"r\" (ou qualquer letra) deixado ANTES de número/1/2: \"r 6\", \"r 1/2\"\nclean = clean.replace(/\\b[a-zà-ÿ]\\s+(?=(\\d|1\\/2)\\b)/gi, \"\");\n\n// 4) mantém só letras/números/espaço e \"/\" (tira resto de símbolos)\nclean = clean.replace(/[^0-9a-zà-ÿ\\s/,.]/g, \" \");\n\n// 5) normaliza plurais comuns\nclean = clean.replace(/\\bpizzas\\b/g, \"pizza\")\n             .replace(/\\besfirras\\b/g, \"esfirra\");\n\n// 6) palavras de quantidade -> número (antes de \"pizza\")\nclean = clean.replace(/\\b(uma|um)\\b(?=\\s+pizza\\b)/g, \"1\")\n             .replace(/\\b(duas|dois)\\b(?=\\s+pizza\\b)/g, \"2\")\n             .replace(/\\b(três|tres)\\b(?=\\s+pizza\\b)/g, \"3\");\n\n// 7) \"meia\" -> \"1/2\"\nclean = clean.replace(/\\bmeia\\b/g, \"1/2\");\n\n// 8) corrige \"6,19\" ou \"6.19\" -> \"1/2 19\"\nclean = clean.replace(/6[,.](\\d{1,2})\\b/g, \"1/2 $1\");\n\n// 9) padrão da transcrição \"6 14 e 6 19\" -> \"1 pizza 1/2 14 e 1/2 19\"\nclean = clean.replace(/\\b6\\s+(\\d{1,2})(?:\\s*[,;]?\\s*e\\s*)6\\s+(\\d{1,2})\\b/g, \"1 pizza 1/2 $1 e 1/2 $2\");\n\n// 10) remove vírgulas/pontos remanescentes que grudem nos números (ex.: \"17,\" -> \"17\")\nclean = clean.replace(/[,.]/g, \" \");\n\n \n\n// 12) compacta espaços\nclean = clean.replace(/\\s+/g, \" \").trim();\n\nreturn { original: input, comando_normalizado: clean };\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-25776,-2176],"id":"78715eb7-f58e-48df-baf5-257cbf642a70","name":"Normalizador"},{"parameters":{"method":"POST","url":"=https://evolution.lglducci.com.br/message/sendText/LaCantina","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"=E9C6EA4E47E7-4905-BC38-475CBACA3F1E"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"={{ $('Webhook1').item.json.body.data.key.remoteJid.replace(\"@s.whatsapp.net\",\"\") }}"},{"name":"text","value":"teste Conversational"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-30912,-2400],"id":"30b8355e-a5e6-4349-b8f2-2aea7d2e0b58","name":"HTTP Request"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1bd6c365-d077-4284-9dfe-94db1cbe39bd","leftValue":"={{ $('Buffer 3').item.json.messages.last() }}","rightValue":"={{ $('Buffer ').item.json.messages.last() }}","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-26624,-2240],"id":"87c00532-3f29-42a0-8001-992e09adc632","name":"ComparandoMensagens1","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"tableId":"usuario","fieldsUi":{"fieldValues":[{"fieldId":"nome","fieldValue":"={{ $('Dados Lead').item.json.LeadNome }}"},{"fieldId":"telefone","fieldValue":"={{ $('Dados Lead').item.json.IdConversa.trim() }}"},{"fieldId":"id_empresa","fieldValue":"={{ $('DadosEmpresa').item.json.id_empresa }}"}]}},"id":"313bea58-3c85-4d21-ac70-fb71e86dcc9d","name":"Criar Cliente2","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-24224,-1168],"credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{},"id":"a551e3a0-eae5-4e23-bdce-0924a1e68440","name":"Merge4","type":"n8n-nodes-base.merge","typeVersion":3,"position":[-23840,-1408],"alwaysOutputData":false,"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"content":"## Variáveis do Fluxo\nCentral de controle do workflow","height":540,"width":326,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-26816,-1536],"id":"46753374-19a3-4e2e-aeba-b543e8538913","name":"Sticky Note13"},{"parameters":{"content":"## Filtros Iniciais\nPara evitar que fluxo seja executado quando não queremos","height":572,"width":340,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-26448,-1552],"id":"74eed0f8-80bf-4528-9590-c784ae52a5e2","name":"Sticky Note14"},{"parameters":{"content":"## Registro do Lead no banco de dados (Supabase)\nFluxo para adição do lead no banco de dados postgrees supabase.","height":684,"width":2536,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-25184,-1568],"id":"c545d7b3-c8b9-490a-a6de-a25dc1f3df3c","name":"Sticky Note15"},{"parameters":{"content":"## Mensagem para o Agente\nMensagem final do usuário para o agente","height":284,"width":836,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-26896,-2464],"id":"be46869a-f48d-49f6-88d2-d8125466af8c","name":"Sticky Note16"},{"parameters":{"httpMethod":"POST","path":"fluxovendas","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-27088,-1312],"id":"4214a201-ce5b-4754-b390-618766c926f8","name":"Webhook1","webhookId":"66949457-5339-4325-b499-9a15d57ff6a1"},{"parameters":{"tableId":"pedido_temp","fieldsUi":{"fieldValues":[{"fieldId":"user_id","fieldValue":"={{ $('Merge4').item.json.user_id }}"},{"fieldId":"status","fieldValue":"enviado"},{"fieldId":"valor","fieldValue":"0"},{"fieldId":"id_empresa","fieldValue":"={{ $('DadosEmpresa').item.json.id_empresa }}"}]}},"id":"6488b85a-2341-4ce5-81bf-cd31f3fe5aff","name":"CriaPedido1","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-23264,-1248],"credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"3419c30f-4400-401b-bf40-db1579507f96","leftValue":"={{ $json.user_id }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"9bd27206-8fff-4d79-81ea-61f02dac6d3b","name":"Cliente Pedido1","type":"n8n-nodes-base.if","typeVersion":2.1,"position":[-23408,-1408],"alwaysOutputData":false,"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"operation":"get","tableId":"pedido_temp","filters":{"conditions":[{"keyName":"user_id","keyValue":"={{ $('Merge4').item.json.user_id }}"},{"keyName":"id_empresa","keyValue":"={{$json.id_empresa}}"}]}},"id":"c76692c6-34ab-44e7-8cd0-3fd6876cdb54","name":"EncontrarPedido1","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-23584,-1408],"alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"CcvRddDPb5xelxfb","name":"Supabase account"}},"notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"content":"Ajuste o Node Set com os campos relevantes fornecidos.\n","height":280,"width":706,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-26032,-1392],"id":"1b5ff1dd-a768-404f-9207-7ab00f34350d","name":"Sticky Note17"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"bc64f125-d93c-4d1d-97ae-65c0adb08b79","leftValue":"={{ $('Webhook1').item.json.body.data.messageType }}","rightValue":"conversation","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"texto"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"f7053057-3e82-49ad-a2bf-07bafc958f06","leftValue":"={{ $('Webhook1').item.json.body.data.messageType }}","rightValue":"extendedTextMessage","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"texto"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"137aec3f-e95e-4d59-b9ba-1140f9fc4fb4","leftValue":"={{ $('Webhook1').item.json.body.data.messageType }}","rightValue":"audioMessage","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"audio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $('Webhook1').item.json.body.data.messageType }}","rightValue":"imageMessage","operator":{"type":"string","operation":"equals"},"id":"40b284c8-fdf7-49e5-9ac3-8c5051f51521"}],"combinator":"and"},"renameOutput":true,"outputKey":"imagem"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"7babc8fd-200c-4cb8-bc63-f999f57d5217","leftValue":"={{ $('Webhook1').item.json.body.data.message.documentWithCaptionMessage.message.documentMessage.mimetype }}","rightValue":"application/pdf","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"PDF"}]},"options":{"fallbackOutput":"extra","renameFallbackOutput":"Outro"}},"id":"60e0d589-fe3c-4f0b-8a84-e803a3c43c28","name":"Switch2","type":"n8n-nodes-base.switch","typeVersion":3.1,"position":[-28464,-3072],"notesInFlow":true,"notes":"Ajustar condições para cada tipo de mensagem a depender da sua entrada de dados\n\nTEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-28592,-3280],"id":"4601c1ae-0729-4749-ad01-1e1c9cd82536","name":"No Operation, do nothing1"},{"parameters":{"content":"## Mensagem para o Agente\nMensagem final do usuário para o agente","height":1084,"width":1988,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-28736,-3472],"id":"b95ddbcb-8872-47fe-9e81-b95d7e1e78bb","name":"Sticky Note20"},{"parameters":{"method":"POST","url":"https://api.openai.com/v1/threads","authentication":"predefinedCredentialType","nodeCredentialType":"openAiApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"OpenAI-Beta","value":"assistants=v2"}]},"options":{}},"id":"9cdd3ea6-4354-4f25-8363-ab8a12e93bd6","name":"[OpenAI] Criar Thread1","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-24416,-1168],"credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"method":"POST","url":"https://api.openai.com/v1/threads","authentication":"predefinedCredentialType","nodeCredentialType":"openAiApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"OpenAI-Beta","value":"assistants=v2"}]},"options":{}},"id":"cedf82b8-a700-47bb-b963-85003874ad43","name":"[OpenAI] Criar Thread2","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-23728,-816],"credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"description":"Chama essa tool para buscar um sabor no cardápio","workflowId":{"__rl":true,"value":"gl0RYjlzfJknufRk","mode":"list","cachedResultName":"ConsultaOnline"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"=1","rotina":7,"telefone":"={{ $('Dados Lead').item.json.IdConversa }}","id_empresa":"=1","pedido_id":16,"mensagem":"={{ $json.arguments.categoria }}  {{ $json.arguments.nome }}","categoria":"={{ $json.arguments.categoria }}"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"categoria","displayName":"categoria","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-18208,-4048],"id":"35766229-c931-44d4-bbfa-1e2fec49922d","name":"ConsultaOnline"},{"parameters":{"fieldsToSummarize":{"values":[{"aggregation":"concatenate","field":"message.content"}]},"options":{}},"id":"626afe4d-d1ee-4b72-8ccb-9fbdee7cb523","name":"Concatenando String1","type":"n8n-nodes-base.summarize","typeVersion":1,"position":[-17568,-3152]},{"parameters":{"description":"Essa intenção de compra deve ser executada sempre que for solicitqado","workflowId":{"__rl":true,"value":"gL1FbKkYm9zGfCAA","mode":"list","cachedResultName":"Kernel Pizza"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"=1","pedido_id":"= 16","id_empresa":"=1","rotina":1,"mensagem":"= {{ $json.arguments.quantidade}}    {{ $json.arguments.categoria}} {{ $json.arguments.numero}} {{ $json.arguments.nome}}  {{ $json.arguments.tamanho}}   ","telefone":"={{ $('Dados Lead').item.json.IdConversa }}","instance":"= {{ $('Dados Lead').item.json.instance }}","apikey":"={{ $('Dados Lead').item.json.apikey }}"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"instance","displayName":"instance","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"apikey","displayName":"apikey","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-17888,-2912],"id":"7bdc39a2-1b27-4609-ae64-f50437c49b82","name":"IntencaoCompra"},{"parameters":{"content":"## Função 3: Get Pizza Carrinho","height":460,"width":1201,"color":5},"id":"b1d4beca-1eff-4599-b1ea-c86703060555","name":"Sticky Note9","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-18464,-2688]},{"parameters":{"assignments":{"assignments":[{"id":"3a3fbf83-7260-4dfa-97f2-4f323816d776","name":"tool_call_id","value":"={{ $('Argumentos da Tools').item.json.id }}","type":"string"},{"id":"3c185636-3fe8-4d4b-8a6b-e3bf5613c503","name":"output","value":"={{ $json.concatenated_message_content }}","type":"string"}]},"options":{}},"id":"056649ca-fd0e-4e81-9776-e9956dabb340","name":"Resposta da Tool postPedidos1","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-17536,-2592]},{"parameters":{"fieldsToSummarize":{"values":[{"aggregation":"concatenate","field":"message.content"}]},"options":{}},"id":"cd004dd3-5272-4af3-b623-ff2bd7e2db3d","name":"Concatenando String2","type":"n8n-nodes-base.summarize","typeVersion":1,"position":[-17872,-2592]},{"parameters":{"workflowId":{"__rl":true,"value":"gl0RYjlzfJknufRk","mode":"list","cachedResultName":"ConsultaOnline"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"=1","rotina":1,"telefone":"={{ $('Dados Lead').item.json.IdConversa }}","id_empresa":"=1","mensagem":"=pizza","categoria":"=pizza","pedido_id":16},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"categoria","displayName":"categoria","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-18176,-2368],"id":"13c079aa-484b-42f6-bb14-2e44841b6c61","name":"Compras"},{"parameters":{"content":"## Função 2:Addiciona Borda Item ","height":492,"width":1201,"color":4},"id":"6da76460-b63c-4759-881d-90be1d2f727e","name":"Sticky Note11","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-18448,-2160]},{"parameters":{"assignments":{"assignments":[{"id":"3a3fbf83-7260-4dfa-97f2-4f323816d776","name":"tool_call_id","value":"={{ $('Argumentos da Tools').item.json.id }}","type":"string"},{"id":"3c185636-3fe8-4d4b-8a6b-e3bf5613c503","name":"output","value":"=''","type":"string"}]},"options":{}},"id":"9fcd9a44-321f-46d0-906b-92c918d00bd7","name":"Resposta da Tool postPedidos2","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-17520,-2064]},{"parameters":{"fieldsToSummarize":{"values":[{"aggregation":"concatenate","field":"message.content"}]},"options":{}},"id":"182cd9bc-2e79-4921-a8e1-82b2b61678b3","name":"Concatenando String3","type":"n8n-nodes-base.summarize","typeVersion":1,"position":[-17872,-2064]},{"parameters":{"description":"Essa intenção de compra deve ser executada sempre que for solicitqado","workflowId":{"__rl":true,"value":"gL1FbKkYm9zGfCAA","mode":"list","cachedResultName":"Kernel Pizza"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"=1","pedido_id":"= 16","id_empresa":"=1","rotina":1,"mensagem":"= {{ $json.arguments.quantidade}}    {{ $json.arguments.categoria}} {{ $json.arguments.nome}}  add item {{ $json.arguments.item_id}}   ","telefone":"={{ $('Dados Lead').item.json.IdConversa }}","instance":"= {{ $('Dados Lead').item.json.instance }}","apikey":"={{ $('Dados Lead').item.json.apikey }}"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"instance","displayName":"instance","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"apikey","displayName":"apikey","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-18192,-1824],"id":"196c9a2b-c9e6-438a-8a9d-93b01a9b951e","name":"IntencaoCompraBordaItem"},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"messages":{"values":[{"content":"=O seu objetivo é executar a tool IntencaoCompraBorda()\n \n "}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-18336,-2064],"id":"e7fa0cfd-04d3-44f3-8d52-12c08309983a","name":"AddBordaItem","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"messages":{"values":[{"content":"=O seu objetivo é executar a tool Compras() e mostrar todos os itens do carrinho de pizzas do cliente\n \n ⚙️ REGRAS DE SAÍDA:\n- Se uma tool (função) retornar dados em formato JSON, NÃO reescreva, resuma ou formate como texto.\n- Apenas repasse o conteúdo JSON exato no output.\n- Não acrescente frases, títulos ou explicações.\n- Se precisar mostrar em texto, mantenha também o JSON original abaixo de forma literal.\n"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-18320,-2592],"id":"f2ca7bd7-0e0f-4833-9f81-6716158b5a47","name":"GetCarrinho","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"messages":{"values":[{"content":"=O seu objetivo é executar a tool IntencaoCompra()\n \n "}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-18032,-3152],"id":"757dbbbf-3478-4021-a880-4085896004ef","name":"AdicionaItemCompra","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"messages":{"values":[{"content":"=O seu objetivo é executar a tool ConsultaOnline()\n \n  \n ⚙️ REGRAS DE SAÍDA:\n- Se uma tool (função) retornar dados em formato JSON, NÃO reescreva, resuma ou formate como texto.\n- Apenas repasse o conteúdo JSON exato no output.\n- Não acrescente frases, títulos ou explicações.\n- Se precisar mostrar em texto, mantenha também o JSON original abaixo de forma literal.\n"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-18688,-4096],"id":"1210db3f-4fb0-4737-80ba-c7b8d6fd3ba2","name":"ConsultaProduto","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"content":"## Função 2: Add Pizza Carrinho","height":492,"width":1201,"color":3},"id":"f2dddf25-50cf-46c9-a1ac-c4021001463c","name":"Sticky Note21","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-18496,-1504]},{"parameters":{"assignments":{"assignments":[{"id":"3a3fbf83-7260-4dfa-97f2-4f323816d776","name":"tool_call_id","value":"={{ $('Argumentos da Tools').item.json.id }}","type":"string"},{"id":"3c185636-3fe8-4d4b-8a6b-e3bf5613c503","name":"output","value":"=''","type":"string"}]},"options":{}},"id":"2bd96dca-b6ec-4002-b03b-c7ce6afe5be8","name":"Resposta da Tool postPedidos3","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-17504,-1456]},{"parameters":{"fieldsToSummarize":{"values":[{"aggregation":"concatenate","field":"message.content"}]},"options":{}},"id":"08863a94-0600-47ca-9793-ffd816e91b6d","name":"Concatenando String4","type":"n8n-nodes-base.summarize","typeVersion":1,"position":[-17856,-1456]},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"messages":{"values":[{"content":"=O seu objetivo é executar a tool IntencaoCompraFracionada()\n\n \n ⚙️ REGRAS DE SAÍDA:\n- Se uma tool (função) retornar dados em formato JSON, NÃO reescreva, resuma ou formate como texto.\n- Apenas repasse o conteúdo JSON exato no output.\n- Não acrescente frases, títulos ou explicações.\n- Se precisar mostrar em texto, mantenha também o JSON original abaixo de forma literal.\n\n "}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-18320,-1456],"id":"72a99149-fb2e-4901-8936-e34eb82f674f","name":"AdicionaItemCompraFracionada","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"description":"Essa intenção de compra deve ser executada sempre que for solicitqado","workflowId":{"__rl":true,"value":"gL1FbKkYm9zGfCAA","mode":"list","cachedResultName":"Kernel Pizza"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"=1","pedido_id":"= 16","id_empresa":"=1","rotina":1,"mensagem":"= {{ $json.arguments.quantidade}}   {{ $json.arguments.categoria}} 1/2 {{ $json.arguments.numero_metade1}}  1/2 {{ $json.arguments.numero_metade2}}   grande","telefone":"={{ $('Dados Lead').item.json.IdConversa }}","instance":"= {{ $('Dados Lead').item.json.instance }}","apikey":"={{ $('Dados Lead').item.json.apikey }}"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"instance","displayName":"instance","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"apikey","displayName":"apikey","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-18176,-1216],"id":"29738fa2-0eac-4dc6-b9d9-5b207ee03c99","name":"IntencaoCompraFracionada"},{"parameters":{"content":"## Função 3: Get Pizza Carrinho","height":492,"width":1361,"color":5},"id":"a5d49c7a-fe14-4e84-b667-9d70e8deca14","name":"Sticky Note22","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-18544,-880]},{"parameters":{"assignments":{"assignments":[{"id":"3a3fbf83-7260-4dfa-97f2-4f323816d776","name":"tool_call_id","value":"={{ $('Argumentos da Tools').item.json.id }}","type":"string"},{"id":"3c185636-3fe8-4d4b-8a6b-e3bf5613c503","name":"output","value":"={{ $json.concatenated_message_content }}","type":"string"}]},"options":{}},"id":"81d148a9-693c-4180-b078-50f4f4275c6f","name":"Resposta da Tool postPedidos4","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-17392,-800]},{"parameters":{"fieldsToSummarize":{"values":[{"aggregation":"concatenate","field":"message.content"}]},"options":{}},"id":"5cd8ed9f-f275-4535-b944-81b6f8e9e9e9","name":"Concatenando String5","type":"n8n-nodes-base.summarize","typeVersion":1,"position":[-17728,-800]},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"messages":{"values":[{"content":"=O seu objetivo é executar a tool Carrinho() e mostrar todos os itens do carrinho total do  cliente\n \n ⚙️ REGRAS DE SAÍDA:\n- Se uma tool (função) retornar dados em formato JSON, NÃO reescreva, resuma ou formate como texto.\n- Apenas repasse o conteúdo JSON exato no output.\n- Não acrescente frases, títulos ou explicações.\n- Se precisar mostrar em texto, mantenha também o JSON original abaixo de forma literal.\n"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-18176,-800],"id":"7d135f0b-9905-414e-8546-f96d0e082246","name":"MinhasCompras","credentials":{"openAiApi":{"id":"YvUoOPijIpNeTjed","name":"OpenAi account"}}},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"item_pedido_temp","mode":"list","cachedResultName":"item_pedido_temp"},"deleteCommand":"delete","where":{"values":[{"column":"user_id","value":"= 1"},{"column":"status","condition":"!=","value":"concluido"},{"column":"id_empresa","value":"=1"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-18464,-800],"id":"cd20beb6-7029-451b-ba48-87633c2b6c04","name":"ExcluiRejeitados1","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-16080,-512],"id":"d9489dfb-f425-4f28-85e5-0bbc9ebb04c1","name":"No Operation, do nothing25","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"description":"Essa intenção de compra deve ser executada sempre que for solicitqado","workflowId":{"__rl":true,"value":"gL1FbKkYm9zGfCAA","mode":"list","cachedResultName":"Kernel Pizza"},"workflowInputs":{"mappingMode":"defineBelow","value":{"user_id":"=1","pedido_id":"= 16","id_empresa":"=1","rotina":4,"mensagem":"=Carrinho","telefone":"={{ $('Dados Lead').item.json.IdConversa }}","instance":"= {{ $('Dados Lead').item.json.instance }}","apikey":"={{ $('Dados Lead').item.json.apikey }}"},"matchingColumns":[],"schema":[{"id":"mensagem","displayName":"mensagem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"pedido_id","displayName":"pedido_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"rotina","displayName":"rotina","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"id_empresa","displayName":"id_empresa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"instance","displayName":"instance","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"apikey","displayName":"apikey","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-18096,-512],"id":"36246f4c-b7c8-41a9-999c-bf1a78979714","name":"Carrinho"},{"parameters":{"operation":"executeQuery","query":"select * from  cancela_pre_pedido(1, 16  ,1);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-18496,128],"id":"925e1807-4497-4176-bf5c-ca6b010e3723","name":"CancelarPedido","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"assignments":{"assignments":[{"id":"3a3fbf83-7260-4dfa-97f2-4f323816d776","name":"tool_call_id","value":"={{ $('Argumentos da Tools').item.json.id }}","type":"string"},{"id":"3c185636-3fe8-4d4b-8a6b-e3bf5613c503","name":"output","value":"={{ $json.concatenated_cancela_pre_pedido }}","type":"string"}]},"options":{}},"id":"08d7933d-1396-4d15-ba8d-5ebb8ffa493d","name":"Resposta da Tool postPedidos5","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-17792,-272]},{"parameters":{"fieldsToSummarize":{"values":[{"aggregation":"concatenate","field":"cancela_pre_pedido"}]},"options":{}},"id":"ebcf8795-7fb3-4cc5-ab92-f19b121d798f","name":"Concatenando String6","type":"n8n-nodes-base.summarize","typeVersion":1,"position":[-18128,-272]},{"parameters":{"operation":"executeQuery","query":"select * from  cancela_pre_pedido( {{ $('Concatena').item.json.user_id }}, {{ $('MergePedido').item.json.pedido_id }}  ,  \n {{ $('DadosEmpresa').item.json.id_empresa }});","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-18368,-272],"id":"7a7095e8-3a2d-4b99-ac6f-0492f0666c75","name":"CancelarPedido1","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"{\n  \"nodes\": [\n    {\n      \"parameters\": {\n        \"operation\": \"executeQuery\",\n        \"query\": \" \\nselect * from  busca_bebida_profundo({{ $('Dados Lead').item.json.id_empresa }},  '{{ $('Code4').item.json.categoria }}',   '{{ $('Bebida').item.json.nome_limpo }}',   '{{ $('Bebida').item.json.volume }}')\\n \",\n        \"options\": {}\n      },\n      \"type\": \"n8n-nodes-base.postgres\",\n      \"typeVersion\": 2.6,\n      \"position\": [\n        -672,\n        -496\n      ],\n      \"id\": \"a362b884-2915-4204-8722-cee59ddb55b7\",\n      \"name\": \"Execute a SQL query\",\n      \"alwaysOutputData\": true,\n      \"credentials\": {\n        \"postgres\": {\n          \"id\": \"3NLaVyXonSrCcLE3\",\n          \"name\": \"Postgres account\"\n        }\n      }\n    }\n  ],\n  \"connections\": {\n    \"Execute a SQL query\": {\n      \"main\": [\n        []\n      ]\n    }\n  },\n  \"pinData\": {},\n  \"meta\": {\n    \"templateCredsSetupCompleted\": true,\n    \"instanceId\": \"33738330930e3881dd5571eca013f36ddf8aab20e4ea5c1f2ebaf4a2b4668ac6\"\n  }\n}","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-19088,-2880],"id":"6565757e-8d87-43e3-aac0-d1bb329df50b","name":"Execute a SQL query","credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":" \nselect * from  BuscaProduto('{{ $json.arguments.nome }}', 1,  '{{ $json.arguments.categoria }}',      ' ')\n ","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-18096,-3744],"id":"31b29838-ab8c-42e9-b763-2c09fd7a6c5b","name":"Execute a SQL query2","alwaysOutputData":true,"credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":" \nselect * from  busca_bebida_profundo({{ $('Dados Lead').item.json.id_empresa }},  '{{ $('Code4').item.json.categoria }}',   '{{ $('Bebida').item.json.nome_limpo }}',   '{{ $('Bebida').item.json.volume }}')\n ","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-17728,-4032],"id":"5a13265c-6a48-46b5-ba0b-a90e9fac02ea","name":"Execute a SQL query3","alwaysOutputData":true,"credentials":{"postgres":{"id":"3NLaVyXonSrCcLE3","name":"Postgres account"}}},{"parameters":{"jsCode":" // 🔹 Captura o resultado do SQL (pode vir array ou objeto único)\nconst rows = $input.all().flatMap(item => {\n  if (Array.isArray(item.json)) return item.json;\n  return [item.json];\n});\n\n// 🔹 Se não veio nada, retorna mensagem padrão\nif (!rows.length) {\n  return [{ json: { mensagem: \"⚠️ Nenhum produto encontrado no cardápio.\" } }];\n}\n\n// 🔹 Monta a mensagem pro cliente\nlet mensagem = \"🍕 *Opções encontradas:*\\n\\n\";\n\nfor (const [i, r] of rows.entries()) {\n  mensagem += `${i + 1}️⃣ *${r.nome}*\\n`;\n  if (r.descricao) mensagem += `🧀 ${r.descricao}\\n`;\n  mensagem += `💰 Grande: R$ ${Number(r.preco_grande || 0).toFixed(2)} | Média: R$ ${Number(r.preco_medio || 0).toFixed(2)}\\n\\n`;\n}\n\nmensagem += \"👉 *Digite o número da pizza desejada* para continuar.\";\n\n// 🔹 Retorna todos os registros preservando o pareamento\nreturn rows.map((r, idx) => ({\n  json: {\n    numero: r.numero,\n    nome: r.nome,\n    categoria: r.categoria,\n    tipo: r.tipo,\n    preco_grande: r.preco_grande,\n    preco_medio: r.preco_medio,\n    preco_pequena: r.preco_pequena,\n    descricao: r.descricao,\n    mensagem\n  },\n  pairedItem: { item: idx }  // 🔸 mantém a thread e o run corretos\n}));\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-17856,-3760],"id":"70429686-f900-4418-8019-57d1eeebd1b6","name":"TrataSqlProduto"},{"parameters":{"jsCode":" // Lê as linhas do SQL e mantém o pareamento\nconst rows = $input.all();\n\n// Monta o texto final pro usuário\nlet mensagem = \"🍕 *Opções encontradas:*\\n\\n\";\n\nfor (const [i, item] of rows.entries()) {\n  const r = item.json;\n  mensagem += `${i + 1}️⃣ *${r.nome}*\\n`;\n  if (r.descricao) mensagem += `🧀 ${r.descricao}\\n`;\n  mensagem += `💰 Grande: R$ ${Number(r.preco_grande).toFixed(2)} | Média: R$ ${Number(r.preco_medio).toFixed(2)}\\n\\n`;\n}\n\nmensagem += \"👉 Escolha o número da opção desejada.\";\n\n// 🔹 Retorna com o pareamento preservado\nreturn rows.map((item, idx) => ({\n  json: {\n    ...item.json,\n    mensagem\n  },\n  pairedItem: { item: idx }\n}));\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-18768,-4592],"id":"01d939aa-8f5b-4147-a72f-5c0d761987ab","name":"TrataSqlProduto1","disabled":true},{"parameters":{"jsCode":" // Evita gravações duplicadas consecutivas\nconst data = $json;\n\n// Recupera cache em memória dentro do node\nif (!globalThis._lastIntent) globalThis._lastIntent = {};\n\nconst key = `${data.user_id || 0}-${data.numero || 0}-${data.tamanho || ''}`;\nconst now = Date.now();\n\n// Verifica se repetiu o mesmo pedido nos últimos 5 segundos\nif (\n  globalThis._lastIntent.key === key &&\n  now - (globalThis._lastIntent.time || 0) < 5000\n) {\n  return []; // Bloqueia duplicação\n}\n\n// Atualiza cache\nglobalThis._lastIntent = { key, time: now };\n\n// Retorna normalmente o dado\nreturn [{ json: data }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-18256,-3152],"id":"15c5470b-ab4f-418d-ba3f-42db73c91642","name":"Code","executeOnce":true}],"connections":{"Simplificação de Dados":{"main":[[{"node":"Buscar Cliente","type":"main","index":0}]]},"Filtro Inicial":{"main":[[{"node":"Simplificação de Dados","type":"main","index":0}]]},"Buscar Cliente":{"main":[[{"node":"Cliente Existe?","type":"main","index":0}]]},"Cliente Existe?":{"main":[[{"node":"Buscar Cliente1","type":"main","index":0}],[{"node":"[OpenAI] Criar Thread","type":"main","index":0}]]},"Criar Cliente":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Merge":{"main":[[{"node":"EncontrarPedido","type":"main","index":0}]]},"[OpenAI] Criar Thread":{"main":[[{"node":"Criar Cliente","type":"main","index":0}]]},"[OpenAI] Criar Run":{"main":[[{"node":"Espera 3 seg","type":"main","index":0}]]},"Espera 3 seg":{"main":[[{"node":"[OpenAI] Buscar Status da Run","type":"main","index":0}]]},"[OpenAI] Listar Runs":{"main":[[{"node":"[OpenAI] Cancelar Run","type":"main","index":0}]]},"[OpenAI] Adicionar Mensagem na Thread":{"main":[[{"node":"[OpenAI] Criar Run","type":"main","index":0}],[{"node":"[OpenAI] Listar Runs","type":"main","index":0}]]},"[OpenAI] Cancelar Run":{"main":[[{"node":"[OpenAI] Adicionar Mensagem na Thread","type":"main","index":0}]]},"Split Out":{"main":[[{"node":"Dados individuais das tools","type":"main","index":0}]]},"Dados individuais das tools":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Argumentos da Tools":{"main":[[{"node":"Switch","type":"main","index":0}]]},"[OpenAI] Buscar Status da Run":{"main":[[{"node":"Qual o status da Run?","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"Edit Fields5","type":"main","index":0}]]},"Edit Fields5":{"main":[[{"node":"Responder a Function Calling","type":"main","index":0}]]},"Parâmentros das Tools":{"main":[[{"node":"Split Out","type":"main","index":0}]]},"Qual o status da Run?":{"main":[[{"node":"Parâmentros das Tools","type":"main","index":0}],[{"node":"[OpenAI] Listar Mensagens Thread","type":"main","index":0}],[{"node":"Espera 3 seg","type":"main","index":0}],[{"node":"Stop and Error","type":"main","index":0}]]},"Buscar Produtos pelo Nome":{"main":[[{"node":"Merge1","type":"main","index":0}]]},"Concatenando String":{"main":[[{"node":"Resposta da Tool Get_Pizza","type":"main","index":0}]]},"Loop Over Items":{"main":[[{"node":"Aggregate","type":"main","index":0}],[{"node":"Argumentos da Tools","type":"main","index":0}]]},"Responder a Function Calling":{"main":[[{"node":"Espera 3 seg","type":"main","index":0}]]},"[OpenAI] Listar Mensagens Thread":{"main":[[{"node":"MenuCardapio44","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Execute a SQL query2","type":"main","index":0}],[{"node":"Code","type":"main","index":0}]]},"Switch1":{"main":[[{"node":"Buscar Produtos pelo Nome","type":"main","index":0}],[{"node":"Buscar protudos pela categoria","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Filtro Inicial","type":"main","index":0}]]},"Buscar protudos pela categoria":{"main":[[{"node":"Merge1","type":"main","index":1}]]},"Buscar Cliente1":{"main":[[{"node":"Merge","type":"main","index":0}]]},"MenuCardapio44":{"main":[[{"node":"No Operation, do nothing","type":"main","index":0}]]},"item1":{"main":[[{"node":"Loop Over Items2","type":"main","index":0}]]},"Resposta da Tool postPedidos":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"CriaPedido":{"main":[[{"node":"Merge2","type":"main","index":1}]]},"Cliente Pedido":{"main":[[{"node":"Merge2","type":"main","index":0}],[{"node":"CriaPedido","type":"main","index":0}]]},"EncontrarPedido":{"main":[[{"node":"Cliente Pedido","type":"main","index":0}]]},"Construindo String4":{"main":[[{"node":"Resposta da Tool GetPedidos","type":"main","index":0}]]},"Resposta da Tool GetPedidos":{"main":[[{"node":"[OpenAI] Adicionar Mensagem na Thread","type":"main","index":0}]]},"Resposta da Tool Get_Pizza":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"If":{"main":[[{"node":"Item","type":"main","index":0}]]},"Loop Over Items2":{"main":[[],[{"node":"ConsultaBorda1","type":"main","index":0}]]},"Encontrar Cliente1":{"main":[[{"node":"Cliente Existe?1","type":"main","index":0}]]},"Cliente Existe?1":{"main":[[{"node":"Concatena","type":"main","index":0}],[{"node":"[OpenAI] Criar Thread1","type":"main","index":0}]]},"Dados Lead":{"main":[[{"node":"Execute a SQL query1","type":"main","index":0}]]},"Parametros Fluxo":{"main":[[{"node":"Filtro Inicial1","type":"main","index":0}]]},"Concatena":{"main":[[{"node":"Merge4","type":"main","index":0}],[{"node":"Merge4","type":"main","index":1}]]},"Filtro Inicial1":{"main":[[{"node":"Dados Lead","type":"main","index":0}]]},"MergePedido":{"main":[[{"node":"Construindo String4","type":"main","index":0}]]},"Transcrever Áudio1":{"main":[[{"node":"Add Audio Buffer1","type":"main","index":0}]]},"OpenAI1":{"main":[[{"node":"Add Imagem Buffer1","type":"main","index":0}]]},"Wait1":{"main":[[{"node":"Buffer 3","type":"main","index":0}]]},"Buffer ":{"main":[[{"node":"Wait1","type":"main","index":0}]]},"Buffer 3":{"main":[[{"node":"ComparandoMensagens1","type":"main","index":0}]]},"Add Texto Buffer1":{"main":[[{"node":"Buffer ","type":"main","index":0}]]},"Apagar Buffer1":{"main":[[{"node":"FielsMsgBuffer","type":"main","index":0}]]},"Mensagem Texto1":{"main":[[{"node":"Add Texto Buffer1","type":"main","index":0}]]},"Mensagem Audio1":{"main":[[{"node":"Convert to File1","type":"main","index":0}]]},"Mensagem Imagem1":{"main":[[{"node":"Convert to File","type":"main","index":0}]]},"Add Audio Buffer1":{"main":[[{"node":"Buffer ","type":"main","index":0}]]},"Add Error Buffer1":{"main":[[{"node":"Buffer ","type":"main","index":0}]]},"Extract from File":{"main":[[{"node":"Add PDF Buffer1","type":"main","index":0}]]},"Mensagem Erro1":{"main":[[{"node":"Add Error Buffer1","type":"main","index":0}]]},"Add PDF Buffer1":{"main":[[{"node":"Buffer ","type":"main","index":0}]]},"Add Imagem Buffer1":{"main":[[{"node":"Buffer ","type":"main","index":0}]]},"Redis":{"main":[[{"node":"Bot Desativado?1","type":"main","index":0}]]},"Bot Desativado?1":{"main":[[{"node":"No Operation, do nothing1","type":"main","index":0}],[{"node":"Switch2","type":"main","index":0}]]},"Mensagem Documento PDF":{"main":[[{"node":"Convert to File2","type":"main","index":0}]]},"Convert to File":{"main":[[{"node":"OpenAI1","type":"main","index":0}]]},"Convert to File1":{"main":[[{"node":"Transcrever Áudio1","type":"main","index":0}]]},"Convert to File2":{"main":[[{"node":"Extract from File","type":"main","index":0}]]},"Mensagem Texto2":{"main":[[{"node":"Add Texto Buffer1","type":"main","index":0}]]},"MensagemTraduzida":{"main":[[{"node":"Encontrar Cliente1","type":"main","index":0}]]},"Execute a SQL query1":{"main":[[{"node":"DadosEmpresa","type":"main","index":0}]]},"DadosEmpresa":{"main":[[{"node":"MensagemTraduzida","type":"main","index":0}]]},"Normalizador":{"main":[[{"node":"Validador","type":"main","index":0}]]},"ComparandoMensagens1":{"main":[[{"node":"Apagar Buffer1","type":"main","index":0}],[{"node":"No Operation, do nothing6","type":"main","index":0}]]},"Criar Cliente2":{"main":[[{"node":"Concatena","type":"main","index":0}]]},"Merge4":{"main":[[{"node":"EncontrarPedido1","type":"main","index":0}]]},"Webhook1":{"main":[[{"node":"Parametros Fluxo","type":"main","index":0}]]},"CriaPedido1":{"main":[[{"node":"MergePedido","type":"main","index":1}]]},"Cliente Pedido1":{"main":[[{"node":"MergePedido","type":"main","index":0}],[{"node":"CriaPedido1","type":"main","index":0}]]},"EncontrarPedido1":{"main":[[{"node":"Cliente Pedido1","type":"main","index":0}]]},"Switch2":{"main":[[{"node":"Mensagem Texto1","type":"main","index":0}],[{"node":"Mensagem Texto2","type":"main","index":0}],[{"node":"Mensagem Audio1","type":"main","index":0}],[{"node":"Mensagem Imagem1","type":"main","index":0}],[{"node":"Mensagem Documento PDF","type":"main","index":0}],[{"node":"Mensagem Erro1","type":"main","index":0}]]},"[OpenAI] Criar Thread1":{"main":[[{"node":"Criar Cliente2","type":"main","index":0}]]},"ConsultaOnline":{"ai_tool":[[{"node":"ConsultaProduto","type":"ai_tool","index":0}]]},"Concatenando String1":{"main":[[{"node":"Resposta da Tool postPedidos","type":"main","index":0}]]},"IntencaoCompra":{"ai_tool":[[{"node":"AdicionaItemCompra","type":"ai_tool","index":0}]]},"Concatenando String2":{"main":[[{"node":"Resposta da Tool postPedidos1","type":"main","index":0}]]},"Resposta da Tool postPedidos1":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Compras":{"ai_tool":[[{"node":"GetCarrinho","type":"ai_tool","index":0}]]},"Concatenando String3":{"main":[[{"node":"Resposta da Tool postPedidos2","type":"main","index":0}]]},"IntencaoCompraBordaItem":{"ai_tool":[[{"node":"AddBordaItem","type":"ai_tool","index":0}]]},"AddBordaItem":{"main":[[{"node":"Concatenando String3","type":"main","index":0}]]},"GetCarrinho":{"main":[[{"node":"Concatenando String2","type":"main","index":0}]]},"AdicionaItemCompra":{"main":[[{"node":"Concatenando String1","type":"main","index":0}]]},"ConsultaProduto":{"main":[[]]},"Concatenando String4":{"main":[[{"node":"Resposta da Tool postPedidos3","type":"main","index":0}]]},"AdicionaItemCompraFracionada":{"main":[[{"node":"Concatenando String4","type":"main","index":0}]]},"IntencaoCompraFracionada":{"ai_tool":[[{"node":"AdicionaItemCompraFracionada","type":"ai_tool","index":0}]]},"Resposta da Tool postPedidos2":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Resposta da Tool postPedidos3":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Concatenando String5":{"main":[[{"node":"Resposta da Tool postPedidos4","type":"main","index":0}]]},"MinhasCompras":{"main":[[{"node":"Concatenando String5","type":"main","index":0}]]},"Resposta da Tool postPedidos4":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"ExcluiRejeitados1":{"main":[[{"node":"MinhasCompras","type":"main","index":0}]]},"Carrinho":{"ai_tool":[[{"node":"MinhasCompras","type":"ai_tool","index":0}]]},"Concatenando String6":{"main":[[{"node":"Resposta da Tool postPedidos5","type":"main","index":0}]]},"Resposta da Tool postPedidos5":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"CancelarPedido1":{"main":[[{"node":"Concatenando String6","type":"main","index":0}]]},"Execute a SQL query2":{"main":[[{"node":"TrataSqlProduto","type":"main","index":0}]]},"TrataSqlProduto":{"main":[[{"node":"Concatenando String","type":"main","index":0}]]},"Code":{"main":[[{"node":"AdicionaItemCompra","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook1":[{"json":{"headers":{"host":"n8n.lglducci.com.br","user-agent":"axios/1.7.7","content-length":"936","accept-encoding":"gzip, br","cdn-loop":"cloudflare; loops=1","cf-connecting-ip":"159.69.117.195","cf-ipcountry":"DE","cf-ray":"9945e7070e599761-FRA","cf-visitor":"{\"scheme\":\"https\"}","content-type":"application/json","x-forwarded-for":"172.69.151.153","x-forwarded-host":"n8n.lglducci.com.br","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"traefik_traefik.1","x-real-ip":"172.69.151.153"},"params":{},"query":{},"body":{"event":"messages.upsert","instance":"LaCantina","data":{"key":{"remoteJid":"5516992975836@s.whatsapp.net","fromMe":false,"id":"3EB093AE17FC6ACEBD5B2C"},"pushName":"Luis Gustavo Landucci","message":{"conversation":"2 media","messageContextInfo":{"deviceListMetadata":{"senderKeyHash":"2uKRt0FvHGKKWg==","senderTimestamp":"1760382036","senderAccountType":"E2EE","receiverAccountType":"E2EE","recipientKeyHash":"wPv/XIryFk6EMg==","recipientTimestamp":"1760388519"},"deviceListMetadataVersion":2,"messageSecret":"NV3HUjeDICpXzKYGLpHv60zvj98oDPU8EPnIonBpHSo="}},"messageType":"conversation","messageTimestamp":1761439227,"instanceId":"cd2747c1-47c6-49d2-9649-45970ef316b7","source":"web"},"destination":"https://n8n.lglducci.com.br/webhook-test/fluxovendas","date_time":"2025-10-25T21:40:27.953Z","sender":"5516994066336@s.whatsapp.net","server_url":"https://evolution.lglducci.com.br","apikey":"E9C6EA4E47E7-4905-BC38-475CBACA3F1E"},"webhookUrl":"https://webhook.lglducci.com.br/webhook-test/fluxovendas","executionMode":"test"}}]},"versionId":"bcb64a36-1bf6-4b06-99ef-f1fdc2bbad4c","triggerCount":2,"shared":[{"createdAt":"2025-09-17T13:36:13.881Z","updatedAt":"2025-09-17T13:36:13.881Z","role":"workflow:owner","workflowId":"SiJ02hfQVfAPp3e3","projectId":"wFRMrac2003Pl1x6"}],"tags":[{"createdAt":"2025-09-17T12:33:06.943Z","updatedAt":"2025-09-17T12:33:06.943Z","id":"oyNaKLDpb8MjOTKe","name":"Modelo"},{"createdAt":"2025-09-17T12:33:06.936Z","updatedAt":"2025-09-17T12:33:06.936Z","id":"JeuuFBr3ONlGRlp1","name":"Formação Assistants"},{"createdAt":"2025-09-08T21:48:39.874Z","updatedAt":"2025-09-08T21:48:39.874Z","id":"ffKYKgI8Ro1kMAIk","name":"NoCode StartUp"}]}