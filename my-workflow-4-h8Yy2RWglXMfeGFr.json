{"createdAt":"2025-09-07T01:19:43.994Z","updatedAt":"2025-09-07T01:19:43.994Z","id":"h8Yy2RWglXMfeGFr","name":"My workflow 4","active":false,"isArchived":false,"nodes":[{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.chatTrigger","typeVersion":1.3,"position":[-816,224],"id":"8711e398-e2b0-45e2-8c25-724befa49c56","name":"When chat message received","webhookId":"c217fc34-0e3e-4fa1-bd5d-29adfb962e7c"},{"parameters":{"options":{"systemMessage":"Você é um especialista em criar plano de conta completo para usuario..   Usuaario vai informar qual o setor que ele trabalha e vc vai sugerir um plano de conta em pdf. "}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[-608,224],"id":"a8b9b894-57cf-4ffe-852e-8b6328e0d8e0","name":"AI Agent"},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-832,384],"id":"85bc6956-d6aa-456c-9de6-8662491f6ca6","name":"OpenAI Chat Model"},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[-608,432],"id":"9219306c-8495-427a-8187-adcc010bf847","name":"Simple Memory"},{"parameters":{"jsCode":" // Pega o texto do agente (ajuste o nome do campo se precisar)\nconst raw = ($json.output || $json.text || $json.message || '').toString();\n\n// ===== helpers =====\nconst esc = (s) => s\n  .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');\n\nconst unbold = (s) => s.replace(/\\*\\*(.+?)\\*\\*/g, '$1');        // tira **...**\nconst strong = (s) => s.replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>');\n\n// Parser de linhas com níveis: \"- 1.1.2 Título\" → depth = número de pontos + 1\nfunction renderBody(text) {\n  const lines = text.replace(/\\r/g,'').split('\\n').map(l => l.trim()).filter(Boolean);\n\n  let html = '';\n  let depth = 0;\n\n  const closeTo = (d) => { while (depth > d) { html += '</ol>'; depth--; } };\n  const openTo  = (d) => { while (depth < d) { html += '<ol>'; depth++; } };\n\n  for (const line of lines) {\n    // Título principal (ex.: **Plano de Contas para Pizzaria**)\n    if (/^\\*{2}.+?\\*{2}$/.test(line)) {\n      closeTo(0);\n      html += `<h2>${strong(esc(unbold(line)))}</h2>`;\n      continue;\n    }\n\n    // Seções tipo \"1. **Receitas**\"\n    const mSection = line.match(/^(\\d+)\\.\\s+(.+)$/);\n    if (mSection && /\\*\\*/.test(mSection[2])) {\n      closeTo(0);\n      const title = strong(esc(unbold(mSection[2])));\n      html += `<h2>${mSection[1]}. ${title}</h2>`;\n      continue;\n    }\n\n    // Itens numerados: \"- 1.1.3 Alguma coisa\" (com possibilidade de subníveis)\n    const mItem = line.match(/^-+\\s*((\\d+)(\\.\\d+){0,6})\\s+(.+)$/);\n    if (mItem) {\n      const code = mItem[1];\n      const title = mItem[4];\n      const d = code.split('.').length; // nível pelo número de pontos\n      openTo(d);\n      html += `<li>${esc(code)} ${strong(esc(unbold(title)))}</li>`;\n      continue;\n    }\n\n    // Texto solto: ignora prefácio do agente (ex.: \"Claro! Vou preparar...\")\n    // Se quiser manter, descomente abaixo:\n    // if (line && !/^---$/.test(line)) {\n    //   closeTo(0);\n    //   html += `<p>${strong(esc(unbold(line)))}</p>`;\n    // }\n  }\n\n  closeTo(0);\n  return html || `<p class=\"muted\">Nenhum conteúdo estruturado encontrado.</p>`;\n}\n\nconst titleMatch = raw.match(/\\*\\*Plano de Contas.+?\\*\\*/i);\nconst titulo = titleMatch ? unbold(titleMatch[0]).replace(/^\\*\\*|\\*\\*$/g,'') : 'Plano de Contas';\n\nconst body = renderBody(raw);\n\n// ===== HTML completo A4 pronto pra PDF =====\nconst html = `<!doctype html>\n<html lang=\"pt-br\"><head>\n<meta charset=\"utf-8\">\n<title>${esc(titulo)}</title>\n<style>\n  @page { size: A4; margin: 20mm 16mm 20mm 16mm; }\n  html, body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,Arial,sans-serif; color:#111827; }\n  h1 { font-size:22pt; margin:0 0 6mm 0; }\n  h2 { font-size:14pt; margin:8mm 0 2mm; }\n  ol { margin:0; padding-left:5mm; }\n  ol > li { margin:1mm 0; }\n  .brand { display:flex; align-items:center; gap:10px; margin-bottom:4mm; }\n  .brand-badge { background:#0EA5E9; color:#fff; padding:6px 10px; border-radius:8px; font-weight:600; font-size:11pt; }\n  .meta { color:#6B7280; font-size:10pt; }\n  .header-line { height:4px; background: linear-gradient(90deg,#0EA5E9,#F59E0B); border-radius:2px; margin:4mm 0 6mm; }\n  footer { position: fixed; bottom: -5mm; left:0; right:0; height:12mm; color:#6B7280; font-size:10pt; }\n  footer .inner { display:flex; justify-content:space-between; padding: 0 16mm; }\n  .pagenum:before { content: counter(page); }\n  .totalpages:before { content: counter(pages); }\n  .muted { color:#6B7280; }\n</style>\n</head>\n<body>\n  <div class=\"brand\">\n    <div class=\"brand-badge\">SuaPlataforma</div>\n    <div>\n      <div style=\"font-weight:700;\">${esc(titulo)}</div>\n      <div class=\"meta\">Gerado via agente — ${new Date().toLocaleString('pt-BR')}</div>\n    </div>\n  </div>\n  <div class=\"header-line\"></div>\n  ${body}\n  <footer><div class=\"inner\"><div>${esc(titulo)}</div><div>Página <span class=\"pagenum\"></span> / <span class=\"totalpages\"></span></div></div></footer>\n</body></html>`;\n\n// === Saída: 1) json.html para debug  2) binary 'files' para Gotenberg ===\nconst binary = {\n  files: {\n    data: Buffer.from(html, 'utf8').toString('base64'),\n    mimeType: 'text/html',\n    fileName: 'index.html',\n  }\n};\n\nreturn [{ json: { html }, binary }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-240,288],"id":"180d8f46-1172-493a-8937-4bf1495e0745","name":"Code"},{"parameters":{"method":"POST","url":"https://gotenberggotenberg8-production-8d7d.up.railway.app/forms/chromium/convert/html","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"files","inputDataFieldName":"file"}]},"options":{"response":{"response":{"responseFormat":"file","outputPropertyName":"=balanconiveis.pdf"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[240,240],"id":"fe2d4d91-e18c-4912-93d7-0f936134523f","name":"HTTP Request16"},{"parameters":{"jsCode":" // garante que entrou um item com binário\nconst item = items[0];\nconst bins = item.binary || {};\nconst keys = Object.keys(bins);\nif (!keys.length) {\n  throw new Error('Nenhum binário no input. No HTTP Request (Gotenberg), ative Download=ON e Response=File.');\n}\n\n// escolhe o PDF: por mimeType, por extensão .pdf, ou o primeiro\nconst pdfKey =\n  keys.find(k => (bins[k].mimeType || '').includes('pdf')) ||\n  keys.find(k => k.toLowerCase().endsWith('.pdf')) ||\n  keys[0];\n\nconst pdf = bins[pdfKey];\nif (!pdf) {\n  throw new Error('PDF não encontrado. Binários disponíveis: ' + keys.join(', '));\n}\n\n// nome do arquivo\nconst fileName = item.json.fileName || pdf.fileName || 'relatorio.pdf';\n\n// sai com base64 + fileName para o próximo nó\nreturn [{\n  json: {\n    base64: pdf.data,                 // JÁ é base64\n    fileName: fileName                // ex.: relatorio-2025-08-20.pdf\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[496,240],"id":"8d68b225-4a20-4418-960b-f034d6e184f9","name":"Code20"},{"parameters":{"operation":"toText","sourceProperty":"html","binaryPropertyName":"=file","options":{"encoding":"utf8","fileName":"index.html"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[0,240],"id":"095f28fe-5359-49da-819e-b178e53a53d4","name":"Convert to File11"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[944,240],"id":"d06974a1-446c-4ef9-9418-a00f0b722e84","name":"No Operation, do nothing24","notes":"TEMPLATE DESENVOLVIDO POR NOCODE STARTUP\nhttps://nocodestartup.io/\n\nFORMAÇÃO GESTOR DE AGENTES DE IA:\nhttps://nocodestartup.io/formacao-gestor-agentes-ia/"},{"parameters":{"method":"POST","url":"=https://apinocode01.megaapi.com.br/rest/sendMessage/megacode-Mp5VTYM2qds/mediaBase64","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Client-Token","value":"application/json"},{"name":"Authorization","value":"Bearer Mp5VTYM2qds"}]},"sendBody":true,"specifyBody":"json","jsonBody":"= {\n  \"messageData\": {\n    \"to\": \"5516992975836\",\n    \"type\": \"document\",\n    \"caption\": \"Segue relatório de modelos\",\n    \"fileName\": \"{{ $node['gerahtml9'].json.fileName || 'balanconiveis.pdf' }}\",\n    \"mimeType\": \"application/pdf\",\n    \"base64\": \"data:application/pdf;base64, {{ $json.base64 }}\"\n  }\n}\n ","options":{}},"id":"faeb49eb-9c8c-4e0c-9a4c-7bcfb7f3157a","name":"MegaApi12","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[720,240]},{"parameters":{"jsCode":" // Texto do agente (ajuste o campo se necessário)\nconst raw = ($json.output || $json.text || $json.message || '').toString();\n\n// Helpers\nconst escBoldOut = (s) => s.replace(/\\*\\*(.+?)\\*\\*/g, '$1');\n\n// Filtra linhas úteis\nconst lines = raw\n  .replace(/\\r/g,'')\n  .split('\\n')\n  .map(l => l.trim())\n  .filter(l =>\n    l &&\n    l !== '---' &&\n    !/^\\[Gerando PDF/i.test(l) &&\n    !/^Claro!/i.test(l) &&\n    !/^Depois de criar/i.test(l) &&\n    !/^Por favor/i.test(l) &&\n    !/^Eu vou gerar/i.test(l)\n  );\n\nlet grupoAtual = '';           // Ex.: \"Receitas\", \"Custos\"...\nlet raizGrupoAtual = '';       // Ex.: \"1\", \"2\", ...\nconst rows = [];\n\n// Mapeia natureza por grupo (ajuste se quiser)\nfunction naturezaDoGrupo(grupo) {\n  const g = (grupo || '').toLowerCase();\n  if (g.includes('receita') || g.includes('passivo')) return 'C';\n  if (g.includes('custo') || g.includes('despesa') || g.includes('ativo')) return 'D';\n  return '';\n}\n\nfor (const line of lines) {\n  // Seção tipo: \"1. **Receitas**\"\n  const sec = line.match(/^(\\d+)\\.\\s+\\*\\*(.+?)\\*\\*/);\n  if (sec) {\n    raizGrupoAtual = sec[1];\n    grupoAtual = escBoldOut(sec[2]);\n    continue;\n  }\n\n  // Item tipo: \"- 1.1.3 Nome da Conta\"\n  const it = line.match(/^-+\\s*((\\d+)(?:\\.\\d+)*)\\s+(.+)$/);\n  if (it) {\n    const codigo = it[1];\n    const nome = escBoldOut(it[3]);\n    const nivel = codigo.split('.').length;\n    const codigo_pai = nivel > 1 ? codigo.slice(0, codigo.lastIndexOf('.')) : (raizGrupoAtual || '');\n    const grupo = grupoAtual;\n    const natureza = naturezaDoGrupo(grupo);\n\n    rows.push({ codigo, nome, grupo, natureza, nivel, codigo_pai });\n  }\n}\n\n// CSV\nfunction csvEscape(v) {\n  if (v === null || v === undefined) return '';\n  const s = String(v);\n  return /[\",\\n]/.test(s) ? `\"${s.replace(/\"/g,'\"\"')}\"` : s;\n}\nconst headers = ['codigo','nome','grupo','natureza','nivel','codigo_pai'];\nconst csv = [\n  headers.join(','),\n  ...rows.map(r => headers.map(h => csvEscape(r[h])).join(','))\n].join('\\n');\n\n// Saída: binário para próximo nó (HTTP Response, Drive, e-mail etc.)\nreturn [{\n  json: { linhas: rows.length },\n  binary: {\n    file: {\n      data: Buffer.from(csv, 'utf8').toString('base64'),\n      mimeType: 'text/csv',\n      fileName: 'plano-contas-pizzaria.csv'\n    }\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[0,0],"id":"118cb4ff-1dfb-4e9e-a941-44aead5849c7","name":"Code1"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-720,448],"id":"40a1fce5-bf99-44ed-80c2-b06d4c714e65","name":"Google Gemini Chat Model"}],"connections":{"When chat message received":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Simple Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"AI Agent":{"main":[[{"node":"Code1","type":"main","index":0},{"node":"Code","type":"main","index":0}]]},"HTTP Request16":{"main":[[{"node":"Code20","type":"main","index":0}]]},"Code20":{"main":[[{"node":"MegaApi12","type":"main","index":0}]]},"Convert to File11":{"main":[[{"node":"HTTP Request16","type":"main","index":0}]]},"MegaApi12":{"main":[[{"node":"No Operation, do nothing24","type":"main","index":0}]]},"Code":{"main":[[{"node":"Convert to File11","type":"main","index":0}]]},"Google Gemini Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"dcf89369-af29-475b-aefb-9e0e19586cd8","triggerCount":0,"shared":[{"createdAt":"2025-09-07T01:19:43.994Z","updatedAt":"2025-09-07T01:19:43.994Z","role":"workflow:owner","workflowId":"h8Yy2RWglXMfeGFr","projectId":"wFRMrac2003Pl1x6"}],"tags":[]}