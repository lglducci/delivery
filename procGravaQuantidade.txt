 CREATE OR REPLACE FUNCTION GravaQuantidade(
  p_user_id     integer,
  p_id_empresa  integer,
  p_quantidade  integer
)
RETURNS jsonb
LANGUAGE plpgsql
AS $$
DECLARE
  v_categoria text;
  v_etapa text;
BEGIN
  IF coalesce(p_quantidade,0) <= 0 THEN
    RETURN jsonb_build_object('acao','erro','mensagem','Quantidade invÃ¡lida');
  END IF;

  SELECT categoria INTO v_categoria
  FROM turno_opcoes
  WHERE user_id = p_user_id
    AND id_empresa = p_id_empresa
    AND escolhido = true
  LIMIT 1;

  IF NOT FOUND THEN
    RETURN jsonb_build_object('acao','erro','mensagem','Nenhum item selecionado');
  END IF;

  IF v_categoria = 'pizza' THEN
    v_etapa := 'falta_tamanho';
  ELSE
    v_etapa := 'ready';
  END IF;

  UPDATE turno_opcoes
     SET quantidade = p_quantidade,
         etapa = v_etapa,
         updated_at = now()
   WHERE user_id = p_user_id
     AND id_empresa = p_id_empresa
     AND escolhido = true;

  -- ðŸ”¹ retorno orientado Ã  IA
  IF v_etapa = 'falta_tamanho' THEN
    RETURN jsonb_build_object(
      'acao','pedir_tamanho',
      'mensagem','Qual tamanho da pizza vocÃª quer? (mÃ©dia ou grande)'
    );
  ELSE
    RETURN jsonb_build_object(
      'acao','gravaintencao',
      'mensagem','Beleza, anotado! Gravando sua escolha...'
    );
  END IF;
END;
$$;
