   

 CREATE OR REPLACE FUNCTION buscar_numero_por_posicao(
  p_user_id     integer,
  p_id_empresa  integer,
  p_posicao     integer
)
RETURNS SETOF jsonb
LANGUAGE plpgsql
AS $$
DECLARE
  v_row jsonb;
BEGIN
  -- Marca o item escolhido nessa posição
  UPDATE turno_opcoes
     SET escolhido = true
   WHERE user_id    = p_user_id
     AND id_empresa = p_id_empresa
     AND posicao    = p_posicao;

  -- Elimina outras opções não escolhidas
  DELETE FROM turno_opcoes
   WHERE user_id    = p_user_id
     AND id_empresa = p_id_empresa
     AND posicao   <> p_posicao
     AND COALESCE(escolhido,false) = false;

  -- Avança a etapa conforme tua regra centralizada
  PERFORM adianta_etapa(p_user_id, p_id_empresa);

  -- Retorna o registro ATUALIZADO dessa posição
  SELECT row_to_json(t.*)::jsonb
    INTO v_row
    FROM turno_opcoes t
   WHERE t.user_id = p_user_id
     AND t.id_empresa = p_id_empresa
     AND t.posicao = p_posicao
   LIMIT 1;
  
 RETURN QUERY
WITH b AS (
  SELECT t.*,
         COUNT(*)  OVER (PARTITION BY t.user_id, t.id_empresa) AS total,
         SUM(CASE WHEN t.escolhido THEN 1 ELSE 0 END) OVER (PARTITION BY t.user_id, t.id_empresa) AS escolhidos
  FROM turno_opcoes t
  WHERE t.user_id = p_user_id
    AND t.id_empresa = p_id_empresa
),
e AS (
  SELECT b.*,
         CASE
           WHEN b.total > 1 AND COALESCE(b.escolhidos,0)=0 THEN 'pedir_posicao'
           WHEN COALESCE(b.numero,0)=0 THEN 'pedir_numero' 
           WHEN b.categoria IN ('pizza','esfirra') AND ( ( b.tamanho IS NULL OR b.tamanho='') and b.quantidade > 0) THEN 'pedir_tamanho'
           WHEN COALESCE(b.quantidade,0)=0 THEN 'pedir_qtd'
           ELSE 'ready'
         END AS etapa_calc
  FROM b
)
SELECT
  row_to_json(e.*)::jsonb ||
  jsonb_build_object(
    'etapa', e.etapa_calc,
    'acao', e.etapa_calc,
    'mensagem',
      CASE
        WHEN e.etapa_calc='pedir_posicao'  THEN 'Qual opção da lista você escolhe? (1–N)'
        WHEN e.etapa_calc='pedir_numero'   THEN 'Digite o número do item desejado.'
       WHEN e.etapa_calc='pedir_qtd'      THEN 'Quantas unidades você deseja desse item?'
        WHEN e.etapa_calc='pedir_tamanho'  THEN 'Qual tamanho você quer? (média ou grande)' 
        WHEN e.etapa_calc='ready'          THEN 'Item pronto para gravação. Confirma? (Sim/Não)'
        ELSE NULL
      END
  )
FROM e;  -- ✅ aqui é o que faltava

 
 
END;
$$;



