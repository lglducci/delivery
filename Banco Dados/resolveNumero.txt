  

 CREATE OR REPLACE FUNCTION buscar_numero_por_posicao(
  p_user_id     integer,
  p_id_empresa  integer,
  p_posicao     integer
)
RETURNS jsonb
LANGUAGE plpgsql
AS $$
DECLARE
  v_row jsonb;
BEGIN
  -- Marca o item escolhido nessa posi√ß√£o
  UPDATE turno_opcoes
     SET escolhido = true
   WHERE user_id    = p_user_id
     AND id_empresa = p_id_empresa
     AND posicao    = p_posicao;

  -- Elimina outras op√ß√µes n√£o escolhidas
  DELETE FROM turno_opcoes
   WHERE user_id    = p_user_id
     AND id_empresa = p_id_empresa
     AND posicao   <> p_posicao
     AND COALESCE(escolhido,false) = false;

  -- Avan√ßa a etapa conforme tua regra centralizada
  PERFORM adianta_etapa(p_user_id, p_id_empresa);

  -- Retorna o registro ATUALIZADO dessa posi√ß√£o
  SELECT row_to_json(t.*)::jsonb
    INTO v_row
    FROM turno_opcoes t
   WHERE t.user_id = p_user_id
     AND t.id_empresa = p_id_empresa
     AND t.posicao = p_posicao
   LIMIT 1;
 
IF v_row IS NULL THEN
  RETURN jsonb_build_object('erro','nenhum_item','posicao',p_posicao);
END IF;

-- üîπ Detecta se a escolha j√° fecha o ciclo (quantidade + tamanho ok, ou categoria ‚â† pizza)
IF (
     (lower(v_row->>'categoria') = 'pizza'
       AND length(btrim(coalesce(v_row->>'tamanho',''))) > 0
       AND (v_row->>'quantidade') IS NOT NULL)
     OR
     (lower(v_row->>'categoria') <> 'pizza'
       AND (v_row->>'quantidade') IS NOT NULL)
   ) THEN
  RETURN jsonb_build_object(
    'acao', 'GravaIntencao',
    'mensagem', 'Perfeito! Item completo, pronto para grava√ß√£o. üçï',
    'item', v_row
  );
END IF;

-- üîπ Caso contr√°rio, apenas devolve o item escolhido
RETURN v_row;
 
END;
$$;



