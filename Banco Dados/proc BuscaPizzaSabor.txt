 DROP FUNCTION IF EXISTS BuscaPizzaSabor(text, integer);

CREATE OR REPLACE FUNCTION BuscaPizzaSabor(
  p_texto      text,
  p_id_empresa int
)
RETURNS TABLE(
  numero        bigint,
  nome          text,
  categoria     text,
  tipo          text,
  preco_grande  real,
  preco_medio   real,
  preco_pequena real,
  descricao     text
)
LANGUAGE plpgsql
AS $$
DECLARE
  v_p1 text;
  v_p2 text;
  v_p3 text;
  v_termos text[];
  v_qtde int;
BEGIN
  -- Divide o texto em até 3 palavras
  v_termos := regexp_split_to_array(unaccent(lower(trim(p_texto))), '\s+');
  v_p1 := COALESCE(v_termos[1], '');
  v_p2 := COALESCE(v_termos[2], '');
  v_p3 := COALESCE(v_termos[3], '');

  -- Conta quantas linhas existem pela descrição
  SELECT COUNT(*) INTO v_qtde
  FROM cardapio c
  WHERE c.id_empresa = p_id_empresa
    AND unaccent(lower(c.categoria)) = 'pizza'
    AND (
      (v_p1 <> '' AND unaccent(lower(c.descricao)) ILIKE '%' || v_p1 || '%')
      AND (v_p2 = '' OR unaccent(lower(c.descricao)) ILIKE '%' || v_p2 || '%')
      AND (v_p3 = '' OR unaccent(lower(c.descricao)) ILIKE '%' || v_p3 || '%')
    )  and disponivel = true ;

  -- Se encontrou algo na descrição
  IF v_qtde > 0 THEN
    RETURN QUERY
    SELECT 
      c.numero,
      c.nome,
      c.categoria,
      c.tipo,
      c.preco_grande,
      c.preco_medio,
      c.preco_pequena,
      c.descricao
    FROM cardapio c
    WHERE c.id_empresa = p_id_empresa
      AND unaccent(lower(c.categoria)) = 'pizza'
      AND (
        (v_p1 <> '' AND unaccent(lower(c.descricao)) ILIKE '%' || v_p1 || '%')
        AND (v_p2 = '' OR unaccent(lower(c.descricao)) ILIKE '%' || v_p2 || '%')
        AND (v_p3 = '' OR unaccent(lower(c.descricao)) ILIKE '%' || v_p3 || '%')
       and disponivel = true 
      )
    ORDER BY c.numero;

  -- Caso contrário, busca pelo nome
  ELSE
    RETURN QUERY
    SELECT 
      c.numero,
      c.nome,
      c.categoria,
      c.tipo,
      c.preco_grande,
      c.preco_medio,
      c.preco_pequena,
      c.descricao
    FROM cardapio c
    WHERE c.id_empresa = p_id_empresa
      AND unaccent(lower(c.categoria)) = 'pizza'
      AND unaccent(lower(c.nome)) ILIKE '%' || unaccent(lower(p_texto)) || '%'
     and disponivel = true 
    ORDER BY c.numero;
  END IF;

IF NOT FOUND THEN
  RETURN QUERY
  SELECT 
    NULL::bigint AS numero,
    'NAO_ENCONTRADO'::text AS nome,
    'pizza'::text AS categoria,
    NULL::text AS tipo,
    0::real AS preco_grande,
    0::real AS preco_medio,
    0::real AS preco_pequena,
    'Sabor não encontrado no cardápio'::text AS descricao;
END IF;



 
END;
$$;
