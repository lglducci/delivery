 CREATE OR REPLACE FUNCTION adianta_etapa(
  p_user_id INT,
  p_id_empresa INT
)
RETURNS text
LANGUAGE plpgsql
AS $$
DECLARE
  v_count INT;
  v_turno RECORD;
BEGIN
  -- üîπ 1Ô∏è‚É£ Se h√° v√°rias op√ß√µes, pedir posi√ß√£o
  SELECT COUNT(*) INTO v_count
  FROM turno_opcoes
  WHERE user_id = p_user_id
    AND id_empresa = p_id_empresa;

  IF v_count > 1 THEN
    UPDATE turno_opcoes
       SET etapa = 'pedir_posicao'
     WHERE user_id = p_user_id AND id_empresa = p_id_empresa;
    RETURN 'pedir_posicao';
  END IF;

  -- üîπ 2Ô∏è‚É£ Se n√£o h√° nenhuma, nada a fazer
  IF v_count = 0 THEN
    RETURN '';
  END IF;

  -- üîπ 3Ô∏è‚É£ Busca o item atual
  SELECT *
  INTO v_turno
  FROM turno_opcoes
  WHERE user_id = p_user_id
    AND id_empresa = p_id_empresa
  LIMIT 1;

  -- üîπ 4Ô∏è‚É£ Falta quantidade ‚Üí pedir_qtd
  IF v_turno.quantidade IS NULL
     AND lower(v_turno.categoria) IN ('pizza','bebida','esfirra') THEN
    UPDATE turno_opcoes
       SET etapa = 'pedir_qtd'
     WHERE user_id = p_user_id AND id_empresa = p_id_empresa;
    RETURN 'pedir_qtd';
  END IF;

  -- üîπ 5Ô∏è‚É£ Pizza sem tamanho ‚Üí pedir_tamanho
  IF lower(v_turno.categoria) = 'pizza'
     AND (v_turno.tamanho IS NULL OR btrim(v_turno.tamanho) = '') THEN
    UPDATE turno_opcoes
       SET etapa = 'pedir_tamanho'
     WHERE user_id = p_user_id AND id_empresa = p_id_empresa;
    RETURN 'pedir_tamanho';
  END IF;

  -- üîπ 6Ô∏è‚É£ Se nada disso, est√° pronto
  UPDATE turno_opcoes
     SET etapa = 'ready'
   WHERE user_id = p_user_id 
         AND id_empresa = p_id_empresa
     and escolhido = true ;
  RETURN 'ready';
END;
$$;
