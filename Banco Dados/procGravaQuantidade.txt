 CREATE OR REPLACE FUNCTION GravaQuantidade(
  p_user_id     integer,
  p_id_empresa  integer,
  p_quantidade  integer
)
RETURNS SETOF jsonb
LANGUAGE plpgsql
AS $$
DECLARE
  v_categoria text;
  v_etapa     text;
  v_tamanho   text;
BEGIN
  -- ðŸ”¹ validaÃ§Ã£o bÃ¡sica
  IF coalesce(p_quantidade,0) <= 0 THEN
    RETURN NEXT jsonb_build_object('acao','erro','mensagem','Quantidade invÃ¡lida');
    RETURN;
  END IF;

  -- ðŸ”¹ obtÃ©m categoria e tamanho do item selecionado
  SELECT categoria, tamanho
    INTO v_categoria, v_tamanho
  FROM turno_opcoes
  WHERE user_id = p_user_id
    AND id_empresa = p_id_empresa
    AND escolhido = true
  LIMIT 1;

  IF NOT FOUND THEN
    RETURN NEXT jsonb_build_object('acao','erro','mensagem','Nenhum item selecionado');
    RETURN;
  ELSE
    v_categoria := lower(coalesce(v_categoria, ''));
    v_tamanho   := btrim(coalesce(v_tamanho, ''));
  END IF;

  -- ðŸ”¹ define a prÃ³xima etapa
  IF v_categoria = 'pizza' AND v_tamanho = '' THEN
    v_etapa := 'pedir_tamanho';
  ELSE
    v_etapa := 'ready';
  END IF;

  -- ðŸ”¹ atualiza a quantidade
  UPDATE turno_opcoes
     SET quantidade = p_quantidade,
         etapa       = v_etapa,
         updated_at  = now()
   WHERE user_id    = p_user_id
     AND id_empresa = p_id_empresa
     AND escolhido  = true;

  -- ðŸ”¹ retorno dinÃ¢mico orientado Ã  IA
  IF v_etapa = 'pedir_tamanho' THEN
    RETURN NEXT jsonb_build_object(
      'acao','pedir_tamanho',
      'mensagem','Qual o tamanho da pizza vocÃª quer? (mÃ©dia ou grande)?'
    );
    RETURN;
  END IF;

-- ðŸ”¹ lÃ³gica final â€” todas as categorias retornam etapa ready
IF v_categoria = 'pizza' THEN
  RETURN NEXT jsonb_build_object(
    'acao','ready',
    'mensagem','Pizza pronta para gravaÃ§Ã£o. Confirma este pedido? (Sim/NÃ£o)'
  );

ELSIF v_categoria IN ('bebida','esfirra') THEN
  RETURN NEXT jsonb_build_object(
    'acao','ready',
    'mensagem','Item pronto para gravaÃ§Ã£o. Confirma este pedido? (Sim/NÃ£o)'
  );

ELSIF v_categoria = 'borda' THEN
  RETURN NEXT jsonb_build_object(
    'acao','ready',
    'mensagem','Borda pronta para gravaÃ§Ã£o. Confirma? (Sim/NÃ£o)'
  );

ELSE
  RETURN NEXT jsonb_build_object(
    'acao','ready',
    'mensagem','Confirma este item? (Sim/NÃ£o)'
  );
END IF;




  -- ðŸ”¹ lÃ³gica por categoria
  --IF v_categoria = 'pizza' THEN
--    RETURN NEXT jsonb_build_object(
 --     'acao','GravaIntencao',
 --     'mensagem','Pizza gravada. Quer borda? Se sim, diga o sabor (ex.: cheddar). Se nÃ£o, responda "sem" ou diga "finalizar".'
 --   );
  --ELSIF v_categoria IN ('bebida','esfirra') THEN
--    RETURN NEXT jsonb_build_object(
  --    'acao','GravaIntencao',
  --    'mensagem','Item gravado com sucesso. Quer adicionar mais alguma coisa?'
  --  );
 -- ELSIF v_categoria = 'borda' THEN
  --  RETURN NEXT jsonb_build_object(
 --     'acao','GravaIntencao',
 --     'mensagem','Borda gravada com sucesso!'
 --   );
  --ELSE
 --   RETURN NEXT jsonb_build_object(
   --   'acao','GravaIntencao',
   --   'mensagem','Item gravado com sucesso. Deseja incluir algo mais?'
  --  );
 -- END IF;

  RETURN;
END;
$$;
