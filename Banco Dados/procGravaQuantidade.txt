 CREATE OR REPLACE FUNCTION GravaQuantidade(
  p_user_id     integer,
  p_id_empresa  integer,
  p_quantidade  integer
)
RETURNS SETOF jsonb
LANGUAGE plpgsql
AS $$
DECLARE
  v_categoria text;
  v_etapa     text;
  v_tamanho   text;
BEGIN
  IF coalesce(p_quantidade,0) <= 0 THEN
    RETURN NEXT jsonb_build_object('acao','erro','mensagem','Quantidade invÃ¡lida');
    RETURN;
  END IF;

  SELECT categoria, tamanho
    INTO v_categoria, v_tamanho
  FROM turno_opcoes
  WHERE user_id = p_user_id
    AND id_empresa = p_id_empresa
    AND escolhido = true
  LIMIT 1;

  IF NOT FOUND THEN
    RETURN NEXT jsonb_build_object('acao','erro','mensagem','Nenhum item selecionado');
    RETURN;
  ELSE
    v_categoria := lower(coalesce(v_categoria, ''));
    v_tamanho   := btrim(coalesce(v_tamanho, ''));
  END IF;

  IF v_categoria = 'pizza' AND v_tamanho = '' THEN
    v_etapa := 'pedir_tamanho';
  ELSE
    v_etapa := 'ready';
  END IF;

  UPDATE turno_opcoes
     SET quantidade = p_quantidade,
         etapa       = v_etapa,
         updated_at  = now()
   WHERE user_id    = p_user_id
     AND id_empresa = p_id_empresa
     AND escolhido  = true;

  -- ðŸ”¹ retorno orientado Ã  IA
  IF v_etapa = 'pedir_tamanho' THEN
    RETURN NEXT jsonb_build_object(
      'acao','pedir_tamanho',
      'mensagem','Qual tamanho da pizza vocÃª quer? (mÃ©dia ou grande)'
    );
    RETURN;
  ELSE
    RETURN NEXT jsonb_build_object(
      'acao','GravaIntencao',
      'mensagem','Beleza, anotado! Gravando sua escolha...'
    );
    RETURN;
  END IF;
END;
$$;
