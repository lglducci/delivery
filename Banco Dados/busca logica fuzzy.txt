 -- extensões (uma vez)
CREATE EXTENSION IF NOT EXISTS unaccent;
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- tabela de alias (opcional mas ótima)
CREATE TABLE IF NOT EXISTS cardapio_alias (
  id_empresa int NOT NULL,
  alias      text NOT NULL,
  numero     int NOT NULL,
  PRIMARY KEY (id_empresa, alias)
);

-- resolver: tenta alias exato e, se falhar, fuzzy por nome
CREATE OR REPLACE FUNCTION resolve_cardapio(
  p_empresa_id int,
  p_texto      text,
  p_topn       int  DEFAULT 5,
  p_min_score  numeric DEFAULT 0.35
) RETURNS TABLE(numero int, nome text, score numeric) AS $$
WITH q AS (SELECT unaccent(lower(coalesce(p_texto,''))) AS t),
alias_hit AS (
  SELECT c.numero, c.nome, 1.0::numeric AS score
  FROM q
  JOIN cardapio_alias a
    ON a.id_empresa = p_empresa_id AND unaccent(lower(a.alias)) = (SELECT t FROM q)
  JOIN cardapio c
    ON c.id_empresa = a.id_empresa AND c.numero = a.numero
  LIMIT p_topn
),
fuzzy AS (
  SELECT c.numero, c.nome,
         similarity(unaccent(lower(c.nome)), (SELECT t FROM q)) AS score
  FROM cardapio c
  WHERE c.id_empresa = p_empresa_id
  ORDER BY score DESC, c.numero
  LIMIT p_topn
)
SELECT * FROM alias_hit
UNION ALL
SELECT * FROM fuzzy WHERE NOT EXISTS (SELECT 1 FROM alias_hit) AND score >= p_min_score
ORDER BY score DESC, numero
LIMIT p_topn;
$$ LANGUAGE sql STABLE;
