CREATE OR REPLACE FUNCTION contab.ff_ultima_apuracao(
  p_empresa_id bigint
)
RETURNS TABLE (
  ano int,
  mes int,
  data_apuracao date,
  resultado numeric(14,2)
)
LANGUAGE sql
STABLE
AS $$
  SELECT
    EXTRACT(YEAR FROM l.data_mov)::int  AS ano,
    EXTRACT(MONTH FROM l.data_mov)::int AS mes,
    l.data_mov                          AS data_apuracao,
    SUM(l.debito - l.credito)::numeric(14,2) AS resultado
  FROM contab.lancamentos l
  JOIN contab.contas c ON c.id = l.conta_id
  WHERE l.empresa_id = p_empresa_id
    AND c.codigo = '3.2.1.01' -- ðŸ”¥ CONTA DE RESULTADO (NÃƒO PL)
    AND l.historico ILIKE 'Fechamento do mÃªs%'
  GROUP BY l.data_mov
  ORDER BY l.data_mov DESC
  LIMIT 1;
$$;
