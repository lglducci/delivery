CREATE OR REPLACE FUNCTION ff_pagar_contas(
  p_empresa_id BIGINT,
  p_lista_ids JSON,
 p_conta_id BIGINT 
)
RETURNS TEXT
LANGUAGE plpgsql
AS $$
DECLARE
  v_id BIGINT;
BEGIN
  FOR v_id IN SELECT json_array_elements_text(p_lista_ids)::BIGINT LOOP


     
    -- Insere transação
    I INSERT INTO transacoes(
  empresa_id,
  conta_id,
  categoria_id,
  tipo,
  valor,
  data_movimento,
  descricao,
  pagar_id,
  evento_codigo,
  origem
)
SELECT 
  c.empresa_id,
  p_conta_id,
  c.categoria_id,
  'saida',
  c.valor,
  CURRENT_DATE,
  c.descricao,
  c.id,
  m_filho.codigo,
  'Pagamento'
FROM contas_a_pagar c
JOIN contab.modelos m_pai
  ON m_pai.codigo = c.modelo_codigo
 AND m_pai.empresa_id = c.empresa_id
JOIN contab.modelos m_filho
  ON m_filho.modelo_pai_id = m_pai.id
 AND m_filho.empresa_id = c.empresa_id
WHERE c.id = v_id
  AND c.status = 'aberto';


    -- Atualiza conta a pagar
    UPDATE contas_a_pagar
    SET 
      status = 'pago',
      data_pagamento = CURRENT_DATE
    WHERE id = v_id 
      AND empresa_id = p_empresa_id; 

  END LOOP;

  RETURN 'Contas pagas com sucesso';
END;
$$;
