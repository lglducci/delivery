CREATE OR REPLACE FUNCTION ff_pagar_contas(
  p_empresa_id BIGINT,
  p_lista_ids JSON,
 p_conta_id BIGINT 
)
RETURNS TEXT
LANGUAGE plpgsql
AS $$
DECLARE
  v_id BIGINT;
BEGIN
  FOR v_id IN SELECT json_array_elements_text(p_lista_ids)::BIGINT LOOP

    -- Atualiza conta a pagar
    UPDATE contas_a_pagar
    SET 
      status = 'pago',
      vencimento = CURRENT_DATE
    WHERE id = v_id 
      AND empresa_id = p_empresa_id;

    -- Insere transação
    INSERT INTO transacoes(
      empresa_id,
      conta_id,
      categoria_id,
      tipo,
      valor,
      data_movimento,
      descricao,
      pagar_id 
    )
    SELECT 
      empresa_id,
      p_conta_id ,
      categoria_id,
      'saida',
      valor,
      CURRENT_DATE,
      descricao,
      id 
    FROM contas_a_pagar
    WHERE id = v_id;

    -- Atualiza saldo
  --  PERFORM ff_atualiza_saldo(
    --  (SELECT conta_id FROM contas_a_pagar WHERE id = v_id),
    --  - (SELECT valor FROM contas_a_pagar WHERE id = v_id)
    --);

  END LOOP;

  RETURN 'Contas pagas com sucesso';
END;
$$;
