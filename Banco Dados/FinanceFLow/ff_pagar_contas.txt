CREATE OR REPLACE FUNCTION ff_pagar_contas(
  p_empresa_id BIGINT,
  p_lista_ids JSON,
 p_conta_id BIGINT 
)
RETURNS TEXT
LANGUAGE plpgsql
AS $$
DECLARE
  v_id BIGINT;
BEGIN
  FOR v_id IN SELECT json_array_elements_text(p_lista_ids)::BIGINT LOOP


     
    -- Insere transação
    INSERT INTO transacoes(
      empresa_id,
      conta_id,
      categoria_id,
      tipo,
      valor,
      data_movimento,
      descricao,
      pagar_id ,
     evento_codigo,
    origem 
    )
    SELECT 
      empresa_id,
      p_conta_id ,
      categoria_id,
      'saida',
      valor,
      CURRENT_DATE,
      descricao,
      id ,
    'PAGAR',
   'Pagamento'
    FROM contas_a_pagar
    WHERE id = v_id 
and status = 'aberto';

    -- Atualiza conta a pagar
    UPDATE contas_a_pagar
    SET 
      status = 'pago',
      data_pagamento = CURRENT_DATE
    WHERE id = v_id 
      AND empresa_id = p_empresa_id; 

  END LOOP;

  RETURN 'Contas pagas com sucesso';
END;
$$;
