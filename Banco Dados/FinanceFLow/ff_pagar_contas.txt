CREATE OR REPLACE FUNCTION ff_pagar_contas(
  p_empresa_id BIGINT,
  p_lista_ids JSON,
 p_conta_id BIGINT 
)
RETURNS TEXT
LANGUAGE plpgsql
AS $$
DECLARE
  v_id BIGINT;
  v_modelo_codigo  text; 
BEGIN


    v_modelo_codigo   := contab.ff_get_modelo_evento(
                   p_empresa_id,
                    'baixa',
                     'financeiro');

  FOR v_id IN SELECT json_array_elements_text(p_lista_ids)::BIGINT LOOP


     
    -- Insere transação
  INSERT INTO transacoes(
  empresa_id,
  conta_id,
  categoria_id,
  tipo,
  valor,
  data_movimento,
  descricao,
  pagar_id,
  evento_codigo,
  origem,
 classificacao
)
SELECT 
  c.empresa_id,
  p_conta_id,
  c.categoria_id,
  'saida',
  c.valor,
  CURRENT_DATE,
  c.descricao,
  c.id,
  v_modelo_codigo  ,
  'Pagamento',
 classificacao
FROM contas_a_pagar c 
WHERE c.id = v_id
  and c.empresa_id = p_empresa_id
  AND c.status = 'aberto';


    -- Atualiza conta a pagar
    UPDATE contas_a_pagar
    SET 
      status = 'pago',
      data_pagamento = CURRENT_DATE
    WHERE id = v_id 
      AND empresa_id = p_empresa_id; 

  END LOOP;

  RETURN 'Contas pagas com sucesso';
END;
$$;
