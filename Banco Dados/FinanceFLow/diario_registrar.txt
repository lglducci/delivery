CREATE OR REPLACE FUNCTION contab.diario_registrar(
  p_empresa_id     BIGINT,
  p_data_mov       DATE,
  p_modelo_codigo  VARCHAR,
  p_historico      TEXT,
  p_valor_total    NUMERIC,
  p_data_vencto    DATE,
 p_parceiro_id      BIGINT,
  p_numero_parcelas INTEGER DEFAULT 1,
  p_doc_ref        TEXT DEFAULT NULL,
  p_outros         JSONB DEFAULT NULL
)
RETURNS UUID
LANGUAGE plpgsql
AS $$
DECLARE
  v_lote_id UUID := gen_random_uuid();
  v_valor_parcela NUMERIC;
  v_data_parcela DATE;
  i INT;
BEGIN
  IF p_numero_parcelas < 1 THEN
    RAISE EXCEPTION 'numero_parcelas invÃ¡lido';
  END IF;

  v_valor_parcela := ROUND(p_valor_total / p_numero_parcelas, 2);

  FOR i IN 1..p_numero_parcelas LOOP
    v_data_parcela := ff_calcula_data_parcela(p_data_vencto, i);

    INSERT INTO contab.diario (
      empresa_id,
      data_mov,
      modelo_codigo,
      historico,
      doc_ref,
      data_vencto,
      valor_total,
      parcelado,
      numero_parcelas,
      parcela_atual,
      lote_id,
      status,
      outros,
     parceiro_id
    )
    VALUES (
      p_empresa_id,
      p_data_mov,
      p_modelo_codigo,
      p_historico,
      p_doc_ref,
      v_data_parcela,
      v_valor_parcela,
      p_numero_parcelas > 1,
      p_numero_parcelas,
      i,
      v_lote_id,
      'confirmado',
      p_outros,
    p_parceiro_id      
    );
  END LOOP;

  RETURN v_lote_id;
END;
$$;
