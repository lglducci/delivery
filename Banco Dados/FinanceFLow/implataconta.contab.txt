CREATE OR REPLACE FUNCTION contab.proc_implantacao_cria_conta(
  p_empresa_id BIGINT,
  p_codigo     TEXT,
  p_nome       TEXT
)
RETURNS BIGINT
LANGUAGE plpgsql
AS $$
DECLARE
  v_id            BIGINT;
  v_nivel         INT;
  v_tipo          VARCHAR(20);
  v_natureza      CHAR(1);

  v_codigo_pai    TEXT;
  v_conta_pai_id  BIGINT;
BEGIN
  -- validações
  IF p_empresa_id IS NULL THEN
    RAISE EXCEPTION 'empresa_id obrigatório';
  END IF;

  p_codigo := trim(p_codigo);
  p_nome   := trim(p_nome);

  IF p_codigo = '' OR p_nome = '' THEN
    RAISE EXCEPTION 'Código e nome são obrigatórios';
  END IF;

  -- 1) Se já existe, retorna o ID
  SELECT id
  INTO v_id
  FROM contab.contas
  WHERE empresa_id = p_empresa_id
    AND codigo = p_codigo
  LIMIT 1;

  IF v_id IS NOT NULL THEN
    RETURN v_id;
  END IF;

  -- 2) Calcula nível
  v_nivel := length(p_codigo) - length(replace(p_codigo, '.', '')) + 1;

  -- 3) Tipo / natureza
  CASE split_part(p_codigo, '.', 1)::INT
    WHEN 1 THEN v_tipo := 'ATIVO';   v_natureza := 'D';
    WHEN 2 THEN v_tipo := 'PASSIVO'; v_natureza := 'C';
    WHEN 3 THEN v_tipo := 'PL';      v_natureza := 'C';
    WHEN 4 THEN v_tipo := 'RECEITA'; v_natureza := 'C';
    WHEN 5 THEN v_tipo := 'CUSTO';   v_natureza := 'D';
    WHEN 6 THEN v_tipo := 'DESPESA'; v_natureza := 'D';
    ELSE
      RAISE EXCEPTION 'Código inválido: %', p_codigo;
  END CASE;

  -- 4) Resolve / cria conta pai
  IF v_nivel > 1 THEN
    v_codigo_pai := regexp_replace(p_codigo, '\.[^\.]+$', '');

    -- tenta achar o pai
    SELECT id
    INTO v_conta_pai_id
    FROM contab.contas
    WHERE empresa_id = p_empresa_id
      AND codigo = v_codigo_pai
    LIMIT 1;

    -- se não existir, cria o pai recursivamente
    IF v_conta_pai_id IS NULL THEN
      v_conta_pai_id :=
        contab.proc_implantacao_cria_conta(
          p_empresa_id,
          v_codigo_pai,
          p_nome
        );
    END IF;
  ELSE
    v_conta_pai_id := NULL;
  END IF;

  -- 5) Cria a conta final
  INSERT INTO contab.contas (
    codigo,
    empresa_id,
    nome,
    tipo,
    natureza,
    nivel,
    conta_pai_id,
    analitica,
    sistema
  )
  VALUES (
    p_codigo,
    p_empresa_id,
    p_nome,
    v_tipo,
    v_natureza,
    v_nivel,
    v_conta_pai_id,
    TRUE,
    FALSE
  )
  RETURNING id INTO v_id;

  RETURN v_id;
END;
$$;
