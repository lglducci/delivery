CREATE OR REPLACE FUNCTION ff_registrar_receita(
  p_empresa_id BIGINT,
  p_conta_id  int,
 p_categoria_id int,  
  p_conta_nome TEXT,
  p_categoria_nome TEXT,
  p_valor NUMERIC,
  p_descricao TEXT,
  p_data DATE DEFAULT CURRENT_DATE,
 p_origem TEXT DEFAULT 'ZAP',
 p_classificacao  text default not null ,
 p_codigo   text default null 
)
RETURNS BIGINT
LANGUAGE plpgsql
AS $$
DECLARE
  v_conta_id BIGINT;
  v_cat_id   BIGINT;
  v_id       BIGINT;
 modelo_codigo  TEXT;
BEGIN
    
           IF p_conta_id IS NOT NULL AND p_conta_id > 0 THEN
                           v_conta_id := p_conta_id;
          ELSE
                          v_conta_id := ff_get_conta_id(p_empresa_id, p_conta_nome);
          END IF;
 
         IF p_categoria_id IS NOT NULL AND p_categoria_id > 0 THEN
               v_cat_id := p_categoria_id;
          ELSE
             v_cat_id := ff_get_categoria_id(p_empresa_id, p_categoria_nome, 'entrada');
           END IF;

       
      modelo_codigo := NULLIF(p_codigo  , '');
  IF   modelo_codigo IS NULL OR modelo_codigo = 'null' THEN 
        modelo_codigo := contab.ff_get_modelo_evento(   p_empresa_id,  p_classificacao,  'financeiro');
     end if ;    

  INSERT INTO transacoes (
    empresa_id,
    conta_id,
    categoria_id,
    tipo,
    valor,
    descricao,
    data_movimento,
    origem,
   classificacao ,
   evento_codigo  
  )
  VALUES (
    p_empresa_id,
    v_conta_id,
    v_cat_id,
    'entrada',
    p_valor,
    p_descricao,
    p_data,
    p_origem ,
   p_classificacao ,
  modelo_codigo  
  )
  RETURNING id INTO v_id;


/*UPDATE public.transacoes t
SET evento_codigo = sub.codigo
FROM (
    SELECT 
        t2.id,
        m.codigo
    FROM public.transacoes t2
    JOIN contab.categorias_modelos cm
        ON cm.categoria_id = t2.categoria_id
       AND cm.empresa_id = t2.empresa_id
       AND cm.ativo = true
       AND cm.forma_operacao = 'VISTA'
    JOIN contab.modelos m
        ON m.id = cm.modelo_id
       AND m.ativo = true
    WHERE t2.id = v_id
      AND t2.empresa_id = p_empresa_id
    ORDER BY m.id
    LIMIT 1
) sub
WHERE t.id = sub.id
AND t.evento_codigo IS NULL;
*/ 
  RETURN v_id;
END;
$$;
