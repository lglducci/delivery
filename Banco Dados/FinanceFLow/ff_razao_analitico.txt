CREATE OR REPLACE FUNCTION contab.ff_razao_analitico(
  p_empresa_id BIGINT,
  p_conta_id   BIGINT,
  p_data_ini   DATE,
  p_data_fim   DATE
)
RETURNS TABLE (
  data_mov     DATE,
  diario_id    BIGINT,
  historico    TEXT,
  debito       NUMERIC(14,2),
  credito      NUMERIC(14,2),
  saldo        NUMERIC(14,2)
)
LANGUAGE sql
AS $$
WITH base_saldo AS (
  SELECT
    COALESCE((
      SELECT si.saldo
      FROM contab.saldos_iniciais si
      WHERE si.empresa_id = p_empresa_id
        AND si.conta_id   = p_conta_id
    ), 0) +
    COALESCE((
      SELECT SUM(COALESCE(l.debito,0) - COALESCE(l.credito,0))
      FROM contab.lancamentos l
      WHERE l.empresa_id = p_empresa_id
        AND l.conta_id   = p_conta_id
        AND l.data_mov   < p_data_ini
    ), 0) AS saldo_ini
),
mov AS (
  SELECT
    l.data_mov,
    l.diario_id,
    l.historico,
    COALESCE(l.debito,0)  AS debito,
    COALESCE(l.credito,0) AS credito,
    (COALESCE(l.debito,0) - COALESCE(l.credito,0)) AS delta
  FROM contab.lancamentos l
  WHERE l.empresa_id = p_empresa_id
    AND l.conta_id   = p_conta_id
    AND l.data_mov BETWEEN p_data_ini AND p_data_fim
)
SELECT
  m.data_mov,
  m.diario_id,
  m.historico,
  m.debito,
  m.credito,
  b.saldo_ini + SUM(m.delta) OVER (ORDER BY m.data_mov, m.diario_id ROWS UNBOUNDED PRECEDING) AS saldo
FROM mov m
CROSS JOIN base_saldo b
ORDER BY m.data_mov, m.diario_id;
$$;
