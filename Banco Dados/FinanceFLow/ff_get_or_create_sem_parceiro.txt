 CREATE OR REPLACE FUNCTION contab.ff_get_or_create_sem_parceiro(
    p_empresa_id BIGINT
)
RETURNS BIGINT
LANGUAGE plpgsql
AS $$
DECLARE
    v_id BIGINT;
    v_cnpj VARCHAR(20) := '00000000000000';
BEGIN
    -- tenta localizar
    SELECT p.id
      INTO v_id
      FROM public.pessoa p
     WHERE p.empresa_id = p_empresa_id
       AND p.cpf_cnpj = v_cnpj
     LIMIT 1;

    -- se n√£o existir, cria
    IF v_id IS NULL THEN
        INSERT INTO public.pessoa (
            empresa_id,
            tipo,
            nome,
            cpf_cnpj,
            validado
        )
        VALUES (
            p_empresa_id,
            'ambos',
            'SEM PARCEIRO',
            v_cnpj,
            true
        )
        RETURNING id INTO v_id;
    END IF;

    RETURN v_id;
END;
$$;
