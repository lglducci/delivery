 CREATE OR REPLACE FUNCTION contab.ff_gerar_contabil_final(
    p_empresa_id BIGINT,
    p_data_ini   DATE,
    p_data_fim   DATE
)
RETURNS VOID
LANGUAGE plpgsql
AS $$
DECLARE
    r RECORD;
BEGIN
    ----------------------------------------------------------------
    -- 1) LIMPA LANÇAMENTOS DO PERÍODO
    ----------------------------------------------------------------
    DELETE FROM contab.lancamentos
    WHERE empresa_id = p_empresa_id
      AND data_mov BETWEEN p_data_ini AND p_data_fim 
       AND origem <>  'CONTABIL';

    ----------------------------------------------------------------
    -- 2) PROCESSA DIÁRIO
    ----------------------------------------------------------------
    FOR r IN
        SELECT id, empresa_id, modelo_codigo
        FROM contab.diario
        WHERE empresa_id = p_empresa_id
          AND data_mov BETWEEN p_data_ini AND p_data_fim
        ORDER BY id
    LOOP
        PERFORM contab.dispatch_gerar_lancamentos(
            r.id,
            r.empresa_id,
            r.modelo_codigo
        );
    END LOOP;

    ----------------------------------------------------------------
    -- 3) LIMPA STAGING
    ----------------------------------------------------------------
    DELETE FROM contab.diario_staging
    WHERE empresa_id = p_empresa_id
      AND data_mov BETWEEN p_data_ini AND p_data_fim;

    ----------------------------------------------------------------
    -- 4) ATUALIZA DIÁRIO
    ----------------------------------------------------------------
    UPDATE contab.diario
    SET status = 'processado'
    WHERE empresa_id = p_empresa_id
      AND data_mov BETWEEN p_data_ini AND p_data_fim
      AND status = 'rascunho';

    ----------------------------------------------------------------
    -- 5) CONTROLE DE FECHAMENTO
    ----------------------------------------------------------------
    UPDATE contab.controle_fechamento
    SET ultimo_dia_processado = p_data_fim + 1
    WHERE empresa_id = p_empresa_id;
END;
$$;
