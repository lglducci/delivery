CREATE OR REPLACE FUNCTION contab.ff_diario_compra_cartao(
    p_empresa_id BIGINT,
    p_data_ini DATE,
    p_data_fim DATE
)
RETURNS void
LANGUAGE plpgsql
AS $$
BEGIN

INSERT INTO contab.diario_staging (
    empresa_id,
    data_mov,
    modelo_codigo,
    historico,
    doc_ref,
   cnpj,
    parceiro_id,
    data_vencto,
    valor_total,
    status,
    outros,
    valor_custo ,
    valor_imposto,
   desconto 
)
SELECT
    t.empresa_id,
    t.data_parcela,
    'CRIA_CARTAO_COMPRA',
    t.descricao,
    CONCAT('CRIA_CARTAO_COMPRA_', t.id),
   '00000000000000',
    c.cartao_id,
    t.data_parcela,
    t.valor,
    'rascunho',
    jsonb_build_object(
        'origem', 'cartao_transacao',
        'transacao_id', t.id,
        'compra_id', t.compra_id,
        'parcela', t.parcela_num,
        'total_parcelas', t.parcela_total,
       'conta_contabil_id', c.conta_contabil_id
    ),
   0,
  0,
  0
FROM cartoes_transacoes t
JOIN cartoes_compras c ON c.id = t.compra_id
WHERE t.empresa_id = p_empresa_id
  AND t.data_parcela BETWEEN p_data_ini AND p_data_fim
  AND NOT EXISTS (
      SELECT 1
      FROM contab.diario_staging d
      WHERE d.empresa_id = t.empresa_id
        AND d.doc_ref = CONCAT('COMPRA_CARTAO_', t.id)
  );

END;
$$;
