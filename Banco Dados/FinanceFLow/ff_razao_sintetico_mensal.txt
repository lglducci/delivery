 CREATE OR REPLACE FUNCTION contab.ff_razao_sintetico_diario (
    p_empresa_id BIGINT,
    p_data_ini   DATE,
    p_data_fim   DATE,
    p_filtro     TEXT DEFAULT NULL
)
RETURNS TABLE (
    data_mov       DATE,
    conta_codigo   TEXT,
    conta_nome     TEXT,
    saldo_inicial  NUMERIC(14,2),
    debito         NUMERIC(14,2),
    credito        NUMERIC(14,2),
    saldo          NUMERIC(14,2)
)
LANGUAGE sql
STABLE
AS $$
WITH base AS (
    -- fonte correta e jÃ¡ validada
    SELECT *
    FROM contab.ff_relatorio_razao(
        p_empresa_id,
        p_data_ini,
        p_data_fim,
        p_filtro
    )
),

agrupado AS (
    SELECT
        data_mov,
        conta_codigo,
        conta_nome,

        -- ðŸ”‘ saldo inicial REAL do dia
        MIN(saldo_inicial) AS saldo_inicial,

        SUM(debito)  AS debito,
        SUM(credito) AS credito,

        -- ðŸ”‘ saldo final REAL do dia
        MAX(saldo)   AS saldo
    FROM base
    GROUP BY
        data_mov,
        conta_codigo,
        conta_nome
)

SELECT
    data_mov,
    conta_codigo,
    conta_nome,
    saldo_inicial,
    debito,
    credito,
    saldo
FROM agrupado
ORDER BY conta_codigo, data_mov;
$$;
