  
 CREATE OR REPLACE FUNCTION contab.ff_razao_sintetico_mensal(
  p_empresa_id bigint,
  p_data_ini date,
  p_data_fim date,
  p_filtro text DEFAULT NULL
)
RETURNS TABLE (
  mes_ano text , 
  conta_codigo text,
  conta_nome text,
   saldo_inicial numeric(14,2),
  debito numeric(14,2),
  credito numeric(14,2),
  saldo numeric(14,2) 
)
LANGUAGE sql
STABLE
AS $$
 WITH mov AS (
  SELECT
    data_mov,
    conta_id,
    conta_codigo,
    conta_nome,
    (debito - credito) AS delta,
    debito,
    credito
  FROM contab.ff_relatorio_razao(
    p_empresa_id ,
     p_data_ini ,
    p_data_fim,
    p_filtro 
  )
),
mensal AS (
  SELECT
    date_trunc('month', data_mov)::date AS mes_ini,
    conta_id,
    conta_codigo,
    conta_nome,
    SUM(debito)::numeric(14,2)  AS debito_mes,
    SUM(credito)::numeric(14,2) AS credito_mes
  FROM mov
  GROUP BY 1,2,3,4
),
saldo_ini AS (
  SELECT
    m.mes_ini,
    m.conta_id,
    -- saldo de implantação + movimentações anteriores ao 1º dia do mês
    COALESCE(si.saldo, 0) +
    COALESCE((
      SELECT SUM(x.delta)
      FROM mov x
      WHERE x.conta_id = m.conta_id
        AND x.data_mov < m.mes_ini
    ), 0) AS saldo_inicial
  FROM mensal m
  LEFT JOIN contab.saldos_iniciais si
    ON si.empresa_id = 1
   AND si.conta_id   = m.conta_id
)
SELECT
  to_char(m.mes_ini, 'MM/YYYY') AS ano_mes,
  m.conta_codigo,
  m.conta_nome,
  s.saldo_inicial::numeric(14,2) AS saldo_inicial,
  m.debito_mes debito,
  m.credito_mes credito ,
  (s.saldo_inicial + m.debito_mes - m.credito_mes)::numeric(14,2) AS saldo
FROM mensal m
JOIN saldo_ini s
  ON s.mes_ini = m.mes_ini
 AND s.conta_id = m.conta_id
ORDER BY m.mes_ini, m.conta_codigo;

$$;
