CREATE OR REPLACE FUNCTION contab.gera_fluxo_caixa_mensal (
    p_empresa_id BIGINT,
    p_data_ini DATE,
    p_data_fim DATE
)
RETURNS TABLE (
    ano INT,
    mes INT,
    entrada NUMERIC(14,2),
    saida NUMERIC(14,2),
    saldo NUMERIC(14,2)
)
LANGUAGE sql
AS $$
SELECT
    EXTRACT(YEAR FROM l.data_mov)::int AS ano,
    EXTRACT(MONTH FROM l.data_mov)::int AS mes,

    SUM(
        CASE 
            WHEN c.tipo = 'ATIVO' AND c.natureza = 'D'
            THEN COALESCE(l.credito,0)
            ELSE 0
        END
    ) AS entrada,

    SUM(
        CASE 
            WHEN c.tipo = 'ATIVO' AND c.natureza = 'D'
            THEN COALESCE(l.debito,0)
            ELSE 0
        END
    ) AS saida,

    SUM(
        CASE 
            WHEN c.tipo = 'ATIVO' AND c.natureza = 'D'
            THEN COALESCE(l.credito,0) - COALESCE(l.debito,0)
            ELSE 0
        END
    ) AS saldo

FROM contab.lancamentos l
JOIN contab.contas c ON c.id = l.conta_id
WHERE l.empresa_id = p_empresa_id
  AND l.data_mov BETWEEN p_data_ini AND p_data_fim
GROUP BY 1,2
ORDER BY 1,2;
$$;
