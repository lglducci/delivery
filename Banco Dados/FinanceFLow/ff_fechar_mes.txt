CREATE OR REPLACE FUNCTION contab.ff_fechar_mes(
  p_empresa_id bigint,
  p_ano int,
  p_mes int,
  p_usuario_id bigint
)
RETURNS void
LANGUAGE plpgsql
AS $$
DECLARE
  v_data_ini date;
  v_data_fim date;
  v_resultado numeric(14,2);
  v_conta_resultado bigint;
  v_conta_pl bigint;
BEGIN
  -- 1) Datas do mês
  v_data_ini := make_date(p_ano, p_mes, 1);
  v_data_fim := (v_data_ini + interval '1 month - 1 day')::date;

  -- 2) Calcula resultado líquido do mês (usa SUA DRE)
  SELECT valor_periodo
  INTO v_resultado
  FROM contab.ff_dre_periodo(p_empresa_id, v_data_ini, v_data_fim)
  WHERE grupo = 'RESULTADO_LIQUIDO';

  IF v_resultado IS NULL OR v_resultado = 0 THEN
    RAISE EXCEPTION 'Nada a fechar neste mês.';
  END IF;

  -- 3) Contas técnicas
  SELECT id INTO v_conta_resultado
  FROM contab.contas
  WHERE codigo = '3.2.1.01' AND empresa_id = p_empresa_id;

  SELECT id INTO v_conta_pl
  FROM contab.contas
  WHERE codigo = '3.1.2.01' AND empresa_id = p_empresa_id;

  IF v_conta_resultado IS NULL OR v_conta_pl IS NULL THEN
    RAISE EXCEPTION 'Contas de fechamento não configuradas.';
  END IF;

  -- 4) Lançamento contábil
  INSERT INTO contab.lancamentos (
    empresa_id,
    data_mov,
    conta_id,
    debito,
    credito,
    historico
  )
  VALUES
    (p_empresa_id, v_data_fim, v_conta_resultado, v_resultado, 0,
     'Fechamento do mês ' || p_mes || '/' || p_ano),
    (p_empresa_id, v_data_fim, v_conta_pl, 0, v_resultado,
     'Fechamento do mês ' || p_mes || '/' || p_ano);

END;
$$;
