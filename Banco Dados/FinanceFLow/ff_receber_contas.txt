

CREATE OR REPLACE FUNCTION ff_receber_contas(
  p_empresa_id BIGINT,
  p_lista_ids JSON,
 p_conta_id BIGINT 
)
RETURNS TEXT
LANGUAGE plpgsql
AS $$
DECLARE
  v_id BIGINT;
BEGIN
  FOR v_id IN SELECT json_array_elements_text(p_lista_ids)::BIGINT LOOP

 
 INSERT INTO transacoes(
  empresa_id,
  conta_id,
  categoria_id,
  tipo,
  valor,
  data_movimento,
  descricao,
  receber_id,
  evento_codigo,
  origem
)
SELECT 
  c.empresa_id,
  p_conta_id,
  c.categoria_id,
  'entrada',
  c.valor,
  CURRENT_DATE,
  c.descricao,
  c.id,
  m_filho.codigo,
  'Recebimento'
FROM contas_a_receber c
JOIN contab.modelos m_pai
  ON m_pai.codigo = c.modelo_codigo
 AND m_pai.empresa_id = c.empresa_id
JOIN contab.modelos m_filho
  ON m_filho.modelo_pai_id = m_pai.id
 AND m_filho.empresa_id = c.empresa_id
WHERE c.id = v_id
  AND c.status = 'aberto';



    -- Atualiza conta a receber
    UPDATE contas_a_receber
    SET 
      status = 'recebido',
      data_recebimento = CURRENT_DATE
    WHERE id = v_id 
      AND empresa_id = p_empresa_id;
 
  END LOOP;

  RETURN 'Contas recebidas com sucesso';
END;
$$;
