 DROP FUNCTION IF EXISTS contab.fn_balancete(BIGINT, DATE, DATE);

CREATE OR REPLACE FUNCTION contab.fn_balancete(
    p_empresa_id BIGINT,
    p_data_ini   DATE,
    p_data_fim   DATE
)
RETURNS TABLE (
    conta_id      BIGINT,
    codigo        TEXT,
    conta_nome    TEXT,
    total_debito  NUMERIC(14,2),
    total_credito NUMERIC(14,2),
    saldo         NUMERIC(14,2)
)
LANGUAGE sql
AS $$
  SELECT
    c.id AS conta_id,
    c.codigo,
    c.nome AS conta_nome,
    SUM(l.debito)::numeric(14,2)  AS total_debito,
    SUM(l.credito)::numeric(14,2) AS total_credito,
    (SUM(l.debito) - SUM(l.credito))::numeric(14,2) AS saldo
  FROM contab.lancamentos l
  JOIN contab.contas c
    ON c.id = l.conta_id
   AND c.empresa_id = p_empresa_id
  WHERE l.empresa_id = p_empresa_id
    AND l.data_mov BETWEEN p_data_ini AND p_data_fim
  GROUP BY c.id, c.codigo, c.nome
  ORDER BY c.codigo;
$$;
