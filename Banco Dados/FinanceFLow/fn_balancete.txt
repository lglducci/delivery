 CREATE OR REPLACE FUNCTION contab.fn_balancete(
    p_empresa_id BIGINT,
    p_data_ini   DATE,
    p_data_fim   DATE
)
RETURNS TABLE (
    conta_id      BIGINT,
    codigo        TEXT,
    conta_nome    TEXT,
    saldo_inicial NUMERIC(14,2),
    total_debito  NUMERIC(14,2),
    total_credito NUMERIC(14,2),
    saldo_final   NUMERIC(14,2)
)
LANGUAGE sql
AS $$
WITH saldo_ini AS (
    SELECT
        si.conta_id,
        si.saldo
    FROM contab.saldos_iniciais si
    WHERE si.empresa_id = p_empresa_id
),
mov AS (
    SELECT
        l.conta_id,
        SUM(l.debito)  AS debito,
        SUM(l.credito) AS credito
    FROM contab.lancamentos l
    WHERE l.empresa_id = p_empresa_id
      AND l.data_mov BETWEEN p_data_ini AND p_data_fim
    GROUP BY l.conta_id
)
SELECT
    c.id,
    c.codigo,
    c.nome,
    COALESCE(si.saldo, 0) AS saldo_inicial,
    COALESCE(m.debito, 0),
    COALESCE(m.credito, 0),
    CASE
        WHEN c.natureza = 'D'
        THEN COALESCE(si.saldo,0) + COALESCE(m.debito,0) - COALESCE(m.credito,0)
        ELSE COALESCE(si.saldo,0) + COALESCE(m.credito,0) - COALESCE(m.debito,0)
    END AS saldo_final
FROM contab.contas c
LEFT JOIN saldo_ini si ON si.conta_id = c.id
LEFT JOIN mov m       ON m.conta_id  = c.id
WHERE c.empresa_id = p_empresa_id
ORDER BY c.codigo;
$$;
