  CREATE OR REPLACE FUNCTION contab.ff_lancamento_partida_dobrada (
    p_empresa_id        BIGINT,
    p_conta_debito_id   BIGINT,
    p_conta_credito_id  BIGINT,
    p_valor             NUMERIC(14,2),
    p_historico         TEXT,
    p_data_lanc         DATE DEFAULT CURRENT_DATE,
    p_lembrete          BOOLEAN DEFAULT FALSE,
    p_data_vencimento   DATE DEFAULT NULL
)
RETURNS VOID
LANGUAGE plpgsql
AS $$
DECLARE
    v_lote_id BIGINT;
BEGIN
    -- valida√ß√µes b√°sicas
    IF p_valor <= 0 THEN
        RAISE EXCEPTION 'Valor deve ser maior que zero';
    END IF;

    IF p_conta_debito_id = p_conta_credito_id THEN
        RAISE EXCEPTION 'Conta d√©bito e cr√©dito n√£o podem ser a mesma';
    END IF;

    -- üî¢ pr√≥ximo lote_id
    SELECT COALESCE(MAX(lote_id), 0) + 1
      INTO v_lote_id
      FROM contab.lancamentos
     WHERE empresa_id = p_empresa_id;

    -- üî¥ D√âBITO
    INSERT INTO contab.lancamentos (
        empresa_id,
        diario_id,
        data_mov,
        conta_id,
        debito,
        credito,
        historico,
        criado_em,
        lote_id
    ) VALUES (
        p_empresa_id,
        0,
        p_data_lanc,
        p_conta_debito_id,
        p_valor,
        0,
        p_historico,
        NOW(),
        v_lote_id
    );

    -- üîµ CR√âDITO
    INSERT INTO contab.lancamentos (
        empresa_id,
        diario_id,
        data_mov,
        conta_id,
        debito,
        credito,
        historico,
        criado_em,
        lote_id,
       origem
    ) VALUES (
        p_empresa_id,
        0,
        p_data_lanc,
        p_conta_credito_id,
        0,
        p_valor,
        p_historico,
        NOW(),
        v_lote_id,
       'CONTABIL'
    );

    -- üîî LEMBRETE (opcional)
    IF p_lembrete = TRUE THEN
        IF p_data_vencimento IS NULL THEN
            RAISE EXCEPTION 'Data de vencimento √© obrigat√≥ria quando lembrete estiver ativo';
        END IF;

        INSERT INTO contab.lembretes (
            empresa_id,
            lote_id,
            tipo,
            descricao,
            valor,
            data_vencimento
        ) VALUES (
            p_empresa_id,
            v_lote_id,
            'Lembrete',
            p_historico,
            p_valor,
            p_data_vencimento
        );
    END IF;

END;
$$;
