CREATE OR REPLACE FUNCTION contab.ff_diario_pagamento_fatura_cartao(
    p_empresa_id BIGINT,
    p_data DATE
)
RETURNS void
LANGUAGE plpgsql
AS $$
BEGIN

INSERT INTO contab.diario_staging (
    empresa_id,
    data_mov,
    modelo_codigo,
    historico,
    doc_ref,
    data_vencto,
    valor_total,
    status,
    outros
)
SELECT
    f.empresa_id,
    f.vencimento,
    'PAGAMENTO_FATURA_CARTAO',
    CONCAT('Pagamento fatura cart√£o ', f.numero),
    CONCAT('PAG_FATURA_', f.id),
    f.vencimento,
    f.valor_total,
    'rascunho',
    jsonb_build_object(
        'origem', 'cartao_fatura',
        'fatura_id', f.id
    )
FROM cartoes_faturas f
WHERE f.empresa_id = p_empresa_id
  AND f.vencimento = p_data
  AND f.status = 'paga'
  AND NOT EXISTS (
      SELECT 1
      FROM contab.diario_staging d
      WHERE d.empresa_id = f.empresa_id
        AND d.doc_ref = CONCAT('PAG_FATURA_', f.id)
  );

END;
$$;
