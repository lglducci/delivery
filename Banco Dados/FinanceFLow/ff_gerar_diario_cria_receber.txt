    CREATE OR REPLACE FUNCTION contab.ff_gerar_diario_cria_receber(
    p_empresa_id BIGINT,
    p_data_ini   DATE,
    p_data_fim   DATE
)
RETURNS INTEGER
LANGUAGE plpgsql
AS $$
DECLARE
    v_qtd INTEGER := 0;
BEGIN
    /*
      üîπ Tabela usada: fin.contas_receber  (troque se o nome for outro)
      Campos esperados (adapte se precisar):
        - empresa_id
        - descricao
        - valor
        - vencimento
        - fornecedor_id        -- parceiro
        - parcelas             -- total de parcelas da d√≠vida
        - parcela_nr           -- n¬∫ da parcela (1..N)
        - status               -- 'aberto', 'pago', etc
        - criado_em            -- data de cria√ß√£o da d√≠vida
        - lote_id              -- identificador do grupo de parcelas da mesma d√≠vida
    */

 INSERT INTO contab.diario_staging (
    empresa_id,
    data_mov,
    modelo_codigo,
    historico,
    doc_ref,
    parceiro_id,
    cnpj,
    data_vencto,
    valor_total,
    valor_custo,
    valor_imposto,
    desconto,
    status,
    outros
)
SELECT
    cr.empresa_id,
    MIN(cr.criado_em)::date,
    'CRIA_RECEBER',
    'Cria√ß√£o de Recebimento: ' || MAX(cr.descricao)
      || ' (' || MAX(cr.parcelas) || ' parcelas)',
    'CR-' || cr.lote_id,
    cr.fornecedor_id,

    -- üî• BUSCA DO CNPJ (N√ÉO NULO)
    (
      SELECT p.cpf_cnpj
      FROM public.pessoa p
      WHERE p.id = cr.fornecedor_id
    ) AS cnpj,

    MAX(cr.vencimento)::date,
    SUM(cr.valor),
    0, 0, 0,
    'rascunho',
    jsonb_build_object(
        'origem', 'CONTAS_RECEBER',
        'evento', 'CRIA_RECEBER',
        'lote_id', cr.lote_id
    )
FROM contas_a_receber cr
WHERE cr.empresa_id = p_empresa_id
  AND cr.criado_em BETWEEN p_data_ini AND p_data_fim
  AND cr.status IN ('aberto', 'em_aberto')
GROUP BY
    cr.empresa_id,
    cr.lote_id,
    cr.fornecedor_id
HAVING NOT EXISTS (
    SELECT 1
    FROM contab.diario d
    WHERE d.empresa_id    = p_empresa_id
      AND d.modelo_codigo = 'CRIA_RECEBER'
      AND d.doc_ref       = 'CR-' || cr.lote_id
);

GET DIAGNOSTICS v_qtd = ROW_COUNT;
RETURN v_qtd;
END;
$$;