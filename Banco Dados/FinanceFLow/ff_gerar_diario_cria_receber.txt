    CREATE OR REPLACE FUNCTION contab.ff_gerar_diario_cria_receber(
    p_empresa_id BIGINT,
    p_data    DATE   
)
RETURNS void
LANGUAGE plpgsql
AS $$
DECLARE
    v_qtd INTEGER := 0;
BEGIN
    /*
      üîπ Tabela usada: fin.contas_receber  (troque se o nome for outro)
      Campos esperados (adapte se precisar):
        - empresa_id
        - descricao
        - valor
        - vencimento
        - fornecedor_id        -- parceiro
        - parcelas             -- total de parcelas da d√≠vida
        - parcela_nr           -- n¬∫ da parcela (1..N)
        - status               -- 'aberto', 'pago', etc
        - criado_em            -- data de cria√ß√£o da d√≠vida
        - lote_id              -- identificador do grupo de parcelas da mesma d√≠vida
    */

 INSERT INTO contab.diario_staging (
    empresa_id,
    data_mov,
    modelo_codigo,
    historico,
    doc_ref,
    parceiro_id,
    cnpj,
    data_vencto,
    valor_total,
    valor_custo,
    valor_imposto,
    desconto,
    status,
    outros 
)
SELECT
    cr.empresa_id,
    MIN(cr.criado_em)::date,
    'CRIA_RECEBER',
    'Cria√ß√£o de Recebimento: ' || MAX(cr.descricao)
      || ' (' || MAX(cr.parcelas) || ' parcelas)',
    'CR-' || cr.lote_id,
    cr.fornecedor_id,

    -- üî• BUSCA DO CNPJ (N√ÉO NULO)
    (
      SELECT p.cpf_cnpj
      FROM public.pessoa p
      WHERE p.id = cr.fornecedor_id
    ) AS cnpj,

    MAX(cr.vencimento)::date,
    SUM(cr.valor),
    0, 0, 0,
    'rascunho',
    jsonb_build_object(
        'origem', 'CONTAS_RECEBER',
        'evento', 'CRIA_RECEBER',
        'vencimento',   MAX(cr.vencimento),
        'parcelas',  MAX(cr.descricao)
    ) 
FROM contas_a_receber cr
WHERE cr.empresa_id = p_empresa_id
    AND cr.criado_em::date =  p_data
--_ini AND p_data_fim
  AND cr.status IN ('aberto', 'em_aberto')
GROUP BY
    cr.empresa_id,
    cr.lote_id,
    cr.fornecedor_id;
 

 
END;
$$;