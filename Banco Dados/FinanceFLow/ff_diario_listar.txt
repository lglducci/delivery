   

 
 CREATE OR REPLACE FUNCTION contab.ff_diario_listar(
    p_empresa_id    INTEGER,
    p_data_ini      DATE,
    p_data_fim      DATE,
    p_modelo_codigo TEXT,
    p_busca         TEXT
)
RETURNS TABLE (
    id              BIGINT,
    data_mov        DATE,
    modelo_codigo   VARCHAR(40),
    historico       TEXT,
    doc_ref         VARCHAR(60), 
    data_vencto     DATE, 
    valor_total     NUMERIC(14,2),
    valor_custo     NUMERIC(14,2),
    valor_imposto   NUMERIC(14,2),
    desconto        NUMERIC(14,2)
)
AS $$
BEGIN
    RETURN QUERY
    SELECT 
        d.id,
        d.data_mov,
        d.modelo_codigo,
        d.historico,
        d.doc_ref, 
        d.data_vencto, 
        d.valor_total,
        d.valor_custo,
        d.valor_imposto,
        d.desconto
    FROM contab.diario d
  
    WHERE  d.data_mov BETWEEN p_data_ini AND p_data_fim
      
      -- FILTRO POR MODELO
      AND (
            p_modelo_codigo IS NULL 
            OR p_modelo_codigo = '' 
            OR d.modelo_codigo = p_modelo_codigo
      )

      -- FILTRO BUSCA GERAL
      AND (
          p_busca IS NULL OR p_busca = '' 
          OR unaccent(lower(d.historico))  LIKE unaccent(lower('%' || p_busca || '%'))
          OR unaccent(lower(d.doc_ref))    LIKE unaccent(lower('%' || p_busca || '%'))
          
      )
    ORDER BY d.data_mov DESC;
END;
$$ LANGUAGE plpgsql;

