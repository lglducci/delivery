 

CREATE TABLE public.perfis (
    id          BIGSERIAL PRIMARY KEY,
    codigo      VARCHAR(30) UNIQUE NOT NULL,
    nome        VARCHAR(100) NOT NULL,
    ativo       BOOLEAN NOT NULL DEFAULT TRUE
);
  

CREATE TABLE public.empresa_perfil (
  empresa_id  BIGINT NOT NULL REFERENCES public.empresas(id) ON DELETE CASCADE,
  perfil_id   BIGINT NOT NULL REFERENCES public.perfis(id),
  ativo       BOOLEAN NOT NULL DEFAULT TRUE,
  criado_em   TIMESTAMP NOT NULL DEFAULT NOW(),
  PRIMARY KEY (empresa_id)
);



CREATE OR REPLACE VIEW public.vw_menu_empresa AS
SELECT
  ep.empresa_id,
  mi.id,
  mi.codigo,
  mi.titulo,
  mi.rota,
  mi.icon,
  mi.parent_id,
  mi.ordem,
  m.codigo AS modulo
FROM public.empresa_perfil ep
JOIN public.perfil_menu pm
  ON pm.perfil_id = ep.perfil_id
 AND pm.permitido = TRUE
JOIN public.menu_itens mi
  ON mi.id = pm.menu_id
 AND mi.ativo = TRUE
JOIN public.modulos m
  ON m.id = mi.modulo_id
WHERE ep.ativo = TRUE;



