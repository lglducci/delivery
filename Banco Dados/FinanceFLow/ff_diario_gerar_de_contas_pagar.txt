 

 CREATE OR REPLACE FUNCTION contab.ff_diario_gerar_de_contas_pagar(
    p_empresa_id bigint,
    p_data_ini   date,
    p_data_fim   date
)
RETURNS void 
LANGUAGE plpgsql
AS $$
DECLARE
    v_lote_id uuid := gen_random_uuid();
BEGIN
    INSERT INTO  contab.diario_staging  (
        empresa_id,
        data_mov,
        modelo_codigo,
        historico,
        doc_ref,
        parceiro_id,
        cnpj, 
        data_vencto,
        valor_total,
        valor_custo,
        valor_imposto,
        desconto,
        status,
        outros 
    )
    SELECT
        c.empresa_id,
        c.criado_em,
        c.evento_codigo   AS modelo_codigo,   -- ← você define o nome da coluna
        c.descricao,
        c.doc_ref,
        c.fornecedor_id,
      (
      SELECT p.cpf_cnpj
      FROM public.pessoa p
      WHERE p.id = c.fornecedor_id
    ) AS cnpj,
        c.vencimento,
        c.valor,
        0,
        0,
        0,
        'rascunho',
         jsonb_build_object(
        'origem', 'CONTAS_PAGAR',
        'evento', 'CRIA_PAGAR' 
    ) 
      
    FROM public.contas_a_pagar c
    WHERE c.empresa_id = p_empresa_id
      AND c.criado_em BETWEEN p_data_ini AND p_data_fim 
      AND c.evento_codigo IS NOT NULL     -- só gera se tiver modelo ligado 
      AND NOT EXISTS (
            SELECT 1 FROM  contab.diario_staging  d
            WHERE d.empresa_id    = c.empresa_id
              AND d.data_mov      = c.vencimento
              AND d.doc_ref       = c.doc_ref
              AND d.modelo_codigo = c.evento_codigo
      );
  
END;
$$;

 