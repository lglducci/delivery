  CREATE OR REPLACE FUNCTION contab.gerar_lancamentos_por_diario(
    p_diario_id BIGINT,
    p_empresa_id BIGINT
)
RETURNS void
LANGUAGE plpgsql
AS $$
 
DECLARE
  v_diario      contab.diario%ROWTYPE;
  v_modelo      contab.modelos%ROWTYPE;
  r_linha       contab.modelos_linhas%ROWTYPE;
  v_valor       NUMERIC(14,2);
  v_deb_count   INT := 0;
  v_cred_count  INT := 0;
BEGIN
  -- 1) Diário
  SELECT * INTO v_diario
  FROM contab.diario
  WHERE id = p_diario_id
    AND empresa_id = p_empresa_id 
    and  modelo_codigo NOT IN ('PAGAR', 'RECEBER') ;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Diário % não encontrado.', p_diario_id;
  END IF;

  IF v_diario.valor_total IS NULL OR v_diario.valor_total = 0 THEN
    RAISE EXCEPTION 'Diário % sem valor_total válido.', p_diario_id;
  END IF;

  v_valor := v_diario.valor_total;

  -- 2) Modelo
  SELECT * INTO v_modelo
  FROM contab.modelos
  WHERE codigo = v_diario.modelo_codigo
    AND empresa_id = p_empresa_id
    AND ativo = TRUE;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Modelo % não encontrado ou inativo.', v_diario.modelo_codigo;
  END IF;

  -- 3) Limpa lançamentos anteriores do diário
  DELETE FROM contab.lancamentos
  WHERE diario_id = p_diario_id
    AND empresa_id = p_empresa_id;

 
  -- 4) Insere linhas D e C
  FOR r_linha IN
    SELECT *
    FROM contab.modelos_linhas
    WHERE modelo_id = v_modelo.id
      AND empresa_id = p_empresa_id
    ORDER BY ordem
  LOOP

    IF r_linha.dc NOT IN ('D','C') THEN
      RAISE EXCEPTION 'DC inválido no modelo_linhas: %', r_linha.dc;
    END IF;

    INSERT INTO contab.lancamentos (
      empresa_id,
      diario_id,
      data_mov,
      conta_id,
      historico,
      debito,
      credito,
      modelo_id
    )
    VALUES (
      p_empresa_id,
      v_diario.id,
      v_diario.data_mov,
      r_linha.conta_id,
      v_diario.historico,
      CASE WHEN r_linha.dc = 'D' THEN v_valor ELSE 0 END,
      CASE WHEN r_linha.dc = 'C' THEN v_valor ELSE 0 END,
      v_modelo.id
    );

    	IF r_linha.dc = 'D' THEN
     	 v_deb_count := v_deb_count + 1;
   	 ELSE
 	     v_cred_count := v_cred_count + 1;
 	   END IF;

  END LOOP;

      	-- 5) Validação final
  	IF v_deb_count = 0 OR v_cred_count = 0 THEN
   	        RAISE EXCEPTION
  	       'Modelo % inválido: precisa ter ao menos 1 débito e 1 crédito.',
    	         v_modelo.codigo;
	  END IF;
end;
 ; 



END;
$$;
