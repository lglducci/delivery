    CREATE OR REPLACE FUNCTION contab.ff_gerar_diario_cria_pagar(
    p_empresa_id BIGINT,
    p_data    DATE 
)
RETURNS INTEGER
LANGUAGE plpgsql
AS $$
 
DECLARE
    v_qtd INTEGER := 0;
BEGIN
    /*
      üîπ Tabela usada: fin.contas_pagar  (troque se o nome for outro)
      Campos esperados (adapte se precisar):
        - empresa_id
        - descricao
        - valor
        - vencimento
        - fornecedor_id        -- parceiro
        - parcelas             -- total de parcelas da d√≠vida
        - parcela_nr           -- n¬∫ da parcela (1..N)
        - status               -- 'aberto', 'pago', etc
        - criado_em            -- data de cria√ß√£o da d√≠vida
        - lote_id              -- identificador do grupo de parcelas da mesma d√≠vida
    */

 INSERT INTO contab.diario_staging (
    empresa_id,
    data_mov,
    modelo_codigo,
    historico,
    doc_ref,
    parceiro_id,
    cnpj,
    data_vencto,
    valor_total,
    valor_custo,
    valor_imposto,
    desconto,
    status,
    outros 
)
SELECT
    cp.empresa_id,
    MIN(cp.criado_em)::date,
    'CRIA_PAGAR',
    'Cria√ß√£o de d√≠vida: ' || MAX(cp.descricao)
      || ' (' || MAX(cp.parcelas) || ' parcelas)',
    'CP-' || cp.lote_id,
    cp.fornecedor_id,

    -- üî• BUSCA DO CNPJ (N√ÉO NULO)
    (
      SELECT p.cpf_cnpj
      FROM public.pessoa p
      WHERE p.id = cp.fornecedor_id
    ) AS cnpj,

    MAX(cp.vencimento)::date,
    SUM(cp.valor),
    0, 0, 0,
    'rascunho',
    jsonb_build_object(
        'origem', 'CONTAS_PAGAR',
        'evento', 'CRIA_PAGAR', 
        'data criacao', MIN(cp.criado_em),
         'parcelas', MAX(cp.parcelas) ,
         'contabil_id', cp.contabil_id
    ) 
FROM contas_a_pagar cp
WHERE cp.empresa_id = p_empresa_id 
 AND cp.criado_em::date =  p_data 
  --AND cp.status IN ('aberto', 'em_aberto')
GROUP BY
    cp.empresa_id,
    cp.lote_id,
    cp.fornecedor_id,
    cp.contabil_id ;

GET DIAGNOSTICS v_qtd = ROW_COUNT;
RETURN v_qtd;
END;
 
$$;
