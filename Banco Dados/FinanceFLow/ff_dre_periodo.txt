 CREATE OR REPLACE FUNCTION contab.ff_dre_periodo(
  p_empresa_id BIGINT,
  p_data_ini   DATE,
  p_data_fim   DATE
)
RETURNS TABLE (
  ordem BIGINT,
  grupo TEXT,
  valor_periodo NUMERIC(18,2)
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY

  WITH mov AS (
    SELECT
      c.codigo AS conta_codigo,
      COALESCE(l.debito,0)  AS debito,
      COALESCE(l.credito,0) AS credito
    FROM contab.lancamentos l
    JOIN contab.contas c ON c.id = l.conta_id
    WHERE l.empresa_id = p_empresa_id
      AND l.data_mov BETWEEN p_data_ini AND p_data_fim
  ),

  mov_map AS (
    SELECT
      mp.grupo,
      mp.ordem,
      mp.sinal,
      CASE
        WHEN mp.sinal =  1 THEN (m.debito - m.credito)
        WHEN mp.sinal = -1 THEN (m.credito - m.debito)
        ELSE 0
      END AS valor
    FROM mov m
    JOIN contab.dre_mapeamento mp
      ON m.conta_codigo LIKE mp.conta_prefix || '%'
  ),

  base AS (
    SELECT
      grupo,
      ordem,
      SUM(valor)::numeric(18,2) AS valor_periodo
    FROM mov_map
    GROUP BY grupo, ordem
  ),

  calc AS (
    SELECT
      COALESCE(SUM(CASE WHEN grupo='RECEITA_BRUTA' THEN valor_periodo END),0) AS receita,
      COALESCE(SUM(CASE WHEN grupo='CMV_CSP' THEN valor_periodo END),0) AS custo,
      COALESCE(SUM(CASE WHEN grupo='DESPESAS_OPERACIONAIS' THEN valor_periodo END),0) AS despesa
    FROM base
  )

  SELECT ordem, grupo, valor_periodo FROM base

  UNION ALL
  SELECT 15,'RESULTADO_BRUTO', (receita - custo) FROM calc

  UNION ALL
  SELECT 55,'RESULTADO_OPERACIONAL', (receita - custo - despesa) FROM calc

  UNION ALL
  SELECT 80,'RESULTADO_LIQUIDO', (receita - custo - despesa) FROM calc

  ORDER BY ordem;
END;
$$;
