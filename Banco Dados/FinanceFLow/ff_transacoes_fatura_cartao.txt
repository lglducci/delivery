 CREATE OR REPLACE FUNCTION ff_transacoes_fatura_cartao(
  p_empresa_id BIGINT,
  p_cartao_id BIGINT, 
  p_referencia DATE
)
RETURNS JSON
LANGUAGE plpgsql
AS $$
DECLARE
    v_fatura_id BIGINT;
    v_cartao_nome TEXT;
    v_fatura JSON;
    v_transacoes JSON;
    v_soma_transacoes NUMERIC;
BEGIN
    -- 1) Buscar a fatura correta usando data_parcela
    SELECT 
        f.id,
        c.nome,
        jsonb_build_object(
            'id', f.id,
            'mes_referencia', f.mes_referencia,
            'status', f.status,
            'valor_total', f.valor_total
        )::json
    INTO v_fatura_id, v_cartao_nome, v_fatura
    FROM cartoes_faturas f
    JOIN cartoes c ON c.id = f.cartao_id
    JOIN cartoes_transacoes t ON t.fatura_id = f.id
    WHERE f.empresa_id = p_empresa_id
      AND c.id = p_cartao_id
      AND date_trunc('month', t.data_parcela) = date_trunc('month', p_referencia)
    LIMIT 1;

    IF v_fatura_id IS NULL THEN
        RETURN json_build_object(
            'erro', 'Nenhuma fatura encontrada para este cartão e mês informado'
        );
    END IF;

    -- 2) Buscar transações já ordenadas por data_parcela
    SELECT json_agg(row_to_json(t2))
    INTO v_transacoes
    FROM (
        SELECT
            t.id,
            t.descricao,
            t.valor,
            t.parcela_num,
            t.parcela_total,
            t.data_parcela,
            t.criado_em
        FROM cartoes_transacoes t
        WHERE t.fatura_id = v_fatura_id
          AND t.empresa_id = p_empresa_id
        ORDER BY t.data_parcela
    ) AS t2;

    -- 3) Soma real das transações (para conferência)
    SELECT SUM(t.valor)
    INTO v_soma_transacoes
    FROM cartoes_transacoes t
    WHERE t.fatura_id = v_fatura_id
      AND t.empresa_id = p_empresa_id;

    -- 4) Retornar JSON final com nome do cartão, fatura e soma
    RETURN json_build_object(
        'cartao', v_cartao_nome,
        'fatura',
            (
                v_fatura::jsonb ||
                jsonb_build_object(
                    'soma_transacoes', COALESCE(v_soma_transacoes, 0)
                )
            )::json,
        'transacoes', COALESCE(v_transacoes, '[]'::json)
    );
END;
$$;
