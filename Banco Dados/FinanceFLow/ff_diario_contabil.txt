 CREATE OR REPLACE FUNCTION contab.ff_diario_contabil(
    p_empresa_id bigint, 
    p_data_ini date, 
    p_data_fim date
)
RETURNS TABLE (
    id          bigint,
    data_mov date, 
    diario_id bigint,
    modelo_codigo text, 
    conta_codigo text,
    conta_nome text, 
    historico text,
    debito numeric,
    credito numeric,
    lote       integer
)
LANGUAGE sql
AS $$
    SELECT
         l.id, 
         (l.data_mov)::date        AS data_mov,   -- ✅ correção aqui
        l.diario_id,
        m.codigo        AS modelo_codigo,
        c.codigo        AS conta_codigo,
        c.nome          AS conta_nome,
        l.historico,
        l.debito,
        l.credito,
        l.lote_id
    FROM contab.lancamentos l
    JOIN contab.contas c
         ON c.id = l.conta_id
    LEFT JOIN contab.modelos m
         ON m.id = l.modelo_id
    WHERE l.empresa_id = p_empresa_id
      AND l.data_mov BETWEEN p_data_ini AND p_data_fim
    ORDER BY
        l.id,
        l.data_mov,
        l.diario_id,
        c.codigo,
        l.lote_id;
$$;
