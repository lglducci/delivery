 CREATE OR REPLACE FUNCTION contab.ff_relatorio_razao(
  p_empresa_id bigint,
  p_data_ini   date,
  p_data_fim   date,
  p_filtro     text DEFAULT NULL
)
RETURNS TABLE (
  data_mov       date,
  conta_id       bigint,
  conta_codigo   text,
  conta_nome     text,
  historico      text,
  debito         numeric(14,2),
  credito        numeric(14,2),
  saldo          numeric(14,2),
  diario_id      bigint,
  modelo_codigo  text
)
LANGUAGE sql
AS $$
WITH contas_filtradas AS (
  SELECT c.id, c.codigo, c.nome
  FROM contab.contas c
  WHERE c.empresa_id = p_empresa_id
    AND (
      p_filtro IS NULL OR btrim(p_filtro) = ''
      OR c.codigo ILIKE '%' || p_filtro || '%'
      OR c.nome   ILIKE '%' || p_filtro || '%'
    )
),

saldo_inicial AS (
  SELECT
    c.id AS conta_id,
    COALESCE(si.saldo, 0)
    +
    COALESCE((
      SELECT SUM(l.debito - l.credito)
      FROM contab.lancamentos l
      WHERE l.empresa_id = p_empresa_id
        AND l.conta_id = c.id
        AND l.data_mov < p_data_ini
    ), 0) AS saldo_inicial
  FROM contas_filtradas c
  LEFT JOIN contab.saldos_iniciais si
         ON si.empresa_id = p_empresa_id
        AND si.conta_id = c.id
),

movimentos AS (
  SELECT
    l.data_mov,
    l.conta_id,
    c.codigo AS conta_codigo,
    c.nome   AS conta_nome,
    l.historico,
    l.debito,
    l.credito,
    l.diario_id,
    m.codigo AS modelo_codigo
  FROM contab.lancamentos l
  JOIN contas_filtradas c ON c.id = l.conta_id
  LEFT JOIN contab.modelos m ON m.id = l.modelo_id
  WHERE l.empresa_id = p_empresa_id
    AND l.data_mov BETWEEN p_data_ini AND p_data_fim
)

SELECT
  m.data_mov,
  m.conta_id,
  m.conta_codigo,
  m.conta_nome,
  m.historico,
  m.debito,
  m.credito,

  -- ðŸ”¥ SALDO CORRETO
  (
    si.saldo_inicial
    +
    SUM(m.debito - m.credito)
      OVER (
        PARTITION BY m.conta_id
        ORDER BY m.data_mov, m.diario_id
        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
      )
  )::numeric(14,2) AS saldo,

  m.diario_id,
  m.modelo_codigo

FROM movimentos m
JOIN saldo_inicial si ON si.conta_id = m.conta_id
ORDER BY m.conta_codigo, m.data_mov, m.diario_id;
$$;