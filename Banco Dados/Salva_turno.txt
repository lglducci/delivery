    

CREATE OR REPLACE FUNCTION salva_turno(
  p_user_id       int,
  p_id_empresa    int,
  p_quantidade    int,
  p_tamanho       text, 
  p_json_opcoes   jsonb
) 
  RETURNS SETOF jsonb
LANGUAGE plpgsql
AS $$
DECLARE 
  v_etapa text;
  v_count int;
  v_categoria text; 
   
   v_tamanho text;
   v_quantidade int;

BEGIN
  -- 1) Zera opÃ§Ãµes anteriores do usuÃ¡rio/empresa
  DELETE FROM turno_opcoes
   WHERE id_empresa = p_id_empresa
     AND user_id    = p_user_id;

  -- 2) Insere as novas opÃ§Ãµes (SEM RETURNING!)
  INSERT INTO turno_opcoes (
    id_empresa, user_id, posicao, numero, nome, categoria, descricao,
    preco_grande, preco_medio, preco_pequena, escolhido, updated_at,
    tamanho, quantidade, volume
  )
  SELECT
    p_id_empresa,
    p_user_id,
    ROW_NUMBER() OVER () AS posicao,
    (elem->>'numero')::int,
    elem->>'nome',
    elem->>'categoria',
    elem->>'descricao',
    NULLIF(elem->>'preco_grande','')::numeric,
    NULLIF(elem->>'preco_medio','')::numeric,
    NULLIF(elem->>'preco_pequena','')::numeric,
    false,
    now(),
    p_tamanho,
    p_quantidade,
    elem->>'volume' 
  FROM jsonb_array_elements(p_json_opcoes) AS elem;

  -- 3) AvanÃ§a etapa (AGORA funciona, porque nÃ£o teve RETURN antes)
  PERFORM adianta_etapa(p_user_id, p_id_empresa);


  -- 4ï¸âƒ£ Conta e identifica a etapa atual
  SELECT COUNT(*)
    INTO v_count
    FROM turno_opcoes
   WHERE user_id = p_user_id
     AND id_empresa = p_id_empresa;

 
-- ðŸ”¹ Se sÃ³ hÃ¡ 1 registro, captura os valores reais da linha
IF v_count = 1 THEN
  SELECT categoria, etapa, tamanho, quantidade
    INTO v_categoria, v_etapa, v_tamanho, v_quantidade
  FROM turno_opcoes
  WHERE user_id = p_user_id
    AND id_empresa = p_id_empresa
  LIMIT 1;

  -- Se ainda faltar quantidade ou tamanho, ajusta etapa conforme o caso
  IF v_quantidade IS NULL THEN
    v_etapa := 'pedir_qtd';
  ELSIF v_categoria = 'pizza' AND (v_tamanho IS NULL OR btrim(v_tamanho) = '') THEN
    v_etapa := 'pedir_tamanho';
  ELSE
    v_etapa := 'ready';
  END IF;
ELSE
  v_etapa := 'escolher';
END IF;

 


  -- 5ï¸âƒ£ Retorna com mensagem adequada
 RETURN QUERY
  SELECT
    row_to_json(t.*)::jsonb ||
    jsonb_build_object(
      'etapa', v_etapa,
      'mensagem',
      CASE
        WHEN v_etapa = 'ready' AND v_count = 1
          THEN format(
            'Item pronto para gravaÃ§Ã£o. Confirma %s unidade%s? (Sim/NÃ£o)',
            COALESCE(t.quantidade,1),
            CASE WHEN COALESCE(t.quantidade,1)>1 THEN 's' ELSE '' END
          )
        WHEN v_etapa = 'ready' AND v_count > 1
          THEN format(
            'Encontrei %s opÃ§Ãµes, qual vocÃª quer? (1â€“%s)',
            v_count, v_count
          )
        WHEN v_etapa = 'pedir_qtd'
          THEN 'Quantas unidades vocÃª deseja desse item?'
        WHEN v_etapa = 'pedir_tamanho'
          THEN 'Qual tamanho vocÃª quer? (mÃ©dia ou grande)'
        WHEN v_etapa = 'pedir_posicao'
          THEN 'Qual opÃ§Ã£o da lista vocÃª escolhe? (1â€“N)'
        ELSE NULL
      END,
      'quantidade', t.quantidade,
      'tamanho', t.tamanho
    )
  FROM turno_opcoes t
  WHERE t.user_id = p_user_id
    AND t.id_empresa = p_id_empresa;

 
  
END;
$$;

