  CREATE OR REPLACE PROCEDURE valida_nome_item_pedido(p_user INT, p_pedido INT, p_empresa_id  INT )
LANGUAGE plpgsql
AS $$
BEGIN
  -- Pizza pelo campo nome
  UPDATE item_pedido_temp AS i
  SET status = CASE
                 WHEN sub.ct = 0 THEN 'rejeitado'
                 ELSE 'opcoes'
               END
  FROM (
    SELECT i2.item_id, COUNT(c.numero) AS ct
    FROM item_pedido_temp AS i2
    LEFT JOIN cardapio AS c
      ON c.categoria = 'pizza'
     AND c.nome ILIKE '%' || TRIM(i2.nome) || '%'
    and  c.id_empresa =  p_empresa_id
    WHERE i2.status = 'inicio'
      AND i2.user_id = p_user
      AND i2.pedido_id = p_pedido
      AND i2.numero = 0
      AND i2.categoria = 'pizza'
     AND i2.id_empresa =  p_empresa_id
    GROUP BY i2.item_id
    HAVING COUNT(c.numero) = 0 OR COUNT(c.numero) > 1
  ) sub
  WHERE i.item_id = sub.item_id
    AND i.status = 'inicio'
    AND i.user_id = p_user
    AND i.pedido_id = p_pedido
    AND i.numero = 0
    AND i.categoria = 'pizza'
   and  i.id_empresa =  p_empresa_id;

  -- Item
  UPDATE item_pedido_temp AS i
  SET status = CASE
                 WHEN sub.ct = 0 THEN 'rejeitado'
                 ELSE 'opcoes'
               END
  FROM (
    SELECT i2.item_id, COUNT(c.numero) AS ct
    FROM item_pedido_temp AS i2
    LEFT JOIN cardapio AS c
      ON c.categoria = 'item'
     AND c.nome ILIKE '%' || TRIM(i2.nome) || '%'
     and  c.id_empresa =  p_empresa_id
    WHERE i2.status = 'inicio'
      AND i2.user_id = p_user
      AND i2.pedido_id = p_pedido
      AND i2.numero = 0
      AND i2.categoria = 'item'
      AND i2.id_empresa =  p_empresa_id
    GROUP BY i2.item_id
    HAVING COUNT(c.numero) = 0 OR COUNT(c.numero) > 1
  ) sub
  WHERE i.item_id = sub.item_id
    AND i.status = 'inicio'
    AND i.user_id = p_user
    AND i.pedido_id = p_pedido
    AND i.numero = 0
    AND i.categoria = 'item'
    and  i.id_empresa =  p_empresa_id;

  -- Pizza pelo campo nome_fracao
  UPDATE item_pedido_temp AS i
  SET status = CASE
                 WHEN sub.ct = 0 THEN 'rejeitado'
                 ELSE 'opcoes'
               END
  FROM (
    SELECT i2.item_id, COUNT(c.numero) AS ct
    FROM item_pedido_temp AS i2
    LEFT JOIN cardapio AS c
      ON c.categoria = 'pizza'
     AND c.nome ILIKE '%' || TRIM(i2.nome_fracao) || '%'
     and  c.id_empresa =  p_empresa_id
    WHERE i2.status = 'inicio'
      AND i2.user_id = p_user
      AND i2.pedido_id = p_pedido
      AND i2.numero_fracao = 0
      AND i2.categoria = 'pizza'
      AND i2.fracionada = true
    and  i2.id_empresa =  p_empresa_id
    GROUP BY i2.item_id
    HAVING COUNT(c.numero) = 0 OR COUNT(c.numero) > 1
  ) sub
  WHERE i.item_id = sub.item_id
    AND i.status = 'inicio'
    AND i.user_id = p_user
    AND i.pedido_id = p_pedido
    AND i.numero_fracao = 0
    AND i.categoria = 'pizza'
    AND i.fracionada = true
    and  i.id_empresa =  p_empresa_id;

  -- Bebida
  UPDATE item_pedido_temp AS i
  SET status = CASE
                 WHEN sub.ct = 0 THEN 'rejeitado'
                 ELSE 'opcoes'
               END
  FROM (
    SELECT i2.item_id, COUNT(c.numero) AS ct
    FROM item_pedido_temp AS i2
    LEFT JOIN cardapio AS c
      ON c.categoria = 'bebida'
     AND (c.palavras_chave ILIKE '%' || TRIM(i2.nome) || '%')
     AND LOWER(TRIM(c.volume)) = LOWER(TRIM(i2.volume))
   and  c.id_empresa =  p_empresa_id
    WHERE i2.status = 'inicio'
      AND i2.user_id = p_user
      AND i2.pedido_id = p_pedido
      AND i2.numero = 0
      AND i2.categoria = 'bebida'
    and  i2.id_empresa =  p_empresa_id
    GROUP BY i2.item_id
    HAVING COUNT(c.numero) = 0 OR COUNT(c.numero) > 1
  ) sub
  WHERE i.item_id = sub.item_id
    AND i.status = 'inicio'
    AND i.user_id = p_user
    AND i.pedido_id = p_pedido
    AND i.numero = 0
    AND i.categoria = 'bebida'
   and  i.id_empresa =  p_empresa_id;

  -- Borda
  UPDATE item_pedido_temp AS i
  SET status = CASE
                 WHEN sub.ct = 0 THEN 'rejeitado'
                 ELSE 'opcoes'
               END
  FROM (
    SELECT i2.item_id, COUNT(c.numero) AS ct
    FROM item_pedido_temp AS i2
    LEFT JOIN cardapio AS c
      ON c.categoria  in (  'borda','esfirra')
     AND (c.palavras_chave ILIKE '%' || TRIM(i2.nome) || '%')
    and  c.id_empresa =  p_empresa_id
    WHERE i2.status = 'inicio'
      AND i2.user_id = p_user
      AND i2.pedido_id = p_pedido
      AND i2.numero = 0
      AND i2.categoria in (  'borda','esfirra')
     and  i2.id_empresa =  p_empresa_id
    GROUP BY i2.item_id
    HAVING COUNT(c.numero) = 0 OR COUNT(c.numero) > 1
  ) sub
  WHERE i.item_id = sub.item_id
    AND i.status = 'inicio'
    AND i.user_id = p_user
    AND i.pedido_id = p_pedido
    AND i.numero = 0
    AND i.categoria  in (  'borda','esfirra')
    and  i.id_empresa =  p_empresa_id;

END;
$$;