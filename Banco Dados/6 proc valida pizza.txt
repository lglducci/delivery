CREATE OR REPLACE FUNCTION valida_pizzas(
    p_user_id   integer,
    p_pedido_id integer,
    p_id_empresa integer 
)
RETURNS json
LANGUAGE plpgsql
AS $$
DECLARE
    v_invalidos json;
    v_count     int;
BEGIN
    -- Junta os possíveis problemas (normal + fracionado)
    WITH candidatos AS (
        SELECT i.nome AS item_nome, c.numero, c.nome AS cardapio_nome
        FROM item_pedido_temp i
        LEFT JOIN cardapio c
          ON c.categoria = 'pizza'
         AND c.nome ILIKE '%' || i.nome || '%'
        WHERE i.status = 'inicio'
          AND i.user_id   = p_user_id
          AND i.pedido_id = p_pedido_id
          AND i.numero = 0
          AND i.fracionado = false 
         and   i.id_empresa = c.id_empresa 
         and   i.id_empresa =  p_id_empresa 

        UNION ALL

        SELECT i.nome_fracao AS item_nome, c.numero, c.nome AS cardapio_nome
        FROM item_pedido_temp i
        LEFT JOIN cardapio c
          ON c.categoria = 'pizza'
         AND c.nome ILIKE '%' || i.nome_fracao || '%'
        WHERE i.status = 'inicio'
          AND i.user_id   = p_user_id
          AND i.pedido_id = p_pedido_id
          AND i.numero = 0
          AND i.fracionado = true  
         and   i.id_empresa = c.id_empresa 
         and   i.id_empresa =  p_id_empresa 

    ),
    -- Pega só os que têm problema (sem correspondência única)
    invalidos AS (
        SELECT item_nome, COUNT(c.numero) AS qtd, json_agg(c.*) AS matches
        FROM candidatos c
        GROUP BY item_nome
        HAVING COUNT(c.numero) <> 1
    )
    SELECT json_agg(invalidos) INTO v_invalidos
    FROM invalidos;

    v_count := COALESCE(json_array_length(v_invalidos), 0);

    IF v_count > 0 THEN
        RETURN json_build_object(
            'ok', false,
            'mensagem', 'Itens inválidos encontrados no cardápio',
            'user_id', p_user_id,
            'pedido_id', p_pedido_id,
            'invalidos', v_invalidos
        );
    ELSE
        RETURN json_build_object(
            'ok', true,
            'mensagem', 'Todos os itens válidos',
            'user_id', p_user_id,
            'pedido_id', p_pedido_id
        );
    END IF;
END;
$$;
