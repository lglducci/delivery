 CREATE OR REPLACE FUNCTION GravaTamanho(
  p_user_id     integer,
  p_id_empresa  integer,
  p_tamanho     text
)
 RETURNS SETOF jsonb
LANGUAGE plpgsql
AS $$

DECLARE
  v_categoria text;
  v_etapa     text;
  v_quantidade  int;

BEGIN


  UPDATE turno_opcoes
     SET tamanho = p_tamanho,
         etapa   = 'pedir_qtd',  -- üîπ j√° sinaliza etapa final
         updated_at = now()
   WHERE user_id    = p_user_id
     AND id_empresa = p_id_empresa
     AND escolhido  = true 
      and   COALESCE(quantidade, 0) = 0  ;


  UPDATE turno_opcoes
     SET tamanho = p_tamanho,
         etapa   = 'ready',  -- üîπ j√° sinaliza etapa final
         updated_at = now()
   WHERE user_id    = p_user_id
     AND id_empresa = p_id_empresa
     AND escolhido  = true 
      and  quantidade  > 0 ;

 
  SELECT categoria, COALESCE(quantidade, 0)
    INTO v_categoria, v_quantidade
  FROM turno_opcoes
  WHERE user_id = p_user_id
    AND id_empresa = p_id_empresa
    AND escolhido = true
  LIMIT 1;

 
  IF  v_quantidade = 0  THEN
    v_etapa := 'pedir_qtd';
  ELSE
    v_etapa := 'ready';
  END IF;

   -- üîπ retorno orientado √† IA
  IF v_etapa = 'pedir_qtd' THEN
    RETURN NEXT jsonb_build_object(
      'acao','pedir_qtd',
      'mensagem','Qual a quantidade de pizza que voc√™ deseja?'
    );
    RETURN;
  ELSE
    -- 1) Confirma a grava√ß√£o da pizza (mant√©m a a√ß√£o como GravaIntencao)
RETURN NEXT jsonb_build_object(
  'acao','GravaIntencao',
    'mensagem','Pizza gravada. Quer borda? Se sim, diga o sabor (ex.: cheddar). Se n√£o, responda "sem" ou diga "finalizar".'
);

  END IF;
 
RETURN;

END;
$$;
