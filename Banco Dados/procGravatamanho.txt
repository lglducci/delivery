 CREATE OR REPLACE FUNCTION GravaTamanho(
  p_user_id     integer,
  p_id_empresa  integer,
  p_tamanho     text
)
 RETURNS SETOF jsonb
LANGUAGE plpgsql
AS $$

DECLARE
  v_categoria text;
  v_etapa     text;
  v_quantidade  int;

BEGIN


  UPDATE turno_opcoes
     SET tamanho = p_tamanho,
         etapa   = 'pedir_qtd',  -- ðŸ”¹ jÃ¡ sinaliza etapa final
         updated_at = now()
   WHERE user_id    = p_user_id
     AND id_empresa = p_id_empresa
     AND escolhido  = true 
      and   COALESCE(quantidade, 0) = 0  ;


  UPDATE turno_opcoes
     SET tamanho = p_tamanho,
         etapa   = 'ready',  -- ðŸ”¹ jÃ¡ sinaliza etapa final
         updated_at = now()
   WHERE user_id    = p_user_id
     AND id_empresa = p_id_empresa
     AND escolhido  = true 
      and  quantidade  > 0 ;

 
  SELECT categoria, COALESCE(quantidade, 0)
    INTO v_categoria, v_quantidade
  FROM turno_opcoes
  WHERE user_id = p_user_id
    AND id_empresa = p_id_empresa
    AND escolhido = true
  LIMIT 1;

 
  IF  v_quantidade = 0  THEN
    v_etapa := 'pedir_qtd';
  ELSE
    v_etapa := 'ready';
  END IF;

  
 
  -- Retorno no formato padrÃ£o do salva_turno
  RETURN QUERY
  SELECT
    row_to_json(t.*)::jsonb ||
    jsonb_build_object(
      'etapa', v_etapa,
      'mensagem',
      CASE
        WHEN v_etapa = 'pedir_qtd' THEN
          'Qual a quantidade de pizza vocÃª quer?'
        WHEN v_etapa = 'ready' THEN
          format(
            'Item pronto para gravaÃ§Ã£o. Confirma %s unidade%s? (Sim/NÃ£o)',
            COALESCE(t.quantidade,1),
            CASE WHEN COALESCE(t.quantidade,1)>1 THEN 's' ELSE '' END
          )
        ELSE
          'Etapa indefinida'
      END,
      'quantidade', t.quantidade,
      'tamanho', t.tamanho
    )
  FROM turno_opcoes t
  WHERE t.user_id = p_user_id
    AND t.id_empresa = p_id_empresa
    AND t.escolhido = true;

END;
$$;

